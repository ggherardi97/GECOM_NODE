<style>
  .img-fluid {
    max-width: 80% !important;
    height: auto;
  }

  p {
    margin-top: 0;
    margin-bottom: 5px;
  }

  /* Contact card actions */
  .contact-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 10px 0 0 0;
  }

  .contact-actions .btn {
    min-width: 44px;
  }

  /* Header project total */
  .projects-total-strong {
    font-family: monospace;
  }

  /* Logo */
  #company_logo {
    width: 100%;
    padding: 20px;
    object-fit: contain;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 6px;
    min-height: 120px;
  }

  .logo-muted {
    font-size: 12px;
    color: #888;
  }
</style>

<div class="row">
  <div class="col-lg-12">
    <div class="wrapper wrapper-content animated fadeInUp">
      <div class="ibox">
        <div class="ibox-content">

          <!-- #region Header Client -->
          <div class="row">
            <div class="col-lg-12">
              <div class="m-b-md">
                <a onclick="callEditDetails()" class="btn btn-white btn-xs float-right" name="btn_act_new">
                  Edite os detalhes do cliente
                </a>
                <h2 id="companyName"></h2>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-lg-10">
              <div class="row">
                <div class="col-lg-6">
                  <dl class="row mb-0">
                    <div class="col-sm-4 text-sm-right">
                      <dt>Status:</dt>
                    </div>
                    <div class="col-sm-8 text-sm-left">
                      <dd class="mb-1">
                        <span class="label label-primary" id="statusLabel"></span>
                      </dd>
                    </div>
                  </dl>

                  <dl class="row mb-0">
                    <div class="col-sm-4 text-sm-right">
                      <dt>Porte:</dt>
                    </div>
                    <div class="col-sm-8 text-sm-left">
                      <dd class="mb-1" id="size">Médio</dd>
                    </div>
                  </dl>

                  <dl class="row mb-0">
                    <div class="col-sm-4 text-sm-right">
                      <dt>Setor:</dt>
                    </div>
                    <div class="col-sm-8 text-sm-left">
                      <dd class="mb-1" id="sector"></dd>
                    </div>
                  </dl>

                  <dl class="row mb-0">
                    <div class="col-sm-4 text-sm-right">
                      <dt>Nome Fantasia:</dt>
                    </div>
                    <div class="col-sm-8 text-sm-left">
                      <dd class="mb-1">
                        <a href="#" class="text-navy" id="fantasyName"></a>
                      </dd>
                    </div>
                  </dl>
                </div>

                <div class="col-lg-6" id="cluster_info">
                  <dl class="row mb-0">
                    <div class="col-sm-4 text-sm-right">
                      <dt>Telefone:</dt>
                    </div>
                    <div class="col-sm-8 text-sm-left">
                      <dd class="mb-1" id="phone"></dd>
                    </div>
                  </dl>

                  <dl class="row mb-0">
                    <div class="col-sm-4 text-sm-right">
                      <dt>Email:</dt>
                    </div>
                    <div class="col-sm-8 text-sm-left">
                      <dd class="mb-1" id="email"></dd>
                    </div>
                  </dl>
                </div>

              </div>

              <div class="row">
                <div class="col-lg-12">
                  <dl class="row mb-0">
                    <div class="col-sm-2 text-sm-right">
                      <dt>Valor total de projetos:</dt>
                    </div>
                    <div class="col-sm-10 text-sm-left">
                      <dd>
                        <div class="progress m-b-1">
                          <div id="projectsTotalBar" style="width: 0%;"
                            class="progress-bar progress-bar-striped progress-bar-animated" title="Total de invoices">
                          </div>
                        </div>

                        <small id="projectsTotalText">
                          Valor total de <strong class="projects-total-strong" id="projectsTotalValue">R$ 0,00</strong>.
                          <span class="text-muted">(meta: <strong>R$ 1.000.000,00</strong>)</span>
                        </small>
                      </dd>
                    </div>
                  </dl>
                </div>
              </div>

            </div>

            <div class="col-lg-2">
              <img id="company_logo" src="../Assets/inspinia/img/zender_logo.png" alt="Logo do cliente">
              <div class="logo-muted" style="padding:0 20px 10px 20px;">
                * Edite o logo em “Edite os detalhes do cliente”.
              </div>
            </div>
          </div>
          <!-- #endregion -->

          <div class="row m-t-sm">
            <div class="col-lg-12">
              <div class="panel blank-panel">
                <div class="panel-heading">
                  <div class="panel-options">
                    <ul class="nav nav-tabs">
                      <li><a class="nav-link active" href="#tab-1" data-toggle="tab">Contatos</a></li>
                      <li><a class="nav-link" href="#tab-2" data-toggle="tab">Documentos</a></li>
                    </ul>
                  </div>
                </div>

                <div class="panel-body">
                  <div class="tab-content">
                    <div class="tab-pane active" id="tab-1">
                      <div class="col-lg-12">
                        <div class="wrapper wrapper-content animated fadeInRight">

                          <div class="row" style="margin-bottom: 10px;">
                            <div class="col-lg-12 text-right">
                              <button name="btn_act_new" type="button" class="btn btn-primary btn-sm"
                                onclick="callNewContact()">
                                <i class="fa fa-plus"></i> Novo contato
                              </button>
                            </div>
                          </div>

                          <div class="row" id="contactsContainer">
                            <!-- Contacts will be rendered here -->
                          </div>

                        </div>
                      </div>
                    </div>

                    <div class="tab-pane" id="tab-2">
                      <div class="wrapper wrapper-content animated fadeInRight">
                        <div class="row">
                          <div class="col-lg-12 animated fadeInRight">

                            <!-- TOP BAR (mini MyDocuments - right only) -->
                            <div class="row" style="padding: 0 15px;">
                              <div class="col-lg-9" style="margin-left:-15px;">
                                <button type="button" class="btn btn-primary" id="cd_btnDocsBack" style="display:none;">
                                  <i class="fa fa-arrow-left"></i> Voltar
                                </button>

                                <div class="btn-group" style="margin-left:8px;" name="btn_act_new">
                                  <button data-toggle="dropdown" class="btn btn-primary dropdown-toggle">
                                    Adicionar
                                  </button>
                                  <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" id="cd_btnDocsNewFolder"><i
                                          class="fa fa-folder"></i> Nova Pasta</a></li>
                                    <li><a class="dropdown-item" href="#" id="cd_btnDocsUpload"><i
                                          class="fa fa-upload"></i> Upload de Documento</a></li>
                                    <li><a class="dropdown-item" href="#" id="cd_btnDocsNewLink"><i
                                          class="fa fa-link"></i> Link do Drive</a></li>
                                  </ul>
                                </div>

                                <button type="button" class="btn btn-white" id="cd_btnDocsOpenSelected"
                                  style="margin-left:8px; display:none;">
                                  <i class="fa fa-external-link"></i> Abrir
                                </button>

                                <button type="button" class="btn btn-danger" id="cd_btnDocsDeleteSelected"
                                  style="margin-left:8px; display:none;">
                                  <i class="fa fa-trash"></i> Excluir
                                </button>

                                <span id="cd_currentDocsFolderLabel" class="text-muted"
                                  style="margin-left:12px;"></span>
                                <span id="cd_docsLoadingBadge" class="label label-info"
                                  style="display:none;margin-left:10px;">Carregando...</span>
                              </div>

                              <div class="col-lg-3">
                                <div class="input-group" style="margin: 0px 0 15px -15px;">
                                  <input id="cd_txtDocsSearch" type="text" class="form-control input-sm"
                                    placeholder="Buscar nesta pasta..." />
                                  <span class="input-group-btn">
                                    <button id="cd_btnDocsSearch" class="btn btn-sm btn-white" type="button"><i
                                        class="fa fa-search"></i></button>
                                  </span>
                                </div>
                              </div>
                            </div>

                            <!-- GRID -->
                            <div class="row" id="cd_itemsDocsGrid" style="padding: 0 15px;">
                              <div class="col-lg-12 text-muted">Carregando...</div>
                            </div>

                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- tab-2 -->

                  </div><!-- tab-content -->
                </div><!-- panel-body -->

              </div><!-- panel -->
            </div>
          </div>

        </div><!-- ibox-content -->
      </div><!-- ibox -->
    </div><!-- wrapper -->
  </div><!-- col -->
</div><!-- row -->

<script>
  (function () {
    // If your backend uses another field name for the logo, change it here:
    const COMPANY_LOGO_FIELD = "company_picture"; // e.g. "logo", "company_logo", "profile_picture"

    // -------------------- DOM helpers --------------------
    function setText(selector, value) {
      const el = document.querySelector(selector);
      if (el) el.textContent = value ?? "";
    }

    function setAttr(selector, attr, value) {
      const el = document.querySelector(selector);
      if (el) el.setAttribute(attr, value);
    }

    function show(selector) {
      const el = document.querySelector(selector);
      if (el) el.style.display = "";
    }

    // -------------------- Utils --------------------
    function escapeHtml(value) {
      if (value == null) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function safeJsonParse(raw) {
      try {
        return raw ? JSON.parse(raw) : null;
      } catch {
        return null;
      }
    }

    function normalizeUsers(company) {
      const u = company?.users;
      if (Array.isArray(u)) return u;
      if (u) return [u];
      return [];
    }

    function normalizeStatusToSelectValue(status) {
      const s = String(status ?? "").toUpperCase();
      if (s === "INACTIVE" || s === "INATIVO") return "INACTIVE";
      return "ACTIVE";
    }

    function mapSelectValueToApiStatus(selectValue) {
      const v = String(selectValue ?? "").toUpperCase();
      return v === "INACTIVE" ? "INACTIVE" : "ACTIVE";
    }

    function normalizeString(value) {
      return String(value ?? "").trim();
    }

    function normalizePhone(value) {
      return String(value ?? "").trim();
    }

    function isNonEmptyString(value) {
      return typeof value === "string" && value.trim().length > 0;
    }

    function isValidEmail(email) {
      const v = String(email ?? "").trim();
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }

    function buildPatchOnlyChanged(originalObj, currentObj, fields) {
      const payload = {};
      let hasChanges = false;

      for (const f of fields) {
        const originalValue = f.normalize(originalObj[f.key]);
        const currentValue = f.normalize(f.read());

        if (originalValue !== currentValue) {
          f.write(payload, currentValue);
          hasChanges = true;
        }
      }

      return { hasChanges, payload };
    }

    function generateTempPassword() {
      const letters = "abcdefghijklmnopqrstuvwxyz";
      const upper = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const digits = "0123456789";
      const specials = "@$!%*#?&";
      const rand = (s) => s[Math.floor(Math.random() * s.length)];

      let pwd = "";
      pwd += "Tmp";
      pwd += rand(specials);
      pwd += rand(upper);
      for (let i = 0; i < 10; i++) pwd += rand(letters + digits);
      pwd += rand(digits);
      return pwd;
    }

    function getCurrentCompanyId() {
      const vm = window.__companyViewModel ?? safeJsonParse(localStorage.getItem("selectedClient"));
      const selectedClientId = localStorage.getItem("selectedClientId");
      return String(vm?.Id ?? selectedClientId ?? "").trim();
    }

    function toNumber(value) {
      const n = Number(String(value ?? "").replace(",", "."));
      return Number.isFinite(n) ? n : 0;
    }

    function moneyPtBr(value) {
      const n = toNumber(value);
      return n.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function getCompanyLogoFromCompany(company) {
      // Try common shapes:
      const candidates = [
        company?.logo_base64,
        company?.logo,
        company?.company_logo,
        company?.profile_picture,
        company?.logo_url,
        company?.logoUrl,
        company?.company_logo_url
      ].filter(Boolean);

      const raw = candidates[0];
      if (!raw) return null;

      const s = String(raw).trim();
      if (!s) return null;

      // If already data URL:
      if (/^data:image\//i.test(s)) return s;

      // If looks like URL:
      if (/^https?:\/\//i.test(s) || s.startsWith("/")) return s;

      // Otherwise treat as base64 png by default
      return "data:image/png;base64," + s;
    }

    function setCompanyLogoOnHeader(logoDataUrlOrUrl) {
      const img = document.getElementById("company_logo");
      if (!img) return;

      if (logoDataUrlOrUrl) {
        img.src = logoDataUrlOrUrl;
        return;
      }

      // fallback image
      img.src = "../Assets/inspinia/img/zender_logo.png";
    }

    // -------------------- GlobalModal (layout) confirm helpers --------------------
    function openGlobalConfirm(options) {
      const title = String(options?.title || "Confirmar");
      const bodyHtml = String(options?.bodyHtml || "<p>Confirmar ação?</p>");
      const okText = String(options?.okText || "Confirmar");
      const okClass = String(options?.okClass || "btn-primary");

      const modalBtn = document.getElementById("modalButton");
      const modalTitle = document.getElementById("modalTitle");
      const modalBody = document.getElementById("modalBody");
      const btnSave = document.getElementById("saveModal");
      const btnClose = document.getElementById("closeModal");

      // Fallback
      if (!modalBtn || !modalTitle || !modalBody || !btnSave || !btnClose) {
        return Promise.resolve(confirm(title));
      }

      modalTitle.textContent = title;
      modalBody.innerHTML = bodyHtml;

      const originalSaveText = btnSave.textContent;
      const originalCloseText = btnClose.textContent;

      btnSave.classList.remove("btn-danger", "btn-warning", "btn-primary", "btn-success", "btn-info", "btn-default");
      btnSave.classList.add(okClass);

      btnSave.textContent = okText;
      btnClose.textContent = "Cancelar";

      return new Promise((resolve) => {
        const cleanup = () => {
          btnSave.onclick = null;
          btnClose.onclick = null;

          btnSave.classList.remove(okClass);
          btnSave.classList.add("btn-primary");
          btnSave.textContent = originalSaveText || "Save";
          btnClose.textContent = originalCloseText || "Close";
        };

        btnSave.onclick = () => { cleanup(); resolve(true); };
        btnClose.onclick = () => { cleanup(); resolve(false); };

        modalBtn.click();
      });
    }

    // -------------------- API: Companies --------------------
    async function fetchCompanyById(companyId) {
      const resp = await fetch(`/api/companies/${encodeURIComponent(companyId)}`, {
        method: "GET",
        headers: { Accept: "application/json" }
      });

      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data?.message || "Falha ao carregar company por id.");
      return data;
    }

    async function patchCompanyById(companyId, patchBody) {
      const resp = await fetch(`/api/companies/${encodeURIComponent(companyId)}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json"
        },
        body: JSON.stringify(patchBody ?? {})
      });

      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data?.message || "Falha ao atualizar empresa.");
      return data;
    }

    // -------------------- API: Users --------------------
    async function patchUserById(userId, patchBody) {
      const resp = await fetch(`/api/users/${encodeURIComponent(userId)}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json"
        },
        body: JSON.stringify(patchBody ?? {})
      });

      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data?.message || "Falha ao atualizar usuário.");
      return data;
    }

    async function deleteUserById(userId) {
      const resp = await fetch(`/api/users/${encodeURIComponent(userId)}`, {
        method: "DELETE",
        headers: { Accept: "application/json" }
      });

      if (resp.status === 204) return true;

      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data?.message || "Falha ao remover usuário.");
      return true;
    }

    async function createUser(payload) {
      const resp = await fetch(`/api/users`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json"
        },
        body: JSON.stringify(payload ?? {})
      });

      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data?.message || "Falha ao criar usuário.");
      return data;
    }

    // -------------------- API: Invoices (sum totals) --------------------
    async function fetchInvoicesByCompany(companyId) {
      const qs = new URLSearchParams();
      qs.set("company_id", String(companyId || "").trim());

      const resp = await fetch(`/api/invoices?${qs.toString()}`, {
        method: "GET",
        headers: { Accept: "application/json" }
      });

      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data?.message || "Falha ao carregar invoices da empresa.");

      const list = Array.isArray(data)
        ? data
        : (data?.data ?? data?.rows ?? data?.invoices ?? []);

      return Array.isArray(list) ? list : [];
    }

    // -------------------- Mapping --------------------
    function getPrimaryUser(company) {
      const users = normalizeUsers(company);
      return users[0] ?? null;
    }

    function mapCompanyToViewModel(company) {
      const primaryUser = getPrimaryUser(company);

      return {
        Id: String(company.id ?? company.company_id ?? company.companyId ?? ""),
        CompanyName: company.company_name ?? "",
        Phone: company.phone ?? "",
        Sector: company.sector ?? "Geral",
        Size: company.category ?? company.porte ?? "-",
        Status: company.status ?? "Active",
        Email: company.email ?? primaryUser?.email ?? "",
        Logo: getCompanyLogoFromCompany(company)
      };
    }

    function mapCompanyUsersToContacts(company) {
      const users = normalizeUsers(company);

      return users.map((x) => ({
        id: x.id ?? "",
        fullName: x.full_name ?? x.fullName ?? "",
        email: x.email ?? "",
        role: x.role ?? "USER",
        status: x.status ?? "ACTIVE",
        phone: x.phonenumber ?? "",
        imageUrl: "/Assets/inspinia/img/user.png"
      }));
    }

    // -------------------- Header fill --------------------
    function fillClientHeader(vm) {
      setText("#companyName", vm?.CompanyName ?? "");
      setText("#fantasyName", vm?.CompanyName ?? "");
      setText("#email", vm?.Email ?? "");
      setText("#phone", vm?.Phone ?? "");
      setText("#sector", vm?.Sector ?? "Geral");
      setText("#size", vm?.Size ?? "-");
      setText("#statusLabel", vm?.Status ?? "Active");
      setCompanyLogoOnHeader(vm?.Logo || null);
    }

    // -------------------- Invoices total -> progress --------------------
    function setProjectsTotalUi(totalValue) {
      const total = Math.max(0, toNumber(totalValue));
      const goal = 1000000;
      const pct = goal > 0 ? Math.min(100, (total / goal) * 100) : 0;

      const bar = document.getElementById("projectsTotalBar");
      if (bar) {
        bar.style.width = `${pct.toFixed(2)}%`;
        bar.setAttribute("aria-valuenow", String(total));
        bar.setAttribute("aria-valuemin", "0");
        bar.setAttribute("aria-valuemax", String(goal));
        bar.title = `Total de invoices: R$ ${moneyPtBr(total)} / Meta: R$ ${moneyPtBr(goal)}`;
      }

      const val = document.getElementById("projectsTotalValue");
      if (val) val.textContent = `R$ ${moneyPtBr(total)}`;
    }

    async function loadInvoicesTotal(companyId) {
      try {
        if (!isNonEmptyString(companyId)) {
          setProjectsTotalUi(0);
          return;
        }

        const invoices = await fetchInvoicesByCompany(companyId);

        let sum = 0;
        for (const inv of invoices) {
          const v = inv?.total ?? inv?.grand_total ?? inv?.total_amount ?? 0;
          sum += toNumber(v);
        }

        setProjectsTotalUi(sum);
      } catch (e) {
        console.error("loadInvoicesTotal error:", e);
        setProjectsTotalUi(0);
      }
    }

    // -------------------- Contacts rendering --------------------
    function renderContacts(contacts) {
      const container = document.querySelector("#contactsContainer");
      if (!container) return;

      container.innerHTML = "";

      if (!contacts || contacts.length === 0) {
        container.innerHTML = `<div class="col-lg-12"><p>Nenhum contato encontrado.</p></div>`;
        return;
      }

      contacts.forEach((c, index) => {
        const col = document.createElement("div");
        col.className = "col-lg-3";

        col.innerHTML = `
          <div class="contact-box" onclick="onContactClick(${index});">
            <a class="row">
              <div class="col-4">
                <div class="text-center">
                  <img alt="image" class="rounded-circle m-t-xs img-fluid" src="${escapeHtml(c.imageUrl)}">
                  <div class="m-t-xs font-bold">${escapeHtml(c.role ?? "")}</div>
                </div>
              </div>

              <div class="col-8">
                <h3><strong>${escapeHtml(c.fullName)}</strong></h3>
                ${c.email ? `<p><i class="fa fa-envelope"></i> ${escapeHtml(c.email)}</p>` : ""}
                ${c.phone ? `<p><i class="fa fa-phone"></i> ${escapeHtml(c.phone)}</p>` : ""}
                <p><i class="fa fa-circle"></i> Status: ${escapeHtml(String(c.status ?? ""))}</p>
              </div>
            </a>

            <div class="row" style="display:block;width:100%;text-align:center;">
              <div class="contact-actions">
                <button type="button" class="btn btn-primary btn-sm" title="Editar"
                  onclick="event.stopPropagation(); onContactEdit(${index});">
                  <i class="fa fa-pencil"></i>
                </button>

                <button type="button" class="btn btn-danger btn-sm" title="Excluir"
                  onclick="event.stopPropagation(); onContactDelete(${index});">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;

        container.appendChild(col);
      });

      window.__contacts = contacts;
    }

    // -------------------- Side modal: Edit User (PATCH) --------------------
    function onContactClick(index) {
      const contacts = window.__contacts ?? [];
      const c = contacts[index];
      if (!c || !c.id) return;

      const original = {
        fullName: normalizeString(c.fullName),
        email: normalizeString(c.email),
        phone: normalizePhone(c.phone),
        status: normalizeString(c.status)
      };

      const statusValue = normalizeStatusToSelectValue(c.status);

      const html = `
        <div class="form-group">
          <label for="txtName">Nome</label>
          <input id="txtName" class="form-control" value="${escapeHtml(c.fullName)}" />
        </div>

        <div class="form-group">
          <label for="txtEmail">Email</label>
          <input id="txtEmail" class="form-control" value="${escapeHtml(c.email)}" />
          <small class="text-muted">Alterar o email irá alterar o acesso deste usuário à plataforma.</small>
        </div>

        <div class="form-group">
          <label for="txtPhoneNumber">Telefone</label>
          <input id="txtPhoneNumber" class="form-control" value="${escapeHtml(c.phone ?? "")}" />
        </div>

        <div class="form-group">
          <label for="txtRole">Role</label>
          <input id="txtRole" class="form-control" value="${escapeHtml(c.role)}" readonly />
        </div>

        <div class="form-group">
          <label for="selStatus">Status</label>
          <select id="selStatus" class="form-control">
            <option value="ACTIVE" ${statusValue === "ACTIVE" ? "selected" : ""}>Ativo</option>
            <option value="INACTIVE" ${statusValue === "INACTIVE" ? "selected" : ""}>Inativo</option>
          </select>
          <small class="text-muted">Ao inativar o user, o mesmo não poderá mais acessar a plataforma.</small>
        </div>
      `;

      SideModal.open({
        title: "Editar Contato",
        html: html,

        onOk: async function () {
          try {
            const current = {
              fullName: $("#txtName").val(),
              email: $("#txtEmail").val(),
              phone: $("#txtPhoneNumber").val(),
              status: mapSelectValueToApiStatus($("#selStatus").val())
            };

            const diff = buildPatchOnlyChanged(
              { fullName: original.fullName, email: original.email, phone: original.phone, status: original.status },
              current,
              [
                { key: "fullName", read: () => current.fullName, normalize: normalizeString, write: (p, v) => { p.full_name = v; } },
                { key: "email", read: () => current.email, normalize: normalizeString, write: (p, v) => { p.email = v; } },
                { key: "phone", read: () => current.phone, normalize: normalizePhone, write: (p, v) => { p.phonenumber = v; } },
                { key: "status", read: () => current.status, normalize: normalizeString, write: (p, v) => { p.status = v; } }
              ]
            );

            if (!diff.hasChanges) return;

            await patchUserById(c.id, diff.payload);

            localStorage.removeItem("selectedClient");
            location.reload();
          } catch (err) {
            console.error(err);
            alert(err?.message || "Erro ao salvar usuário.");
          }
        },

        onCancel: function () { }
      });
    }

    window.onContactClick = onContactClick;

    function onContactEdit(index) {
      onContactClick(index);
    }

    async function onContactDelete(index) {
      const contacts = window.__contacts ?? [];
      const c = contacts[index];
      if (!c || !c.id) return;

      const ok = await openGlobalConfirm({
        title: "Excluir contato",
        bodyHtml: `
          <p>Você está prestes a excluir o contato <strong>${escapeHtml(c.fullName || "-")}</strong>.</p>
          <p class="text-danger" style="margin-bottom:0;">Esta ação não poderá ser desfeita.</p>
        `,
        okText: "Excluir",
        okClass: "btn-danger"
      });

      if (!ok) return;

      try {
        await deleteUserById(c.id);
        localStorage.removeItem("selectedClient");
        location.reload();
      } catch (e) {
        console.error(e);
        alert(e?.message || "Erro ao excluir contato.");
      }
    }

    window.onContactEdit = onContactEdit;
    window.onContactDelete = onContactDelete;

    // -------------------- Side modal: New Contact (POST) --------------------
    function callNewContact() {
      const companyId = getCurrentCompanyId();
      if (!isNonEmptyString(companyId)) {
        alert("Não foi possível identificar o company_id desta página.");
        return;
      }

      const html = `
        <div class="form-group">
          <label for="txtNewName">Nome</label>
          <input id="txtNewName" class="form-control" />
        </div>

        <div class="form-group">
          <label for="txtNewEmail">Email</label>
          <input id="txtNewEmail" class="form-control" />
        </div>

        <div class="form-group">
          <label for="txtNewPhone">Telefone</label>
          <input id="txtNewPhone" class="form-control" placeholder="+5511961381234" />
        </div>

        <div class="form-group">
          <label for="selNewRole">Role</label>
          <select id="selNewRole" class="form-control">
            <option value="USER" selected>User</option>
            <option value="MANAGER">Manager</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>

        <div class="form-group" style="margin-top:10px;">
          <div class="checkbox">
            <label>
              <input type="checkbox" id="chkSendAccess" checked />
              Enviar acesso à plataforma (primeiro acesso)
            </label>
          </div>
          <small class="text-muted">
            Se marcado, o sistema irá enviar um email para que o usuário acesse a plataforma.
          </small>
        </div>
      `;

      SideModal.open({
        title: "Novo Contato",
        html: html,

        onOk: async function () {
          try {
            const fullName = normalizeString($("#txtNewName").val());
            const email = normalizeString($("#txtNewEmail").val());
            const phonenumber = normalizePhone($("#txtNewPhone").val());
            const role = normalizeString($("#selNewRole").val()) || "USER";
            const sendAccess = $("#chkSendAccess").is(":checked") === true;

            if (!isNonEmptyString(fullName)) { alert("Informe o Nome."); return; }
            if (!isNonEmptyString(email) || !isValidEmail(email)) { alert("Informe um Email válido."); return; }

            const tempPassword = generateTempPassword();

            const payload = {
              full_name: fullName,
              email: email,
              password: tempPassword,
              role: role === "ADMIN" ? "ADMIN" : "USER",
              phonenumber: phonenumber,
              first_access: sendAccess,
              company_id: companyId,
              status: "ACTIVE"
            };

            await createUser(payload);

            localStorage.removeItem("selectedClient");
            location.reload();
          } catch (err) {
            console.error(err);
            alert(err?.message || "Erro ao criar contato.");
          }
        },

        onCancel: function () { }
      });
    }

    window.callNewContact = callNewContact;

    // -------------------- Logo helpers --------------------
    function readFileAsDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ""));
        reader.onerror = () => reject(new Error("Falha ao ler o arquivo."));
        reader.readAsDataURL(file);
      });
    }

    function isImageFile(file) {
      const type = String(file?.type || "").toLowerCase();
      return type.startsWith("image/");
    }

    // -------------------- Side modal: Edit Company (PATCH) + LOGO --------------------
    function callEditDetails() {
      const vm = window.__companyViewModel ?? safeJsonParse(localStorage.getItem("selectedClient"));
      if (!vm?.Id) { alert("Cliente inválido (Id não encontrado)."); return; }

      const original = {
        companyName: normalizeString(vm.CompanyName),
        phone: normalizeString(vm.Phone),
        sector: normalizeString(vm.Sector),
        size: normalizeString(vm.Size),
        logo: vm.Logo || "" // data url or url
      };

      const currentLogo = original.logo ? original.logo : "../Assets/inspinia/img/zender_logo.png";

      const html = `
        <div class="form-group">
          <label for="txtCompanyName">Nome da Empresa</label>
          <input id="txtCompanyName" class="form-control" value="${escapeHtml(vm.CompanyName ?? "")}" />
        </div>

        <div class="form-group">
          <label for="txtPhone">Telefone</label>
          <input id="txtPhone" class="form-control" value="${escapeHtml(vm.Phone ?? "")}" />
        </div>

        <div class="form-group">
          <label for="txtSector">Setor</label>
          <input id="txtSector" class="form-control" value="${escapeHtml(vm.Sector ?? "")}" />
        </div>

        <div class="form-group">
          <label for="txtSize">Porte</label>
          <input id="txtSize" class="form-control" value="${escapeHtml(vm.Size ?? "")}" />
        </div>

        <div class="form-group">
          <label for="txtEmail">Email (contato principal)</label>
          <input id="txtEmail" class="form-control" value="${escapeHtml(vm.Email ?? "")}" readonly />
          <small class="text-muted">O email vem do usuário principal (tabela Users).</small>
        </div>

        <hr style="margin: 15px 0;" />

        <div class="form-group">
          <label>Logo do Cliente</label>
          <div style="display:flex; gap:12px; align-items:flex-start;">
            <img id="cd_logoPreview" src="${escapeHtml(currentLogo)}"
              style="width:120px;height:120px;object-fit:contain;border:1px solid #e7eaec;border-radius:6px;background:#fff;padding:6px;" />
            <div style="flex:1;">
              <input id="cd_logoFile" type="file" class="form-control" accept="image/*" />
              <small class="text-muted">
                PNG/JPG/SVG. Máximo 5MB. O logo será salvo em <strong>${escapeHtml(COMPANY_LOGO_FIELD)}</strong>.
              </small>
              <div id="cd_logoError" class="text-danger" style="margin-top:8px; display:none;"></div>

              <div style="margin-top:10px; display:flex; gap:8px;">
                <button type="button" class="btn btn-white btn-sm" id="cd_btnLogoRemove">
                  <i class="fa fa-times"></i> Remover logo
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      SideModal.open({
        title: "Editar detalhes do Cliente",
        html: html,

        onOk: async function () {
          try {
            $("#cd_logoError").hide().text("");

            const current = {
              companyName: $("#txtCompanyName").val(),
              phone: $("#txtPhone").val(),
              sector: $("#txtSector").val(),
              size: $("#txtSize").val(),
            };

            const diff = buildPatchOnlyChanged(
              {
                companyName: original.companyName,
                phone: original.phone,
                sector: original.sector,
                size: original.size
              },
              current,
              [
                { key: "companyName", read: () => current.companyName, normalize: normalizeString, write: (p, v) => { p.company_name = v; } },
                { key: "phone", read: () => current.phone, normalize: normalizeString, write: (p, v) => { p.phone = v; } },
                { key: "sector", read: () => current.sector, normalize: normalizeString, write: (p, v) => { p.sector = v; } },
                { key: "size", read: () => current.size, normalize: normalizeString, write: (p, v) => { p.category = v; } }
              ]
            );

            // Logo change detection
            const removeLogo = $("#cd_btnLogoRemove").data("remove") === true;
            const fileInput = document.getElementById("cd_logoFile");
            const file = fileInput && fileInput.files && fileInput.files[0];

            let logoChanged = false;
            let newLogoDataUrl = null;

            if (removeLogo) {
              logoChanged = true;
              newLogoDataUrl = "";
            } else if (file) {
              if (!isImageFile(file)) {
                $("#cd_logoError").show().text("Selecione um arquivo de imagem.");
                return;
              }
              const maxBytes = 5 * 1024 * 1024;
              if (file.size > maxBytes) {
                $("#cd_logoError").show().text("Imagem maior que 5MB. Reduza o tamanho do arquivo.");
                return;
              }
              newLogoDataUrl = await readFileAsDataUrl(file);
              logoChanged = true;
            }

            const payload = diff.payload || {};
            let hasAnything = diff.hasChanges;

            if (logoChanged) {
              payload[COMPANY_LOGO_FIELD] = newLogoDataUrl; // data URL or empty string to remove
              hasAnything = true;
            }

            if (!hasAnything) return;

            await patchCompanyById(vm.Id, payload);

            // Update local VM and header UI immediately
            const updatedVm = Object.assign({}, vm, {
              CompanyName: normalizeString(current.companyName),
              Phone: normalizeString(current.phone),
              Sector: normalizeString(current.sector),
              Size: normalizeString(current.size),
              Logo: logoChanged ? (newLogoDataUrl ? newLogoDataUrl : null) : (vm.Logo || null)
            });

            window.__companyViewModel = updatedVm;
            localStorage.setItem("selectedClient", JSON.stringify(updatedVm));
            fillClientHeader(updatedVm);

            // Keep it simple/consistent with your current approach:
            location.reload();
          } catch (err) {
            console.error(err);
            alert(err?.message || "Erro ao salvar dados do cliente.");
          }
        },

        onCancel: function () { }
      });

      // Wire preview & remove
      setTimeout(function () {
        $("#cd_btnLogoRemove").off("click.__rm").on("click.__rm", function (e) {
          e.preventDefault();
          e.stopPropagation();
          $("#cd_logoFile").val("");
          $("#cd_logoPreview").attr("src", "../Assets/inspinia/img/zender_logo.png");
          $("#cd_btnLogoRemove").data("remove", true);
        });

        $("#cd_logoFile").off("change.__preview").on("change.__preview", function () {
          $("#cd_btnLogoRemove").data("remove", false);
          $("#cd_logoError").hide().text("");

          const f = this.files && this.files[0];
          if (!f) return;

          if (!isImageFile(f)) {
            $("#cd_logoError").show().text("Selecione um arquivo de imagem.");
            $(this).val("");
            return;
          }

          const maxBytes = 5 * 1024 * 1024;
          if (f.size > maxBytes) {
            $("#cd_logoError").show().text("Imagem maior que 5MB. Reduza o tamanho do arquivo.");
            $(this).val("");
            return;
          }

          const url = URL.createObjectURL(f);
          $("#cd_logoPreview").attr("src", url);
        });
      }, 50);
    }

    window.callEditDetails = callEditDetails;

    // -------------------- Init --------------------
    async function init() {
      setText("#pageName", "Detalhes do Cliente");
      setText("#subSecoundPageName", "Detalhes do Cliente");
      setText("#subpageName", "Clientes");
      setAttr("#subpageName", "href", "Clientes");
      show("#path");

      const selectedClientId = localStorage.getItem("selectedClientId");
      const rawClient = localStorage.getItem("selectedClient");

      if (!selectedClientId && !rawClient) {
        alert("Erro ao carregar dados do cliente! (no localStorage)");
        return;
      }

      const cached = safeJsonParse(rawClient);
      if (cached) fillClientHeader(cached);

      if (selectedClientId) {
        try {
          const company = await fetchCompanyById(selectedClientId);
          window.__companyRaw = company;

          const vm = mapCompanyToViewModel(company);
          window.__companyViewModel = vm;

          localStorage.setItem("selectedClient", JSON.stringify(vm));
          fillClientHeader(vm);

          const contacts = mapCompanyUsersToContacts(company);
          renderContacts(contacts);

          await loadInvoicesTotal(selectedClientId);
        } catch (err) {
          console.error("Failed to fetch company by id:", err);
          if (!cached) alert("Erro ao carregar dados do cliente via API.");
          setProjectsTotalUi(0);
          setCompanyLogoOnHeader(null);
        }
      } else {
        setProjectsTotalUi(0);
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();
</script>

<style>
  /* ClientDetails Documents mini grid selection */
  #cd_itemsDocsGrid .file-box .file {
    cursor: default;
  }

  #cd_itemsDocsGrid .file-box.is-selected .file {
    outline: 2px solid rgba(26, 179, 148, 0.45);
    box-shadow: 0 0 0 3px rgba(26, 179, 148, 0.12);
    border-radius: 4px;
  }

  #cd_itemsDocsGrid .file-box .select-badge {
    position: absolute;
    top: 6px;
    left: 6px;
    width: 22px;
    height: 22px;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid #d5d5d5;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 5;
    cursor: pointer;
  }

  #cd_itemsDocsGrid .file-box .select-badge i {
    font-size: 14px;
    color: #1ab394;
  }

  #cd_itemsDocsGrid .file-box.is-selected .select-badge {
    display: flex;
  }

  #cd_itemsDocsGrid .file-box:hover .select-badge {
    display: flex;
    opacity: .75;
  }

  #cd_itemsDocsGrid .file-box.is-selected:hover .select-badge {
    opacity: 1;
  }
</style>

<script>
  (function () {
    // ---------------------------
    // Mini MyDocuments inside ClientDetails (Tab Documentos)
    // ---------------------------

    function escapeHtml(value) {
      if (value == null) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function formatDate(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString("pt-BR") + " " + d.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
    }

    function debounce(fn, waitMs) {
      let t = null;
      return function () {
        const args = arguments;
        clearTimeout(t);
        t = setTimeout(() => fn.apply(null, args), waitMs);
      };
    }

    function showLoading(flag) {
      $("#cd_docsLoadingBadge").toggle(!!flag);
    }

    function isFolder(item) { return String(item?.item_type || "").toUpperCase() === "FOLDER"; }
    function isLink(item) { return String(item?.item_type || "").toUpperCase() === "LINK"; }
    function isFile(item) { return String(item?.item_type || "").toUpperCase() === "FILE"; }

    function isDriveLink(item) {
      const sp = String(item?.storage_provider || "").toUpperCase();
      const it = String(item?.item_type || "").toUpperCase();
      return sp === "DRIVE" || it === "DRIVE";
    }

    function iconFor(item) {
      if (isFolder(item)) return '<i class="fa fa-folder"></i>';
      if (isLink(item)) {
        if (isDriveLink(item)) return '<i class="fa fa-google"></i>';
        return '<i class="fa fa-link"></i>';
      }

      const ext = String(item?.ext || "").toLowerCase();
      const mime = String(item?.mime_type || "").toLowerCase();

      if (mime.startsWith("image/")) return '<i class="fa fa-file-image-o"></i>';
      if (mime.startsWith("video/")) return '<i class="fa fa-film"></i>';
      if (mime.startsWith("audio/")) return '<i class="fa fa-music"></i>';
      if (ext === "pdf") return '<i class="fa fa-file-pdf-o"></i>';
      if (ext === "xls" || ext === "xlsx" || mime.includes("spreadsheet")) return '<i class="fa fa-bar-chart-o"></i>';
      if (ext === "doc" || ext === "docx") return '<i class="fa fa-file-word-o"></i>';
      return '<i class="fa fa-file"></i>';
    }

    function getClientId() {
      const selectedClientId = localStorage.getItem("selectedClientId");
      if (selectedClientId && String(selectedClientId).trim()) return String(selectedClientId).trim();

      try {
        const raw = localStorage.getItem("selectedClient");
        if (raw) {
          const vm = JSON.parse(raw);
          if (vm?.Id) return String(vm.Id).trim();
        }
      } catch { }

      return "";
    }

    function getUserCompanyId() {
      const id = window.__auth?.company_id || window.__auth?.companyId || null;
      return id ? String(id) : null;
    }

    function getAccountIdForCreate() {
      const id =
        window.__auth?.accountId ||
        window.__auth?.account_id ||
        window.__auth?.account?.id ||
        window.__auth?.tenant_id ||
        window.__auth?.admin_account_id ||
        null;

      if (id) return String(id);

      const companyId = getUserCompanyId();
      return companyId ? String(companyId) : null;
    }

    async function readJsonSafe(response) {
      const text = await response.text();
      if (!text) return {};
      try { return JSON.parse(text); } catch { return { message: text }; }
    }

    async function apiGet(url) {
      const res = await fetch(url, { method: "GET", headers: { "Accept": "application/json" } });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || "Erro ao buscar dados");
      return data;
    }

    async function apiPost(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Accept": "application/json", "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || "Erro ao salvar");
      return data;
    }

    async function apiDelete(url) {
      const res = await fetch(url, { method: "DELETE", headers: { "Accept": "application/json" } });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || "Erro ao excluir");
      return data;
    }

    function pickFirst(selectors) {
      for (const sel of selectors) {
        const el = document.querySelector(sel);
        if (el) return el;
      }
      return null;
    }
    function replaceWithClone(el) {
      if (!el || !el.parentNode) return el;
      const clone = el.cloneNode(true);
      el.parentNode.replaceChild(clone, el);
      return clone;
    }
    function openSideModal(opts) {
      const overlay = pickFirst(["#dynamicModalOverlay", ".dynamic-modal-overlay"]);
      const modal = pickFirst(["#dynamicModal", ".dynamic-modal"]);
      const titleEl = pickFirst(["#dynamicModalTitle", ".dynamic-modal-title"]);
      const bodyEl = pickFirst(["#dynamicModalBody", ".dynamic-modal-body"]);

      let btnClose = pickFirst(["#dynamicModalCloseBtn", ".dynamic-modal-close"]);
      let btnCancel = pickFirst(["#dynamicModalCancelBtn", ".dynamic-modal-cancel"]);
      let btnOk = pickFirst(["#dynamicModalOkBtn", ".dynamic-modal-ok"]);

      if (!overlay || !modal || !titleEl || !bodyEl || !btnOk) {
        alert("Side modal global não encontrado no layout. Verifique IDs do dynamic modal.");
        return;
      }

      btnOk = replaceWithClone(btnOk);
      if (btnCancel) btnCancel = replaceWithClone(btnCancel);
      if (btnClose) btnClose = replaceWithClone(btnClose);

      titleEl.textContent = (opts?.title || "");
      bodyEl.innerHTML = (opts?.bodyHtml || "");
      if (btnCancel) btnCancel.textContent = (opts?.cancelText || "Cancelar");
      btnOk.textContent = (opts?.okText || "OK");

      function close() {
        overlay.style.display = "none";
        modal.style.display = "none";
      }

      btnOk.addEventListener("click", async function (e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        const keepOpen = (typeof opts?.onOk === "function") ? await opts.onOk() : false;
        if (!keepOpen) close();
      }, true);

      if (btnCancel) {
        btnCancel.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          if (typeof opts?.onCancel === "function") opts.onCancel();
          close();
        }, true);
      }

      if (btnClose) {
        btnClose.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          if (typeof opts?.onCancel === "function") opts.onCancel();
          close();
        }, true);
      }

      overlay.style.display = "block";
      modal.style.display = "block";
    }

    const docsState = {
      initialized: false,
      currentParentId: null,
      navStack: [],
      selected: new Set(),
      currentSearch: "",
      lastLoadedItems: [],
      lastClick: { id: null, ts: 0 },
    };

    function updateTopActions() {
      const count = docsState.selected.size;
      $("#cd_btnDocsDeleteSelected").toggle(count > 0);
      $("#cd_btnDocsOpenSelected").toggle(count === 1);
      $("#cd_btnDocsBack").toggle(docsState.navStack.length > 0);

      if (docsState.navStack.length === 0) {
        $("#cd_currentDocsFolderLabel").text("");
      } else {
        const parts = docsState.navStack.map(x => x.name || "Pasta");
        $("#cd_currentDocsFolderLabel").text(parts.join(" / "));
      }
    }

    function clearSelection() {
      docsState.selected.clear();
      $("#cd_itemsDocsGrid .file-box").removeClass("is-selected");
      updateTopActions();
    }

    function applySelectionClasses() {
      $("#cd_itemsDocsGrid .file-box").removeClass("is-selected");
      for (const selId of docsState.selected) {
        $('#cd_itemsDocsGrid .file-box[data-id="' + selId + '"]').addClass("is-selected");
      }
      updateTopActions();
    }

    function setSelected(id, single) {
      if (single) docsState.selected.clear();
      docsState.selected.add(id);
      applySelectionClasses();
    }

    function toggleSelected(id) {
      if (docsState.selected.has(id)) docsState.selected.delete(id);
      else docsState.selected.add(id);
      applySelectionClasses();
    }

    function buildListQuery() {
      const qs = new URLSearchParams();

      if (docsState.currentParentId === null) qs.set("parent_id", "null");
      else qs.set("parent_id", docsState.currentParentId);

      if (docsState.currentSearch && docsState.currentSearch.trim()) qs.set("q", docsState.currentSearch.trim());

      qs.set("take", "500");
      qs.set("skip", "0");

      const clientId = getClientId();
      qs.set("related_table", "company");
      qs.set("related_id", clientId || "00000000-0000-0000-0000-000000000000");

      return qs.toString();
    }

    function renderGrid(items) {
      const $grid = $("#cd_itemsDocsGrid");
      $grid.empty();

      const list = Array.isArray(items) ? items : [];
      docsState.lastLoadedItems = list;

      if (list.length === 0) {
        $grid.append('<div class="col-lg-12 text-muted">Nenhum item encontrado.</div>');
        clearSelection();
        return;
      }

      list.forEach(function (item) {
        const id = item.id;
        const name = escapeHtml(item.name || item.filename || "Sem nome");
        const added = formatDate(item.created_at);
        const iconHtml = iconFor(item);

        $grid.append(`
          <div class="file-box" data-id="${escapeHtml(id)}" style="position:relative;">
            <div class="select-badge" title="Selecionar"><i class="fa fa-check"></i></div>

            <div class="file">
              <a href="javascript:void(0)" class="cd-doc-hit" data-id="${escapeHtml(id)}" style="display:block;">
                <span class="corner"></span>
                <div class="icon">${iconHtml}</div>
                <div class="file-name">
                  ${name}
                  <br />
                  <small>Adicionado: ${escapeHtml(added || "-")}</small>
                </div>
              </a>
            </div>
          </div>
        `);
      });

      $("#cd_itemsDocsGrid").off("click.bg").on("click.bg", function (e) {
        if ($(e.target).closest(".file-box").length === 0) clearSelection();
      });

      $("#cd_itemsDocsGrid .select-badge").off("click.sel").on("click.sel", function (e) {
        e.preventDefault();
        e.stopPropagation();
        const id = String($(this).closest(".file-box").data("id"));
        if (!id) return;
        toggleSelected(id);
      });

      $(".cd-doc-hit").off("click").on("click", async function (e) {
        e.preventDefault();
        e.stopPropagation();

        const id = String($(this).data("id"));
        const now = Date.now();
        const isDouble = (docsState.lastClick.id === id && (now - docsState.lastClick.ts) < 320);
        docsState.lastClick = { id: id, ts: now };

        const item = docsState.lastLoadedItems.find(x => x.id === id);
        if (!item) return;

        const multi = !!(e.ctrlKey || e.metaKey) || docsState.selected.size > 0;

        if (isDouble) { await openItem(item); return; }

        if (multi) toggleSelected(id);
        else setSelected(id, true);
      });

      applySelectionClasses();
    }

    async function loadCurrentFolder() {
      try {
        updateTopActions();
        showLoading(true);

        const query = buildListQuery();
        const data = await apiGet("/api/documents?" + query);

        renderGrid(data);
        clearSelection();
      } catch (e) {
        $("#cd_itemsDocsGrid").html('<div class="col-lg-12 text-danger">' + escapeHtml(e?.message || "Erro ao carregar") + '</div>');
      } finally {
        updateTopActions();
        showLoading(false);
      }
    }

    async function openItem(item) {
      if (!item) return;

      if (isFolder(item)) {
        docsState.navStack.push({ parentId: docsState.currentParentId, name: item.name || "Pasta" });
        docsState.currentParentId = item.id;
        await loadCurrentFolder();
        return;
      }

      if (isLink(item)) {
        const url = isDriveLink(item)
          ? (item.object_key || item.external_key || "")
          : (item.external_key || item.object_key || "");

        if (url) window.open(url, "_blank", "noopener,noreferrer");
        return;
      }

      try {
        showLoading(true);
        const dl = await apiGet("/api/documents/" + encodeURIComponent(item.id) + "/presign-download");
        const url = dl?.url || dl?.downloadUrl || dl?.signedUrl;
        if (!url) throw new Error("Não foi possível gerar o link de download.");
        window.open(url, "_blank", "noopener,noreferrer");
      } catch (err) {
        alert(err?.message || "Erro ao baixar arquivo.");
      } finally {
        showLoading(false);
      }
    }

    function getExtFromName(fileName) {
      const n = String(fileName || "");
      const idx = n.lastIndexOf(".");
      if (idx <= 0 || idx >= n.length - 1) return null;
      return n.substring(idx + 1).toLowerCase();
    }

    async function doUpload(file, accountId, displayNameRaw, progressCb) {
      const fileName = file.name;
      const displayName = displayNameRaw || fileName;
      const mimeType = file.type || "application/octet-stream";
      const ext = getExtFromName(fileName);

      const clientId = getClientId();
      if (!clientId) throw new Error("Não foi possível identificar o cliente para vincular os documentos.");

      progressCb && progressCb(5, "Criando registro no banco...");

      const createPayload = {
        account_id: accountId,
        parent_id: docsState.currentParentId,
        item_type: "FILE",
        name: displayName,
        filename: fileName,
        ext: ext,
        mime_type: mimeType,
        related_table: "company",
        related_id: clientId
      };

      const created = await apiPost("/api/documents", createPayload);
      const docId = created?.id;
      if (!docId) throw new Error("Falha ao criar registro do documento.");

      progressCb && progressCb(20, "Gerando URL de upload...");

      const presign = await apiPost("/api/documents/" + encodeURIComponent(docId) + "/presign-upload", {
        fileName: fileName,
        contentType: mimeType,
        size: file.size
      });

      const putUrl = presign?.url;
      const putHeaders = presign?.headers || { "Content-Type": mimeType };
      const objectKey = presign?.object_key || presign?.key || null;

      if (!putUrl) throw new Error("Não foi possível gerar a URL de upload.");

      progressCb && progressCb(45, "Enviando arquivo para o Cloudflare R2...");

      const putRes = await fetch(putUrl, { method: "PUT", headers: putHeaders, body: file });
      if (!putRes.ok) {
        const t = await putRes.text().catch(() => "");
        throw new Error(("Upload falhou (" + putRes.status + "). " + (t || "")).trim());
      }

      const etag = putRes.headers.get("etag") || presign?.etag || null;

      progressCb && progressCb(85, "Finalizando...");

      await apiPost("/api/documents/" + encodeURIComponent(docId) + "/complete-upload", {
        upload_status: "UPLOADED",
        object_key: objectKey,
        etag: etag,
        mime_type: mimeType,
        size_bytes: file.size
      });

      progressCb && progressCb(100, "Concluído!");
      return docId;
    }

    function openNewFolderSideModal() {
      openSideModal({
        title: "Nova Pasta",
        okText: "Criar",
        cancelText: "Cancelar",
        bodyHtml: `
          <div class="form-group">
            <label>Nome</label>
            <input id="cd_sm_folderName" type="text" class="form-control" maxlength="255" placeholder="Ex: Contratos" />
            <div id="cd_sm_folderError" class="text-danger" style="margin-top:8px; display:none;"></div>
          </div>
        `,
        onOk: async function () {
          const name = ($("#cd_sm_folderName").val() || "").trim();
          $("#cd_sm_folderError").hide().text("");

          if (!name) { $("#cd_sm_folderError").show().text("Informe o nome da pasta."); return true; }

          const accountId = getAccountIdForCreate();
          if (!accountId) { $("#cd_sm_folderError").show().text("Não foi possível identificar o account_id para criar."); return true; }

          const clientId = getClientId();
          if (!clientId) { $("#cd_sm_folderError").show().text("Não foi possível identificar o cliente."); return true; }

          try {
            showLoading(true);

            const payload = {
              account_id: accountId,
              parent_id: docsState.currentParentId,
              item_type: "FOLDER",
              name: name,
              filename: null,
              storage_provider: "NONE",
              related_table: "company",
              related_id: clientId
            };

            await apiPost("/api/documents", payload);
            await loadCurrentFolder();
            return false;
          } catch (e) {
            $("#cd_sm_folderError").show().text(e?.message || "Erro ao criar pasta.");
            return true;
          } finally {
            showLoading(false);
          }
        }
      });

      setTimeout(function () { $("#cd_sm_folderName").focus(); }, 150);
    }

    function openNewLinkSideModal() {
      openSideModal({
        title: "Link do Drive",
        okText: "Salvar",
        cancelText: "Cancelar",
        bodyHtml: `
          <div class="form-group">
            <label>Nome</label>
            <input id="cd_sm_linkName" type="text" class="form-control" maxlength="255" placeholder="Ex: Pasta do Google Drive" />
          </div>
          <div class="form-group">
            <label>URL</label>
            <input id="cd_sm_linkUrl" type="text" class="form-control" maxlength="1000" placeholder="https://drive.google.com/..." />
            <small class="text-muted">O link será salvo no campo <strong>object_key</strong>.</small>
          </div>
          <div id="cd_sm_linkError" class="text-danger" style="display:none;"></div>
        `,
        onOk: async function () {
          const name = ($("#cd_sm_linkName").val() || "").trim();
          const url = ($("#cd_sm_linkUrl").val() || "").trim();
          $("#cd_sm_linkError").hide().text("");

          if (!name) { $("#cd_sm_linkError").show().text("Informe o nome."); return true; }
          if (!url || !/^https?:\/\//i.test(url)) { $("#cd_sm_linkError").show().text("Informe uma URL válida (http/https)."); return true; }

          const accountId = getAccountIdForCreate();
          if (!accountId) { $("#cd_sm_linkError").show().text("Não foi possível identificar o account_id."); return true; }

          const clientId = getClientId();
          if (!clientId) { $("#cd_sm_linkError").show().text("Não foi possível identificar o cliente."); return true; }

          try {
            showLoading(true);

            const payload = {
              account_id: accountId,
              parent_id: docsState.currentParentId,
              item_type: "LINK",
              name: name,
              filename: null,
              object_key: url,
              storage_provider: "DRIVE",
              related_table: "company",
              related_id: clientId
            };

            await apiPost("/api/documents", payload);
            await loadCurrentFolder();
            return false;
          } catch (e) {
            $("#cd_sm_linkError").show().text(e?.message || "Erro ao salvar link.");
            return true;
          } finally {
            showLoading(false);
          }
        }
      });

      setTimeout(function () { $("#cd_sm_linkName").focus(); }, 150);
    }

    function openUploadSideModal() {
      openSideModal({
        title: "Upload de Documento",
        okText: "Enviar",
        cancelText: "Cancelar",
        bodyHtml: `
          <div class="alert alert-info" style="margin-bottom:10px;">
            Selecione apenas um arquivo.
          </div>

          <div class="form-group">
            <label>Arquivo</label>
            <input id="cd_sm_uploadFile" type="file" class="form-control" />
          </div>

          <div class="form-group">
            <label>Nome</label>
            <input id="cd_sm_uploadDisplayName" type="text" class="form-control" maxlength="255"
              placeholder="Vamos preencher automaticamente com o nome do arquivo" />
            <small class="text-muted">Você pode alterar o nome antes de enviar.</small>
          </div>

          <div id="cd_sm_uploadProgress" style="display:none;">
            <div class="progress progress-striped active">
              <div id="cd_sm_uploadProgressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <small id="cd_sm_uploadProgressText" class="text-muted"></small>
          </div>

          <div id="cd_sm_uploadError" class="text-danger" style="display:none;"></div>
        `,
        onOk: async function () {
          const input = document.getElementById("cd_sm_uploadFile");
          const file = input && input.files && input.files[0];
          const displayNameRaw = ($("#cd_sm_uploadDisplayName").val() || "").trim();
          $("#cd_sm_uploadError").hide().text("");

          if (!file) { $("#cd_sm_uploadError").show().text("Selecione um arquivo."); return true; }

          const accountId = getAccountIdForCreate();
          if (!accountId) { $("#cd_sm_uploadError").show().text("Não foi possível identificar o account_id."); return true; }

          try {
            showLoading(true);
            $("#cd_sm_uploadProgress").show();

            await doUpload(file, accountId, displayNameRaw, function (pct, text) {
              $("#cd_sm_uploadProgressBar").css("width", String(Math.max(0, Math.min(100, pct || 0))) + "%");
              $("#cd_sm_uploadProgressText").text(text || "");
            });

            await loadCurrentFolder();
            return false;
          } catch (e) {
            $("#cd_sm_uploadError").show().text(e?.message || "Erro no upload.");
            return true;
          } finally {
            showLoading(false);
          }
        }
      });

      setTimeout(function () {
        const $file = $("#cd_sm_uploadFile");
        const $name = $("#cd_sm_uploadDisplayName");

        $file.off("change.__autoname").on("change.__autoname", function () {
          const f = this.files && this.files[0];
          if (!f) return;
          $name.val(f.name || "");
          try { $name.focus(); } catch { }
        });
      }, 50);
    }

    async function deleteSelected() {
      if (docsState.selected.size === 0) return;

      const ok = confirm("Confirma excluir " + docsState.selected.size + " item(ns)?");
      if (!ok) return;

      try {
        showLoading(true);
        const ids = Array.from(docsState.selected);
        for (const id of ids) {
          await apiDelete("/api/documents/" + encodeURIComponent(id));
        }
        await loadCurrentFolder();
      } catch (e) {
        alert(e?.message || "Erro ao excluir.");
      } finally {
        showLoading(false);
      }
    }

    async function openSelected() {
      if (docsState.selected.size !== 1) return;
      const id = Array.from(docsState.selected)[0];
      const item = docsState.lastLoadedItems.find(x => x.id === id);
      if (!item) return;
      await openItem(item);
    }

    const runSearchDebounced = debounce(async function () {
      docsState.currentSearch = ($("#cd_txtDocsSearch").val() || "").trim();
      await loadCurrentFolder();
    }, 280);

    async function initDocsTabOnce() {
      if (docsState.initialized) return;
      docsState.initialized = true;

      if (!window.__auth?.isAdmin) {
        $('a[name="btn_act_new"]').hide();
        $('button[name="btn_act_new"]').hide();
      }

      docsState.currentParentId = null;
      docsState.navStack = [];
      docsState.selected.clear();
      docsState.currentSearch = "";
      updateTopActions();

      $("#cd_btnDocsBack").on("click", async function () {
        const last = docsState.navStack.pop();
        docsState.currentParentId = last?.parentId ?? null;
        await loadCurrentFolder();
      });

      $("#cd_btnDocsNewFolder").on("click", function (e) { e.preventDefault(); openNewFolderSideModal(); });
      $("#cd_btnDocsUpload").on("click", function (e) { e.preventDefault(); openUploadSideModal(); });
      $("#cd_btnDocsNewLink").on("click", function (e) { e.preventDefault(); openNewLinkSideModal(); });

      $("#cd_btnDocsDeleteSelected").on("click", deleteSelected);
      $("#cd_btnDocsOpenSelected").on("click", openSelected);

      $("#cd_btnDocsSearch").on("click", async function () {
        docsState.currentSearch = ($("#cd_txtDocsSearch").val() || "").trim();
        await loadCurrentFolder();
      });

      $("#cd_txtDocsSearch").on("input keyup", function () {
        runSearchDebounced();
      });

      $("#cd_txtDocsSearch").on("keydown", async function (e) {
        if (e.key === "Enter") {
          docsState.currentSearch = ($("#cd_txtDocsSearch").val() || "").trim();
          await loadCurrentFolder();
        }
      });

      $(".dropdown-item").on("click", function (e) { e.preventDefault(); });

      await loadCurrentFolder();
    }

    $(document).ready(function () {
      $('a[href="#tab-2"]').on("shown.bs.tab", function () {
        initDocsTabOnce();
      });
    });
  })();
</script>
