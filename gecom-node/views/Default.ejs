<style>
  .ibox-title { padding: 15px 60px 8px 15px; }

  .truncate {
    max-width: 280px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .table-actions a { margin-right: 8px; }
  .sortable { cursor: pointer; user-select: none; }
  .sort-indicator { margin-left: 6px; font-size: 11px; opacity: .75; }

  /* Filter bar */
  .dash-filterbar {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
    margin-bottom: 15px;
  }
  .dash-filterbar label {
    margin: 0;
    font-weight: 600;
    font-size: 12px;
    color: #666;
  }
  .dash-filterbar .form-control {
    height: 30px;
    padding: 3px 10px;
  }

  /* ---------- Billing Dashboard charts ---------- */
  .dash-chart-wrap { height: 315px; } /* AUMENTA a altura do gráfico principal */
  /* #lineChart { width: 100% !important; height: 100% !important; } */

  .dash-doughnut-wrap {
    height: 320px;
    display: block;
    position: relative;
  }
  #processStatusChart {
    width: 100% !important;
    height: 320px !important;
    display: block;
  }
  .dash-empty-chart {
    height: 320px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
    font-size: 12px;
    text-align: center;
  }

  /* Cards clicáveis */
  .dash-clicker { padding: 5px 20px; cursor: pointer; }

  /* Lista */
  .dash-inprogress-list { max-height: 220px; overflow: auto; }

  /* ---------- My Processes Dashboard ---------- */
  .dash-kpi .ibox-title h5 { text-transform: none; }
  .dash-kpi .ibox-content h1 { font-size: 28px; }
  .dash-table td, .dash-table th { vertical-align: middle; }
  .dash-muted { color: #999; }
  .dash-mini-list .feed-element { padding: 10px 0; border-bottom: 1px solid #e7eaec; }
  .dash-mini-list .feed-element:last-child { border-bottom: none; }
  .dash-mini-list .media-body { padding-left: 0; }
  .dash-mini-list .feed-element.is-read { background: #eef9f5; border-radius: 4px; padding: 10px 8px; }
  .inspinia-timeline .timeline-item .date { width: 110px; }
  .inspinia-timeline .timeline-item .content { width: calc(100% - 110px); }

  /* AQUI resolve o gráfico “espremidinho” do Meus Processos */
  .dash-chart-wrap-company { height: 260px; }
  #lineChartCompany { width: 100% !important; height: 100% !important; display:block; }
</style>

<div class="wrapper wrapper-content">

  <!-- FILTER BAR (mantém a Default) -->
  <div class="row">
    <div class="col-lg-9">
      <div class="dash-filterbar" style="float: inline-start;">
        <label for="dashboardPicker"><%= t('page.layout.menu.dashboard') %>:</label>

        <!-- Picklist de dashboards (Faturamento + Meus processos) -->
        <select id="dashboardPicker" class="form-control input-sm" style="width: 250px;">
          <option value="billing" selected><%= t('page.dashboard.pageTitle') %></option>
          <option value="myprocesses">Meus processos</option>
        </select>
      </div>
    </div>

    <div class="col-lg-3">
      <!-- Ano (só afeta o dashboard de faturamento) -->
      <div class="dash-filterbar" id="yearFilterWrap">
        <label for="yearFilter"><%= t('page.dashboard.filters.year') %></label>
        <select id="yearFilter" class="form-control input-sm" style="width: 120px;">
          <option value="2025">2025</option>
          <option value="2026">2026</option>
        </select>
      </div>
    </div>
  </div>

  <!-- =========================================================
       VIEW 1: FATURAMENTO (seu dashboard atual)
  ========================================================== -->
  <div id="dashBillingWrap">

    <!-- ROW 1: Cards + Processos próximos do prazo (top 2) -->
    <div class="row">
      <div class="col-lg-2">
        <div class="ibox">
          <div class="ibox-title">
            <span class="label label-success float-right"><%= t('page.dashboard.filters.monthly') %></span>
            <h5>Faturamento</h5>
          </div>
          <div class="ibox-content">
            <h1 id="monthlyRevenue" class="no-margins">-</h1>
            <div class="stat-percent font-bold text-success">
              <span id="monthlyDelta">-</span> <i class="fa fa-bolt"></i>
            </div>
            <small><%= t('page.dashboard.cards.monthBillingTitle') %></small>
          </div>
        </div>
      </div>

      <div class="col-lg-2">
        <div class="ibox">
          <div class="ibox-title">
            <span class="label label-info float-right"><%= t('page.dashboard.filters.annual') %></span>
            <h5>Faturamento</h5>
          </div>
          <div class="ibox-content">
            <h1 id="annualRevenue" class="no-margins">-</h1>
            <div class="stat-percent font-bold text-info">
              <span id="annualDelta">-</span> <i class="fa fa-level-up"></i>
            </div>
            <small><%= t('page.dashboard.cards.yearBillingTitle') %></small>
          </div>
        </div>
      </div>

      <!-- Média mensal -->
      <div class="col-lg-2">
        <div class="ibox">
          <div class="ibox-title">
            <span class="label label-primary float-right">Ano</span>
            <h5><%= t('page.dashboard.cards.monthlyAverageTitle') %></h5>
          </div>
          <div class="ibox-content">
            <h1 id="avgMonthlyRevenue" class="no-margins">-</h1>
            <div class="stat-percent font-bold text-navy">
              <span id="avgMonthlyHint">-</span> <i class="fa fa-line-chart"></i>
            </div>
            <small><%= t('page.dashboard.cards.monthlyAverageHelp') %></small>
          </div>
        </div>
      </div>

      <!-- Melhor mês -->
      <div class="col-lg-2">
        <div class="ibox">
          <div class="ibox-title">
            <span class="label label-warning float-right">Ano</span>
            <h5><%= t('page.dashboard.cards.bestMonthTitle') %></h5>
          </div>
          <div class="ibox-content">
            <h2 id="bestMonthName" class="no-margins">-</h2>
            <div class="stat-percent font-bold text-warning">
              <span id="bestMonthRevenue">-</span> <i class="fa fa-trophy"></i>
            </div>
            <small><%= t('page.dashboard.cards.bestMonthHelp') %></small>
          </div>
        </div>
      </div>

      <!-- Processos próximos do prazo (top 2) -->
      <div class="col-lg-4">
        <div class="ibox">
          <div class="ibox-title">
            <h5><%= t('page.dashboard.sections.nearDeadline') %></h5>
          </div>

          <div id="nearDueContainer" class="dash-inprogress-list">
            <div class="ibox-content"><small><%= t('page.dashboard.labels.loading') %></small></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ROW 2: Line + Doughnut -->
    <div class="row">
      <div class="col-lg-8">
        <div class="ibox">
          <div class="ibox-content">
            <div>
              <span class="float-right text-right">
                <small><%= t('page.dashboard.labels.totalInvoicesInPeriod') %> <strong id="totalInvoicesInPeriod">-</strong></small>
                <br />
                <small><%= t('page.dashboard.labels.totalProcessesInPeriod') %> <strong id="totalProcessesInPeriod">-</strong></small>
              </span>
              <h3 class="font-bold no-margins"><%= t('page.dashboard.sections.annualBilling') %></h3>
              <small><%= t('page.dashboard.labels.legend') %></small>
            </div>

            <div class="m-t-sm">
              <div class="dash-chart-wrap">
                <canvas id="lineChart"></canvas>
              </div>
            </div>

            <div class="m-t-md">
              <small class="float-right">
                <i class="fa fa-clock-o"></i>
                <%= t('page.dashboard.labels.updatedAt') %> <span id="lastUpdateAt">-</span>
              </small>
              <small>
                <strong><%= t('page.dashboard.labels.note') %></strong> <%= t('page.dashboard.labels.noteLine1') %>
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Doughnut -->
      <div class="col-lg-4">
        <div class="ibox">
          <div class="ibox-title">
            <h5><%= t('page.dashboard.sections.byStatus') %></h5>
          </div>
          <div class="ibox-content">
            <div class="dash-doughnut-wrap">
              <canvas id="processStatusChart"></canvas>
              <div id="processStatusEmpty" class="dash-empty-chart" style="display:none;">
                <%= t('page.dashboard.labels.emptyPeriod') %>
              </div>
            </div>
            <div class="text-center m-t-sm">
              <small><%= t('page.dashboard.labels.yearByStatus') %></small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ROW 3: Grid de Processos -->
    <div class="row">
      <div class="col-lg-12">
        <div class="ibox">
          <div class="ibox-title">
            <h5><%= t('page.dashboard.sections.processes') %></h5>
          </div>

          <div class="ibox-content">
            <div class="row">
              <div class="col-sm-9 m-b-xs">
                <div class="btn-group">
                  <button id="btnReloadProcesses" class="btn btn-sm btn-white" type="button">
                    <i class="fa fa-refresh"></i> <%= t('page.dashboard.table.reload') %>
                  </button>
                </div>
              </div>
              <div class="col-sm-3">
                <div class="input-group mb-3">
                  <input id="processSearch" type="text" class="form-control form-control-sm" placeholder="<%= t('page.dashboard.table.search') %>">
                  <div class="input-group-append">
                    <button id="btnSearch" class="btn btn-sm btn-primary" type="button"><%= t('page.dashboard.table.search') %></button>
                  </div>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th class="sortable" data-sort="process_number"><%= t('page.dashboard.table.process') %> <span class="sort-indicator"></span></th>
                    <th class="sortable" data-sort="company"><%= t('page.dashboard.table.company') %> <span class="sort-indicator"></span></th>
                    <th class="sortable" data-sort="completed"><%= t('page.dashboard.table.completed') %> <span class="sort-indicator"></span></th>
                    <th class="sortable" data-sort="status"><%= t('page.dashboard.table.status') %> <span class="sort-indicator"></span></th>
                    <th class="sortable" data-sort="invoice"><%= t('page.dashboard.table.invoice') %> <span class="sort-indicator"></span></th>
                    <th><%= t('page.dashboard.table.action') %></th>
                  </tr>
                </thead>
                <tbody id="processesTbody">
                  <tr><td colspan="6"><%= t('page.dashboard.table.loading') %></td></tr>
                </tbody>
              </table>
            </div>

            <div class="row m-t-sm">
              <div class="col-sm-6">
                <small id="processesCount">-</small>
              </div>
              <div class="col-sm-6 text-right">
                <button id="prevPage" class="btn btn-sm btn-white" type="button"><%= t('page.dashboard.table.previous') %></button>
                <button id="nextPage" class="btn btn-sm btn-white" type="button"><%= t('page.dashboard.table.next') %></button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- =========================================================
       VIEW 2: MEUS PROCESSOS (dashboard “da empresa logada”)
  ========================================================== -->
  <div id="dashMyProcessesWrap" style="display:none;padding-top: 0px;">

    <div class="wrapper wrapper-content animated fadeInUp">

      <!-- Row 1: Line chart + Notificações -->
      <div class="row">
        <div class="col-lg-8">
          <div class="ibox">
            <div class="ibox-content">
              <div>
                <span class="float-right text-right">
                  <small class="dash-muted">Atualizado em: <strong id="lastUpdateAtCompany">-</strong></small>
                  <br />
                  <span class="dash-muted">Empresa:</span> <strong id="companyNameText">-</strong>
                </span>

                <h1 class="m-b-xs" id="lineTotalYear">R$ 0,00</h1>
                <h3 class="font-bold no-margins">Valores dos meus Processos</h3>
                <small class="dash-muted">Somatório dos invoices por mês (ano atual).</small>
              </div>

              <div class="m-t-md">
                <div class="dash-chart-wrap-company">
                  <!-- REMOVIDO height="70" para não “espremir” -->
                  <canvas id="lineChartCompany"></canvas>
                </div>
              </div>

              <div class="m-t-md">
                <small class="dash-muted">
                  <strong>Observação:</strong> valores calculados com base nos invoices vinculados à sua empresa.
                </small>
              </div>

            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="ibox">
            <div class="ibox-title">
              <h5>Notificações</h5>
            </div>
            <div class="ibox-content dash-mini-list" id="notificationsList">
              <div class="feed-element">
                <div class="media-body">Carregando notificações...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Row 2: KPI cards -->
      <div class="row dash-kpi">
        <div class="col-lg-4">
          <div class="ibox">
            <div class="ibox-title">
              <span class="label label-primary float-right">Total</span>
              <h5>Número de processos GECOM</h5>
            </div>
            <div class="ibox-content">
              <h1 class="no-margins" id="kpiProcessCount">0</h1>
              <small class="dash-muted">Processos vinculados à sua empresa</small>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="ibox">
            <div class="ibox-title">
              <span class="label label-info float-right">Este ano</span>
              <h5>Valor total de processos</h5>
            </div>
            <div class="ibox-content">
              <h1 class="no-margins" id="kpiTotalYear">R$ 0,00</h1>
              <small class="dash-muted">Somatório dos invoices do ano</small>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="ibox">
            <div class="ibox-title">
              <span class="label label-success float-right">Status 4</span>
              <h5>Processos fechados</h5>
            </div>
            <div class="ibox-content">
              <h1 class="no-margins" id="kpiClosedCount">0</h1>
              <small class="dash-muted">Processos com status = 4</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Row 3: Top 2 + Timeline -->
      <div class="row">
        <div class="col-lg-6">
          <div class="ibox">
            <div class="ibox-title">
              <h5>Novos dados para o relatório</h5>
            </div>

            <div class="ibox-content">
              <div class="table-responsive">
                <table class="table table-striped dash-table">
                  <thead>
                    <tr>
                      <th style="width: 160px;">Processo</th>
                      <th style="width: 140px;">Status</th>
                      <th style="width: 200px;">Criado em</th>
                    </tr>
                  </thead>
                  <tbody id="top2ProcessesTbody">
                    <tr><td colspan="3">Carregando...</td></tr>
                  </tbody>
                </table>
              </div>

              <small class="dash-muted">Mostrando os 2 processos mais recentes.</small>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="ibox">
            <div class="ibox-title">
              <h5>Timeline</h5>
              <span class="label label-primary" id="timelineBadge">Processo ativo</span>
            </div>

            <div class="ibox-content inspinia-timeline" id="timelineWrap">
              <div id="timelineEmpty" class="dash-muted">Carregando timeline...</div>
              <div id="timelineContainer"></div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>

</div>

<% contentFor('scripts') %>
<script src="../Assets/inspinia/js/plugins/peity/jquery.peity.min.js"></script>
<script src="../Assets/inspinia/js/demo/peity-demo.js"></script>

<script src="../Assets/inspinia/js/plugins/jquery-ui/jquery-ui.min.js"></script>
<script src="../Assets/inspinia/js/plugins/chartJs/Chart.min.js"></script>

<script>
  function redirectToProcessDetail(id) {
    if (!id) return;
    window.location = "ProcessDetail?id=" + encodeURIComponent(String(id));
  }

  $(document).ready(function () {
    $("#masterHeader").hide();

    // -------------------- Auth / Role helpers --------------------
    function parseBool(value) {
      if (value === true) return true;
      if (value === false) return false;
      if (value == null) return false;

      var s = String(value).trim().toLowerCase();
      if (s === "true" || s === "1" || s === "yes" || s === "y") return true;
      if (s === "false" || s === "0" || s === "no" || s === "n" || s === "") return false;

      // fallback: avoid treating random strings as true
      return false;
    }

    function getUserRole() {
      return String(
        window.__auth?.role ||
        window.__auth?.user_role ||
        window.__auth?.user?.role ||
        window.__auth?.user?.user_role ||
        ""
      ).trim().toLowerCase();
    }

    function isAdminUser() {
      // Only treat as admin if it's really true OR role is admin
      var isAdminFlag =
        parseBool(window.__auth?.is_admin) ||
        parseBool(window.__auth?.isAdmin) ||
        parseBool(window.__auth?.user?.is_admin) ||
        parseBool(window.__auth?.user?.isAdmin);

      if (isAdminFlag) return true;

      var role = getUserRole();
      return role === "admin" || role === "administrator";
    }

    // -------------------- Dashboard view model --------------------
    var DASH_VIEW = { billing: "billing", my: "my" };
    var isAdmin = isAdminUser();

    // Admin: default billing | Non-admin: default my
    var selectedDashView = isAdmin ? DASH_VIEW.billing : DASH_VIEW.my;

    // -------------------- Picker --------------------
    function buildDashPicker() {
      var $sel = $("#dashboardPicker");
      if (!$sel.length) return;

      $sel.empty();

      if (isAdmin) {
        $sel.append(`<option value="${DASH_VIEW.billing}"><%= t('page.dashboard.pageTitle') %></option>`);
        $sel.append(`<option value="${DASH_VIEW.my}">Meus Processos</option>`);
        $sel.prop("disabled", false);

        // garante visível
        $sel.closest(".dash-filterbar").show();
      } else {
        // Non-admin: ONLY my
        $sel.append(`<option value="${DASH_VIEW.my}">Meus Processos</option>`);
        $sel.val(DASH_VIEW.my);
        $sel.prop("disabled", true);

        // Se você quer esconder o picker inteiro:
        $sel.closest(".dash-filterbar").hide();
      }

      // Important: set value AFTER options
      $sel.val(selectedDashView);
    }

    // -------------------- View toggle --------------------
    var myProcessesLoadedOnce = false;

    function setView(viewName) {
      if (viewName === DASH_VIEW.my) {
        $("#dashBillingWrap").hide();
        $("#dashMyProcessesWrap").show();
        $("#yearFilterWrap").hide();
        return;
      }

      $("#dashMyProcessesWrap").hide();
      $("#dashBillingWrap").show();
      $("#yearFilterWrap").show();
    }

    // Orchestrator
    function loadDashboard() {
      setView(selectedDashView);

      if (selectedDashView === DASH_VIEW.billing) {
        loadBillingDashboard();
        return;
      }

      // my
      if (!myProcessesLoadedOnce) {
        myProcessesLoadedOnce = true;
        loadMyProcessesDashboard();
      } else {
        // se você quiser sempre recarregar ao trocar, deixe assim:
        loadMyProcessesDashboard();
      }
    }

    // ✅ FIX: event delegation (pega change mesmo se plugin mexer no select)
    $(document).on("change", "#dashboardPicker", function () {
      var v = String($(this).val() || "");
      selectedDashView = (v === DASH_VIEW.my) ? DASH_VIEW.my : DASH_VIEW.billing;
      loadDashboard();
    });

    // -------------------- Helpers (shared) --------------------
    function toNumber(value) {
      var n = Number(String(value ?? "").replace(",", "."));
      return Number.isFinite(n) ? n : 0;
    }

    function moneyCurrencyPtBr(value, currencyCode) {
      var n = toNumber(value);
      try {
        if (currencyCode) {
          return new Intl.NumberFormat("pt-BR", { style: "currency", currency: currencyCode }).format(n);
        }
      } catch (e) { }
      return new Intl.NumberFormat("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
    }

    function moneyPtBr(value, currencyCode) { return moneyCurrencyPtBr(value, currencyCode); }

    function formatDateTimePtBr(value) {
      if (!value) return "-";
      var d = new Date(value);
      if (Number.isNaN(d.getTime())) return "-";
      return d.toLocaleString("pt-BR");
    }

    function formatDatePtBr(value) {
      if (!value) return "-";
      var d = new Date(value);
      if (Number.isNaN(d.getTime())) return "-";
      return d.toLocaleDateString("pt-BR");
    }

    function applyPeity() {
      try { $(".pie").peity("pie"); } catch (e) { }
    }

    async function fetchJson(url) {
      var res = await fetch(url, { headers: { "Accept": "application/json" } });
      var data = await res.json().catch(function () { return {}; });
      if (!res.ok) throw new Error(data?.message || ("HTTP " + res.status));
      return data;
    }

    function normalizeArrayResponse(data) {
      if (Array.isArray(data)) return data;
      if (Array.isArray(data?.data)) return data.data;
      if (Array.isArray(data?.rows)) return data.rows;
      if (Array.isArray(data?.items)) return data.items;
      return [];
    }

    // -------- Invoice helpers (billing) --------
    function pickInvoiceDate(inv) { return inv?.quote_at || inv?.created_at || null; }
    function pickInvoiceTotal(inv) { return inv?.total ?? 0; }
    function pickInvoiceStatus(inv) {
      var s = inv?.status ?? inv?.invoice_status ?? inv?.invoiceStatus ?? inv?.state ?? inv?.statecode ?? null;
      if (s == null) return null;
      var n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    // -------- Process helpers (billing + myprocesses) --------
    function getProcessStatusValue(p) {
      var n = Number(p?.status);
      return Number.isFinite(n) ? n : null;
    }

    function getProcessStatusLabel(p) {
      var v = getProcessStatusValue(p);
      if (v == null) return "-";
      if (window.ProcessStatusEnum?.getLabel) return window.ProcessStatusEnum.getLabel(v);
      return "Status " + v;
    }

    function getProcessStatusCssFull(p) {
      var v = getProcessStatusValue(p);
      var cssClass = "label-default";
      if (v != null && window.ProcessStatusEnum?.getCssClass) {
        cssClass = window.ProcessStatusEnum.getCssClass(v) || "label-default";
      }
      return "label " + cssClass;
    }

    function pickProcessNumber(p) { return p?.process_number || p?.processNumber || p?.number || p?.code || p?.id || "-"; }
    function pickProcessCompanyName(p) { return p?.companies?.company_name || p?.company?.company_name || p?.company_name || p?.companyName || "-"; }
    function pickProcessId(p) { return p?.id || p?.process_id || p?.processId || null; }
    function pickProcessInvoice(p) {
      var v =
        p?.invoice ??
        p?.invoice_number ??
        p?.invoiceNumber ??
        p?.invoice_seq ??
        p?.invoiceSeq ??
        p?.invoices?.invoice_number ??
        p?.invoices?.invoiceNumber ??
        p?.related_invoice?.invoice_number ??
        p?.relatedInvoice?.invoice_number ??
        null;

      if (v == null) return "-";
      var s = String(v).trim();
      return s.length ? s : "-";
    }

    function pickProcessCreatedAt(p) { return p?.created_on || p?.createdOn || p?.created_at || p?.createdAt || null; }
    function pickProcessUpdatedAt(p) { return p?.updated_on || p?.updatedOn || p?.updated_at || p?.updatedAt || p?.modified_at || p?.modifiedAt || p?.created_on || p?.createdOn || null; }

    function pickProcessDueAt(p) {
      return (
        p?.ship_date || p?.shipDate ||
        p?.due_at || p?.dueAt ||
        p?.deadline_at || p?.deadlineAt ||
        p?.due_date || p?.dueDate ||
        p?.expected_at || p?.expectedAt ||
        p?.eta_at || p?.etaAt ||
        null
      );
    }

    function pickProcessCompletedPercent(p) {
      var v =
        p?.completed ??
        p?.completed_percent ??
        p?.completedPercent ??
        p?.progress_percent ??
        p?.progressPercent ??
        p?.completion_percent ??
        p?.completionPercent ??
        null;

      if (v == null) return null;

      var n = toNumber(v);
      if (n > 0 && n <= 1) n = n * 100;
      n = Math.max(0, Math.min(100, n));
      return n;
    }

    // -------------------- BILLING dashboard --------------------
    var monthsPt = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    var lineChart = null;
    var doughnutChart = null;

    var allProcesses = [];
    var viewProcesses = [];
    var sortState = { key: "process_number", dir: "asc" };
    var pageSize = 10;
    var pageIndex = 0;

    function setSortIndicator() {
      $(".sortable .sort-indicator").text("");
      var th = $('.sortable[data-sort="' + sortState.key + '"]');
      th.find(".sort-indicator").text(sortState.dir === "asc" ? "▲" : "▼");
    }

    function applySort(items) {
      var key = sortState.key;
      var dir = sortState.dir === "asc" ? 1 : -1;

      function getValue(p) {
        if (key === "process_number") return String(pickProcessNumber(p) || "");
        if (key === "company") return String(pickProcessCompanyName(p) || "");
        if (key === "status") return String(getProcessStatusLabel(p) || "");
        if (key === "invoice") return String(pickProcessInvoice(p) || "");
        if (key === "completed") return pickProcessCompletedPercent(p) ?? -1;
        return "";
      }

      return items.slice().sort(function (a, b) {
        var av = getValue(a);
        var bv = getValue(b);

        if (typeof av === "number" && typeof bv === "number") return (av - bv) * dir;
        return String(av).localeCompare(String(bv), "pt-BR") * dir;
      });
    }

    function applyFilter(items) {
      var q = String($("#processSearch").val() || "").trim().toLowerCase();
      if (!q) return items;

      return items.filter(function (p) {
        var text = [
          pickProcessNumber(p),
          pickProcessCompanyName(p),
          getProcessStatusLabel(p),
          pickProcessInvoice(p)
        ].join(" ").toLowerCase();

        return text.includes(q);
      });
    }

    function renderProcessesTable() {
      var filtered = applyFilter(allProcesses);
      var sorted = applySort(filtered);
      viewProcesses = sorted;

      var total = viewProcesses.length;
      var start = pageIndex * pageSize;
      var end = Math.min(total, start + pageSize);
      var pageItems = viewProcesses.slice(start, end);

      $("#processesCount").text("Mostrando " + (total ? (start + 1) : 0) + "–" + end + " de " + total);

      var $tbody = $("#processesTbody");
      $tbody.empty();

      if (!pageItems.length) {
        $tbody.append('<tr><td colspan="6">Nenhum processo encontrado.</td></tr>');
        return;
      }

      pageItems.forEach(function (p) {
        var number = pickProcessNumber(p);
        var company = pickProcessCompanyName(p);

        var statusLabel = getProcessStatusLabel(p);
        var statusClass = getProcessStatusCssFull(p);

        var completed = pickProcessCompletedPercent(p);
        var completedNumber = completed == null ? 0 : completed;
        var pieValue = completed == null ? "0/100" : (completedNumber.toFixed(2) + "/100");

        var invoice = pickProcessInvoice(p);
        var pid = pickProcessId(p);

        var row = `
          <tr class="dash-clicker" onclick="${pid ? `redirectToProcessDetail('${String(pid).replace(/'/g, "\\'")}')` : ""}">
            <td class="truncate">${number}</td>
            <td class="truncate">${company}</td>
            <td>
              <span class="pie">${pieValue}</span>
              <span class="sr-only">${completed == null ? "-" : (completedNumber.toFixed(2) + "%")}</span>
            </td>
            <td><span class="${statusClass}">${statusLabel}</span></td>
            <td class="truncate">${invoice}</td>
            <td class="table-actions">
              ${pid ? `<a href="ProcessDetail?id=${encodeURIComponent(pid)}" title="Abrir"><i class="fa fa-external-link text-navy"></i></a>` : "-"}
            </td>
          </tr>
        `;
        $tbody.append(row);
      });

      applyPeity();
    }

    function renderNearDue(processesInSelectedYear) {
      var items = Array.isArray(processesInSelectedYear) ? processesInSelectedYear.slice() : [];
      items = items.filter(function (p) { return getProcessStatusValue(p) === 2; });

      items.sort(function (a, b) {
        var ad = new Date(pickProcessDueAt(a) || pickProcessUpdatedAt(a) || 0).getTime();
        var bd = new Date(pickProcessDueAt(b) || pickProcessUpdatedAt(b) || 0).getTime();
        return ad - bd;
      });

      items = items.slice(0, 2);

      var $wrap = $("#nearDueContainer");
      $wrap.empty();

      if (!items.length) {
        $wrap.append('<div class="ibox-content"><small>Nenhum processo próximo do prazo no período.</small></div>');
        return;
      }

      items.forEach(function (p) {
        var number = pickProcessNumber(p);
        var company = pickProcessCompanyName(p);
        var dueAt = pickProcessDueAt(p);
        var dueText = dueAt ? formatDatePtBr(dueAt) : "-";
        var statusLabel = getProcessStatusLabel(p);
        var cls = getProcessStatusCssFull(p);
        var pid = pickProcessId(p);

        var block = `
          <div class="ibox-content dash-clicker" ${pid ? `onclick="redirectToProcessDetail('${String(pid).replace(/'/g, "\\'")}')"` : ""}>
            <div class="row">
              <div class="col-5">
                <small class="stats-label">Processo</small>
                <h4 class="truncate">${number}</h4>
                <small class="truncate text-muted">${company}</small>
              </div>
              <div class="col-4">
                <small class="stats-label">Prazo</small>
                <h4>${dueText}</h4>
              </div>
              <div class="col-3">
                <small class="stats-label">Status</small>
                <h4><span class="${cls}">${statusLabel}</span></h4>
              </div>
            </div>
          </div>
        `;
        $wrap.append(block);
      });
    }

    function renderProcessStatusDoughnut(processesYear) {
      var $empty = $("#processStatusEmpty");
      var canvas = document.getElementById("processStatusChart");
      if (!canvas) return;

      var list = Array.isArray(processesYear) ? processesYear : [];

      if (!list.length) {
        if (doughnutChart) { doughnutChart.destroy(); doughnutChart = null; }
        $(canvas).hide();
        $empty.show();
        return;
      }

      $empty.hide();
      $(canvas).show();

      var counts = {};
      list.forEach(function (p) {
        var label = getProcessStatusLabel(p);
        if (!label || label === "-") label = "Sem status";
        counts[label] = (counts[label] || 0) + 1;
      });

      var labels = Object.keys(counts);
      var values = labels.map(function (k) { return counts[k]; });

      var palette = [
        "rgba(26,179,148,0.85)",
        "rgba(23,162,184,0.85)",
        "rgba(0,123,255,0.85)",
        "rgba(220,53,69,0.85)",
        "rgba(255,193,7,0.90)",
        "rgba(108,117,125,0.85)",
        "rgba(111,66,193,0.85)",
        "rgba(253,126,20,0.85)"
      ];

      var bg = labels.map(function (_, i) { return palette[i % palette.length]; });
      var border = labels.map(function (_, i) { return palette[i % palette.length].replace("0.85", "1").replace("0.90", "1"); });

      var ctx = canvas.getContext("2d");
      if (doughnutChart) doughnutChart.destroy();

      doughnutChart = new Chart(ctx, {
        type: "doughnut",
        data: { labels: labels, datasets: [{ data: values, backgroundColor: bg, borderColor: border, borderWidth: 1 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          legend: { display: true, position: "bottom" }
        }
      });
    }

    var INVOICE_STATUS = { rascunho: 0, ativo: 1, faturado: 3, pago: 4 };

    var now = new Date();
    var currentYear = now.getFullYear();
    var currentMonth = now.getMonth();
    var selectedYear = currentYear;

    $("#yearFilter").val(String(selectedYear));

    function computeRanges() {
      var yearStart = new Date(selectedYear, 0, 1, 0, 0, 0, 0);
      var yearEnd = new Date(selectedYear + 1, 0, 1, 0, 0, 0, 0);

      var monthStart = new Date(selectedYear, currentMonth, 1, 0, 0, 0, 0);
      var monthEnd = new Date(selectedYear, currentMonth + 1, 1, 0, 0, 0, 0);

      return { yearStart: yearStart, yearEnd: yearEnd, monthStart: monthStart, monthEnd: monthEnd };
    }

    function pickProcessDateForYearFilter(p) {
      return pickProcessCreatedAt(p) || pickProcessUpdatedAt(p) || null;
    }

async function loadBillingDashboard() {
    try {
      $("#lastUpdateAt").text(formatDateTimePtBr(new Date()));

      var ranges = computeRanges();
      var yearStart = ranges.yearStart;
      var yearEnd = ranges.yearEnd;
      var monthStart = ranges.monthStart;
      var monthEnd = ranges.monthEnd;

      var results = await Promise.all([
        fetchJson("/api/invoices?fields=summary"),
        fetchJson("/api/processes?fields=dashboard")
      ]);

      var invoicesResp = results[0];
      var processesResp = results[1];

      var invoicesRaw = normalizeArrayResponse(invoicesResp);

      var invoices = invoicesRaw.filter(function (inv) {
        var st = pickInvoiceStatus(inv);
        return st !== INVOICE_STATUS.faturado;
      });

      var totalsByMonthAll = new Array(12).fill(0);
      var activeByMonth = new Array(12).fill(0);
      var paidByMonth = new Array(12).fill(0);

      var monthSumAll = 0;
      var yearSumAll = 0;

      invoices.forEach(function (inv) {
        var dtRaw = pickInvoiceDate(inv);
        if (!dtRaw) return;

        var dt = new Date(dtRaw);
        if (Number.isNaN(dt.getTime())) return;

        var total = toNumber(pickInvoiceTotal(inv));
        var st = pickInvoiceStatus(inv);

        if (dt >= monthStart && dt < monthEnd) monthSumAll += total;

        if (dt >= yearStart && dt < yearEnd) {
          yearSumAll += total;

          var m = dt.getMonth();
          totalsByMonthAll[m] += total;

          if (st === INVOICE_STATUS.ativo) activeByMonth[m] += total;
          if (st === INVOICE_STATUS.pago) paidByMonth[m] += total;
        }
      });

      // Revenues
      $("#monthlyRevenue").text(moneyCurrencyPtBr(monthSumAll, "BRL"));
      $("#annualRevenue").text(moneyCurrencyPtBr(yearSumAll, "BRL"));

      // ✅ RESTORE DELTAS (avoid null/NaN)
      // If you had these numbers coming from DB/settings before, plug them here later.
      var estimatedMonthly = 30000;       // same as your old script
      var estimatedYear = 30000 * 12;

      var deltaMonth = estimatedMonthly > 0 ? ((monthSumAll / estimatedMonthly) * 100) : 0;
      var deltaYear = estimatedYear > 0 ? ((yearSumAll / estimatedYear) * 100) : 0;

      if (!Number.isFinite(deltaMonth)) deltaMonth = 0;
      if (!Number.isFinite(deltaYear)) deltaYear = 0;

      $("#monthlyDelta").text(deltaMonth.toFixed(0) + "%");
      $("#annualDelta").text(deltaYear.toFixed(0) + "%");

      // Avg / Best month
      var avgMonthly = yearSumAll / 12;
      $("#avgMonthlyRevenue").text(moneyCurrencyPtBr(avgMonthly, "BRL"));
      $("#avgMonthlyHint").text("Ano ÷ 12");

      var bestMonthIndex = 0;
      var bestMonthValue = totalsByMonthAll[0] || 0;
      for (var i = 1; i < 12; i++) {
        if ((totalsByMonthAll[i] || 0) > bestMonthValue) {
          bestMonthValue = totalsByMonthAll[i] || 0;
          bestMonthIndex = i;
        }
      }
      $("#bestMonthName").text(monthsPt[bestMonthIndex] || "-");
      $("#bestMonthRevenue").text(moneyCurrencyPtBr(bestMonthValue, "BRL"));

      // Chart (kept as your simplified version)
      var canvasLine = document.getElementById("lineChart");
      if (canvasLine) {
        var ctx = canvasLine.getContext("2d");
        if (lineChart) lineChart.destroy();

        lineChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: monthsPt,
            datasets: [
              { label: "Invoices ativas (status 1)", backgroundColor: "rgba(26,179,148,0.10)", borderColor: "rgba(26,179,148,1)", data: activeByMonth },
              { label: "Invoices pagas (status 4)", backgroundColor: "rgba(220,38,38,0.08)", borderColor: "rgba(220,38,38,1)", data: paidByMonth }
            ]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }

      $("#totalInvoicesInPeriod").text(String(invoices.filter(function (inv) {
        var dt = new Date(pickInvoiceDate(inv) || 0);
        return dt >= yearStart && dt < yearEnd;
      }).length));

      var processes = normalizeArrayResponse(processesResp);

      var processesYear = processes.filter(function (p) {
        var dtRaw = pickProcessDateForYearFilter(p);
        if (!dtRaw) return false;

        var dt = new Date(dtRaw);
        if (Number.isNaN(dt.getTime())) return false;

        return dt >= yearStart && dt < yearEnd;
      });

      $("#totalProcessesInPeriod").text(String(processesYear.length));

      renderNearDue(processesYear);
      renderProcessStatusDoughnut(processesYear);

      allProcesses = processes.slice();
      pageIndex = 0;
      setSortIndicator();
      renderProcessesTable();

    } catch (e) {
      console.error("Erro ao carregar dashboard faturamento:", e);
    }
  }

    // Billing UI events
    $(document).on("click", ".sortable", function () {
      var key = $(this).data("sort");
      if (!key) return;

      if (sortState.key === key) sortState.dir = (sortState.dir === "asc") ? "desc" : "asc";
      else {
        sortState.key = key;
        sortState.dir = (key === "completed") ? "desc" : "asc";
      }

      pageIndex = 0;
      setSortIndicator();
      renderProcessesTable();
    });

    $("#btnReloadProcesses").on("click", function () { loadBillingDashboard(); });
    $("#btnSearch").on("click", function () { pageIndex = 0; renderProcessesTable(); });

    $("#yearFilter").on("change", function () {
      var v = Number($(this).val());
      if (Number.isFinite(v)) selectedYear = v;
      loadBillingDashboard();
    });

    // -------------------- MY PROCESSES dashboard --------------------
    function pickCompanyId() {
      return (
        window.__auth?.company_id ||
        window.__auth?.companyId ||
        window.__auth?.company?.id ||
        window.__auth?.company?.company_id ||
        null
      );
    }

    function pickCompanyName() {
      return (
        window.__auth?.company_name ||
        window.__auth?.companyName ||
        window.__auth?.company?.company_name ||
        "-"
      );
    }

    function pickInvoiceCurrency(inv) {
      return inv?.currency_code || inv?.currency || inv?.currencyCode || null;
    }

    function escapeHtml(value) {
      if (value == null) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function isReadNotification(n) {
      if (n?.is_read === true) return true;
      if (n?.isRead === true) return true;
      if (n?.read_at || n?.readAt) return true;
      return false;
    }

    function renderDashboardNotifications(rows) {
      var $list = $("#notificationsList");
      if (!$list.length) return;

      var items = Array.isArray(rows) ? rows : [];
      if (!items.length) {
        $list.html('<div class="feed-element"><div class="media-body">Nenhuma notificação ativa.</div></div>');
        return;
      }

      $list.html(items.map(function (n) {
        var id = String(n?.id || "");
        var title = escapeHtml(String(n?.title || "Notificação"));
        var msg = escapeHtml(String(n?.message || "").trim() || "-");
        var when = escapeHtml(formatDateTimePtBr(n?.created_at || n?.createdAt || n?.starts_at || n?.startsAt));
        var readClass = isReadNotification(n) ? "is-read" : "";
        var href = id ? ("/NewNotification?id=" + encodeURIComponent(id)) : "/Notifications";
        return `
          <div class="feed-element ${readClass}">
            <div class="media-body">
              <strong>${title}</strong><br/>
              ${msg}<br/>
              <small class="dash-muted">${when}</small><br/>
              <a href="${href}" class="text-navy">Abrir</a>
            </div>
          </div>
        `;
      }).join(""));
    }

    function typeToMeta(type) {
      var t = Number(type ?? 0);
      switch (t) {
        case 8: return { icon: "fa fa-briefcase", label: "Informação", color: "#1ab394" };
        case 1: return { icon: "fa fa-file-text", label: "Documento", color: "#1c84c6" };
        case 2: return { icon: "fa fa-phone", label: "Reunião / Telefonema", color: "#f8ac59" };
        case 3: return { icon: "fa fa-coffee", label: "Reunião presencial / Café", color: "#23c6c8" };
        case 4: return { icon: "fa fa-plane", label: "Informação - Aérea", color: "#e1bb00" };
        case 5: return { icon: "fa fa-ship", label: "Informação - Marítimo", color: "#445fad" };
        case 6: return { icon: "fa fa-truck", label: "Informação - Terrestre", color: "#a17f72" };
        case 7: return { icon: "fa fa-check-circle-o", label: "Processo finalizado", color: "#dc3545" };
        case 9: return { icon: "fa fa-envelope-o", label: "Email", color: "#1c84c6" };
        default: return { icon: "fa fa-info-circle", label: "Evento", color: "#999" };
      }
    }

    function renderTimeline(events) {
      var wrap = document.getElementById("timelineContainer");
      var empty = document.getElementById("timelineEmpty");
      if (!wrap) return;

      wrap.innerHTML = "";

      var rows = Array.isArray(events) ? events : [];
      if (!rows.length) {
        if (empty) empty.textContent = "Nenhum evento encontrado para o processo ativo.";
        return;
      }

      if (empty) empty.style.display = "none";

      rows = rows.slice().sort(function (a, b) {
        return new Date(b?.start_time ?? 0) - new Date(a?.start_time ?? 0);
      });

      rows.forEach(function (ev) {
        var meta = typeToMeta(ev?.type);
        var title = escapeHtml(ev?.title || "Evento");
        var desc = escapeHtml(ev?.description || "");
        var when = ev?.start_time ? formatDateTimePtBr(ev.start_time) : "-";

        var item = document.createElement("div");
        item.className = "timeline-item";
        item.innerHTML = `
          <div class="row">
            <div class="col-3 date">
              <i class="${escapeHtml(meta.icon)}" style="color:${escapeHtml(meta.color)}"></i>
              <br/>
              <small class="text-navy">${escapeHtml(when)}</small>
            </div>
            <div class="col-9 content">
              <p class="m-b-xs"><strong>${title}</strong></p>
              ${desc ? `<p>${desc}</p>` : `<p class="dash-muted">Sem descrição</p>`}
              <span class="text-muted"><small>${escapeHtml(meta.label)}</small></span>
            </div>
          </div>
        `;
        wrap.appendChild(item);
      });
    }

    var lineChartCompany = null;

    function buildLineChartCompany(labels, values, currencyCode) {
      var el = document.getElementById("lineChartCompany");
      if (!el) return;

      var ctx = el.getContext("2d");
      if (lineChartCompany) { try { lineChartCompany.destroy(); } catch (e) { } }

      lineChartCompany = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Invoices",
            backgroundColor: "rgba(26,179,148,0.2)",
            borderColor: "rgba(26,179,148,0.8)",
            data: values
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    async function loadMyProcessesDashboard() {
      $("#companyNameText").text(pickCompanyName());

      var companyId = pickCompanyId();
      if (!companyId) {
        $("#timelineEmpty").text("Não foi possível identificar a empresa logada (company_id).");
        $("#top2ProcessesTbody").html("<tr><td colspan='3'>Empresa não identificada.</td></tr>");
        return;
      }

      try {
        window.GECOM?.spinner?.show("Carregando dashboard...");

        var [procRes, invRes] = await Promise.all([
          fetchJson("/api/processes?company_id=" + encodeURIComponent(String(companyId))),
          fetchJson("/api/invoices?fields=summary&company_id=" + encodeURIComponent(String(companyId)))
        ]);

        try {
          var notifRows = [];
          if (window.GECOM_NOTIFICATIONS?.fetchTopByCompany) {
            notifRows = await window.GECOM_NOTIFICATIONS.fetchTopByCompany();
          }
          renderDashboardNotifications(notifRows);
        } catch (notifErr) {
          console.error("Notifications dashboard error:", notifErr);
          renderDashboardNotifications([]);
        }

        var processes = normalizeArrayResponse(procRes);
        var invoices = normalizeArrayResponse(invRes);

        $("#kpiProcessCount").text(String(processes.length));
        $("#kpiClosedCount").text(String(processes.filter(function (p) { return Number(p?.status) === 4; }).length));

        var year = new Date().getFullYear();
        var totalYear = 0;
        var currencyCode = null;

        invoices.forEach(function (inv) {
          var dt = inv?.quote_at || inv?.created_at || inv?.createdAt || inv?.issued_at || inv?.issue_date || inv?.date || null;
          if (!dt) return;
          var d = new Date(dt);
          if (Number.isNaN(d.getTime())) return;
          if (d.getFullYear() !== year) return;

          totalYear += toNumber(inv?.total ?? inv?.total_value ?? inv?.total_amount ?? inv?.amount ?? inv?.grand_total ?? inv?.value ?? 0);
          if (!currencyCode) currencyCode = pickInvoiceCurrency(inv);
        });

        $("#kpiTotalYear").text(moneyPtBr(totalYear, currencyCode));
        $("#lineTotalYear").text(moneyPtBr(totalYear, currencyCode));
        $("#lastUpdateAtCompany").text(formatDateTimePtBr(new Date().toISOString()));

        var labels = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        var monthly = new Array(12).fill(0);

        invoices.forEach(function (inv) {
          var dt = inv?.quote_at || inv?.created_at || inv?.createdAt || inv?.issued_at || inv?.issue_date || inv?.date || null;
          if (!dt) return;
          var d = new Date(dt);
          if (Number.isNaN(d.getTime())) return;
          if (d.getFullYear() !== year) return;

          monthly[d.getMonth()] += toNumber(inv?.total ?? inv?.total_value ?? inv?.total_amount ?? inv?.amount ?? inv?.grand_total ?? inv?.value ?? 0);
        });

        buildLineChartCompany(labels, monthly, currencyCode);

        // Top 2
        var top2 = processes.slice().sort(function (a, b) {
          return new Date(pickProcessCreatedAt(b) ?? 0) - new Date(pickProcessCreatedAt(a) ?? 0);
        }).slice(0, 2);

        if (!top2.length) {
          $("#top2ProcessesTbody").html("<tr><td colspan='3'>Nenhum processo encontrado.</td></tr>");
        } else {
          $("#top2ProcessesTbody").html(top2.map(function (p) {
            var num = escapeHtml(pickProcessNumber(p));
            var stLabel = escapeHtml(getProcessStatusLabel(p));
            var stClass = escapeHtml(getProcessStatusCssFull(p));
            var created = escapeHtml(formatDateTimePtBr(pickProcessCreatedAt(p)));
            return `
              <tr style="cursor:pointer;" onclick="window.location='ProcessDetail?id=${encodeURIComponent(String(p?.id || ''))}'">
                <td><strong>${num}</strong></td>
                <td><span class="${stClass}">${stLabel}</span></td>
                <td>${created}</td>
              </tr>
            `;
          }).join(""));
        }

        // Timeline
        var active = processes
          .filter(function (p) { return Number(p?.status) === 0; })
          .sort(function (a, b) { return new Date(pickProcessCreatedAt(b) ?? 0) - new Date(pickProcessCreatedAt(a) ?? 0); })[0];

        if (!active?.id) {
          $("#timelineEmpty").text("Nenhum processo ativo (status 0) encontrado.");
          $("#timelineBadge").text("Sem processo ativo");
          return;
        }

        $("#timelineBadge").text("Processo ativo: " + (active?.process_number || active?.id));

        var detail = await fetchJson("/api/processes/" + encodeURIComponent(String(active.id)));
        var events = detail?.events || detail?.Events || detail?.eventos || [];
        renderTimeline(events);

      } catch (e) {
        console.error("DashboardCompany error:", e);
        $("#top2ProcessesTbody").html("<tr><td colspan='3'>Erro ao carregar.</td></tr>");
        $("#timelineEmpty").text(e?.message || "Erro ao carregar a timeline.");
      } finally {
        window.GECOM?.spinner?.hide();
      }
    }

    // -------------------- Init --------------------
    buildDashPicker();
    setSortIndicator();
    loadDashboard();
  });
</script>

