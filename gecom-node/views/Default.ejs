<style>
  .ibox-title { padding: 15px 60px 8px 15px; }

  .truncate {
    max-width: 280px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .table-actions a { margin-right: 8px; }
  .sortable { cursor: pointer; user-select: none; }
  .sort-indicator { margin-left: 6px; font-size: 11px; opacity: .75; }

  /* Chart */
  .dash-chart-wrap { height: 320px; }
  #lineChart { width: 100% !important; height: 100% !important; }

  /* Doughnut */
  .dash-doughnut-wrap {
    height: 320px;
    display: block;
    position: relative;
  }
  #processStatusChart {
    width: 100% !important;
    height: 320px !important;
    display: block;
  }

  .dash-empty-chart {
    height: 320px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
    font-size: 12px;
    text-align: center;
  }

  /* Cards clicáveis */
  .dash-clicker {
    padding: 5px 20px;
    cursor: pointer;
  }

  /* Lista */
  .dash-inprogress-list {
    max-height: 220px;
    overflow: auto;
  }

  /* Filter bar */
  .dash-filterbar {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
    margin-bottom: 15px;
  }
  .dash-filterbar label {
    margin: 0;
    font-weight: 600;
    font-size: 12px;
    color: #666;
  }
  .dash-filterbar .form-control {
    height: 30px;
    padding: 3px 10px;
  }
</style>

<div class="wrapper wrapper-content">

  <!-- FILTER BAR -->
  <div class="row">
    <div class="col-lg-9">
<div class="dash-filterbar" style="float: inline-start;">
        <label for="yearFilter"><%= t('page.layout.menu.dashboard') %>:</label>
        <select class="form-control input-sm" style="width: 250px;">
          <option value="0" selected><%= t('page.dashboard.pageTitle') %></option>
        </select>
      </div>
    </div>
    <div class="col-lg-3">
      <div class="dash-filterbar">
        <label for="yearFilter"><%= t('page.dashboard.filters.year') %></label>
        <select id="yearFilter" class="form-control input-sm" style="width: 120px;">
          <option value="2025">2025</option>
          <option value="2026">2026</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ROW 1: Cards + Processos próximos do prazo (top 2) -->
  <div class="row">
    <div class="col-lg-2">
      <div class="ibox">
        <div class="ibox-title">
          <span class="label label-success float-right"><%= t('page.dashboard.filters.monthly') %></span>
          <h5>Faturamento</h5>
        </div>
        <div class="ibox-content">
          <h1 id="monthlyRevenue" class="no-margins">-</h1>
          <div class="stat-percent font-bold text-success">
            <span id="monthlyDelta">-</span> <i class="fa fa-bolt"></i>
          </div>
          <small><%= t('page.dashboard.cards.monthBillingTitle') %></small>
        </div>
      </div>
    </div>

    <div class="col-lg-2">
      <div class="ibox">
        <div class="ibox-title">
          <span class="label label-info float-right"><%= t('page.dashboard.filters.annual') %></span>
          <h5>Faturamento</h5>
        </div>
        <div class="ibox-content">
          <h1 id="annualRevenue" class="no-margins">-</h1>
          <div class="stat-percent font-bold text-info">
            <span id="annualDelta">-</span> <i class="fa fa-level-up"></i>
          </div>
          <small><%= t('page.dashboard.cards.yearBillingTitle') %></small>
        </div>
      </div>
    </div>

    <!-- Média mensal -->
    <div class="col-lg-2">
      <div class="ibox">
        <div class="ibox-title">
          <span class="label label-primary float-right">Ano</span>
          <h5><%= t('page.dashboard.cards.monthlyAverageTitle') %></h5>
        </div>
        <div class="ibox-content">
          <h1 id="avgMonthlyRevenue" class="no-margins">-</h1>
          <div class="stat-percent font-bold text-navy">
            <span id="avgMonthlyHint">-</span> <i class="fa fa-line-chart"></i>
          </div>
          <small><%= t('page.dashboard.cards.monthlyAverageHelp') %></small>
        </div>
      </div>
    </div>

    <!-- Melhor mês -->
    <div class="col-lg-2">
      <div class="ibox">
        <div class="ibox-title">
          <span class="label label-warning float-right">Ano</span>
          <h5><%= t('page.dashboard.cards.bestMonthTitle') %></h5>
        </div>
        <div class="ibox-content">
          <h2 id="bestMonthName" class="no-margins">-</h2>
          <div class="stat-percent font-bold text-warning">
            <span id="bestMonthRevenue">-</span> <i class="fa fa-trophy"></i>
          </div>
          <small><%= t('page.dashboard.cards.bestMonthHelp') %></small>
        </div>
      </div>
    </div>

    <!-- Processos próximos do prazo (top 2) -->
    <div class="col-lg-4">
      <div class="ibox">
        <div class="ibox-title">
          <h5><%= t('page.dashboard.sections.nearDeadline') %></h5>
        </div>

        <div id="nearDueContainer" class="dash-inprogress-list">
          <div class="ibox-content"><small><%= t('page.dashboard.labels.loading') %></small></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ROW 2: Line (col-lg-8) + Doughnut (col-lg-4) -->
  <div class="row">
    <div class="col-lg-8">
      <div class="ibox">
        <div class="ibox-content">
          <div>
            <span class="float-right text-right">
              <small><%= t('page.dashboard.labels.totalInvoicesInPeriod') %> <strong id="totalInvoicesInPeriod">-</strong></small>
              <br />
              <small><%= t('page.dashboard.labels.totalProcessesInPeriod') %> <strong id="totalProcessesInPeriod">-</strong></small>
            </span>
            <h3 class="font-bold no-margins"><%= t('page.dashboard.sections.annualBilling') %></h3>
            <small><%= t('page.dashboard.labels.legend') %></small>
          </div>

          <div class="m-t-sm">
            <div class="dash-chart-wrap">
              <canvas id="lineChart"></canvas>
            </div>
          </div>

          <div class="m-t-md">
            <small class="float-right">
              <i class="fa fa-clock-o"></i>
              <%= t('page.dashboard.labels.updatedAt') %> <span id="lastUpdateAt">-</span>
            </small>
            <small>
              <strong><%= t('page.dashboard.labels.note') %></strong> <%= t('page.dashboard.labels.noteLine1') %>
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Doughnut: Processos por status -->
    <div class="col-lg-4">
      <div class="ibox">
        <div class="ibox-title">
          <h5><%= t('page.dashboard.sections.byStatus') %></h5>
        </div>
        <div class="ibox-content">
          <div class="dash-doughnut-wrap">
            <canvas id="processStatusChart"></canvas>
            <div id="processStatusEmpty" class="dash-empty-chart" style="display:none;">
              <%= t('page.dashboard.labels.emptyPeriod') %>
            </div>
          </div>
          <div class="text-center m-t-sm">
            <small><%= t('page.dashboard.labels.yearByStatus') %></small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ROW 3: Grid de Processos -->
  <div class="row">
    <div class="col-lg-12">
      <div class="ibox">
        <div class="ibox-title">
          <h5><%= t('page.dashboard.sections.processes') %></h5>
        </div>

        <div class="ibox-content">
          <div class="row">
            <div class="col-sm-9 m-b-xs">
              <div class="btn-group">
                <button id="btnReloadProcesses" class="btn btn-sm btn-white" type="button">
                  <i class="fa fa-refresh"></i> <%= t('page.dashboard.table.reload') %>
                </button>
              </div>
            </div>
            <div class="col-sm-3">
              <div class="input-group mb-3">
                <input id="processSearch" type="text" class="form-control form-control-sm" placeholder="<%= t('page.dashboard.table.search') %>">
                <div class="input-group-append">
                  <button id="btnSearch" class="btn btn-sm btn-primary" type="button"><%= t('page.dashboard.table.search') %></button>
                </div>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th class="sortable" data-sort="process_number"><%= t('page.dashboard.table.process') %> <span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort="company"><%= t('page.dashboard.table.company') %> <span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort="completed"><%= t('page.dashboard.table.completed') %> <span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort="status"><%= t('page.dashboard.table.status') %> <span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort="invoice"><%= t('page.dashboard.table.invoice') %> <span class="sort-indicator"></span></th>
                  <th><%= t('page.dashboard.table.action') %></th>
                </tr>
              </thead>
              <tbody id="processesTbody">
                <tr><td colspan="6"><%= t('page.dashboard.table.loading') %></td></tr>
              </tbody>
            </table>
          </div>

          <div class="row m-t-sm">
            <div class="col-sm-6">
              <small id="processesCount">-</small>
            </div>
            <div class="col-sm-6 text-right">
              <button id="prevPage" class="btn btn-sm btn-white" type="button"><%= t('page.dashboard.table.previous') %></button>
              <button id="nextPage" class="btn btn-sm btn-white" type="button"><%= t('page.dashboard.table.next') %></button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<% contentFor('scripts') %>
<script src="../Assets/inspinia/js/plugins/peity/jquery.peity.min.js"></script>
<script src="../Assets/inspinia/js/demo/peity-demo.js"></script>

<script src="../Assets/inspinia/js/inspinia.js"></script>
<script src="../Assets/inspinia/js/plugins/pace/pace.min.js"></script>
<script src="../Assets/inspinia/js/plugins/jquery-ui/jquery-ui.min.js"></script>

<script src="../Assets/inspinia/js/plugins/chartJs/Chart.min.js"></script>

<script>
  function redirectToProcessDetail(id) {
    if (!id) return;
    window.location = "ProcessDetail?id=" + encodeURIComponent(String(id));
  }

  $(document).ready(function () {
    $("#masterHeader").hide();

    // -------------------- Helpers --------------------
    function toNumber(value) {
      var n = Number(String(value ?? "").replace(",", "."));
      return Number.isFinite(n) ? n : 0;
    }

    function moneyCurrencyPtBr(value, currencyCode) {
      var n = toNumber(value);
      try {
        if (currencyCode) {
          return new Intl.NumberFormat("pt-BR", { style: "currency", currency: currencyCode }).format(n);
        }
      } catch (e) { }
      return new Intl.NumberFormat("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
    }

    function formatDateTimePtBr(value) {
      if (!value) return "-";
      var d = new Date(value);
      if (Number.isNaN(d.getTime())) return "-";
      return d.toLocaleString("pt-BR");
    }

    function formatDatePtBr(value) {
      if (!value) return "-";
      var d = new Date(value);
      if (Number.isNaN(d.getTime())) return "-";
      return d.toLocaleDateString("pt-BR");
    }

    function applyPeity() {
      try { $(".pie").peity("pie"); } catch (e) { }
    }

    function pickInvoiceDate(inv) {
      return inv?.quote_at || inv?.created_at || null;
    }

    function pickInvoiceTotal(inv) {
      return inv?.total ?? 0;
    }

    function pickInvoiceStatus(inv) {
      var s = inv?.status ?? inv?.invoice_status ?? inv?.invoiceStatus ?? inv?.state ?? inv?.statecode ?? null;
      if (s == null) return null;
      var n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    // -------- Process Status (usa window.ProcessStatusEnum) --------
    function getProcessStatusValue(p) {
      var v = p?.status;
      var n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function getProcessStatusLabel(p) {
      var v = getProcessStatusValue(p);
      if (v == null) return "-";
      if (window.ProcessStatusEnum?.getLabel) return window.ProcessStatusEnum.getLabel(v);
      return "Status " + v;
    }

    function getProcessStatusCssFull(p) {
      var v = getProcessStatusValue(p);

      var cssClass = "label-default";
      if (v != null && window.ProcessStatusEnum?.getCssClass) {
        cssClass = window.ProcessStatusEnum.getCssClass(v) || "label-default";
      }

      return "label " + cssClass;
    }

    function pickProcessNumber(p) {
      return p?.process_number || p?.processNumber || p?.number || p?.code || p?.id || "-";
    }

    function pickProcessCompanyName(p) {
      return p?.companies?.company_name || p?.company?.company_name || p?.company_name || p?.companyName || "-";
    }

    function pickProcessId(p) {
      return p?.id || p?.process_id || p?.processId || null;
    }

    function pickProcessInvoice(p) {
      var v =
        p?.invoice ??
        p?.invoice_number ??
        p?.invoiceNumber ??
        p?.invoice_seq ??
        p?.invoiceSeq ??
        p?.invoices?.invoice_number ??
        p?.invoices?.invoiceNumber ??
        p?.related_invoice?.invoice_number ??
        p?.relatedInvoice?.invoice_number ??
        null;

      if (v == null) return "-";
      var s = String(v).trim();
      return s.length ? s : "-";
    }

    function pickProcessCreatedAt(p) {
      return p?.created_on || p?.createdOn || p?.created_at || p?.createdAt || null;
    }

    function pickProcessUpdatedAt(p) {
      return p?.updated_on || p?.updatedOn || p?.updated_at || p?.updatedAt || p?.modified_at || p?.modifiedAt || p?.created_on || p?.createdOn || null;
    }

    // Used for "Próximo do prazo" ordering (best effort)
    function pickProcessDueAt(p) {
      return (
        p?.ship_date || p?.shipDate ||
        p?.due_at || p?.dueAt ||
        p?.deadline_at || p?.deadlineAt ||
        p?.due_date || p?.dueDate ||
        p?.expected_at || p?.expectedAt ||
        p?.eta_at || p?.etaAt ||
        null
      );
    }

    function pickProcessCompletedPercent(p) {
      var v =
        p?.completed ??
        p?.completed_percent ??
        p?.completedPercent ??
        p?.progress_percent ??
        p?.progressPercent ??
        p?.completion_percent ??
        p?.completionPercent ??
        null;

      if (v == null) return null;

      var n = toNumber(v);
      if (n > 0 && n <= 1) n = n * 100;
      n = Math.max(0, Math.min(100, n));
      return n;
    }

    async function fetchJson(url) {
      var res = await fetch(url, { headers: { "Accept": "application/json" } });
      var data = await res.json().catch(function () { return {}; });
      if (!res.ok) throw new Error(data?.message || ("HTTP " + res.status));
      return data;
    }

    // -------------------- Time/Filters --------------------
    var now = new Date();
    var currentYear = now.getFullYear();
    var currentMonth = now.getMonth();
    var selectedYear = currentYear;

    $("#yearFilter").val(String(selectedYear));

    function computeRanges() {
      var yearStart = new Date(selectedYear, 0, 1, 0, 0, 0, 0);
      var yearEnd = new Date(selectedYear + 1, 0, 1, 0, 0, 0, 0);

      var monthStart = new Date(selectedYear, currentMonth, 1, 0, 0, 0, 0);
      var monthEnd = new Date(selectedYear, currentMonth + 1, 1, 0, 0, 0, 0);

      return { yearStart: yearStart, yearEnd: yearEnd, monthStart: monthStart, monthEnd: monthEnd };
    }

    var monthsPt = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];

    var lineChart = null;
    var doughnutChart = null;

    // -------------------- Grid state --------------------
    var allProcesses = [];
    var viewProcesses = [];
    var sortState = { key: "process_number", dir: "asc" };
    var pageSize = 10;
    var pageIndex = 0;

    function setSortIndicator() {
      $(".sortable .sort-indicator").text("");
      var th = $('.sortable[data-sort="' + sortState.key + '"]');
      th.find(".sort-indicator").text(sortState.dir === "asc" ? "▲" : "▼");
    }

    function applySort(items) {
      var key = sortState.key;
      var dir = sortState.dir === "asc" ? 1 : -1;

      function getValue(p) {
        if (key === "process_number") return String(pickProcessNumber(p) || "");
        if (key === "company") return String(pickProcessCompanyName(p) || "");
        if (key === "status") return String(getProcessStatusLabel(p) || "");
        if (key === "invoice") return String(pickProcessInvoice(p) || "");
        if (key === "completed") return pickProcessCompletedPercent(p) ?? -1;
        return "";
      }

      return items.slice().sort(function (a, b) {
        var av = getValue(a);
        var bv = getValue(b);

        if (typeof av === "number" && typeof bv === "number") return (av - bv) * dir;
        return String(av).localeCompare(String(bv), "pt-BR") * dir;
      });
    }

    function applyFilter(items) {
      var q = String($("#processSearch").val() || "").trim().toLowerCase();
      if (!q) return items;

      return items.filter(function (p) {
        var text = [
          pickProcessNumber(p),
          pickProcessCompanyName(p),
          getProcessStatusLabel(p),
          pickProcessInvoice(p)
        ].join(" ").toLowerCase();

        return text.includes(q);
      });
    }

    function renderProcessesTable() {
      var filtered = applyFilter(allProcesses);
      var sorted = applySort(filtered);
      viewProcesses = sorted;

      var total = viewProcesses.length;
      var start = pageIndex * pageSize;
      var end = Math.min(total, start + pageSize);
      var pageItems = viewProcesses.slice(start, end);

      $("#processesCount").text("Mostrando " + (total ? (start + 1) : 0) + "–" + end + " de " + total);

      var $tbody = $("#processesTbody");
      $tbody.empty();

      if (!pageItems.length) {
        $tbody.append('<tr><td colspan="6">Nenhum processo encontrado.</td></tr>');
        return;
      }

      pageItems.forEach(function (p) {
        var number = pickProcessNumber(p);
        var company = pickProcessCompanyName(p);

        var statusLabel = getProcessStatusLabel(p);
        var statusClass = getProcessStatusCssFull(p);

        var completed = pickProcessCompletedPercent(p);
        var completedNumber = completed == null ? 0 : completed;
        var pieValue = completed == null ? "0/100" : (completedNumber.toFixed(2) + "/100");

        var invoice = pickProcessInvoice(p);
        var pid = pickProcessId(p);

        var row = `
          <tr class="dash-clicker" onclick="${pid ? `redirectToProcessDetail('${String(pid).replace(/'/g, "\\'")}')` : ""}">
            <td class="truncate">${number}</td>
            <td class="truncate">${company}</td>
            <td>
              <span class="pie">${pieValue}</span>
              <span class="sr-only">${completed == null ? "-" : (completedNumber.toFixed(2) + "%")}</span>
            </td>
            <td><span class="${statusClass}">${statusLabel}</span></td>
            <td class="truncate">${invoice}</td>
            <td class="table-actions">
              ${pid ? `<a href="ProcessDetail?id=${encodeURIComponent(pid)}" title="Abrir"><i class="fa fa-external-link text-navy"></i></a>` : "-"}
            </td>
          </tr>
        `;
        $tbody.append(row);
      });

      applyPeity();
    }

    // TOP 2 - Próximo do prazo (status 2)
    function renderNearDue(processesInSelectedYear) {
      var items = Array.isArray(processesInSelectedYear) ? processesInSelectedYear.slice() : [];

      items = items.filter(function (p) {
        var v = getProcessStatusValue(p);
        return v === 2;
      });

      items.sort(function (a, b) {
        var ad = new Date(pickProcessDueAt(a) || pickProcessUpdatedAt(a) || 0).getTime();
        var bd = new Date(pickProcessDueAt(b) || pickProcessUpdatedAt(b) || 0).getTime();
        return ad - bd;
      });

      items = items.slice(0, 2);

      var $wrap = $("#nearDueContainer");
      $wrap.empty();

      if (!items.length) {
        $wrap.append('<div class="ibox-content"><small>Nenhum processo próximo do prazo no período.</small></div>');
        return;
      }

      items.forEach(function (p) {
        var number = pickProcessNumber(p);
        var company = pickProcessCompanyName(p);

        var dueAt = pickProcessDueAt(p);
        var dueText = dueAt ? formatDatePtBr(dueAt) : "-";

        var statusLabel = getProcessStatusLabel(p);
        var cls = getProcessStatusCssFull(p);

        var pid = pickProcessId(p);

        var block = `
          <div class="ibox-content dash-clicker" ${pid ? `onclick="redirectToProcessDetail('${String(pid).replace(/'/g, "\\'")}')"` : ""}>
            <div class="row">
              <div class="col-5">
                <small class="stats-label">Processo</small>
                <h4 class="truncate">${number}</h4>
                <small class="truncate text-muted">${company}</small>
              </div>
              <div class="col-4">
                <small class="stats-label">Prazo</small>
                <h4>${dueText}</h4>
              </div>
              <div class="col-3">
                <small class="stats-label">Status</small>
                <h4><span class="${cls}">${statusLabel}</span></h4>
              </div>
            </div>
          </div>
        `;
        $wrap.append(block);
      });
    }

    function pickProcessDateForYearFilter(p) {
      return pickProcessCreatedAt(p) || pickProcessUpdatedAt(p) || null;
    }

    function renderProcessStatusDoughnut(processesYear) {
      var $empty = $("#processStatusEmpty");
      var canvas = document.getElementById("processStatusChart");
      if (!canvas) return;

      var list = Array.isArray(processesYear) ? processesYear : [];

      if (!list.length) {
        if (doughnutChart) { doughnutChart.destroy(); doughnutChart = null; }
        $(canvas).hide();
        $empty.show();
        return;
      }

      $empty.hide();
      $(canvas).show();

      var counts = {};
      list.forEach(function (p) {
        var label = getProcessStatusLabel(p);
        if (!label || label === "-") label = "Sem status";
        counts[label] = (counts[label] || 0) + 1;
      });

      var labels = Object.keys(counts);
      var values = labels.map(function (k) { return counts[k]; });

      var palette = [
        "rgba(26,179,148,0.85)",
        "rgba(23,162,184,0.85)",
        "rgba(0,123,255,0.85)",
        "rgba(220,53,69,0.85)",
        "rgba(255,193,7,0.90)",
        "rgba(108,117,125,0.85)",
        "rgba(111,66,193,0.85)",
        "rgba(253,126,20,0.85)"
      ];

      var bg = labels.map(function (_, i) { return palette[i % palette.length]; });
      var border = labels.map(function (_, i) { return palette[i % palette.length].replace("0.85", "1").replace("0.90", "1"); });

      var ctx = canvas.getContext("2d");
      if (doughnutChart) doughnutChart.destroy();

      doughnutChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: bg,
            borderColor: border,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          legend: { display: true, position: "bottom" },
          tooltips: {
            callbacks: {
              label: function (tooltipItem, data) {
                var label = data.labels[tooltipItem.index] || "";
                var value = data.datasets[0].data[tooltipItem.index] || 0;
                return label + ": " + value;
              }
            }
          }
        }
      });
    }

    var INVOICE_STATUS = {
      rascunho: 0,
      ativo: 1,
      faturado: 3,
      pago: 4
    };

    async function loadDashboard() {
      try {
        $("#lastUpdateAt").text(formatDateTimePtBr(new Date()));

        var ranges = computeRanges();
        var yearStart = ranges.yearStart;
        var yearEnd = ranges.yearEnd;
        var monthStart = ranges.monthStart;
        var monthEnd = ranges.monthEnd;

        // ✅ Load invoices + processes in parallel
        var results = await Promise.all([
          fetchJson("/api/invoices?fields=summary"),
          fetchJson("/api/processes?fields=dashboard")
        ]);

        var invoicesResp = results[0];
        var processesResp = results[1];

        // --------- INVOICES ---------
        var invoicesRaw = Array.isArray(invoicesResp) ? invoicesResp : (invoicesResp?.data || invoicesResp?.items || []);

        // Filter out "faturado"
        var invoices = invoicesRaw.filter(function (inv) {
          var st = pickInvoiceStatus(inv);
          return st !== INVOICE_STATUS.faturado;
        });

        // Single pass: month/year arrays + sums + monthly buckets
        var invoicesMonth = [];
        var invoicesYear = [];

        var totalsByMonthAll = new Array(12).fill(0);
        var activeByMonth = new Array(12).fill(0);
        var paidByMonth = new Array(12).fill(0);

        var monthSumAll = 0;
        var yearSumAll = 0;

        invoices.forEach(function (inv) {
          var dtRaw = pickInvoiceDate(inv);
          if (!dtRaw) return;

          var dt = new Date(dtRaw);
          if (Number.isNaN(dt.getTime())) return;

          var total = toNumber(pickInvoiceTotal(inv));
          var st = pickInvoiceStatus(inv);

          // month
          if (dt >= monthStart && dt < monthEnd) {
            invoicesMonth.push(inv);
            monthSumAll += total;
          }

          // year
          if (dt >= yearStart && dt < yearEnd) {
            invoicesYear.push(inv);
            yearSumAll += total;

            var m = dt.getMonth();
            totalsByMonthAll[m] += total;

            if (st === INVOICE_STATUS.ativo) activeByMonth[m] += total;
            if (st === INVOICE_STATUS.pago) paidByMonth[m] += total;
          }
        });

        $("#monthlyRevenue").text(moneyCurrencyPtBr(monthSumAll, "BRL"));
        $("#annualRevenue").text(moneyCurrencyPtBr(yearSumAll, "BRL"));

        var estimatedMonthly = 30000;
        var estimatedYear = 30000 * 12;

        var deltaMonth = estimatedMonthly > 0 ? ((monthSumAll / estimatedMonthly) * 100) : 0;
        $("#monthlyDelta").text((deltaMonth || 0).toFixed(0) + "%");

        var deltaYear = estimatedYear > 0 ? ((yearSumAll / estimatedYear) * 100) : 0;
        $("#annualDelta").text((deltaYear || 0).toFixed(0) + "%");

        var avgMonthly = yearSumAll / 12;
        $("#avgMonthlyRevenue").text(moneyCurrencyPtBr(avgMonthly, "BRL"));
        $("#avgMonthlyHint").text("Ano ÷ 12");

        // Best month
        var bestMonthIndex = 0;
        var bestMonthValue = totalsByMonthAll[0] || 0;
        for (var i = 1; i < 12; i++) {
          if ((totalsByMonthAll[i] || 0) > bestMonthValue) {
            bestMonthValue = totalsByMonthAll[i] || 0;
            bestMonthIndex = i;
          }
        }

        $("#bestMonthName").text(monthsPt[bestMonthIndex] || "-");
        $("#bestMonthRevenue").text(moneyCurrencyPtBr(bestMonthValue, "BRL"));

        // Chart
        var estimatedByMonth = new Array(12).fill(30000);

        var lineData = {
          labels: monthsPt,
          datasets: [
            {
              label: "Estimado (30.000/mês)",
              backgroundColor: "rgba(220,220,220,0.10)",
              borderColor: "rgba(170,170,170,1)",
              pointBackgroundColor: "rgba(170,170,170,1)",
              pointBorderColor: "#fff",
              data: estimatedByMonth
            },
            {
              label: "Invoices ativas (status 1)",
              backgroundColor: "rgba(26,179,148,0.10)",
              borderColor: "rgba(26,179,148,1)",
              pointBackgroundColor: "rgba(26,179,148,1)",
              pointBorderColor: "#fff",
              data: activeByMonth
            },
            {
              label: "Invoices pagas (status 4)",
              backgroundColor: "rgba(220,38,38,0.08)",
              borderColor: "rgba(220,38,38,1)",
              pointBackgroundColor: "rgba(220,38,38,1)",
              pointBorderColor: "#fff",
              data: paidByMonth
            }
          ]
        };

        var lineOptions = {
          responsive: true,
          maintainAspectRatio: false,
          tooltips: {
            enabled: true,
            callbacks: {
              label: function (tooltipItem, data) {
                var dsLabel = data?.datasets?.[tooltipItem.datasetIndex]?.label || "";
                return dsLabel + ": " + moneyCurrencyPtBr(tooltipItem.yLabel, "BRL");
              }
            }
          },
          scales: {
            yAxes: [{
              ticks: {
                beginAtZero: true,
                stepSize: 10000,
                callback: function (value) {
                  try { return new Intl.NumberFormat("pt-BR", { maximumFractionDigits: 0 }).format(value); }
                  catch (e) { return String(value); }
                }
              }
            }]
          }
        };

        var canvasLine = document.getElementById("lineChart");
        if (canvasLine) {
          var ctx = canvasLine.getContext("2d");
          if (lineChart) lineChart.destroy();
          lineChart = new Chart(ctx, { type: "line", data: lineData, options: lineOptions });
        }

        $("#totalInvoicesInPeriod").text(String(invoicesYear.length));

        // --------- PROCESSES ---------
        var processes = Array.isArray(processesResp) ? processesResp : (processesResp?.data || processesResp?.items || []);

        var processesYear = processes.filter(function (p) {
          var dtRaw = pickProcessDateForYearFilter(p);
          if (!dtRaw) return false;

          var dt = new Date(dtRaw);
          if (Number.isNaN(dt.getTime())) return false;

          return dt >= yearStart && dt < yearEnd;
        });

        $("#totalProcessesInPeriod").text(String(processesYear.length));

        renderNearDue(processesYear);
        renderProcessStatusDoughnut(processesYear);

        allProcesses = processes.slice();
        pageIndex = 0;
        setSortIndicator();
        renderProcessesTable();

      } catch (e) {
        console.error("Erro ao carregar dashboard:", e);
        $("#monthlyRevenue").text("Erro");
        $("#annualRevenue").text("Erro");
        $("#avgMonthlyRevenue").text("Erro");
        $("#bestMonthName").text("-");
        $("#bestMonthRevenue").text("Erro");
        $("#processesTbody").html('<tr><td colspan="6">Erro ao carregar dados.</td></tr>');
        $("#nearDueContainer").html('<div class="ibox-content"><small>Erro ao carregar processos.</small></div>');
      }
    }

    // -------------------- UI events --------------------
    $(document).on("click", ".sortable", function () {
      var key = $(this).data("sort");
      if (!key) return;

      if (sortState.key === key) {
        sortState.dir = (sortState.dir === "asc") ? "desc" : "asc";
      } else {
        sortState.key = key;
        sortState.dir = (key === "completed") ? "desc" : "asc";
      }

      pageIndex = 0;
      setSortIndicator();
      renderProcessesTable();
    });

    $("#btnReloadProcesses").on("click", function () { loadDashboard(); });

    $("#btnSearch").on("click", function () {
      pageIndex = 0;
      renderProcessesTable();
    });

    $("#processSearch").on("keyup", function (e) {
      if (e.key === "Enter") {
        pageIndex = 0;
        renderProcessesTable();
      }
    });

    $("#prevPage").on("click", function () {
      if (pageIndex > 0) pageIndex--;
      renderProcessesTable();
    });

    $("#nextPage").on("click", function () {
      var total = viewProcesses.length;
      var maxPage = Math.max(0, Math.ceil(total / pageSize) - 1);
      if (pageIndex < maxPage) pageIndex++;
      renderProcessesTable();
    });

    $("#yearFilter").on("change", function () {
      var v = Number($(this).val());
      if (Number.isFinite(v)) selectedYear = v;
      loadDashboard();
    });

    setSortIndicator();
    loadDashboard();
  });
</script>
