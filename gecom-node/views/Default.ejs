<style>
  .ibox-title { padding: 15px 60px 8px 15px; }

  .truncate {
    max-width: 280px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .table-actions a { margin-right: 8px; }
  .sortable { cursor: pointer; user-select: none; }
  .sort-indicator { margin-left: 6px; font-size: 11px; opacity: .75; }

  /* Chart maior */
  .dash-chart-wrap { height: 320px; }
  #lineChart { width: 100% !important; height: 100% !important; }

  /* Cards em andamento clicáveis */
  .dash-clicker { cursor: pointer; }

  /* Lista top 5 */
  .dash-inprogress-list {
    max-height: 220px;
    overflow: auto;
  }
</style>

<div class="wrapper wrapper-content">
  <!-- ROW 1: Cards + Processos em andamento (top 5) -->
  <div class="row">
    <div class="col-lg-2">
      <div class="ibox">
        <div class="ibox-title">
          <span id="lblMonthly" class="label label-success float-right">Monthly</span>
          <h5>Faturamento</h5>
        </div>
        <div class="ibox-content">
          <h1 id="monthlyRevenue" class="no-margins">-</h1>
          <div class="stat-percent font-bold text-success">
            <span id="monthlyDelta">-</span> <i class="fa fa-bolt"></i>
          </div>
          <small>Faturamento no mês</small>
        </div>
      </div>
    </div>

    <div class="col-lg-2">
      <div class="ibox">
        <div class="ibox-title">
          <span id="lblAnnual" class="label label-info float-right">Annual</span>
          <h5>Faturamento</h5>
        </div>
        <div class="ibox-content">
          <h1 id="annualRevenue" class="no-margins">-</h1>
          <div class="stat-percent font-bold text-info">
            <span id="annualDelta">-</span> <i class="fa fa-level-up"></i>
          </div>
          <small>Faturamento no ano</small>
        </div>
      </div>
    </div>

    <!-- Visitas ao site (fixo) -->
    <div class="col-lg-4">
      <div class="ibox">
        <div class="ibox-title">
          <span class="label label-primary float-right">Today</span>
          <h5>Visitas ao site</h5>
        </div>
        <div class="ibox-content">
          <div class="row">
            <div class="col-md-6">
              <h1 class="no-margins">406,42</h1>
              <div class="font-bold text-navy">44% <i class="fa fa-level-up"></i><small>Rapid pace</small></div>
            </div>
            <div class="col-md-6">
              <h1 class="no-margins">206,12</h1>
              <div class="font-bold text-navy">22% <i class="fa fa-level-up"></i><small>Slow pace</small></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Processos em andamento (top 5) -->
    <div class="col-lg-4">
      <div class="ibox">
        <div class="ibox-title">
          <h5>Processos em andamento</h5>
        </div>

        <div id="inProgressContainer" class="dash-inprogress-list">
          <div class="ibox-content"><small>Carregando...</small></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ROW 2: Gráfico principal -->
  <div class="row">
    <div class="col-lg-12">
      <div class="ibox">
        <div class="ibox-content">
          <div>
            <span class="float-right text-right">
              <small>Total de invoices no período: <strong id="totalInvoicesInPeriod">-</strong></small>
              <br />
              <small>Total de processos no período: <strong id="totalProcessesInPeriod">-</strong></small>
            </span>
            <h3 class="font-bold no-margins">Faturamento Anual</h3>
            <small>Ativos (status 0) / Pagos (status 4) / Estimado (30k/mês).</small>
          </div>

          <div class="m-t-sm">
            <div class="row">
              <div class="col-md-9">
                <div class="dash-chart-wrap">
                  <canvas id="lineChart"></canvas>
                </div>
              </div>
              <div class="col-md-3">
                <ul class="stat-list m-t-lg">
                  <li>
                    <h2 id="yearRevenueTotal" class="no-margins">-</h2>
                    <small>Total (todas invoices) no período</small>
                    <div class="progress progress-mini">
                      <div id="yearRevenueProgress" class="progress-bar" style="width: 0%;"></div>
                    </div>
                  </li>
                  <li>
                    <h2 id="yearEstimatedTotal" class="no-margins">-</h2>
                    <small>Total estimado no período (30k/mês)</small>
                    <div class="progress progress-mini">
                      <div id="yearEstimatedProgress" class="progress-bar" style="width: 0%;"></div>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="m-t-md">
            <small class="float-right">
              <i class="fa fa-clock-o"></i>
              Update em <span id="lastUpdateAt">-</span>
            </small>
            <small>
              <strong>Obs:</strong> Ideal ter endpoints agregados no backend (sum/group-by) quando crescer.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ROW 3: Grid de Processos -->
  <div class="row">
    <div class="col-lg-12">
      <div class="ibox">
        <div class="ibox-title">
          <h5>Processos</h5>
        </div>

        <div class="ibox-content">
          <div class="row">
            <div class="col-sm-9 m-b-xs">
              <div class="btn-group">
                <button id="btnReloadProcesses" class="btn btn-sm btn-white" type="button">
                  <i class="fa fa-refresh"></i> Recarregar
                </button>
              </div>
            </div>
            <div class="col-sm-3">
              <div class="input-group mb-3">
                <input id="processSearch" type="text" class="form-control form-control-sm" placeholder="Search">
                <div class="input-group-append">
                  <button id="btnSearch" class="btn btn-sm btn-primary" type="button">Search</button>
                </div>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th class="sortable" data-sort="process_number">Processo <span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort="company">Empresa <span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort="completed">Completed <span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort="status">Status <span class="sort-indicator"></span></th>
                  <th class="sortable" data-sort="invoice">Invoice <span class="sort-indicator"></span></th>
                  <th>Ação</th>
                </tr>
              </thead>
              <tbody id="processesTbody">
                <tr><td colspan="6">Carregando...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="row m-t-sm">
            <div class="col-sm-6">
              <small id="processesCount">-</small>
            </div>
            <div class="col-sm-6 text-right">
              <button id="prevPage" class="btn btn-sm btn-white" type="button">Anterior</button>
              <button id="nextPage" class="btn btn-sm btn-white" type="button">Próximo</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<% contentFor('scripts') %>
<!-- Peity -->
<script src="../Assets/inspinia/js/plugins/peity/jquery.peity.min.js"></script>
<script src="../Assets/inspinia/js/demo/peity-demo.js"></script>

<script src="../Assets/inspinia/js/inspinia.js"></script>
<script src="../Assets/inspinia/js/plugins/pace/pace.min.js"></script>
<script src="../Assets/inspinia/js/plugins/jquery-ui/jquery-ui.min.js"></script>

<script src="../Assets/inspinia/js/plugins/chartJs/Chart.min.js"></script>

<script>
  // redirect global (pra onclick no html)
  function redirectToProcessDetail(id) {
    if (!id) return;
    window.location = "ProcessDetail?id=" + encodeURIComponent(String(id));
  }

  $(document).ready(function () {
    $("#pageName").text("Home");
    $("#subpageName").text("Home");

    // -------------------- Helpers --------------------
    function toNumber(value) {
      var n = Number(String(value ?? "").replace(",", "."));
      return Number.isFinite(n) ? n : 0;
    }

    function moneyCurrencyPtBr(value, currencyCode) {
      var n = toNumber(value);
      try {
        if (currencyCode) {
          return new Intl.NumberFormat("pt-BR", { style: "currency", currency: currencyCode }).format(n);
        }
      } catch (e) { }
      return new Intl.NumberFormat("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
    }

    function formatDateTimePtBr(value) {
      if (!value) return "-";
      var d = new Date(value);
      if (Number.isNaN(d.getTime())) return "-";
      return d.toLocaleString("pt-BR");
    }

    function applyPeity() {
      try { $(".pie").peity("pie"); } catch (e) { /* ignore */ }
    }

    function pickInvoiceDate(inv) {
      return inv?.quote_at || inv?.quoteAt || inv?.created_at || inv?.createdAt || null;
    }

    function pickInvoiceTotal(inv) {
      return (
        inv?.total ??
        inv?.total_amount ??
        inv?.amount_total ??
        inv?.grand_total ??
        inv?.total_value ??
        inv?.value ??
        0
      );
    }

    function pickInvoiceStatus(inv) {
      // tenta achar status em campos comuns
      var s = inv?.status ?? inv?.invoice_status ?? inv?.invoiceStatus ?? inv?.state ?? inv?.statecode ?? null;
      var n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    // Status do processo
    function normalizeProcessStatus(p) {
      var text = p?.status_name || p?.statusName || p?.status_text || p?.statusText || null;
      if (text && String(text).trim().length > 0) return String(text);

      var s = p?.status;
      var sn = Number(s);
      if (!Number.isFinite(sn)) return "-";

      if (sn === 0) return "No Prazo";
      if (sn === 1) return "Próximo do prazo";
      if (sn === 2) return "Atrasado";
      if (sn === 3) return "Encerrado";
      if (sn === 4) return "Cancelado";
      return String(sn);
    }

    function statusClassFromLabel(label) {
      var s = String(label || "").toLowerCase();
      if (s.includes("no prazo")) return "label label-success";
      if (s.includes("próximo")) return "label label-warning";
      if (s.includes("atras")) return "label label-error";
      if (s.includes("encerr")) return "label label-danger";
      if (s.includes("cancel")) return "label label-error";
      return "label label-primary";
    }

    function pickProcessNumber(p) {
      return p?.process_number || p?.processNumber || p?.number || p?.code || p?.id || "-";
    }

    function pickProcessCompanyName(p) {
      return p?.companies?.company_name || p?.company?.company_name || p?.company_name || p?.companyName || "-";
    }

    function pickProcessId(p) {
      return p?.id || p?.process_id || p?.processId || null;
    }

    function pickProcessInvoice(p) {
      var v =
        p?.invoice ??
        p?.invoice_number ??
        p?.invoiceNumber ??
        p?.invoice_seq ??
        p?.invoiceSeq ??
        p?.invoices?.invoice_number ??
        p?.invoices?.invoiceNumber ??
        p?.related_invoice?.invoice_number ??
        p?.relatedInvoice?.invoice_number ??
        null;

      if (v == null) return "-";
      var s = String(v).trim();
      return s.length ? s : "-";
    }

    function pickProcessCreatedAt(p) {
      return p?.created_at || p?.createdAt || null;
    }

    function pickProcessUpdatedAt(p) {
      return p?.updated_at || p?.updatedAt || p?.modified_at || p?.modifiedAt || p?.created_at || p?.createdAt || null;
    }

    function pickProcessCompletedPercent(p) {
      var v =
        p?.completed ??
        p?.completed_percent ??
        p?.completedPercent ??
        p?.progress_percent ??
        p?.progressPercent ??
        p?.completion_percent ??
        p?.completionPercent ??
        null;

      if (v == null) return null;

      var n = toNumber(v);
      if (n > 0 && n <= 1) n = n * 100;
      n = Math.max(0, Math.min(100, n));
      return n;
    }

    async function fetchJson(url) {
      var res = await fetch(url, { headers: { "Accept": "application/json" } });
      var data = await res.json().catch(function () { return {}; });
      if (!res.ok) throw new Error(data?.message || ("HTTP " + res.status));
      return data;
    }

    // -------------------- Dates --------------------
    var now = new Date();
    var year = now.getFullYear();
    var month = now.getMonth();

    var yearStart = new Date(year, 0, 1, 0, 0, 0, 0);
    var yearEnd = new Date(year + 1, 0, 1, 0, 0, 0, 0);

    var monthStart = new Date(year, month, 1, 0, 0, 0, 0);
    var monthEnd = new Date(year, month + 1, 1, 0, 0, 0, 0);

    var monthsPt = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];

    var chart = null;

    // -------------------- Grid state --------------------
    var allProcesses = [];
    var viewProcesses = [];
    var sortState = { key: "process_number", dir: "asc" };
    var pageSize = 10;
    var pageIndex = 0;

    function setSortIndicator() {
      $(".sortable .sort-indicator").text("");
      var th = $('.sortable[data-sort="' + sortState.key + '"]');
      th.find(".sort-indicator").text(sortState.dir === "asc" ? "▲" : "▼");
    }

    function applySort(items) {
      var key = sortState.key;
      var dir = sortState.dir === "asc" ? 1 : -1;

      function getValue(p) {
        if (key === "process_number") return String(pickProcessNumber(p) || "");
        if (key === "company") return String(pickProcessCompanyName(p) || "");
        if (key === "status") return String(normalizeProcessStatus(p) || "");
        if (key === "invoice") return String(pickProcessInvoice(p) || "");
        if (key === "completed") return pickProcessCompletedPercent(p) ?? -1;
        return "";
      }

      return items.slice().sort(function (a, b) {
        var av = getValue(a);
        var bv = getValue(b);

        if (typeof av === "number" && typeof bv === "number") return (av - bv) * dir;
        return String(av).localeCompare(String(bv), "pt-BR") * dir;
      });
    }

    function applyFilter(items) {
      var q = String($("#processSearch").val() || "").trim().toLowerCase();
      if (!q) return items;

      return items.filter(function (p) {
        var text = [
          pickProcessNumber(p),
          pickProcessCompanyName(p),
          normalizeProcessStatus(p),
          pickProcessInvoice(p)
        ].join(" ").toLowerCase();

        return text.includes(q);
      });
    }

    function renderProcessesTable() {
      var filtered = applyFilter(allProcesses);
      var sorted = applySort(filtered);
      viewProcesses = sorted;

      var total = viewProcesses.length;
      var start = pageIndex * pageSize;
      var end = Math.min(total, start + pageSize);
      var pageItems = viewProcesses.slice(start, end);

      $("#processesCount").text("Mostrando " + (total ? (start + 1) : 0) + "–" + end + " de " + total);

      var $tbody = $("#processesTbody");
      $tbody.empty();

      if (!pageItems.length) {
        $tbody.append('<tr><td colspan="6">Nenhum processo encontrado.</td></tr>');
        return;
      }

      pageItems.forEach(function (p) {
        var number = pickProcessNumber(p);
        var company = pickProcessCompanyName(p);

        var statusLabel = normalizeProcessStatus(p);
        var statusClass = statusClassFromLabel(statusLabel);

        var completed = pickProcessCompletedPercent(p);
        var completedNumber = completed == null ? 0 : completed;
        var pieValue = completed == null ? "0/100" : (completedNumber.toFixed(2) + "/100");

        var invoice = pickProcessInvoice(p);

        var pid = pickProcessId(p);

        var row = `
          <tr class="dash-clicker" onclick="${pid ? `redirectToProcessDetail('${String(pid).replace(/'/g, "\\'")}')` : ""}">
            <td class="truncate">${number}</td>
            <td class="truncate">${company}</td>
            <td>
              <span class="pie">${pieValue}</span>
              <span class="sr-only">${completed == null ? "-" : (completedNumber.toFixed(2) + "%")}</span>
            </td>
            <td><span class="${statusClass}">${statusLabel}</span></td>
            <td class="truncate">${invoice}</td>
            <td class="table-actions">
              ${pid ? `<a href="ProcessDetail?id=${encodeURIComponent(pid)}"><i class="fa fa-external-link text-navy"></i></a>` : "-"}
            </td>
          </tr>
        `;
        $tbody.append(row);
      });

      applyPeity();
    }

    function renderInProgress(processes) {
      var items = Array.isArray(processes) ? processes.slice() : [];

      // heurística: excluir finalizados/cancelados
      function isInProgress(p) {
        var statusLabel = normalizeProcessStatus(p).toLowerCase();
        if (!statusLabel) return true;
        if (statusLabel.includes("cancel")) return false;
        if (statusLabel.includes("encerr") || statusLabel.includes("finaliz") || statusLabel.includes("conclu")) return false;
        return true;
      }

      items = items.filter(isInProgress);

      // ordena por updated_at desc
      items.sort(function (a, b) {
        return new Date(pickProcessUpdatedAt(b) || 0).getTime() - new Date(pickProcessUpdatedAt(a) || 0).getTime();
      });

      // TOP 5
      items = items.slice(0, 5);

      var $wrap = $("#inProgressContainer");
      $wrap.empty();

      if (!items.length) {
        $wrap.append('<div class="ibox-content"><small>Nenhum processo em andamento.</small></div>');
        return;
      }

      items.forEach(function (p) {
        var number = pickProcessNumber(p);
        var completed = pickProcessCompletedPercent(p);
        var completedText = completed == null ? "-" : (completed.toFixed(2) + "%");

        var statusLabel = normalizeProcessStatus(p);
        var cls = statusClassFromLabel(statusLabel);

        var pid = pickProcessId(p);

        var block = `
          <div class="ibox-content dash-clicker" ${pid ? `onclick="redirectToProcessDetail('${String(pid).replace(/'/g, "\\'")}')"` : ""}>
            <div class="row">
              <div class="col-4">
                <small class="stats-label">Processo</small>
                <h4 class="truncate">${number}</h4>
              </div>
              <div class="col-4">
                <small class="stats-label">% Estágio</small>
                <h4>${completedText}</h4>
              </div>
              <div class="col-4">
                <small class="stats-label">Status</small>
                <h4><span class="${cls}">${statusLabel}</span></h4>
              </div>
            </div>
          </div>
        `;
        $wrap.append(block);
      });
    }

    async function loadDashboard() {
      try {
        $("#lastUpdateAt").text(formatDateTimePtBr(new Date()));

        // --------- INVOICES ---------
        var invoicesResp = await fetchJson("/api/invoices");
        var invoices = Array.isArray(invoicesResp) ? invoicesResp : (invoicesResp?.data || invoicesResp?.items || []);

        var invoicesMonth = [];
        var invoicesYear = [];

        invoices.forEach(function (inv) {
          var dtRaw = pickInvoiceDate(inv);
          if (!dtRaw) return;

          var dt = new Date(dtRaw);
          if (Number.isNaN(dt.getTime())) return;

          if (dt >= monthStart && dt < monthEnd) invoicesMonth.push(inv);
          if (dt >= yearStart && dt < yearEnd) invoicesYear.push(inv);
        });

        // cards: todos
        var monthSumAll = invoicesMonth.reduce(function (acc, inv) { return acc + toNumber(pickInvoiceTotal(inv)); }, 0);
        var yearSumAll = invoicesYear.reduce(function (acc, inv) { return acc + toNumber(pickInvoiceTotal(inv)); }, 0);

        $("#monthlyRevenue").text(moneyCurrencyPtBr(monthSumAll, "BRL"));
        $("#annualRevenue").text(moneyCurrencyPtBr(yearSumAll, "BRL"));

        var estimatedMonthly = 30000;
        var estimatedYear = 30000 * 12;

        var deltaMonth = estimatedMonthly > 0 ? ((monthSumAll / estimatedMonthly) * 100) : 0;
        $("#monthlyDelta").text((deltaMonth || 0).toFixed(0) + "%");

        var deltaYear = estimatedYear > 0 ? ((yearSumAll / estimatedYear) * 100) : 0;
        $("#annualDelta").text((deltaYear || 0).toFixed(0) + "%");

        // chart: estimado (30k) + ativos (status 0) + pagos (status 4)
        var estimatedByMonth = new Array(12).fill(30000);
        var activeByMonth = new Array(12).fill(0);
        var paidByMonth = new Array(12).fill(0);

        invoicesYear.forEach(function (inv) {
          var dt = new Date(pickInvoiceDate(inv));
          if (Number.isNaN(dt.getTime())) return;

          var m = dt.getMonth();
          var total = toNumber(pickInvoiceTotal(inv));
          var st = pickInvoiceStatus(inv);

          if (st === 0) activeByMonth[m] += total;      // Ativos
          if (st === 4) paidByMonth[m] += total;        // Pagos
        });

        var lineData = {
          labels: monthsPt,
          datasets: [
            {
              label: "Estimado (30.000/mês)",
              backgroundColor: "rgba(220,220,220,0.10)",
              borderColor: "rgba(170,170,170,1)",
              pointBackgroundColor: "rgba(170,170,170,1)",
              pointBorderColor: "#fff",
              data: estimatedByMonth
            },
            {
              label: "Invoices Ativos (status 0)",
              backgroundColor: "rgba(26,179,148,0.10)",
              borderColor: "rgba(26,179,148,1)", /* verde */
              pointBackgroundColor: "rgba(26,179,148,1)",
              pointBorderColor: "#fff",
              data: activeByMonth
            },
            {
              label: "Invoices Pagos (status 4)",
              backgroundColor: "rgba(220,38,38,0.08)",
              borderColor: "rgba(220,38,38,1)", /* vermelho */
              pointBackgroundColor: "rgba(220,38,38,1)",
              pointBorderColor: "#fff",
              data: paidByMonth
            }
          ]
        };

        var lineOptions = {
          responsive: true,
          maintainAspectRatio: false,
          tooltips: { enabled: false },   // remove tooltips do gráfico
          hover: { mode: null },          // evita hover highlight
          scales: {
            yAxes: [{
              ticks: {
                beginAtZero: true,
                stepSize: 10000
              }
            }]
          }
        };

        var ctx = document.getElementById("lineChart").getContext("2d");
        if (chart) chart.destroy();
        chart = new Chart(ctx, { type: "line", data: lineData, options: lineOptions });

        $("#totalInvoicesInPeriod").text(String(invoicesYear.length));
        $("#yearRevenueTotal").text(moneyCurrencyPtBr(yearSumAll, "BRL"));
        $("#yearEstimatedTotal").text(moneyCurrencyPtBr(estimatedYear, "BRL"));

        var prog = estimatedYear > 0 ? Math.max(0, Math.min(100, (yearSumAll / estimatedYear) * 100)) : 0;
        $("#yearRevenueProgress").css("width", prog.toFixed(0) + "%");
        $("#yearEstimatedProgress").css("width", "100%");

        // --------- PROCESSES ---------
        var processesResp = await fetchJson("/api/processes");
        var processes = Array.isArray(processesResp) ? processesResp : (processesResp?.data || processesResp?.items || []);

        var processesYear = processes.filter(function (p) {
          var dtRaw = pickProcessCreatedAt(p);
          if (!dtRaw) return false;
          var dt = new Date(dtRaw);
          if (Number.isNaN(dt.getTime())) return false;
          return dt >= yearStart && dt < yearEnd;
        });

        $("#totalProcessesInPeriod").text(String(processesYear.length));

        renderInProgress(processes);

        allProcesses = processes.slice();
        pageIndex = 0;
        setSortIndicator();
        renderProcessesTable();

      } catch (e) {
        console.error("Dashboard load error:", e);
        $("#monthlyRevenue").text("Erro");
        $("#annualRevenue").text("Erro");
        $("#processesTbody").html('<tr><td colspan="6">Erro ao carregar dados.</td></tr>');
        $("#inProgressContainer").html('<div class="ibox-content"><small>Erro ao carregar processos.</small></div>');
      }
    }

    // -------------------- UI events --------------------
    $(document).on("click", ".sortable", function () {
      var key = $(this).data("sort");
      if (!key) return;

      if (sortState.key === key) {
        sortState.dir = (sortState.dir === "asc") ? "desc" : "asc";
      } else {
        sortState.key = key;
        sortState.dir = (key === "completed") ? "desc" : "asc";
      }

      pageIndex = 0;
      setSortIndicator();
      renderProcessesTable();
    });

    $("#btnReloadProcesses").on("click", function () { loadDashboard(); });

    $("#btnSearch").on("click", function () {
      pageIndex = 0;
      renderProcessesTable();
    });

    $("#processSearch").on("keyup", function (e) {
      if (e.key === "Enter") {
        pageIndex = 0;
        renderProcessesTable();
      }
    });

    $("#prevPage").on("click", function () {
      if (pageIndex > 0) pageIndex--;
      renderProcessesTable();
    });

    $("#nextPage").on("click", function () {
      var total = viewProcesses.length;
      var maxPage = Math.max(0, Math.ceil(total / pageSize) - 1);
      if (pageIndex < maxPage) pageIndex++;
      renderProcessesTable();
    });

    setSortIndicator();
    loadDashboard();
  });
</script>
