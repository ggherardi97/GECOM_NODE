<link rel="stylesheet" href="../Assets/inspinia/css/plugins/daterangepicker/daterangepicker-bs3.css">
<style>
  .ibox-title {
    padding: 15px 90px 20px 15px;
  }

  th {
    padding-left: 0px;
  }

  .clicker {
    cursor: pointer;
  }

  .bulk-actions{
    display:none;
    align-items:center;
    gap:10px;
    padding:10px 15px;
    background:#f3f3f4;
    border:1px solid #e7eaec;
    border-radius:4px;
    margin-bottom:10px;
  }
  .bulk-actions .count{ font-weight:600; }
  .bulk-actions .btn{ margin:0; }

  th.sortable {
    cursor: pointer;
    user-select: none;
  }
  th.sortable .sort-indicator {
    margin-left: 6px;
    font-size: 11px;
    opacity: .75;
  }
  .sv-actions { margin-left: unset !important; }
  .sv-name.text-muted { display: inline-block !important; }
  #processSavedViewsHost .sv-bar { margin-top: -2px; }
  th.sv-fixed-col, td.sv-fixed-col { display: table-cell !important; visibility: visible !important; }
  .sv-date-filter .input-group-addon { padding: 3px 8px; cursor: pointer; }
</style>

<div class="row animated fadeInRight" style="margin-top: 25px;">
  <div class="col-lg-12">
    <div class="ibox ">
      <div class="ibox-title">
        <div id="processSavedViewsHost"></div>
        <div class="ibox-tools">
          <a type="button"
             class="btn btn-sm btn-primary"
             name="btn_act_new"
             href="/NovoProcesso">
            <%= t('page.processos.header.newProcess') %>
          </a>
        </div>
      </div>

      <div class="ibox-content">

        <!-- Bulk actions -->
        <div id="bulkActions" class="bulk-actions">
          <span class="count">
            <%= t('page.processos.toolbar.selected') %>
            <span id="selectedCount">0</span>
          </span>

          <button id="btnBulkDelete" type="button" class="btn btn-danger btn-sm">
            <i class="fa fa-trash"></i>
            <%= t('page.processos.toolbar.remove') %>
          </button>

          <button id="btnClearSelection" type="button" class="btn btn-white btn-sm">
            <%= t('page.processos.toolbar.clearSelection') %>
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-striped" id="process">
            <thead>

              <!-- Filters row -->
              <tr id="processFiltersRow">
                <th class="sv-fixed-col" data-field="__select" data-sv-fixed="left" style="width:40px;"></th>
                <th></th>

                <th data-field="ProjectName">
                  <input type="text" class="form-control input-sm"
                    placeholder="<%= t('page.processos.columns.process') %>" />
                </th>

                <th data-field="ContactName">
                  <input type="text" class="form-control input-sm"
                    placeholder="<%= t('page.processos.columns.primaryContact') %>" />
                </th>

                <th data-field="Phone">
                  <input type="text" class="form-control input-sm"
                    placeholder="<%= t('page.processos.columns.phone') %>" />
                </th>

                <th data-field="CompanyName">
                  <input type="text" class="form-control input-sm"
                    placeholder="<%= t('page.processos.columns.company') %>" />
                </th>

                <th data-field="CompletedNumber">
                  <input type="text" disabled class="form-control input-sm"
                    placeholder="<%= t('page.processos.columns.stage') %>" />
                </th>

                <th data-field="Task">
                  <input type="text" class="form-control input-sm"
                    placeholder="<%= t('page.processos.columns.invoice') %>" />
                </th>

                <th class="sv-date-filter" data-field="DateValue">
                  <div class="input-group">
                    <input id="processDateRangeFilter" type="text" class="form-control input-sm" placeholder="<%= t('page.layout.savedViews.dateRangePlaceholder') %>" autocomplete="off" />
                    <span class="input-group-addon" id="processDateRangeBtn"><i class="fa fa-calendar"></i></span>
                  </div>
                  <input id="processDateFromFilter" type="hidden" />
                  <input id="processDateToFilter" type="hidden" />
                </th>

                <th data-field="ActionText">
                  <select id="actionFilter" class="form-control input-sm">
                    <option value="">
                      <%= t('page.processos.filters.all') %>
                    </option>
                  </select>
                </th>
              </tr>

              <!-- Header row -->
              <tr id="processHeaderRow">
                <th class="sv-fixed-col" data-sort-key="__select" data-field="__select" data-sv-fixed="left" style="width:40px;">
                  <input id="chkSelectAll" type="checkbox"
                    title="<%= t('page.processos.toolbar.selected') %>">
                </th>

                <th class="sortable" data-sort-key="rowNumber" data-field="rowNumber">
                  <%= t('page.processos.columns.number') %>
                  <span class="sort-indicator"></span>
                </th>

                <th class="sortable" data-sort-key="ProjectName" data-field="ProjectName">
                  <%= t('page.processos.columns.process') %>
                  <span class="sort-indicator"></span>
                </th>

                <th class="sortable" data-sort-key="ContactName" data-field="ContactName" style="width: 15%;">
                  <%= t('page.processos.columns.primaryContact') %>
                  <span class="sort-indicator"></span>
                </th>

                <th class="sortable" data-sort-key="Phone" data-field="Phone">
                  <%= t('page.processos.columns.phone') %>
                  <span class="sort-indicator"></span>
                </th>

                <th class="sortable" data-sort-key="CompanyName" data-field="CompanyName" style="width: 27%;">
                  <%= t('page.processos.columns.company') %>
                  <span class="sort-indicator"></span>
                </th>

                <th class="sortable" data-sort-key="CompletedNumber" data-field="CompletedNumber">
                  <%= t('page.processos.columns.stage') %>
                  <span class="sort-indicator"></span>
                </th>

                <th class="sortable" data-sort-key="Task" data-field="Task">
                  <%= t('page.processos.columns.invoice') %>
                  <span class="sort-indicator"></span>
                </th>

                <th class="sortable" data-sort-key="DateValue" data-field="DateValue">
                  <%= t('page.processos.columns.date') %>
                  <span class="sort-indicator"></span>
                </th>

                <th class="sortable" data-sort-key="ActionText" data-field="ActionText">
                  <%= t('page.processos.columns.status') %>
                  <span class="sort-indicator"></span>
                </th>
              </tr>

            </thead>

            <tbody id="processLines"></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>


<% contentFor('scripts') %>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.tooltip.min.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.spline.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.resize.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.pie.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.symbol.js"></script>

<!-- Peity -->
<script src="../Assets/inspinia/js/plugins/peity/jquery.peity.min.js"></script>
<script src="../Assets/inspinia/js/demo/peity-demo.js"></script>

<!-- Custom and plugin javascript -->
<script src="../Assets/inspinia/js/inspinia.js"></script>
<script src="../Assets/inspinia/js/plugins/pace/pace.min.js"></script>

<!-- jQuery UI -->
<script src="../Assets/inspinia/js/plugins/jquery-ui/jquery-ui.min.js"></script>
<script src="../Assets/inspinia/js/plugins/fullcalendar/moment.min.js"></script>
<script src="../Assets/inspinia/js/plugins/daterangepicker/daterangepicker.js"></script>

<!-- Jvectormap -->
<script src="../Assets/inspinia/js/plugins/jvectormap/jquery-jvectormap-2.0.2.min.js"></script>
<script src="../Assets/inspinia/js/plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>

<!-- Sparkline -->
<script src="../Assets/inspinia/js/plugins/sparkline/jquery.sparkline.min.js"></script>

<!-- Sparkline demo data  -->
<script src="../Assets/inspinia/js/demo/sparkline-demo.js"></script>

<!-- ChartJS-->
<script src="../Assets/inspinia/js/plugins/chartJs/Chart.min.js"></script>
<%  %>

<script>
  // -------------------- i18n (server -> client) --------------------
  const I18N = {
    pageTitle: <%- JSON.stringify(t('page.processos.pageTitle')) %>,

    toolbarSelected: <%- JSON.stringify(t('page.processos.toolbar.selected')) %>,
    toolbarRemove: <%- JSON.stringify(t('page.processos.toolbar.remove')) %>,
    toolbarClearSelection: <%- JSON.stringify(t('page.processos.toolbar.clearSelection')) %>,

    filtersAll: <%- JSON.stringify(t('page.processos.filters.all')) %>,

    // Generic layout modal
    modalCancel: <%- JSON.stringify(t('page.layout.modal.cancel')) %>,
    modalClose: <%- JSON.stringify(t('page.layout.modal.close')) %>,
    modalSave: <%- JSON.stringify(t('page.layout.modal.save')) %>,

    // Messages (ADD THESE KEYS in common.json - see snippet below)
    msgLoadFail: <%- JSON.stringify(t('page.processos.messages.loadFail')) %>,
    msgDeleteFail: <%- JSON.stringify(t('page.processos.messages.deleteFail')) %>,
    msgDeleteFailSingle: <%- JSON.stringify(t('page.processos.messages.deleteFailSingle')) %>,
    msgNoneFound: <%- JSON.stringify(t('page.processos.messages.noneFound')) %>,
    msgBulkSomeFailed: <%- JSON.stringify(t('page.processos.messages.bulkSomeFailed')) %>,
    msgBulkUnexpected: <%- JSON.stringify(t('page.processos.messages.bulkUnexpected')) %>,

    // UI strings (ADD THESE KEYS in common.json - see snippet below)
    uiSelect: <%- JSON.stringify(t('page.processos.ui.select')) %>,
    uiRemoving: <%- JSON.stringify(t('page.processos.ui.removing')) %>,

    // Modal remove (ADD THESE KEYS in common.json - see snippet below)
    modalRemoveTitle: <%- JSON.stringify(t('page.processos.modalRemove.title')) %>,
    modalRemoveLine1: <%- JSON.stringify(t('page.processos.modalRemove.line1')) %>,
    modalRemoveLine2: <%- JSON.stringify(t('page.processos.modalRemove.line2')) %>,
    modalRemoveConfirm: <%- JSON.stringify(t('page.processos.modalRemove.confirm')) %>,

    // Status fallback key template: page.processos.status.<number>
    statusKeyPrefix: "page.processos.status."
  };

  function tClient(key) {
    // This uses server-injected strings when you reference a known key
    // For dynamic keys (like status), we handle separately below
    return key;
  }

  // -------------------- Global state --------------------
  let processes = [];
  const selectedProcessIds = new Set();
  const sortState = { key: null, dir: "asc" };
  const savedViewsState = { viewId: null, name: "", columns: [], columns_order: [], filters: [], sort: [] };

  // -------------------- Utils --------------------
  function escapeHtml(value) {
    if (value == null) return "";
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function isNonEmptyString(value) {
    return typeof value === "string" && value.trim().length > 0;
  }

  function toNumber(value) {
    const n = Number(value);
    return Number.isNaN(n) ? 0 : n;
  }

  function formatDatePtBR(value) {
    if (!value) return "";
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) return String(value);
    return d.toLocaleDateString("pt-BR");
  }

  function parseDateValue(value) {
    if (!value) return 0;
    const d = new Date(value);
    const t = d.getTime();
    return Number.isNaN(t) ? 0 : t;
  }

  function parsePtDateToTs(value) {
    const raw = String(value || "").trim();
    const m = raw.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (!m) return NaN;
    const d = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]), 0, 0, 0, 0);
    return d.getTime();
  }

  function pickIdFromApi(obj) {
    return obj?.id || obj?.process_id || obj?.processId || obj?._id || obj?.uuid || null;
  }

  function setBulkActionsVisible(isVisible) {
    const bar = document.getElementById("bulkActions");
    if (!bar) return;
    bar.style.display = isVisible ? "flex" : "none";
  }

  function updateBulkUI() {
    const countEl = document.getElementById("selectedCount");
    if (countEl) countEl.textContent = String(selectedProcessIds.size);

    setBulkActionsVisible(selectedProcessIds.size > 0);

    const chkAll = document.getElementById("chkSelectAll");
    if (chkAll) {
      const rowChecks = document.querySelectorAll("input.process-check");
      const total = rowChecks.length;
      const checked = Array.from(rowChecks).filter((x) => x.checked).length;
      chkAll.checked = total > 0 && checked === total;
      chkAll.indeterminate = checked > 0 && checked < total;
    }
  }

  function applyPeity() {
    if (window.jQuery) {
      try {
        $(".pie").peity("pie");
      } catch (e) {
        // ignore if plugin not loaded
      }
    }
  }

  // -------------------- API --------------------
  async function fetchProcesses() {
    const isAdmin = !!window.__auth?.isAdmin;
    const companyId = localStorage.getItem("companyId");

    let url = "/api/processes?fields=dashboard";
    if (!isAdmin && companyId) {
      url += `&company_id=${encodeURIComponent(String(companyId))}`;
    }

    const resp = await fetch(url, { method: "GET", headers: { Accept: "application/json" } });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data?.message || I18N.msgLoadFail);
    return data;
  }

  async function deleteProcessById(processId) {
    const resp = await fetch(`/api/processes/${encodeURIComponent(processId)}`, {
      method: "DELETE",
      headers: { Accept: "application/json" },
    });

    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data?.message || I18N.msgDeleteFailSingle);
    return data;
  }

  async function runWithConcurrency(items, limit, worker) {
    const queue = [...items];
    const workers = Array.from({ length: Math.min(limit, items.length) }, async () => {
      while (queue.length > 0) {
        const item = queue.shift();
        await worker(item);
      }
    });
    await Promise.all(workers);
  }

  // -------------------- Status (source of truth: ProcessStatusEnum) --------------------
  function getStatusValueFromApi(value) {
    const n = Number(value);
    return Number.isNaN(n) ? 0 : n;
  }

  function tryGetI18nStatusLabel(statusValue) {
    // We can't call server t() dynamically here; instead we rely on common.json having these keys
    // and your server-side i18n system returning the translation at render time.
    // Strategy: we embed a small lookup table generated from those keys.
    const s = getStatusValueFromApi(statusValue);

    // If you add these keys in common.json, the server will inject the correct strings here:
    // page.processos.status.0 ... etc
    const map = {
      0: <%- JSON.stringify(t('page.processos.status.0')) %>,
      1: <%- JSON.stringify(t('page.processos.status.1')) %>,
      2: <%- JSON.stringify(t('page.processos.status.2')) %>,
      3: <%- JSON.stringify(t('page.processos.status.3')) %>,
      4: <%- JSON.stringify(t('page.processos.status.4')) %>,
    };

    const label = map[s];

    // If the key doesn't exist in i18n, many libs return the key string itself.
    // We detect that and fallback to ProcessStatusEnum.
    if (label && !String(label).startsWith(I18N.statusKeyPrefix)) return label;

    return null;
  }

  function getStatusLabel(statusValue) {
    const s = getStatusValueFromApi(statusValue);

    const i18nLabel = tryGetI18nStatusLabel(s);
    if (i18nLabel) return i18nLabel;

    return window.ProcessStatusEnum?.getLabel(s) ?? `Status ${s}`;
  }

  function getStatusCssClass(statusValue) {
    const s = getStatusValueFromApi(statusValue);
    const enumCss = window.ProcessStatusEnum?.getCssClass(s) ?? "label-default";
    return enumCss.includes("label ") ? enumCss : `label ${enumCss}`;
  }

  // -------------------- Mapping --------------------
  function mapApiToRow(p, index) {
    const id = pickIdFromApi(p) || p?.process_number || String(index + 1);

    const process_number = p?.process_number ?? p?.processNumber ?? "";
    const invoice = p?.invoice ?? "";
    const ship_date = p?.ship_date ?? p?.shipDate ?? p?.created_on ?? p?.createdAt ?? p?.created_at ?? "";
    const status = getStatusValueFromApi(p?.status);

    const completedNumber = Math.max(0, Math.min(100, toNumber(p?.completed)));

    const companyName = p?.companies?.company_name ?? "";
    const contactName = p?.users?.full_name ?? "";
    const contactPhone = p?.users?.phonenumber ?? "";

    return {
      Id: String(id),

      ProjectName: isNonEmptyString(process_number)
        ? String(process_number)
        : (isNonEmptyString(invoice) ? String(invoice) : `PRC-${String(id)}`),

      Task: isNonEmptyString(invoice) ? String(invoice) : "",

      Date: ship_date,
      DateValue: parseDateValue(ship_date),

      CompletedNumber: completedNumber,
      StatusValue: status,

      CompanyName: isNonEmptyString(companyName) ? String(companyName).trim() : "",
      ContactName: isNonEmptyString(contactName) ? String(contactName).trim() : "",
      Phone: isNonEmptyString(contactPhone) ? String(contactPhone).trim() : "",

      rowNumber: index + 1,
    };
  }

  // -------------------- Sorting --------------------
  function normalizeForCompare(value) {
    if (value == null) return "";
    return String(value).toLowerCase();
  }

  function sortProcesses(list) {
    if (!sortState.key) return list;

    const key = sortState.key;
    const dir = sortState.dir;

    const sorted = [...list].sort((a, b) => {
      if (key === "CompletedNumber" || key === "DateValue" || key === "rowNumber") {
        const av = Number(a[key] ?? 0);
        const bv = Number(b[key] ?? 0);
        return av - bv;
      }

      const av = normalizeForCompare(a[key]);
      const bv = normalizeForCompare(b[key]);
      if (av < bv) return -1;
      if (av > bv) return 1;
      return 0;
    });

    if (dir === "desc") sorted.reverse();
    return sorted;
  }

  function updateSortIndicators() {
    const headers = document.querySelectorAll("#process thead tr:nth-child(2) th.sortable");
    headers.forEach((th) => {
      const indicator = th.querySelector(".sort-indicator");
      if (!indicator) return;

      const key = th.getAttribute("data-sort-key");
      if (key && key === sortState.key) indicator.textContent = sortState.dir === "asc" ? "▲" : "▼";
      else indicator.textContent = "";
    });
  }

  function bindSorting() {
    const headers = document.querySelectorAll("#process thead tr:nth-child(2) th.sortable");
    headers.forEach((th) => {
      th.addEventListener("click", function (e) {
        e.stopPropagation();

        const key = this.getAttribute("data-sort-key");
        if (!key) return;

        if (sortState.key === key) sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
        else {
          sortState.key = key;
          sortState.dir = "asc";
        }

        updateSortIndicators();
        renderProcessTable(processes);
        applyCurrentFilters();
      });
    });
  }

  // -------------------- Render --------------------
  function renderProcessTable(list) {
    const tbody = document.getElementById("processLines");
    if (!tbody) return;

    tbody.innerHTML = "";

    const sorted = sortProcesses(list);

    if (!sorted || sorted.length === 0) {
      tbody.innerHTML = `<tr><td colspan="10">${escapeHtml(I18N.msgNoneFound)}</td></tr>`;
      updateBulkUI();
      return;
    }

    sorted.forEach((p, idx) => {
      const tr = document.createElement("tr");
      tr.className = "clicker";
      tr.setAttribute("data-process-id", String(p.Id));
      tr.setAttribute("data-status", String(p.StatusValue));

      tr.addEventListener("click", function () {
        redirectToProcess(p.Id);
      });

      const isChecked = selectedProcessIds.has(String(p.Id));
      const pieValue = `${p.CompletedNumber}/100`;

      tr.innerHTML = `
        <td>
          <input
            class="process-check"
            type="checkbox"
            data-id="${escapeHtml(String(p.Id))}"
            ${isChecked ? "checked" : ""}
            title="${escapeHtml(I18N.uiSelect)}"
          />
        </td>
        <td>${escapeHtml(String(idx + 1))}</td>
        <td>${escapeHtml(p.ProjectName)}</td>
        <td>${escapeHtml(p.ContactName)}</td>
        <td>${escapeHtml(p.Phone)}</td>
        <td>${escapeHtml(p.CompanyName)}</td>
        <td>
          <span class="pie">${escapeHtml(pieValue)}</span>
          <span class="sr-only">${escapeHtml(String(p.CompletedNumber))}</span>
        </td>
        <td>${escapeHtml(p.Task)}</td>
        <td>${escapeHtml(formatDatePtBR(p.Date))}</td>
        <td><span class="${escapeHtml(getStatusCssClass(p.StatusValue))}">${escapeHtml(getStatusLabel(p.StatusValue))}</span></td>
      `;

      const chk = tr.querySelector("input.process-check");
      chk.addEventListener("click", function (e) {
        e.stopPropagation();
        const id = String(this.getAttribute("data-id") ?? "");
        if (!id) return;

        if (this.checked) selectedProcessIds.add(id);
        else selectedProcessIds.delete(id);

        updateBulkUI();
      });

      tbody.appendChild(tr);
    });

    updateBulkUI();
    applyPeity();
  }

  // -------------------- Navigation --------------------
  function redirectToProcess(id) {
    const selected = processes.find((x) => x.Id === String(id));
    if (!selected) {
      console.error("Process not found for id:", id);
      return;
    }

    localStorage.setItem("selectedProcessId", String(selected.Id));
    localStorage.setItem("selectedProcess", JSON.stringify(selected));

    window.location = `ProcessDetail?id=${encodeURIComponent(String(selected.Id))}`;
  }
  window.redirectToProcess = redirectToProcess;

  // -------------------- Bulk delete (GlobalModal) --------------------
  function showBulkDeleteConfirm(selectedIds) {
    if (!Array.isArray(selectedIds) || selectedIds.length === 0) return Promise.resolve(false);

    const qty = selectedIds.length;

    const modalBtn = document.getElementById("modalButton");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const btnSave = document.getElementById("saveModal");
    const btnClose = document.getElementById("closeModal");

    if (!modalBtn || !modalTitle || !modalBody || !btnSave || !btnClose) {
      const ok = confirm(`${I18N.toolbarRemove} ${qty} processo(s)?`);
      return Promise.resolve(ok);
    }

    modalTitle.textContent = I18N.modalRemoveTitle;
    modalBody.innerHTML = `
      <p>${escapeHtml(I18N.modalRemoveLine1)} <strong>${escapeHtml(qty)}</strong> processo(s).</p>
      <p class="text-danger">${escapeHtml(I18N.modalRemoveLine2)}</p>
      <p>${escapeHtml(I18N.modalRemoveConfirm)}</p>
    `;

    btnSave.textContent = I18N.toolbarRemove;
    btnSave.classList.remove("btn-primary");
    btnSave.classList.add("btn-danger");

    btnClose.textContent = I18N.modalCancel;

    return new Promise((resolve) => {
      const cleanup = () => {
        btnSave.onclick = null;
        btnClose.onclick = null;

        btnSave.classList.remove("btn-danger");
        btnSave.classList.add("btn-primary");
        btnSave.textContent = I18N.modalSave;
        btnClose.textContent = I18N.modalClose;
      };

      btnSave.onclick = () => {
        cleanup();
        resolve(true);
      };

      btnClose.onclick = () => {
        cleanup();
        resolve(false);
      };

      modalBtn.click();
    });
  }

  async function executeBulkDelete() {
    const ids = Array.from(selectedProcessIds);
    if (ids.length === 0) return;

    const confirmed = await showBulkDeleteConfirm(ids);
    if (!confirmed) return;

    const btn = document.getElementById("btnBulkDelete");
    const oldText = btn ? btn.innerHTML : "";
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ${escapeHtml(I18N.uiRemoving)}...`;
    }

    try {
      const failures = [];
      await runWithConcurrency(ids, 5, async (id) => {
        try {
          await deleteProcessById(id);
        } catch (e) {
          failures.push({ id, message: e?.message || I18N.msgDeleteFail });
        }
      });

      if (failures.length > 0) {
        console.warn("Bulk delete failures:", failures);
        alert(`${I18N.msgBulkSomeFailed} (${failures.length}).`);
      }

      const failedIds = new Set(failures.map((x) => String(x.id)));
      const removedIds = ids.filter((id) => !failedIds.has(String(id)));

      processes = processes.filter((p) => !removedIds.includes(String(p.Id)));
      removedIds.forEach((id) => selectedProcessIds.delete(String(id)));

      renderProcessTable(processes);
      applyCurrentFilters();
    } catch (err) {
      console.error("executeBulkDelete error:", err);
      alert(err?.message || I18N.msgBulkUnexpected);
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = oldText || `<i class="fa fa-trash"></i> ${escapeHtml(I18N.toolbarRemove)}`;
      }
      updateBulkUI();
    }
  }

  function clearSelection() {
    selectedProcessIds.clear();
    renderProcessTable(processes);
    applyCurrentFilters();
  }

  function bindBulkEvents() {
    const chkAll = document.getElementById("chkSelectAll");
    const btnDelete = document.getElementById("btnBulkDelete");
    const btnClear = document.getElementById("btnClearSelection");

    if (chkAll) {
      chkAll.addEventListener("click", function (e) {
        e.stopPropagation();
        const checks = document.querySelectorAll("input.process-check");
        checks.forEach((chk) => {
          const id = String(chk.getAttribute("data-id") ?? "");
          if (!id) return;

          chk.checked = this.checked;

          if (this.checked) selectedProcessIds.add(id);
          else selectedProcessIds.delete(id);
        });

        updateBulkUI();
      });
    }

    if (btnDelete) btnDelete.addEventListener("click", executeBulkDelete);
    if (btnClear) btnClear.addEventListener("click", clearSelection);
  }

  // -------------------- Filters --------------------
  function installColumnFilters() {
    $("#process thead input:not([type='hidden'])").on("keyup change", function () {
      applyCurrentFilters();
    });

    $("#actionFilter").on("change", function () {
      applyCurrentFilters();
    });
  }

  function initDateRangeFilter() {
    const $range = $("#processDateRangeFilter");
    const $from = $("#processDateFromFilter");
    const $to = $("#processDateToFilter");
    if (!$range.length) return;

    const hasDateRangePicker = !!($.fn.daterangepicker && window.moment);
    if (hasDateRangePicker) {
      if ($range.data("daterangepicker")) $range.data("daterangepicker").remove();

      $range.daterangepicker({
        autoUpdateInput: false,
        locale: {
          format: "DD/MM/YYYY",
          cancelLabel: "<%= t('page.layout.savedViews.clearLabel') %>",
          applyLabel: "<%= t('page.layout.savedViews.applyLabel') %>",
          fromLabel: "<%= t('page.layout.savedViews.fromLabel') %>",
          toLabel: "<%= t('page.layout.savedViews.toLabel') %>",
          daysOfWeek: ["Do", "Se", "Te", "Qa", "Qi", "Se", "Sa"],
          monthNames: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]
        }
      });

      $range.off("apply.daterangepicker.proc").on("apply.daterangepicker.proc", function (_ev, picker) {
        $from.val(picker.startDate.format("DD/MM/YYYY"));
        $to.val(picker.endDate.format("DD/MM/YYYY"));
        $range.val(`${$from.val()} - ${$to.val()}`);
        applyCurrentFilters();
      });

      $range.off("cancel.daterangepicker.proc").on("cancel.daterangepicker.proc", function () {
        $from.val("");
        $to.val("");
        $range.val("");
        applyCurrentFilters();
      });
    }

    $("#processDateRangeBtn").off("click.proc").on("click.proc", function (e) {
      e.preventDefault();
      e.stopPropagation();
      if ($range.data("daterangepicker")) $range.data("daterangepicker").show();
      else $range.focus();
    });
  }

  function applyCurrentFilters() {
    const table = $("#process");
    const actionSelectedRaw = $("#actionFilter").val();
    const actionSelected = actionSelectedRaw !== "" && actionSelectedRaw != null ? Number(actionSelectedRaw) : null;

    const filterInputs = $("#process thead tr:nth-child(1) input:not([type='hidden'])");

    table.find("tbody tr").each(function () {
      const $row = $(this);
      let visible = true;

      filterInputs.each(function (i) {
        const value = String($(this).val() || "").toLowerCase();
        if (!value) return;

        const map = [2, 3, 4, 5, 6, 7, 8];
        const tdIndex = map[i];

        if (i === 6) {
          const fromTs = parsePtDateToTs($("#processDateFromFilter").val());
          const toTs = parsePtDateToTs($("#processDateToFilter").val());
          const rowDateTs = parsePtDateToTs(String($row.find("td").eq(8).text() || "").trim());

          if (!Number.isNaN(fromTs) && (Number.isNaN(rowDateTs) || rowDateTs < fromTs)) visible = false;
          if (!Number.isNaN(toTs) && (Number.isNaN(rowDateTs) || rowDateTs > toTs)) visible = false;
          return;
        }

        const cellText = String($row.find("td").eq(tdIndex).text() || "").toLowerCase();
        if (cellText.indexOf(value) === -1) visible = false;
      });

      if (visible && actionSelected != null && !Number.isNaN(actionSelected)) {
        const rowStatus = Number($row.attr("data-status"));
        if (Number.isNaN(rowStatus) || rowStatus !== actionSelected) visible = false;
      }

      $row.toggle(visible);
    });
  }

  function getAllColumnKeys() {
    return $("#processHeaderRow th.sortable")
      .map(function () { return String($(this).data("sort-key") || ""); })
      .get()
      .filter(k => k.length > 0);
  }

  function tryTriggerAny(selectors) {
    for (const s of selectors) {
      const el = $(s);
      if (el.length) { el.trigger("click"); return true; }
    }
    return false;
  }

  function ensureSavedViewsExtraButtons() {
    const host = $("#processSavedViewsHost");
    if (!host.length) return;
    const actions = host.find(".sv-actions").length ? host.find(".sv-actions").first() : host;

    if (!$("#btnSaveCurrentProcessView").length) {
      actions.append(`<button id="btnSaveCurrentProcessView" class="btn btn-white btn-xs sv-actionbar-btn" style="margin-left:8px;" title="<%= t('page.layout.savedViews.saveCurrentTitle') %>"><i class="fa fa-check"></i> <%= t('page.layout.savedViews.saveLabel') %></button>`);
    }
    if (!$("#btnDeleteCurrentProcessView").length) {
      actions.append(`<button id="btnDeleteCurrentProcessView" class="btn btn-danger btn-xs sv-actionbar-btn" style="margin-left:6px; display:none;" title="<%= t('page.layout.savedViews.deleteCurrentTitle') %>"><i class="fa fa-trash"></i> <%= t('page.layout.savedViews.deleteLabel') %></button>`);
    }

    if (savedViewsState.viewId) $("#btnDeleteCurrentProcessView").show();
    else $("#btnDeleteCurrentProcessView").hide();

    $("#btnSaveCurrentProcessView").off("click.svSaveCurrent").on("click.svSaveCurrent", function (e) {
      e.preventDefault(); e.stopPropagation();
      const did = tryTriggerAny(["#sv_btnSave", "[data-action='save']", ".sv-btn-save"]);
      if (did) return;
      if (savedViewsState.viewId) {
        (async () => {
          try {
            const payload = {
              name: savedViewsState.name || undefined,
              definition_json: {
                columns: savedViewsState.columns,
                columns_order: savedViewsState.columns_order,
                filters: captureFiltersForSavedView(),
                sort: sortState.key ? [{ field: sortState.key, dir: sortState.dir }] : []
              }
            };
            await fetch(`/api/saved-views/${encodeURIComponent(savedViewsState.viewId)}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json", Accept: "application/json" },
              body: JSON.stringify(payload)
            });
            if (typeof window.SavedViewsGrid?.reload === "function") window.SavedViewsGrid.reload();
          } catch (err) { console.error(err); }
        })();
        return;
      }
      tryTriggerAny(["#sv_btnSaveAs", "[data-action='saveas']", ".sv-btn-saveas"]);
    });

    $("#btnDeleteCurrentProcessView").off("click.svDeleteCurrent").on("click.svDeleteCurrent", function (e) {
      e.preventDefault(); e.stopPropagation();
      if (!savedViewsState.viewId) return;
      if (!confirm("<%= t('page.layout.savedViews.deleteCurrentConfirm') %>")) return;
      const did = tryTriggerAny(["#sv_btnDelete", "[data-action='delete']", ".sv-btn-delete"]);
      if (did) return;
      (async () => {
        try {
          await fetch(`/api/saved-views/${encodeURIComponent(savedViewsState.viewId)}`, { method: "DELETE", headers: { Accept: "application/json" } });
          savedViewsState.viewId = null;
          savedViewsState.name = "";
          if (typeof window.SavedViewsGrid?.reload === "function") window.SavedViewsGrid.reload();
        } catch (err) { console.error(err); }
      })();
    });
  }

  function captureFiltersForSavedView() {
    const filters = [];
    const map = ["ProjectName", "ContactName", "Phone", "CompanyName", "CompletedNumber", "Task", "DateValue"];
    $("#processFiltersRow input").each(function (idx) {
      const v = String($(this).val() || "").trim();
      const field = map[idx];
      if (!field || !v) return;
      if (field === "DateValue") return;
      filters.push({ field, op: "contains", value: v });
    });

    const action = String($("#actionFilter").val() || "").trim();
    if (action) filters.push({ field: "ActionText", op: "eq", value: action });

    const from = String($("#processDateFromFilter").val() || "").trim();
    const to = String($("#processDateToFilter").val() || "").trim();
    if (from) filters.push({ field: "DateValue", op: "gte", value: from });
    if (to) filters.push({ field: "DateValue", op: "lte", value: to });

    return filters;
  }

  function applyFiltersFromSavedView(def) {
    $("#processFiltersRow input").val("");
    $("#actionFilter").val("");
    $("#processDateFromFilter,#processDateToFilter,#processDateRangeFilter").val("");

    (def.filters || []).forEach(f => {
      const field = String(f.field || "");
      const value = String(f.value || "");
      const op = String(f.op || "").toLowerCase();
      if (!value) return;

      if (field === "ProjectName") $("#processFiltersRow input").eq(0).val(value);
      else if (field === "ContactName") $("#processFiltersRow input").eq(1).val(value);
      else if (field === "Phone") $("#processFiltersRow input").eq(2).val(value);
      else if (field === "CompanyName") $("#processFiltersRow input").eq(3).val(value);
      else if (field === "CompletedNumber") $("#processFiltersRow input").eq(4).val(value);
      else if (field === "Task") $("#processFiltersRow input").eq(5).val(value);
      else if (field === "ActionText") $("#actionFilter").val(value);
      else if (field === "DateValue" && op === "gte") $("#processDateFromFilter").val(value);
      else if (field === "DateValue" && op === "lte") $("#processDateToFilter").val(value);
    });

    const from = $("#processDateFromFilter").val();
    const to = $("#processDateToFilter").val();
    if (from && to) $("#processDateRangeFilter").val(`${from} - ${to}`);
    else if (from) $("#processDateRangeFilter").val(from);
    else if (to) $("#processDateRangeFilter").val(to);
  }

  function applySortFromSavedView(def) {
    const first = Array.isArray(def.sort) ? def.sort[0] : null;
    const key = first?.field ? String(first.field) : "";
    const dir = String(first?.dir || "asc").toLowerCase() === "desc" ? "desc" : "asc";
    if (!key) {
      sortState.key = null;
      sortState.dir = "asc";
      updateSortIndicators();
      renderProcessTable(processes);
      applyCurrentFilters();
      return;
    }
    sortState.key = key;
    sortState.dir = dir;
    updateSortIndicators();
    renderProcessTable(processes);
    applyCurrentFilters();
  }

  function fillStatusFilter() {
    const sel = document.getElementById("actionFilter");
    if (!sel) return;

    const options = window.ProcessStatusEnum?.toSelectOptions?.() ?? [];
    options.forEach((o) => {
      const opt = document.createElement("option");
      opt.value = String(o.value);

      // Apply same i18n override to dropdown labels
      const i18nLabel = tryGetI18nStatusLabel(o.value);
      opt.textContent = i18nLabel ? i18nLabel : o.label;

      sel.appendChild(opt);
    });
  }

  // -------------------- Load --------------------
  async function loadProcesses() {
    try {
      const apiData = await fetchProcesses();

      const rows = Array.isArray(apiData)
        ? apiData
        : (apiData.data ?? apiData.rows ?? apiData.processes ?? [apiData]);

      processes = rows.map(mapApiToRow);

      updateSortIndicators();
      renderProcessTable(processes);
      applyCurrentFilters();
    } catch (err) {
      console.error("loadProcesses error:", err);
      const tbody = document.getElementById("processLines");
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan="10">${escapeHtml(err?.message || I18N.msgLoadFail)}</td></tr>`;
      }
    }
  }

  // -------------------- Init --------------------
  $(document).ready(function () {
    $("#pageName").text(I18N.pageTitle);
    $("#subpageName").text(I18N.pageTitle);

    bindBulkEvents();
    bindSorting();
    fillStatusFilter();
    installColumnFilters();
    initDateRangeFilter();

    (async function initSavedViews() {
      await loadProcesses();

      const allKeys = getAllColumnKeys();
      savedViewsState.columns = allKeys.slice();
      savedViewsState.columns_order = allKeys.slice();

      await window.SavedViewsGrid.init({
        entityName: "processes",
        hostSelector: "#processSavedViewsHost",
        tableSelector: "#process",
        headerRowSelector: "#process thead tr:eq(1)",
        filtersRowSelector: "#process thead tr:eq(0)",
        getAllColumnKeys: () => getAllColumnKeys(),
        fallbackViewName: "",
        includeFallbackOption: false,
        fallbackDefinition: { columns: allKeys.slice(), columns_order: allKeys.slice(), filters: [], sort: [] },
        getCurrentState: () => {
          const domOrder = $("#processHeaderRow th.sortable").map(function () { return String($(this).data("sort-key") || ""); }).get().filter(Boolean);
          const visible = $("#processHeaderRow th.sortable:visible").map(function () { return String($(this).data("sort-key") || ""); }).get().filter(Boolean);
          savedViewsState.columns_order = domOrder.length ? domOrder : savedViewsState.columns_order;
          savedViewsState.columns = visible.length ? visible : savedViewsState.columns;
          savedViewsState.filters = captureFiltersForSavedView();
          savedViewsState.sort = sortState.key ? [{ field: sortState.key, dir: sortState.dir }] : [];
          return Object.assign({}, savedViewsState);
        },
        applyState: ({ viewId, name, definition, _fromColumnsModal }) => {
          savedViewsState.viewId = viewId;
          savedViewsState.name = name || "";
          if (_fromColumnsModal === true) {
            initDateRangeFilter();
            return;
          }
          applyFiltersFromSavedView(definition || {});
          applySortFromSavedView(definition || {});
          initDateRangeFilter();
          ensureSavedViewsExtraButtons();
        },
        onAfterApply: () => {
          initDateRangeFilter();
          applyCurrentFilters();
          updateSortIndicators();
          ensureSavedViewsExtraButtons();
        }
      });
      setTimeout(ensureSavedViewsExtraButtons, 120);
    })().catch((err) => {
      console.error("init saved views (processos) error:", err);
    });
  });
</script>




