<style>
  .ibox-title {
    padding: 15px 90px 20px 15px;
  }

  .wizard-big.wizard>.content {
    min-height: 350px !important;
  }

  .users-table th,
  .users-table td {
    vertical-align: middle !important;
  }

  .users-table input.form-control {
    height: 34px;
    padding: 6px 10px;
  }

  .btn-xs2 {
    padding: 4px 8px;
    font-size: 12px;
    line-height: 1.2;
  }
</style>

<% contentFor('headerLink') %>
  <link href="../Assets/inspinia/css/plugins/iCheck/custom.css" rel="stylesheet">
  <link href="../Assets/inspinia/css/plugins/steps/jquery.steps.css" rel="stylesheet">
  <% %>

    <div>
      <div id="wrapper-clientes">
        <div id="page-wrapper-clientes" class="gray-bg">
          <div class="row border-bottom">
            <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0; display: none;">
              <div class="navbar-header">
                <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i></a>
                <form role="search" class="navbar-form-custom" action="search_results.html">
                  <div class="form-group">
                    <input type="text" placeholder="<%= t('page.newClient.navbar.searchPlaceholder') %>" class="form-control" name="top-search"
                      id="top-search">
                  </div>
                </form>
              </div>
            </nav>
          </div>

          <div class="wrapper wrapper-content animated fadeInRight">
            <div class="row">
              <div class="col-lg-12">
                <div class="ibox">
                  <div class="ibox-title">
                    <h5><%= t('page.newClient.pageTitle') %></h5>
                    <div class="ibox-tools"></div>
                  </div>

                  <div class="ibox-content">
                    <p><%= t('page.newClient.subtitle') %></p>

                    <!-- ✅ NEW ORDER: Cliente -> Dados Opcionais -> Acesso -->
                    <form id="form" action="#" class="wizard-big">

                      <!-- ===================== STEP 1: CLIENTE ===================== -->
                      <h1><%= t('page.newClient.steps.client') %></h1>
                      <fieldset>
                        <h2><%= t('page.newClient.client.title') %></h2>
                        <div class="row">
                          <div class="col-lg-4">
                            <div class="form-group">
                              <label><%= t('page.newClient.client.labels.cnpjRequired') %></label>
                              <input id="cnpj" name="cnpj" onkeyup="maskCNPJ(this)" type="text"
                                class="form-control required" maxlength="18" placeholder="<%= t('page.newClient.client.placeholders.cnpj') %>">
                              <small id="cnpjHelp" style="display:none; color:#999;"><%= t('page.newClient.client.state.fetchingCnpj') %></small>
                            </div>

                            <div class="form-group">
                              <label><%= t('page.newClient.client.phoneRequired') %></label>
                              <input id="phone" name="phone" onkeyup="maskPhone(this)" type="text"
                                class="form-control required" maxlength="15">
                            </div>

                            <div class="form-group">
                              <label><%= t('page.newClient.client.labels.sector') %></label>
                              <input id="setor" name="setor" type="text" class="form-control" maxlength="120"
                                placeholder="<%= t('page.newClient.access.sectorExample') %>">
                            </div>
                          </div>

                          <div class="col-lg-4">
                            <div class="form-group">
                              <label><%= t('page.newClient.client.companyNameRequired') %></label>
                              <input id="companyname" name="companyname" type="text" class="form-control required">
                            </div>

                            <div class="form-group">
                              <label><%= t('page.newClient.client.labels.size') %></label>
                              <select id="categoria" class="form-control">
                                <option value="-1" selected><%= t('page.newClient.client.sizeOptions.select') %></option>
                                <option value="0"><%= t('page.newClient.client.sizeOptions.small') %></option>
                                <option value="1"><%= t('page.newClient.client.sizeOptions.medium') %></option>
                                <option value="2"><%= t('page.newClient.client.sizeOptions.large') %></option>
                              </select>
                            </div>

                            <div class="form-group">
                              <label><%= t('page.newClient.client.labels.status') %></label>
                              <input class="form-control" value="<%= t('page.newClient.client.status.active') %>" readonly />
                            </div>
                          </div>

                          <div class="col-lg-4">
                            <div class="text-center">
                              <div style="margin-top: 20px">
                                <i class="fa fa-building" style="font-size: 180px; color: #e5e5e5"></i>
                              </div>
                              <!-- <div class="m-t-sm">
                            <small class="text-muted">
                              Ao avançar para o próximo passo, você preencherá os dados opcionais.
                              <br />
                            </small>
                          </div> -->
                            </div>
                          </div>
                        </div>
                      </fieldset>

                      <!-- ===================== STEP 2: DADOS OPCIONAIS ===================== -->
                      <h1><%= t('page.newClient.steps.optional') %></h1>
                      <fieldset>
                        <h2><%= t('page.newClient.optional.addressOptional') %></h2>
                        <div class="row">
                          <div class="col-lg-6">
                            <div class="form-group">
                              <label><%= t('page.newClient.optional.postalCode') %></label>
                              <input id="postalcode" name="postalcode" type="text" class="form-control" maxlength="9"
                                placeholder="<%= t('page.newClient.optional.placeholders.postalCode') %>" oninput="maskCEP(this)">
                              <small id="postalHelp" style="display:none; color:#999;"><%= t('page.newClient.optional.fetchingAddress') %></small>
                            </div>

                            <div class="form-group">
                              <label><%= t('page.newClient.optional.labels.street') %></label>
                              <input id="street" name="street" type="text" class="form-control">
                            </div>

                            <div class="form-group">
                              <label><%= t('page.newClient.optional.country') %></label>
                              <input id="country" name="country" type="text" class="form-control">
                            </div>
                          </div>

                          <div class="col-lg-6">
                            <div class="form-group">
                              <label><%= t('page.newClient.optional.labels.city') %></label>
                              <input id="city" name="city" type="text" class="form-control">
                            </div>

                            <div class="form-group">
                              <label><%= t('page.newClient.optional.labels.state') %></label>
                              <input id="state" name="state" type="text" class="form-control">
                            </div>

                            <div class="form-group">
                              <label><%= t('page.newClient.optional.labels.complement') %></label>
                              <input id="complemento" name="complemento" type="text" class="form-control">
                            </div>
                          </div>
                        </div>

                      </fieldset>

                      <!-- ===================== STEP 3: ACESSO (MULTI USERS) ===================== -->
                      <h1><%= t('page.newClient.steps.access') %></h1>
                      <fieldset>
                        <h2><%= t('page.newClient.access.title') %></h2>

                        <div class="row">
                          <div class="col-lg-12">
                            <div class="alert alert-warning" id="companyNotCreatedBanner" style="display:none;">
                              <%= t('page.newClient.access.companyNotCreated') %>
                            </div>

                            <div class="m-b-sm">
                              <button type="button" class="btn btn-primary btn-xs2" onclick="addUserRow()">
                                <i class="fa fa-plus"></i> <%= t('page.newClient.access.addUser') %>
                              </button>
                              <small class="text-muted m-l-sm">
                                <%= t('page.newClient.access.setPrimaryPrefix') %> <strong><%= t('page.newClient.access.setPrimaryStrong') %></strong> <%= t('page.newClient.access.setPrimaryHint') %>
                              </small>
                            </div>

                            <div class="table-responsive">
                              <table class="table table-bordered users-table">
                                <thead>
                                  <tr>
                                    <th style="width:70px;"><%= t('page.newClient.access.table.primary') %></th>
                                    <th><%= t('page.newClient.access.table.nameRequired') %></th>
                                    <th><%= t('page.newClient.access.emailRequired') %></th>
                                    <th><%= t('page.newClient.access.phone') %></th>
                                    <th style="width:150px;"><%= t('page.newClient.access.sendAccess') %></th>
                                    <th style="width:90px;"><%= t('page.newClient.access.actions') %></th>
                                  </tr>
                                </thead>
                                <tbody id="usersTbody">
                                  <!-- rows -->
                                </tbody>
                              </table>
                            </div>

                          </div>
                        </div>
                      </fieldset>

                    </form>

                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <% contentFor('scripts') %>
      <script src="../Assets/inspinia/js/plugins/iCheck/icheck.min.js"></script>
      <% %>

        <script>
          (function () {
            // ===================== State =====================
            window.__newClientState = window.__newClientState || {
              companyId: null,
              placeholderUserId: null,
              lastCnpjFetched: null,
              companyCreated: false,
              creatingCompany: false,
              userRowsSeq: 0
            };

            // ===================== UI helpers =====================
            function getValue(id) {
              const el = document.getElementById(id);
              return (el && el.value ? el.value : "").trim();
            }

            function setIfEmpty(id, value) {
              const el = document.getElementById(id);
              if (!el) return;
              if (String(el.value || "").trim().length > 0) return;
              el.value = value ?? "";
            }

            function normalizeCep(value) {
              return String(value || "").replace(/\D/g, "").slice(0, 8);
            }

            function onlyDigits(value) {
              return String(value || "").replace(/\D/g, "");
            }

            function showPostalLoading(isLoading) {
              const el = document.getElementById("postalHelp");
              if (!el) return;
              el.style.display = isLoading ? "block" : "none";
            }

            function showCnpjLoading(isLoading) {
              const el = document.getElementById("cnpjHelp");
              if (!el) return;
              el.style.display = isLoading ? "block" : "none";
            }

            // Anti-spam alert (cooldown)
            function showAlertOnce(message) {
              const now = Date.now();
              const last = window.__lastAlertAt || 0;
              if (now - last < 2500) return;
              window.__lastAlertAt = now;
              alert(message);
            }

            function pickCompanyIdFromApiResponse(data) {
  return (data?.company_id || data?.companyId || data?.id || data?.uuid || data?._id || null);
}

function pickUserIdFromApiResponse(data) {
  return (data?.user_id || data?.userId || data?.id || data?.uuid || data?._id || null);
}

            function generateTempPassword() {
              const rand = Math.random().toString(36).slice(2);
              return `Tmp@${rand}9159`;
            }

            function buildCompanyDetailUrl(companyId) {
              return `ClientDetails?id=${encodeURIComponent(companyId)}`;
            }

            function getSelectedCategoryText() {
              const txt = $("#categoria option:selected").text() || "";
              return txt.includes("<%= t('page.newClient.client.sizeOptions.selectKeyword') %>") ? "" : txt;
            }

            // ===================== CNPJ lookup (via your BFF proxy) =====================
            async function fetchCompanyByCnpj(cnpjDigits) {
              const resp = await fetch(`/api/cnpj/lookup?cnpj=${encodeURIComponent(cnpjDigits)}`, {
                method: "GET",
                headers: { "Accept": "application/json" }
              });

              const data = await resp.json().catch(() => ({}));
              if (!resp.ok) throw new Error(data?.message || "<%= t('page.newClient.messages.cnpjLookupFail') %>");
              return data;
            }

            async function tryAutoFillFromCnpj(options) {
              const opts = options || {};
              const showAlert = !!opts.showAlert;

              const cnpjDigits = onlyDigits(getValue("cnpj"));
              if (cnpjDigits.length !== 14) return;

              if (window.__newClientState.lastCnpjFetched === cnpjDigits) return;

              try {
                showCnpjLoading(true);

                const data = await fetchCompanyByCnpj(cnpjDigits);
                window.__newClientState.lastCnpjFetched = cnpjDigits;

                setIfEmpty("companyname", data?.nome);

                const setorText =
                  (data?.atividade_principal && data.atividade_principal.text)
                    ? data.atividade_principal.text
                    : "";
                setIfEmpty("setor", setorText);

                setIfEmpty("postalcode", data?.cep.replace(".", "") || "");
                setIfEmpty("street", data?.logradouro || "");
                setIfEmpty("city", data?.municipio || "");
                setIfEmpty("state", data?.uf || "");
                setIfEmpty("country", "<%= t('page.newClient.defaults.country') %>");

                const cep = normalizeCep(getValue("postalcode"));
                if (cep.length === 8) lookupAddressByPostalCode();

              } catch (e) {
                console.error("[CNPJ] lookup failed:", e);
                if (showAlert) showAlertOnce(e?.message || "<%= t('page.newClient.messages.cnpjAutoFillFail') %>");
              } finally {
                showCnpjLoading(false);
              }
            }

            function installCnpjAutoFill() {
              if (window.__cnpjListenersInstalled) return;
              window.__cnpjListenersInstalled = true;

              let debounceTimer = null;

              document.addEventListener("keyup", function (ev) {
                const target = ev.target;
                if (!target || target.id !== "cnpj") return;

                const digits = onlyDigits(target.value);
                if (digits.length !== 14) return;

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(function () {
                  tryAutoFillFromCnpj({ showAlert: false });
                }, 600);
              }, true);

              document.addEventListener("blur", function (ev) {
                const target = ev.target;
                if (!target || target.id !== "cnpj") return;
                tryAutoFillFromCnpj({ showAlert: true });
              }, true);
            }

            // ===================== CEP lookup (server-side proxy) =====================
            let cepTimer = null;

            async function lookupAddressByPostalCode() {
              const cep = normalizeCep(getValue("postalcode"));
              if (cep.length !== 8) return;

              try {
                showPostalLoading(true);

                const response = await fetch(`/api/address/lookup?postalcode=${encodeURIComponent(cep)}`, {
                  method: "GET",
                  headers: { "Accept": "application/json" }
                });

                const data = await response.json().catch(() => ({}));
                if (!response.ok) return;

                const street = document.getElementById("street");
                const city = document.getElementById("city");
                const state = document.getElementById("state");
                const country = document.getElementById("country");

                if (street && !street.value.trim() && data.street) street.value = data.street;
                if (city && !city.value.trim() && data.city) city.value = data.city;
                if (state && !state.value.trim() && data.state) state.value = data.state;
                if (country && !country.value.trim()) country.value = data.country || "<%= t('page.newClient.defaults.country') %>";
              } catch (e) {
                console.error("CEP lookup error:", e);
              } finally {
                showPostalLoading(false);
              }
            }
            window.lookupAddressByPostalCode = lookupAddressByPostalCode;

            function attachPostalAutoFill() {
              const postal = document.getElementById("postalcode");
              if (!postal) return;

              postal.addEventListener("input", function () {
                let v = postal.value.replace(/\D/g, "").slice(0, 8);
                if (v.length > 5) v = v.slice(0, 5) + "-" + v.slice(5);
                postal.value = v;

                clearTimeout(cepTimer);
                cepTimer = setTimeout(lookupAddressByPostalCode, 500);
              });

              postal.addEventListener("blur", function () {
                lookupAddressByPostalCode();
              });
            }

            // ===================== Masks =====================
            function maskPhone(element) {
              let value = element.value.replace(/\D/g, '');
              if (value.length <= 10) {
                element.value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
              } else {
                element.value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
              }
            }
            function maskCNPJ(element) {
              let value = element.value;
              value = value.replace(/\D/g, '');
              value = value.replace(/^(\d{2})(\d)/, "$1.$2");
              value = value.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
              value = value.replace(/\.(\d{3})(\d)/, ".$1/$2");
              value = value.replace(/(\d{4})(\d)/, "$1-$2");
              element.value = value;
            }
            function maskCEP(element) {
              let v = String(element.value || "").replace(/\D/g, "").slice(0, 8);
              if (v.length > 5) v = v.slice(0, 5) + "-" + v.slice(5);
              element.value = v;
            }
            window.maskPhone = maskPhone;
            window.maskCNPJ = maskCNPJ;
            window.maskCEP = maskCEP;

            // ===================== API calls =====================
            async function apiCreateUser(payload) {
              const response = await fetch("/api/users", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Accept": "application/json" },
                body: JSON.stringify(payload || {})
              });
              const data = await response.json().catch(() => ({}));
              if (!response.ok) throw new Error(data?.message || "<%= t('page.newClient.messages.createUserFail') %>");
              return data;
            }

            async function apiPatchUser(userId, payload) {
              const response = await fetch(`/api/users/${encodeURIComponent(userId)}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json", "Accept": "application/json" },
                body: JSON.stringify(payload || {})
              });
              const text = await response.text().catch(() => "");
              const data = text ? (function () { try { return JSON.parse(text); } catch { return { message: text }; } })() : {};
              if (!response.ok) throw new Error(data?.message || text || "<%= t('page.newClient.messages.patchUserFail') %>");
              return data;
            }

            async function apiCreateCompany(payload) {
              const response = await fetch("/api/companies", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Accept": "application/json" },
                body: JSON.stringify(payload || {})
              });
              const data = await response.json().catch(() => ({}));
              if (!response.ok) throw new Error(data?.message || "<%= t('page.newClient.messages.createCompanyFail') %>");
              return data;
            }

            async function apiPatchCompany(companyId, payload) {
              const response = await fetch(`/api/companies/${encodeURIComponent(companyId)}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json", "Accept": "application/json" },
                body: JSON.stringify(payload || {})
              });
              const text = await response.text().catch(() => "");
              const data = text ? (function () { try { return JSON.parse(text); } catch { return { message: text }; } })() : {};
              if (!response.ok) throw new Error(data?.message || text || "<%= t('page.newClient.messages.patchCompanyFail') %>");
              return data;
            }

            // ===================== Multi-users UI =====================
            function escapeHtml(value) {
              if (value == null) return "";
              return String(value)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
            }

            function ensureAtLeastOneRow() {
              const tbody = document.getElementById("usersTbody");
              if (!tbody) return;
              if (tbody.children.length === 0) addUserRow();
            }

            function addUserRow(prefill) {
              const tbody = document.getElementById("usersTbody");
              if (!tbody) return;

              const seq = ++window.__newClientState.userRowsSeq;
              const rowId = `urow_${seq}`;

              const p = prefill || {};
              const name = p.full_name || "";
              const email = p.email || "";
              const phone = p.phonenumber || "";
              const send = (p.send_access !== false); // default true

              const tr = document.createElement("tr");
              tr.setAttribute("data-row-id", rowId);

              tr.innerHTML = `
        <td class="text-center">
          <input type="radio" name="primaryUserRadio" value="${escapeHtml(rowId)}" ${tbody.children.length === 0 ? "checked" : ""} />
        </td>
        <td>
          <input type="text" class="form-control" id="${rowId}_name" placeholder="<%= t('page.newClient.access.placeholders.fullName') %>" value="${escapeHtml(name)}" />
        </td>
        <td>
          <input type="text" class="form-control" id="${rowId}_email" placeholder="<%= t('page.newClient.access.emailExample') %>" value="${escapeHtml(email)}" />
        </td>
        <td>
          <input type="text" class="form-control" id="${rowId}_phone" placeholder="<%= t('page.newClient.access.placeholders.phoneExample') %>" value="${escapeHtml(phone)}" onkeyup="maskPhone(this)" maxlength="15" />
        </td>
        <td class="text-center">
          <label style="margin:0; cursor:pointer;">
            <input type="checkbox" id="${rowId}_send" ${send ? "checked" : ""} />
            <span class="m-l-xs"><%= t('page.newClient.access.yes') %></span>
          </label>
        </td>
        <td class="text-center">
          <button type="button" class="btn btn-danger btn-xs2" onclick="removeUserRow('${rowId}')">
            <i class="fa fa-trash"></i>
          </button>
        </td>
      `;

              tbody.appendChild(tr);
            }
            window.addUserRow = addUserRow;

            function removeUserRow(rowId) {
              const tbody = document.getElementById("usersTbody");
              if (!tbody) return;

              const tr = tbody.querySelector(`tr[data-row-id="${CSS.escape(rowId)}"]`);
              if (tr) tr.remove();

              // if removed the checked primary, ensure one remains checked
              const checked = tbody.querySelector(`input[name="primaryUserRadio"]:checked`);
              if (!checked) {
                const first = tbody.querySelector(`input[name="primaryUserRadio"]`);
                if (first) first.checked = true;
              }

              ensureAtLeastOneRow();
            }
            window.removeUserRow = removeUserRow;

            function readUsersFromTable() {
              const tbody = document.getElementById("usersTbody");
              if (!tbody) return { users: [], primaryRowId: null };

              const rows = Array.from(tbody.querySelectorAll("tr[data-row-id]"));
              const primary = tbody.querySelector(`input[name="primaryUserRadio"]:checked`);
              const primaryRowId = primary ? primary.value : null;

              const users = rows.map(r => {
                const rowId = r.getAttribute("data-row-id");
                const full_name = (document.getElementById(`${rowId}_name`)?.value || "").trim();
                const email = (document.getElementById(`${rowId}_email`)?.value || "").trim();
                const phonenumber = (document.getElementById(`${rowId}_phone`)?.value || "").trim();
                const send_access = !!document.getElementById(`${rowId}_send`)?.checked;
                return { rowId, full_name, email, phonenumber, send_access };
              });

              return { users, primaryRowId };
            }

            function validateUsersTable() {
              const { users } = readUsersFromTable();
              if (!users || users.length === 0) return "<%= t('page.newClient.messages.usersAtLeastOne') %>";

              const invalid = users.find(u => !u.full_name || !u.email);
              if (invalid) return "<%= t('page.newClient.messages.usersFillNameEmail') %>";

              // very basic email check
              const badEmail = users.find(u => !/^\S+@\S+\.\S+$/.test(u.email));
              if (badEmail) return `<%= t('page.newClient.messages.invalidEmailPrefix') %> ${badEmail.email}`;

              // unique email check
              const emails = users.map(u => u.email.toLowerCase());
              const hasDup = new Set(emails).size !== emails.length;
              if (hasDup) return "<%= t('page.newClient.messages.duplicateEmail') %>";

              return null;
            }

            // ===================== Core rule: create company on step2 -> next =====================
            async function ensureCompanyCreatedBeforeAccess() {
              if (window.__newClientState.companyCreated && window.__newClientState.companyId) return true;
              if (window.__newClientState.creatingCompany) return false;

              window.__newClientState.creatingCompany = true;

              try {
                // ✅ Create company directly (NO placeholder user)
                const payloadCompany = {
                  company_name: getValue("companyname"),
                  // ✅ user_id removed
                  phone: getValue("phone"),
                  company_number: getValue("cnpj"),
                  sector: getValue("setor"),
                  category: getSelectedCategoryText(),

                  address_postalcode: normalizeCep(getValue("postalcode")) || null,
                  address_line: getValue("complemento"),
                  address_street: getValue("street"),
                  address_number: "",
                  address_city: getValue("city"),
                  address_state: getValue("state"),
                  address_country: getValue("country") || "<%= t('page.newClient.defaults.country') %>"
                };

                const createdCompany = await apiCreateCompany(payloadCompany);
                const companyId = pickCompanyIdFromApiResponse(createdCompany);
                if (!companyId) throw new Error("<%= t('page.newClient.messages.companyCreatedNoId') %>");

                window.__newClientState.companyId = companyId;
                window.__newClientState.companyCreated = true;

                // ✅ mantém seu cache do companyId como estava
                localStorage.setItem("selectedClientId", String(companyId));
                localStorage.setItem("selectedClient", JSON.stringify(payloadCompany));

                console.log("[NewClient] Company created:", companyId);
                return true;
              } catch (e) {
                console.error("[NewClient] ensureCompanyCreatedBeforeAccess failed:", e);
                showAlertOnce(e?.message || "<%= t('page.newClient.messages.createCompanyStep2Fail') %>");
                return false;
              } finally {
                window.__newClientState.creatingCompany = false;
              }
            }

            function showCompanyNotCreatedBanner(show) {
              const el = document.getElementById("companyNotCreatedBanner");
              if (!el) return;
              el.style.display = show ? "block" : "none";
            }

            // ===================== Finish: create all users + link + set primary =====================
            async function finishCreateUsersAndLink() {
              const companyId = window.__newClientState.companyId;
              if (!companyId) throw new Error("<%= t('page.newClient.messages.companyIdMissingForFinish') %>");

              const validationMsg = validateUsersTable();
              if (validationMsg) throw new Error(validationMsg);

              const { users, primaryRowId } = readUsersFromTable();
              if (!primaryRowId) throw new Error("<%= t('page.newClient.messages.selectPrimary') %>");

              // create users (real)
              const createdUsers = [];
              for (const u of users) {
                const password = u.send_access ? generateTempPassword() : "";

                const payload = {
                  full_name: u.full_name,
                  email: u.email,
                  password: password,
                  role: "USER",
                  status: "ACTIVE",
                  phonenumber: u.phonenumber || null,

                  // ✅ link on create (needs usersApi.js to forward company_id)
                  company_id: companyId
                };

                const created = await apiCreateUser(payload);
                const userId =pickUserIdFromApiResponse(created);
                if (!userId) throw new Error(`<%= t('page.newClient.messages.userCreatedNoIdPrefix') %> (${u.email}) <%= t('page.newClient.messages.userCreatedNoIdSuffix') %>`);

                createdUsers.push({ rowId: u.rowId, userId, email: u.email });
              }

              // choose primary
              const primary = createdUsers.find(x => x.rowId === primaryRowId);
              if (!primary) throw new Error("<%= t('page.newClient.messages.primaryNotFound') %>");

              // patch company user_id to primary
              await apiPatchCompany(companyId, { user_id: primary.userId });

              // ensure all users have company_id (in case backend ignored on create)
              for (const cu of createdUsers) {
                await apiPatchUser(cu.userId, { company_id: companyId });
              }

              window.location.href = buildCompanyDetailUrl(companyId);
            }

            // ===================== Wizard init =====================
            $(document).ready(function () {
              $("#pageName").text("<%= t('page.newClient.pageTitle') %>");
              $("#subSecoundPageName").text("<%= t('page.newClient.pageTitle') %>");
              $("#subpageName").text("<%= t('page.newClient.breadcrumbs.clients') %>");
              $("#subpageName").attr("href", "Clientes");
              $("#path").show();

              $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green'
              });

              attachPostalAutoFill();
              installCnpjAutoFill();

              // initial table
              ensureAtLeastOneRow();

              $("#form").steps({
                bodyTag: "fieldset",

                onStepChanging: async function (event, currentIndex, newIndex) {
                  // allow back
                  if (currentIndex > newIndex) return true;

                  const form = $(this);

                  // clean next step errors
                  if (currentIndex < newIndex) {
                    $(".body:eq(" + newIndex + ") label.error", form).remove();
                    $(".body:eq(" + newIndex + ") .error", form).removeClass("error");
                  }

                  form.validate().settings.ignore = ":disabled,:hidden";
                  const ok = form.valid();
                  if (!ok) return false;

                  // ✅ when leaving Step 2 (Dados Opcionais) to Step 3 (Acesso): create company
                  // Step indexes: 0 Cliente, 1 Dados Opcionais, 2 Acesso
                  if (currentIndex === 1 && newIndex === 2) {
                    const created = await ensureCompanyCreatedBeforeAccess();
                    showCompanyNotCreatedBanner(!created);
                    return created;
                  }

                  return true;
                },

                onStepChanged: function (event, currentIndex) {
                  // If user lands on access but company not created, show banner
                  if (currentIndex === 2) {
                    const hasCompany = !!(window.__newClientState.companyId);
                    showCompanyNotCreatedBanner(!hasCompany);
                  }
                },

                onFinishing: function () {
                  const form = $(this);
                  form.validate().settings.ignore = ":disabled";
                  return form.valid();
                },

                onFinished: async function () {
                  try {
                    await finishCreateUsersAndLink();
                  } catch (e) {
                    console.error(e);
                    showAlertOnce(e?.message || "<%= t('page.newClient.messages.finishFail') %>");
                  }
                }
              }).validate({
                errorPlacement: function (error, element) {
                  element.before(error);
                }
              });
            });

          })();
        </script>
