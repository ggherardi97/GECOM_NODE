<div class="row">
  <!-- LEFT -->
  <div class="col-lg-3">
    <div class="ibox" style="margin-top: 15px;">
      <div class="ibox-content">
        <div class="file-manager">
          <div class="row" style="margin:0;">
            <h5 class="tag-title"><%= t('page.myDocuments.sidebar.folders') %></h5>

            <div class="input-group" style="margin: 8px 0 12px 0;">
              <input id="txtSearchLeft" type="text" class="form-control input-sm" placeholder="<%= t('page.documents.placeholders.searchFolders') %>" />
              <span class="input-group-btn">
                <button id="btnSearchLeft" class="btn btn-sm btn-primary" type="button"><%= t('page.myDocuments.buttons.ok') %></button>
              </span>
            </div>

            <ul id="leftFolders" class="folder-list" style="width: 100%;padding:0;margin-top:10px;">
              <li class="text-muted"><%= t('page.clientDetails.documentsToolbar.loading') %></li>
            </ul>
          </div>

          <div class="hr-line-dashed"></div>
          <div class="clearfix"></div>

          <button class="btn btn-primary btn-block" id="btnAddQuickUpload" type="button" name="btn_act_new">
            <i class="fa fa-upload"></i> <%= t('page.myDocuments.quickUpload.title') %>
          </button>
          <input type="file" style="display:none;" id="fileQuickInput" />

          <div style="margin-top:10px;" class="text-muted">
            <small><%= t('page.myDocuments.quickUpload.hint') %></small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="col-lg-9 animated fadeInRight">
    <!-- TOP BAR -->
    <div class="row" style="padding: 15px 15px;">
      <div class="col-lg-9" style="margin-left:-15px;">
        <button type="button" class="btn btn-primary" id="btnBack" style="display:none;">
          <i class="fa fa-arrow-left"></i> <%= t('page.myDocuments.toolbar.back') %>
        </button>

        <div class="btn-group" style="margin-left:8px;" name="btn_act_new">
          <button data-toggle="dropdown" class="btn btn-primary dropdown-toggle" name="btn_act_new">
            <%= t('page.myDocuments.toolbar.add') %>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="btnNewFolder"><i class="fa fa-folder"></i> <%= t('page.myDocuments.toolbar.newFolder') %></a></li>
            <li><a class="dropdown-item" href="#" id="btnUploadDoc"><i class="fa fa-upload"></i> <%= t('page.myDocuments.toolbar.uploadDocument') %></a></li>
            <li><a class="dropdown-item" href="#" id="btnNewLink"><i class="fa fa-link"></i> <%= t('page.myDocuments.toolbar.driveLink') %></a></li>
          </ul>
        </div>

        <button type="button" class="btn btn-white" id="btnOpenSelected" style="margin-left:8px; display:none;">
          <i class="fa fa-external-link"></i> <%= t('page.myDocuments.toolbar.open') %>
        </button>

        <button type="button" class="btn btn-danger" id="btnDeleteSelected" style="margin-left:8px; display:none;">
          <i class="fa fa-trash"></i> <%= t('page.myDocuments.toolbar.delete') %>
        </button>

        <span id="currentFolderLabel" class="text-muted" style="margin-left:12px;"></span>
        <span id="loadingBadge" class="label label-info" style="display:none;margin-left:10px;"><%= t('page.clientDetails.documentsToolbar.loading') %></span>
      </div>

      <div class="col-lg-3">
        <div class="input-group" style="margin: 0px 0 15px -15px;">
          <input id="txtSearch" type="text" class="form-control input-sm" placeholder="<%= t('page.clientDetails.documents.placeholders.searchInFolder') %>" />
          <span class="input-group-btn">
            <button id="btnSearch" class="btn btn-sm btn-white" type="button"><i class="fa fa-search"></i></button>
          </span>
        </div>
      </div>
    </div>

    <!-- GRID -->
    <div class="row" id="itemsGrid">
      <div class="col-lg-12 text-muted"><%= t('page.clientDetails.documentsToolbar.loading') %></div>
    </div>
  </div>
</div>

<style>
  /* Drive-like selection */
  .file-box .file { cursor: default; }
  .file-box.is-selected .file {
    outline: 2px solid rgba(26, 179, 148, 0.45);
    box-shadow: 0 0 0 3px rgba(26, 179, 148, 0.12);
    border-radius: 4px;
  }
  .related-badge {
    display: inline-block;
    margin-right: 6px;
    margin-bottom: 6px;
    padding: 2px 2px;
    font-size: 11px;
    font-weight: 600;
    line-height: 1.4;
    vertical-align: middle;
  }

  /* inspinia "primary" */
  .related-badge.label-primary {
    margin-top: 5px;
    background: none;
    color: #808080;
  }

  .related-badge i {
    margin-right: 5px;
  }
  /* NEW: selection check badge (top-left) */
  .file-box .select-badge {
    position: absolute;
    top: 6px;
    left: 6px;
    width: 22px;
    height: 22px;
    border-radius: 4px;
    background: rgba(255,255,255,0.95);
    border: 1px solid #d5d5d5;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 5;
    cursor: pointer;
  }
  .file-box .select-badge i {
    font-size: 14px;
    color: #1ab394; /* inspinia green */
  }
  .file-box.is-selected .select-badge {
    display: flex;
  }
  /* show hint on hover so user learns it exists */
  .file-box:hover .select-badge {
    display: flex;
    opacity: .75;
  }
  .file-box.is-selected:hover .select-badge {
    opacity: 1;
  }
</style>

<% contentFor('scripts') %>
<script src="/Assets/inspinia/js/plugins/typehead/bootstrap3-typeahead.min.js"></script>

<script>
  (function () {
    // ---------------------------
    // Page headers + permissions
    // ---------------------------
    $(document).ready(function () {
      $("#pageName").text(t("page.myDocuments.pageTitle"));
      $("#subSecoundPageName").text("");
      $("#subpageName").text(t("page.myDocuments.pageTitle"));
      $("#subpageName").attr("href", "MyDocuments");
      $("#path").hide();

      // Permissions (igual layout)
      if (window.__auth?.isUser) {
        $('a[name="btn_act_new"]').hide();
        $('button[name="btn_act_new"]').hide();
        $('input[name="btn_act_new"]').hide();
      } else if (window.__auth?.isManager) {
        $('a[name="btn_act_new"]').hide();
        $('button[name="btn_act_new"]').hide();
        $('input[name="btn_act_new"]').hide();
      } else if (window.__auth?.isAdmin) {
        // ok
      }
    });

    // ---------------------------
    // Side modal (GLOBAL - robust)
    // IMPORTANT: removes previous listeners by cloning buttons
    // ---------------------------
    function pickFirst(selectors) {
      for (const sel of selectors) {
        const el = document.querySelector(sel);
        if (el) return el;
      }
      return null;
    }

    function replaceWithClone(el) {
      if (!el || !el.parentNode) return el;
      const clone = el.cloneNode(true);
      el.parentNode.replaceChild(clone, el);
      return clone;
    }

    function openSideModal(opts) {
      const overlay = pickFirst(["#dynamicModalOverlay", ".dynamic-modal-overlay"]);
      const modal = pickFirst(["#dynamicModal", ".dynamic-modal"]);
      const titleEl = pickFirst(["#dynamicModalTitle", ".dynamic-modal-title"]);
      const bodyEl = pickFirst(["#dynamicModalBody", ".dynamic-modal-body"]);

      let btnClose = pickFirst(["#dynamicModalCloseBtn", ".dynamic-modal-close"]);
      let btnCancel = pickFirst(["#dynamicModalCancelBtn", ".dynamic-modal-cancel"]);
      let btnOk = pickFirst(["#dynamicModalOkBtn", ".dynamic-modal-ok"]);

      if (!overlay || !modal || !titleEl || !bodyEl || !btnOk) {
        alert(t("page.clientDetails.documents.messages.sideModalMissing"));
        return;
      }

      // ðŸ”¥ Remove any old listeners that other scripts attached
      btnOk = replaceWithClone(btnOk);
      if (btnCancel) btnCancel = replaceWithClone(btnCancel);
      if (btnClose) btnClose = replaceWithClone(btnClose);

      titleEl.textContent = (opts?.title || "");
      bodyEl.innerHTML = (opts?.bodyHtml || "");
      if (btnCancel) btnCancel.textContent = (opts?.cancelText || t("page.layout.modal.cancel"));
      btnOk.textContent = (opts?.okText || t("page.layout.modal.ok"));

      function close() {
        overlay.style.display = "none";
        modal.style.display = "none";
      }

      btnOk.addEventListener("click", async function (e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        const keepOpen = (typeof opts?.onOk === "function") ? await opts.onOk() : false;
        if (!keepOpen) close();
      }, true);

      if (btnCancel) {
        btnCancel.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          if (typeof opts?.onCancel === "function") opts.onCancel();
          close();
        }, true);
      }

      if (btnClose) {
        btnClose.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          if (typeof opts?.onCancel === "function") opts.onCancel();
          close();
        }, true);
      }

      overlay.style.display = "block";
      modal.style.display = "block";

      // Optional hook
      if (typeof opts?.onOpen === "function") {
        setTimeout(() => {
          try { opts.onOpen(); } catch { /* ignore */ }
        }, 0);
      }
    }

    // ---------------------------
    // State
    // ---------------------------
    const state = {
      currentParentId: null,     // null = root
      navStack: [],              // { parentId, name }
      selected: new Set(),       // ids
      currentSearch: "",
      lastLoadedItems: [],
      lastClick: { id: null, ts: 0 },
    };

    // ---------------------------
    // Helpers
    // ---------------------------
    function escapeHtml(value) {
      if (value == null) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showLoading(flag) {
      $("#loadingBadge").toggle(!!flag);
    }

    function isFolder(item) { return String(item?.item_type || "").toUpperCase() === "FOLDER"; }
    function isLink(item) { return String(item?.item_type || "").toUpperCase() === "LINK"; }
    function isFile(item) { return String(item?.item_type || "").toUpperCase() === "FILE"; }

    function isDriveLink(item) {
      const sp = String(item?.storage_provider || "").toUpperCase();
      const it = String(item?.item_type || "").toUpperCase();
      return sp === "DRIVE" || it === "DRIVE";
    }

    function iconFor(item) {
      if (isFolder(item)) return '<i class="fa fa-folder"></i>';
      if (isLink(item)) {
        if (isDriveLink(item)) return '<i class="fa fa-google"></i>';
        return '<i class="fa fa-link"></i>';
      }

      const ext = String(item?.ext || "").toLowerCase();
      const mime = String(item?.mime_type || "").toLowerCase();

      if (mime.startsWith("image/")) return '<i class="fa fa-file-image-o"></i>';
      if (mime.startsWith("video/")) return '<i class="fa fa-film"></i>';
      if (mime.startsWith("audio/")) return '<i class="fa fa-music"></i>';
      if (ext === "pdf") return '<i class="fa fa-file-pdf-o"></i>';
      if (ext === "xls" || ext === "xlsx" || mime.includes("spreadsheet")) return '<i class="fa fa-bar-chart-o"></i>';
      if (ext === "doc" || ext === "docx") return '<i class="fa fa-file-word-o"></i>';
      return '<i class="fa fa-file"></i>';
    }

    function formatDate(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString("pt-BR") + " " + d.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
    }

    function normalizeText(value) {
      const s = String(value ?? "").toLowerCase().trim();
      try {
        return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      } catch {
        return s;
      }
    }

    function getUserCompanyId() {
      const id = window.__auth?.company_id || window.__auth?.companyId || null;
      return id ? String(id) : null;
    }

    function getAccountIdForCreate() {
      const id =
        window.__auth?.accountId ||
        window.__auth?.account_id ||
        window.__auth?.account?.id ||
        window.__auth?.tenant_id ||
        window.__auth?.admin_account_id ||
        null;

      if (id) return String(id);

      const companyId = getUserCompanyId();
      return companyId ? String(companyId) : null;
    }

    function isAdminRoot() {
      return !!window.__auth?.isAdmin && state.currentParentId === null;
    }

    function updateTopActions() {
      const count = state.selected.size;
      $("#btnDeleteSelected").toggle(count > 0);
      $("#btnOpenSelected").toggle(count === 1);
      $("#btnBack").toggle(state.navStack.length > 0);

      if (state.navStack.length === 0) {
        $("#currentFolderLabel").text("");
      } else {
        const parts = state.navStack.map(x => x.name || t("page.documents.defaults.folderName"));
        $("#currentFolderLabel").text(parts.join(" / "));
      }
    }

    function buildListQuery() {
      const qs = new URLSearchParams();

      if (state.currentParentId === null) qs.set("parent_id", "null");
      else qs.set("parent_id", state.currentParentId);

      if (state.currentSearch && state.currentSearch.trim()) qs.set("q", state.currentSearch.trim());

      qs.set("take", "500");
      qs.set("skip", "0");

      // âœ… PermissÃ£o: admin vÃª tudo, outros filtram por company
      if (!window.__auth?.isAdmin) {
        const companyId = getUserCompanyId();
        qs.set("related_table", "company");
        qs.set("related_id", companyId || "00000000-0000-0000-0000-000000000000");
      }

      return qs.toString();
    }

    async function confirmAsync(message, options) {
      try {
        const result = window.confirm(message, options);
        return await Promise.resolve(result);
      } catch {
        return false;
      }
    }

    // ---------------------------
    // API wrappers
    // ---------------------------
    async function readJsonSafe(response) {
      const text = await response.text();
      if (!text) return {};
      try { return JSON.parse(text); } catch { return { message: text }; }
    }

    async function apiGet(url) {
      const res = await fetch(url, { method: "GET", headers: { "Accept": "application/json" } });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || t("page.documents.api.getFail"));
      return data;
    }

    async function apiPost(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Accept": "application/json", "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || t("page.documents.api.saveFail"));
      return data;
    }

    async function apiDelete(url) {
      const res = await fetch(url, { method: "DELETE", headers: { "Accept": "application/json" } });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || t("page.documents.api.deleteFail"));
      return data;
    }

    // ---------------------------
    // Companies cache + typeahead
    // ---------------------------
    let companiesCache = null; // [{id,name,_norm}]
    let companiesLoading = false;

    async function loadCompaniesOnce() {
      if (companiesCache && Array.isArray(companiesCache) && companiesCache.length > 0) return companiesCache;
      if (companiesLoading) {
        // cheap wait loop
        for (let i = 0; i < 20; i++) {
          await new Promise(r => setTimeout(r, 150));
          if (companiesCache) return companiesCache;
        }
      }

      companiesLoading = true;
      try {
        // tenta padrÃµes comuns do backend
        const data = await apiGet("/api/companies");
        const list =
          Array.isArray(data) ? data :
          (Array.isArray(data?.data) ? data.data :
          (Array.isArray(data?.rows) ? data.rows :
          (Array.isArray(data?.companies) ? data.companies : [])));

        const mapped = (Array.isArray(list) ? list : [])
          .map((c) => ({
            id: String(c.id ?? c.company_id ?? c.companyId ?? "").trim(),
            name: String(c.company_name ?? c.companyName ?? c.name ?? "").trim(),
          }))
          .filter(x => x.id && x.name)
          .map((x) => ({ ...x, _norm: normalizeText(x.name) }));

        companiesCache = mapped;
        return companiesCache;
      } finally {
        companiesLoading = false;
      }
    }

    function destroyTypeaheadSafe($input) {
      try { $input.typeahead("destroy"); } catch { /* ignore */ }
    }

    async function bindCompanyTypeahead({ $nameInput, $idInput, $errorEl }) {
      const items = await loadCompaniesOnce();

      destroyTypeaheadSafe($nameInput);
      $nameInput.off(".cmpTa");

      $nameInput.typeahead({
        source: items,
        autoSelect: true,
        minLength: 0,
        displayText: function (item) { return item.name; },
        matcher: function (item) {
          const q = normalizeText(this.query);
          if (!q) return true;
          return item._norm.includes(q);
        },
        afterSelect: function (item) {
          $idInput.val(item.id);
          if ($errorEl) $errorEl.hide().text("");

          setTimeout(() => {
            try { $nameInput.typeahead("hide"); } catch { /* ignore */ }
            $nameInput.blur();
          }, 0);
        }
      });

      $nameInput.on("input.cmpTa", function () {
        $idInput.val("");
      });

      $nameInput.on("focus.cmpTa", function () {
        const hasText = String($(this).val() || "").trim().length > 0;
        if (!hasText) $(this).typeahead("lookup");
      });
    }

    function readRelatedFromModal() {
      // admin/root => must pick company in modal
      const relatedId = String($("#sm_related_company_id").val() || "").trim() || null;
      const relatedName = String($("#sm_related_company_name").val() || "").trim();

      return {
        relatedTable: relatedId ? "company" : null,
        relatedId,
        relatedName
      };
    }

    function requireRelatedCompanyIfAdminRoot(errorSelector) {
      if (!isAdminRoot()) return { ok: true, related: null };

      const r = readRelatedFromModal();
      if (!r.relatedId) {
        if (errorSelector) $(errorSelector).show().text(t("page.documents.messages.relatedCompanyRequired"));
        return { ok: false, related: null };
      }

      return { ok: true, related: { related_table: "company", related_id: r.relatedId } };
    }

    function renderRelatedCompanyFieldHtml() {
      return `
        <div id="sm_relatedWrap" class="form-group" style="display:none;">
          <label>${t("page.documents.modals.relatedCompany.label")}</label>
          <input
            id="sm_related_company_name"
            type="text"
            class="form-control"
            placeholder="${t("page.documents.modals.relatedCompany.placeholder")}"
            autocomplete="off"
          />
          <input id="sm_related_company_id" type="hidden" />
          <div class="small text-muted" style="margin-top:6px;">${t("page.documents.modals.relatedCompany.hint")}</div>
        </div>
      `;
    }

    async function ensureRelatedFieldWired(errorSelector) {
      if (!isAdminRoot()) {
        $("#sm_relatedWrap").hide();
        $("#sm_related_company_name").val("");
        $("#sm_related_company_id").val("");
        return;
      }

      $("#sm_relatedWrap").show();

      const $name = $("#sm_related_company_name");
      const $id = $("#sm_related_company_id");
      const $err = errorSelector ? $(errorSelector) : null;

      try {
        await bindCompanyTypeahead({ $nameInput: $name, $idInput: $id, $errorEl: $err });
      } catch (e) {
        if ($err) $err.show().text(e?.message || t("page.documents.messages.loadCompaniesFail"));
      }
    }

    // ---------------------------
    // Selection + rendering
    // ---------------------------
    function clearSelection() {
      state.selected.clear();
      $("#itemsGrid .file-box").removeClass("is-selected");
      updateTopActions();
    }

    function applySelectionClasses() {
      $("#itemsGrid .file-box").removeClass("is-selected");
      for (const selId of state.selected) {
        $('#itemsGrid .file-box[data-id="' + selId + '"]').addClass("is-selected");
      }
      updateTopActions();
    }

    function setSelected(id, single) {
      if (single) state.selected.clear();
      state.selected.add(id);
      applySelectionClasses();
    }

    function toggleSelected(id) {
      if (state.selected.has(id)) state.selected.delete(id);
      else state.selected.add(id);
      applySelectionClasses();
    }

    function renderGrid(items) {
      const $grid = $("#itemsGrid");
      $grid.empty();

      const list = Array.isArray(items) ? items : [];
      state.lastLoadedItems = list;

      if (list.length === 0) {
        $grid.append('<div class="col-lg-12 text-muted">' + escapeHtml(t("page.clientDetails.documents.messages.noneFound")) + '</div>');
        clearSelection();
        return;
      }
list.forEach(function (item) {
  const id = item.id;
  const name = escapeHtml(item.name || item.filename || t("page.documents.defaults.unnamed"));
  const added = formatDate(item.created_at);
  const iconHtml = iconFor(item);

  // âœ… NEW: show related badge ONLY in root
  const isRoot = state.currentParentId === null;

  const relatedTable = String(item?.related_table || "").trim().toLowerCase();
  const relatedName = String(item?.related_name || "").trim();

  function relatedIcon(table) {
    if (table === "company") return "fa-building";
    if (table === "process") return "fa-briefcase";
    return "fa-link";
  }

  function relatedLabelPrefix(table) {
    if (table === "company") return t("page.documents.related.company");
    if (table === "process") return t("page.documents.related.process");
    return t("page.documents.related.generic");
  }

  const relatedHtml =
    isRoot && relatedName
      ? `<span class="related-badge label label-primary" style='width: 95%;
    overflow: hidden;' title="${escapeHtml(relatedLabelPrefix(relatedTable))}">
           <i class="fa ${relatedIcon(relatedTable)}"></i>${escapeHtml(relatedName)}
         </span>`
      : "";

  $grid.append(`
    <div class="file-box" data-id="${escapeHtml(id)}" style="position:relative;">
      <div class="select-badge" title="${escapeHtml(t("page.clientDetails.documents.labels.select"))}">
        <i class="fa fa-check"></i>
      </div>

      <div class="file">
        <a href="javascript:void(0)" class="doc-hit" data-id="${escapeHtml(id)}" style="display:block;">
          <span class="corner"></span>
          <div class="icon">${iconHtml}</div>
          <div class="file-name" style="    color: #505050;">
            ${name}
            <br />
            ${relatedHtml}
            <small>${escapeHtml(t("page.clientDetails.documents.labels.added"))} ${escapeHtml(added || "-")}</small>
          </div>
        </a>
      </div>
    </div>
  `);
});


      $("#itemsGrid").off("click.bg").on("click.bg", function (e) {
        if ($(e.target).closest(".file-box").length === 0) clearSelection();
      });

      $("#itemsGrid .select-badge").off("click.sel").on("click.sel", function (e) {
        e.preventDefault();
        e.stopPropagation();
        const id = String($(this).closest(".file-box").data("id"));
        if (!id) return;
        toggleSelected(id);
      });

      $(".doc-hit").off("click").on("click", async function (e) {
        e.preventDefault();
        e.stopPropagation();

        const id = String($(this).data("id"));
        const now = Date.now();
        const isDouble = (state.lastClick.id === id && (now - state.lastClick.ts) < 320);
        state.lastClick = { id: id, ts: now };

        const item = state.lastLoadedItems.find(x => x.id === id);
        if (!item) return;

        const multi = !!(e.ctrlKey || e.metaKey) || state.selected.size > 0;

        if (isDouble) {
          await openItem(item);
          return;
        }

        if (multi) toggleSelected(id);
        else setSelected(id, true);
      });

      applySelectionClasses();
    }

    async function openItem(item) {
      if (!item) return;

      if (isFolder(item)) {
        state.navStack.push({ parentId: state.currentParentId, name: item.name || t("page.documents.defaults.folderName") });
        state.currentParentId = item.id;
        await loadCurrentFolder();
        return;
      }

      if (isLink(item)) {
        const url = isDriveLink(item)
          ? (item.object_key || item.external_key || "")
          : (item.external_key || item.object_key || "");

        if (url) window.open(url, "_blank", "noopener,noreferrer");
        return;
      }

      try {
        showLoading(true);
        const dl = await apiGet("/api/documents/" + encodeURIComponent(item.id) + "/presign-download");
        const url = dl?.url || dl?.downloadUrl || dl?.signedUrl;
        if (!url) throw new Error(t("page.clientDetails.documents.messages.downloadLinkFail"));
        window.open(url, "_blank", "noopener,noreferrer");
      } catch (err) {
        alert(err?.message || t("page.clientDetails.documents.messages.downloadFail"));
      } finally {
        showLoading(false);
      }
    }

    // ---------------------------
    // Left folders
    // ---------------------------
    async function loadLeftFolders() {
      try {
        const qs = new URLSearchParams();
        qs.set("parent_id", "null");
        qs.set("item_type", "FOLDER");
        qs.set("take", "500");
        qs.set("skip", "0");

        if (!window.__auth?.isAdmin) {
          const companyId = getUserCompanyId();
          qs.set("related_table", "company");
          qs.set("related_id", companyId || "00000000-0000-0000-0000-000000000000");
        }

        const q = ($("#txtSearchLeft").val() || "").trim();
        if (q) qs.set("q", q);

        const data = await apiGet("/api/documents?" + qs.toString());
        const list = Array.isArray(data) ? data : [];

        const $ul = $("#leftFolders");
        $ul.empty();

        if (list.length === 0) {
          $ul.append('<li class="text-muted">' + escapeHtml(t("page.documents.messages.noFolders")) + '</li>');
          return;
        }

        list.forEach(function (f) {
          $ul.append(`
            <li>
              <a href="javascript:void(0)" class="left-folder" data-id="${escapeHtml(f.id)}" data-name="${escapeHtml(f.name || t("page.documents.defaults.folderName"))}">
                <i class="fa fa-folder"></i> ${escapeHtml(f.name || t("page.documents.defaults.folderName"))}
              </a>
            </li>
          `);
        });

        $(".left-folder").off("click").on("click", async function (e) {
          e.preventDefault();
          const folderId = String($(this).data("id"));
          const folderName = String($(this).data("name") || t("page.documents.defaults.folderName"));

          state.navStack = [{ parentId: null, name: folderName }];
          state.currentParentId = folderId;
          await loadCurrentFolder();
        });
      } catch (e) {
        $("#leftFolders").html('<li class="text-danger">' + escapeHtml(t("page.documents.messages.loadFoldersFail")) + '</li>');
      }
    }

    async function loadCurrentFolder() {
      try {
        updateTopActions();
        showLoading(true);

        const query = buildListQuery();
        const data = await apiGet("/api/documents?" + query);

        renderGrid(data);
        clearSelection();
        await loadLeftFolders();
      } catch (e) {
        $("#itemsGrid").html('<div class="col-lg-12 text-danger">' + escapeHtml(e?.message || t("page.clientDetails.documents.messages.loadFail")) + '</div>');
      } finally {
        updateTopActions();
        showLoading(false);
      }
    }

    // ---------------------------
    // Upload flow
    // ---------------------------
    function getExtFromName(fileName) {
      const n = String(fileName || "");
      const idx = n.lastIndexOf(".");
      if (idx <= 0 || idx >= n.length - 1) return null;
      return n.substring(idx + 1).toLowerCase();
    }

    async function doUpload(file, accountId, displayNameRaw, progressCb, relatedOverride) {
      const fileName = file.name;
      const displayName = displayNameRaw || fileName;
      const mimeType = file.type || "application/octet-stream";
      const ext = getExtFromName(fileName);

      progressCb && progressCb(5, t("page.documents.progress.creatingRecord"));

      const createPayload = {
        account_id: accountId,
        parent_id: state.currentParentId,
        item_type: "FILE",
        name: displayName,
        filename: fileName,
        ext: ext,
        mime_type: mimeType
      };

      // âœ… new: admin root can override related company
      if (relatedOverride?.related_table && relatedOverride?.related_id) {
        createPayload.related_table = relatedOverride.related_table;
        createPayload.related_id = relatedOverride.related_id;
      } else if (!window.__auth?.isAdmin) {
        createPayload.related_table = "company";
        createPayload.related_id = getUserCompanyId();
      }

      const created = await apiPost("/api/documents", createPayload);
      const docId = created?.id;
      if (!docId) throw new Error(t("page.documents.messages.createRecordFail"));

      progressCb && progressCb(20, t("page.documents.progress.generatingUploadUrl"));

      const presign = await apiPost("/api/documents/" + encodeURIComponent(docId) + "/presign-upload", {
        fileName: fileName,
        contentType: mimeType,
        size: file.size
      });

      const putUrl = presign?.url;
      const putHeaders = presign?.headers || { "Content-Type": mimeType };
      const objectKey = presign?.object_key || presign?.key || null;

      if (!putUrl) throw new Error(t("page.documents.messages.uploadUrlFail"));

      progressCb && progressCb(45, t("page.documents.progress.uploadingToR2"));

      const putRes = await fetch(putUrl, { method: "PUT", headers: putHeaders, body: file });
      if (!putRes.ok) {
        const tRes = await putRes.text().catch(() => "");
        throw new Error((t("page.documents.messages.uploadFailedPrefix") + " (" + putRes.status + "). " + (tRes || "")).trim());
      }

      const etag = putRes.headers.get("etag") || presign?.etag || null;

      progressCb && progressCb(85, t("page.documents.progress.finalizing"));

      await apiPost("/api/documents/" + encodeURIComponent(docId) + "/complete-upload", {
        upload_status: "UPLOADED",
        object_key: objectKey,
        etag: etag,
        mime_type: mimeType,
        size_bytes: file.size
      });

      progressCb && progressCb(100, t("page.documents.progress.done"));
      return docId;
    }

    // ---------------------------
    // Side modal forms
    // ---------------------------
    function openNewFolderSideModal() {
      openSideModal({
        title: t("page.clientDetails.documents.modals.newFolder.title"),
        okText: t("page.clientDetails.documents.modals.newFolder.create"),
        cancelText: t("page.layout.modal.cancel"),
        bodyHtml: `
          ${renderRelatedCompanyFieldHtml()}

          <div class="form-group">
            <label>${t("page.clientDetails.documents.modals.newFolder.name")}</label>
            <input id="sm_folderName" type="text" class="form-control" maxlength="255" placeholder="${t("page.clientDetails.documents.modals.newFolder.placeholder")}" />
            <div id="sm_folderError" class="text-danger" style="margin-top:8px; display:none;"></div>
          </div>
        `,
        onOpen: async function () {
          await ensureRelatedFieldWired("#sm_folderError");
          setTimeout(function () { $("#sm_folderName").focus(); }, 120);
        },
        onOk: async function () {
          const name = ($("#sm_folderName").val() || "").trim();
          $("#sm_folderError").hide().text("");

          if (!name) {
            $("#sm_folderError").show().text(t("page.clientDetails.documents.modals.newFolder.nameRequired"));
            return true;
          }

          const accountId = getAccountIdForCreate();
          if (!accountId) {
            $("#sm_folderError").show().text(t("page.documents.messages.accountIdMissing"));
            return true;
          }

          // âœ… admin root must select related company
          const relCheck = requireRelatedCompanyIfAdminRoot("#sm_folderError");
          if (!relCheck.ok) return true;

          try {
            showLoading(true);

            const payload = {
              account_id: accountId,
              parent_id: state.currentParentId,
              item_type: "FOLDER",
              name: name,
              filename: null,
              storage_provider: "NONE"
            };

            if (relCheck.related) {
              payload.related_table = relCheck.related.related_table;
              payload.related_id = relCheck.related.related_id;
            } else if (!window.__auth?.isAdmin) {
              payload.related_table = "company";
              payload.related_id = getUserCompanyId();
            }

            await apiPost("/api/documents", payload);
            await loadCurrentFolder();
            return false;
          } catch (e) {
            $("#sm_folderError").show().text(e?.message || t("page.documents.messages.createFolderFail"));
            return true;
          } finally {
            showLoading(false);
          }
        }
      });
    }

    function openNewLinkSideModal() {
      openSideModal({
        title: t("page.clientDetails.documents.modals.newLink.title"),
        okText: t("page.clientDetails.documents.modals.newLink.save"),
        cancelText: t("page.layout.modal.cancel"),
        bodyHtml: `
          ${renderRelatedCompanyFieldHtml()}

          <div class="form-group">
            <label>${t("page.clientDetails.documents.modals.newFolder.name")}</label>
            <input id="sm_linkName" type="text" class="form-control" maxlength="255" placeholder="${t("page.documents.modals.newLink.namePlaceholder")}" />
          </div>
          <div class="form-group">
            <label>${t("page.documents.modals.newLink.urlLabel")}</label>
            <input id="sm_linkUrl" type="text" class="form-control" maxlength="1000" placeholder="${t("page.documents.modals.newLink.urlPlaceholder")}" />
            <small class="text-muted">${t("page.documents.modals.newLink.savedInObjectKey")}</small>
          </div>
          <div id="sm_linkError" class="text-danger" style="display:none;"></div>
        `,
        onOpen: async function () {
          await ensureRelatedFieldWired("#sm_linkError");
          setTimeout(function () { $("#sm_linkName").focus(); }, 120);
        },
        onOk: async function () {
          const name = ($("#sm_linkName").val() || "").trim();
          const url = ($("#sm_linkUrl").val() || "").trim();
          $("#sm_linkError").hide().text("");

          if (!name) { $("#sm_linkError").show().text(t("page.clientDetails.documents.modals.newLink.nameRequired")); return true; }
          if (!url || !/^https?:\/\//i.test(url)) { $("#sm_linkError").show().text(t("page.clientDetails.documents.modals.newLink.urlRequired")); return true; }

          const accountId = getAccountIdForCreate();
          if (!accountId) { $("#sm_linkError").show().text(t("page.documents.messages.accountIdMissing")); return true; }

          // âœ… admin root must select related company
          const relCheck = requireRelatedCompanyIfAdminRoot("#sm_linkError");
          if (!relCheck.ok) return true;

          try {
            showLoading(true);

            const payload = {
              account_id: accountId,
              parent_id: state.currentParentId,
              item_type: "LINK",
              name: name,
              filename: null,
              object_key: url,
              storage_provider: "DRIVE"
            };

            if (relCheck.related) {
              payload.related_table = relCheck.related.related_table;
              payload.related_id = relCheck.related.related_id;
            } else if (!window.__auth?.isAdmin) {
              payload.related_table = "company";
              payload.related_id = getUserCompanyId();
            }

            await apiPost("/api/documents", payload);
            await loadCurrentFolder();
            return false;
          } catch (e) {
            $("#sm_linkError").show().text(e?.message || t("page.documents.messages.saveLinkFail"));
            return true;
          } finally {
            showLoading(false);
          }
        }
      });
    }

    function openUploadSideModal() {
      openSideModal({
        title: t("page.clientDetails.documents.modals.upload.title"),
        okText: t("page.clientDetails.documents.modals.upload.send"),
        cancelText: t("page.layout.modal.cancel"),
        bodyHtml: `
          ${renderRelatedCompanyFieldHtml()}

          <div class="alert alert-info" style="margin-bottom:10px;">
            ${t("page.documents.modals.upload.singleFileOnly")}
          </div>

          <div class="form-group">
            <label>${t("page.documents.modals.upload.fileLabel")}</label>
            <input id="sm_uploadFile" type="file" class="form-control" />
          </div>

          <div class="form-group">
            <label>${t("page.clientDetails.documents.modals.newFolder.name")}</label>
            <input id="sm_uploadDisplayName" type="text" class="form-control" maxlength="255"
              placeholder="${t("page.documents.modals.upload.autoFillName")}" />
            <small class="text-muted">${t("page.documents.modals.upload.renameHint")}</small>
          </div>

          <div id="sm_uploadProgress" style="display:none;">
            <div class="progress progress-striped active">
              <div id="sm_uploadProgressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <small id="sm_uploadProgressText" class="text-muted"></small>
          </div>

          <div id="sm_uploadError" class="text-danger" style="display:none;"></div>
        `,
        onOpen: async function () {
          await ensureRelatedFieldWired("#sm_uploadError");

          // auto-fill name when file is picked
          setTimeout(function () {
            const $file = $("#sm_uploadFile");
            const $name = $("#sm_uploadDisplayName");

            $file.off("change.__autoname").on("change.__autoname", function () {
              const f = this.files && this.files[0];
              if (!f) return;
              $name.val(f.name || "");
              try { $name.focus(); } catch {}
            });

            try { document.getElementById("sm_uploadFile")?.focus(); } catch {}
          }, 30);
        },
        onOk: async function () {
          const input = document.getElementById("sm_uploadFile");
          const file = input && input.files && input.files[0];
          const displayNameRaw = ($("#sm_uploadDisplayName").val() || "").trim();
          $("#sm_uploadError").hide().text("");

          if (!file) { $("#sm_uploadError").show().text(t("page.clientDetails.documents.modals.upload.selectFile")); return true; }

          const accountId = getAccountIdForCreate();
          if (!accountId) { $("#sm_uploadError").show().text(t("page.documents.messages.accountIdMissingForUpload")); return true; }

          // âœ… admin root must select related company
          const relCheck = requireRelatedCompanyIfAdminRoot("#sm_uploadError");
          if (!relCheck.ok) return true;

          try {
            showLoading(true);
            $("#sm_uploadProgress").show();

            await doUpload(file, accountId, displayNameRaw, function (pct, text) {
              $("#sm_uploadProgressBar").css("width", String(Math.max(0, Math.min(100, pct || 0))) + "%");
              $("#sm_uploadProgressText").text(text || "");
            }, relCheck.related);

            await loadCurrentFolder();
            return false;
          } catch (e) {
            $("#sm_uploadError").show().text(e?.message || t("page.clientDetails.documents.modals.upload.error"));
            return true;
          } finally {
            showLoading(false);
          }
        }
      });
    }

    // ---------------------------
    // Delete / Open selected
    // ---------------------------
    async function deleteSelected() {
      if (state.selected.size === 0) return;

      const ok = await confirmAsync(t("page.documents.confirm.deleteMany"), { danger: true, okText: t("page.layout.modal.delete"), cancelText: t("page.layout.modal.cancel") });
      if (!ok) return;

      try {
        showLoading(true);
        const ids = Array.from(state.selected);
        for (const id of ids) {
          await apiDelete("/api/documents/" + encodeURIComponent(id));
        }
        await loadCurrentFolder();
        await loadLeftFolders();
      } catch (e) {
        alert(e?.message || t("page.clientDetails.documents.messages.deleteFail"));
      } finally {
        showLoading(false);
      }
    }

    async function openSelected() {
      if (state.selected.size !== 1) return;
      const id = Array.from(state.selected)[0];
      const item = state.lastLoadedItems.find(x => x.id === id);
      if (!item) return;
      await openItem(item);
    }

    // ---------------------------
    // Search-as-you-type (debounce)
    // ---------------------------
    function debounce(fn, waitMs) {
      let tmr = null;
      return function () {
        const args = arguments;
        clearTimeout(tmr);
        tmr = setTimeout(() => fn.apply(null, args), waitMs);
      };
    }

    const runRightSearchDebounced = debounce(async function () {
      state.currentSearch = ($("#txtSearch").val() || "").trim();
      await loadCurrentFolder();
    }, 280);

    const runLeftSearchDebounced = debounce(async function () {
      await loadLeftFolders();
    }, 280);

    // ---------------------------
    // Quick upload (admin root asks company)
    // ---------------------------
    function openQuickUploadCompanyPicker(file) {
      openSideModal({
        title: t("page.documents.quickUpload.pickCompanyTitle"),
        okText: t("page.clientDetails.documents.modals.upload.send"),
        cancelText: t("page.layout.modal.cancel"),
        bodyHtml: `
          ${renderRelatedCompanyFieldHtml()}
          <div class="form-group">
            <label>${t("page.documents.modals.upload.fileLabel")}</label>
            <input class="form-control" value="${escapeHtml(file?.name || "")}" readonly />
          </div>
          <div id="sm_quickError" class="text-danger" style="display:none;"></div>
        `,
        onOpen: async function () {
          await ensureRelatedFieldWired("#sm_quickError");
        },
        onOk: async function () {
          $("#sm_quickError").hide().text("");

          const accountId = getAccountIdForCreate();
          if (!accountId) { $("#sm_quickError").show().text(t("page.documents.messages.accountIdMissingForUpload")); return true; }

          const relCheck = requireRelatedCompanyIfAdminRoot("#sm_quickError");
          if (!relCheck.ok) return true;

          try {
            showLoading(true);
            await doUpload(file, accountId, "", null, relCheck.related);
            await loadCurrentFolder();
            return false;
          } catch (e) {
            $("#sm_quickError").show().text(e?.message || t("page.clientDetails.documents.modals.upload.error"));
            return true;
          } finally {
            showLoading(false);
          }
        }
      });
    }

    // ---------------------------
    // Wire UI
    // ---------------------------
    $(document).ready(async function () {
      state.currentParentId = null;
      state.navStack = [];
      updateTopActions();

      await loadCurrentFolder();
      await loadLeftFolders();

      $("#btnBack").on("click", async function () {
        state.navStack.pop();
        if (state.navStack.length === 0) state.currentParentId = null;
        await loadCurrentFolder();
      });

      $("#btnNewFolder").on("click", function (e) { e.preventDefault(); openNewFolderSideModal(); });
      $("#btnUploadDoc").on("click", function (e) { e.preventDefault(); openUploadSideModal(); });
      $("#btnNewLink").on("click", function (e) { e.preventDefault(); openNewLinkSideModal(); });

      $("#btnDeleteSelected").on("click", deleteSelected);
      $("#btnOpenSelected").on("click", openSelected);

      $("#btnSearch").on("click", async function () {
        state.currentSearch = ($("#txtSearch").val() || "").trim();
        await loadCurrentFolder();
      });

      $("#txtSearch").on("input keyup", function () {
        runRightSearchDebounced();
      });

      $("#txtSearch").on("keydown", async function (e) {
        if (e.key === "Enter") {
          state.currentSearch = ($("#txtSearch").val() || "").trim();
          await loadCurrentFolder();
        }
      });

      $("#btnSearchLeft").on("click", loadLeftFolders);

      $("#txtSearchLeft").on("input keyup", function () {
        runLeftSearchDebounced();
      });

      $("#txtSearchLeft").on("keydown", function (e) {
        if (e.key === "Enter") loadLeftFolders();
      });

      // Quick upload
      $("#btnAddQuickUpload").on("click", function () {
        const input = document.getElementById("fileQuickInput");
        if (input) input.click();
      });

      $("#fileQuickInput").on("change", async function () {
        const file = this.files && this.files[0];
        this.value = "";
        if (!file) return;

        // âœ… admin root must pick company for quick upload too
        if (isAdminRoot()) {
          openQuickUploadCompanyPicker(file);
          return;
        }

        const accountId = getAccountIdForCreate();
        if (!accountId) {
          alert(t("page.documents.messages.accountIdMissingForUpload"));
          return;
        }

        try {
          showLoading(true);
          await doUpload(file, accountId, "", null, null);
          await loadCurrentFolder();
        } catch (e) {
          alert(e?.message || t("page.clientDetails.documents.modals.upload.error"));
        } finally {
          showLoading(false);
        }
      });

      $(".dropdown-item").on("click", function (e) { e.preventDefault(); });
    });
  })();
</script>
