<div class="row">
  <!-- LEFT -->
  <div class="col-lg-3">
    <div class="ibox">
      <div class="ibox-content">
        <div class="file-manager">
          <div class="row" style="margin:0;">
            <h5 class="tag-title">Pastas</h5>

            <div class="input-group" style="margin: 8px 0 12px 0;">
              <input id="txtSearchLeft" type="text" class="form-control input-sm" placeholder="Buscar..." />
              <span class="input-group-btn">
                <button id="btnSearchLeft" class="btn btn-sm btn-primary" type="button">OK</button>
              </span>
            </div>

            <ul id="leftFolders" class="folder-list" style="padding:0;margin-top:10px;">
              <li class="text-muted">Carregando...</li>
            </ul>
          </div>

          <div class="hr-line-dashed"></div>
          <div class="clearfix"></div>

          <button class="btn btn-primary btn-block" id="btnAddQuickUpload" type="button" name="btn_act_new">
            <i class="fa fa-upload"></i> Upload r√°pido
          </button>
          <input type="file" style="display:none;" id="fileQuickInput" />

          <div style="margin-top:10px;" class="text-muted">
            <small>Voc√™ tamb√©m pode usar o bot√£o ‚ÄúAdicionar‚Äù no topo.</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="col-lg-9 animated fadeInRight">
    <!-- TOP BAR -->
    <div class="row" style="padding: 15px 15px;">
      <div class="col-lg-9" style="margin-left:-15px;">
        <button type="button" class="btn btn-primary" id="btnBack" style="display:none;">
          <i class="fa fa-arrow-left"></i> Voltar
        </button>

        <div class="btn-group" style="margin-left:8px;" name="btn_act_new">
          <button data-toggle="dropdown" class="btn btn-primary dropdown-toggle">
            Adicionar
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="btnNewFolder"><i class="fa fa-folder"></i> Nova Pasta</a></li>
            <li><a class="dropdown-item" href="#" id="btnUploadDoc"><i class="fa fa-upload"></i> Upload de Documento</a></li>
            <li><a class="dropdown-item" href="#" id="btnNewLink"><i class="fa fa-link"></i> Link do Drive</a></li>
          </ul>
        </div>

        <button type="button" class="btn btn-white" id="btnOpenSelected" style="margin-left:8px; display:none;">
          <i class="fa fa-external-link"></i> Abrir
        </button>

        <button type="button" class="btn btn-danger" id="btnDeleteSelected" style="margin-left:8px; display:none;">
          <i class="fa fa-trash"></i> Excluir
        </button>

        <span id="currentFolderLabel" class="text-muted" style="margin-left:12px;"></span>
        <span id="loadingBadge" class="label label-info" style="display:none;margin-left:10px;">Carregando...</span>
      </div>

      <div class="col-lg-3">
        <div class="input-group" style="margin: 0px 0 15px -15px;">
          <input id="txtSearch" type="text" class="form-control input-sm" placeholder="Buscar nesta pasta..." />
          <span class="input-group-btn">
            <button id="btnSearch" class="btn btn-sm btn-white" type="button"><i class="fa fa-search"></i></button>
          </span>
        </div>
      </div>
    </div>

    <!-- GRID -->
    <div class="row" id="itemsGrid">
      <div class="col-lg-12 text-muted">Carregando...</div>
    </div>
  </div>
</div>

<style>
  /* Drive-like selection */
  .file-box .file { cursor: default; }
  .file-box.is-selected .file {
    outline: 2px solid rgba(26, 179, 148, 0.45);
    box-shadow: 0 0 0 3px rgba(26, 179, 148, 0.12);
    border-radius: 4px;
  }

  /* NEW: selection check badge (top-left) */
  .file-box .select-badge {
    position: absolute;
    top: 6px;
    left: 6px;
    width: 22px;
    height: 22px;
    border-radius: 4px;
    background: rgba(255,255,255,0.95);
    border: 1px solid #d5d5d5;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 5;
    cursor: pointer;
  }
  .file-box .select-badge i {
    font-size: 14px;
    color: #1ab394; /* inspinia green */
  }
  .file-box.is-selected .select-badge {
    display: flex;
  }
  /* show hint on hover so user learns it exists */
  .file-box:hover .select-badge {
    display: flex;
    opacity: .75;
  }
  .file-box.is-selected:hover .select-badge {
    opacity: 1;
  }
</style>

<% contentFor('scripts') %>
<script>
  (function () {
    // ---------------------------
    // Page headers + permissions
    // ---------------------------
    $(document).ready(function () {
      $("#pageName").text("Meus Documentos");
      $("#subSecoundPageName").text("");
      $("#subpageName").text("Meus Documentos");
      $("#subpageName").attr("href", "MyDocuments");
      $("#path").hide();

      // Permissions (igual layout)
      if (window.__auth?.isUser) {
        $('a[name="btn_act_new"]').hide();
        $('button[name="btn_act_new"]').hide();
        $('input[name="btn_act_new"]').hide();
      } else if (window.__auth?.isManager) {
        $('a[name="btn_act_new"]').hide();
        $('button[name="btn_act_new"]').hide();
        $('input[name="btn_act_new"]').hide();
      } else if (window.__auth?.isAdmin) {
        // ok
      }
    });

    // ---------------------------
    // Side modal (GLOBAL - robust)
    // IMPORTANT: removes previous listeners by cloning buttons
    // ---------------------------
    function pickFirst(selectors) {
      for (const sel of selectors) {
        const el = document.querySelector(sel);
        if (el) return el;
      }
      return null;
    }

    function replaceWithClone(el) {
      if (!el || !el.parentNode) return el;
      const clone = el.cloneNode(true);
      el.parentNode.replaceChild(clone, el);
      return clone;
    }

    function openSideModal(opts) {
      const overlay = pickFirst(["#dynamicModalOverlay", ".dynamic-modal-overlay"]);
      const modal = pickFirst(["#dynamicModal", ".dynamic-modal"]);
      const titleEl = pickFirst(["#dynamicModalTitle", ".dynamic-modal-title"]);
      const bodyEl = pickFirst(["#dynamicModalBody", ".dynamic-modal-body"]);

      let btnClose = pickFirst(["#dynamicModalCloseBtn", ".dynamic-modal-close"]);
      let btnCancel = pickFirst(["#dynamicModalCancelBtn", ".dynamic-modal-cancel"]);
      let btnOk = pickFirst(["#dynamicModalOkBtn", ".dynamic-modal-ok"]);

      if (!overlay || !modal || !titleEl || !bodyEl || !btnOk) {
        alert("Side modal global n√£o encontrado no layout. Verifique IDs do dynamic modal.");
        return;
      }

      // üî• Remove any old listeners that other scripts attached
      btnOk = replaceWithClone(btnOk);
      if (btnCancel) btnCancel = replaceWithClone(btnCancel);
      if (btnClose) btnClose = replaceWithClone(btnClose);

      titleEl.textContent = (opts?.title || "");
      bodyEl.innerHTML = (opts?.bodyHtml || "");
      if (btnCancel) btnCancel.textContent = (opts?.cancelText || "Cancelar");
      btnOk.textContent = (opts?.okText || "OK");

      function close() {
        overlay.style.display = "none";
        modal.style.display = "none";
      }

      btnOk.addEventListener("click", async function (e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        const keepOpen = (typeof opts?.onOk === "function") ? await opts.onOk() : false;
        if (!keepOpen) close();
      }, true); // capture = true to beat other handlers

      if (btnCancel) {
        btnCancel.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          if (typeof opts?.onCancel === "function") opts.onCancel();
          close();
        }, true);
      }

      if (btnClose) {
        btnClose.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          if (typeof opts?.onCancel === "function") opts.onCancel();
          close();
        }, true);
      }

      overlay.style.display = "block";
      modal.style.display = "block";
    }

    // ---------------------------
    // State
    // ---------------------------
    const state = {
      currentParentId: null,     // null = root
      navStack: [],              // { parentId, name }
      selected: new Set(),       // ids
      currentSearch: "",
      lastLoadedItems: [],
      lastClick: { id: null, ts: 0 },
    };

    // ---------------------------
    // Helpers
    // ---------------------------
    function escapeHtml(value) {
      if (value == null) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showLoading(flag) {
      $("#loadingBadge").toggle(!!flag);
    }

    function isFolder(item) { return String(item?.item_type || "").toUpperCase() === "FOLDER"; }
    function isLink(item)   { return String(item?.item_type || "").toUpperCase() === "LINK"; }
    function isFile(item)   { return String(item?.item_type || "").toUpperCase() === "FILE"; }

    // NEW: identify drive link (either by storage_provider or item_type if you decide to add later)
    function isDriveLink(item) {
      const sp = String(item?.storage_provider || "").toUpperCase();
      const it = String(item?.item_type || "").toUpperCase();
      return sp === "DRIVE" || it === "DRIVE";
    }

    function iconFor(item) {
      if (isFolder(item)) return '<i class="fa fa-folder"></i>';
      if (isLink(item)) {
        if (isDriveLink(item)) return '<i class="fa fa-google"></i>';
        return '<i class="fa fa-link"></i>';
      }

      const ext = String(item?.ext || "").toLowerCase();
      const mime = String(item?.mime_type || "").toLowerCase();

      if (mime.startsWith("image/")) return '<i class="fa fa-file-image-o"></i>';
      if (mime.startsWith("video/")) return '<i class="fa fa-film"></i>';
      if (mime.startsWith("audio/")) return '<i class="fa fa-music"></i>';
      if (ext === "pdf") return '<i class="fa fa-file-pdf-o"></i>';
      if (ext === "xls" || ext === "xlsx" || mime.includes("spreadsheet")) return '<i class="fa fa-bar-chart-o"></i>';
      if (ext === "doc" || ext === "docx") return '<i class="fa fa-file-word-o"></i>';
      return '<i class="fa fa-file"></i>';
    }

    function formatDate(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString("pt-BR") + " " + d.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
    }

    function getUserCompanyId() {
      const id = window.__auth?.company_id || window.__auth?.companyId || null;
      return id ? String(id) : null;
    }

    // Ainda sem multitenant: accountId pode n√£o existir.
    // Para criar/upload, tentamos v√°rios fallbacks, e por √∫ltimo company_id.
    function getAccountIdForCreate() {
      const id =
        window.__auth?.accountId ||
        window.__auth?.account_id ||
        window.__auth?.account?.id ||
        window.__auth?.tenant_id ||
        window.__auth?.admin_account_id ||
        null;

      if (id) return String(id);

      const companyId = getUserCompanyId();
      return companyId ? String(companyId) : null;
    }

    function updateTopActions() {
      const count = state.selected.size;
      $("#btnDeleteSelected").toggle(count > 0);
      $("#btnOpenSelected").toggle(count === 1);
      $("#btnBack").toggle(state.navStack.length > 0);

      if (state.navStack.length === 0) {
        $("#currentFolderLabel").text("");
      } else {
        const parts = state.navStack.map(x => x.name || "Pasta");
        $("#currentFolderLabel").text(parts.join(" / "));
      }
    }

    function buildListQuery() {
      const qs = new URLSearchParams();

      if (state.currentParentId === null) qs.set("parent_id", "null");
      else qs.set("parent_id", state.currentParentId);

      if (state.currentSearch && state.currentSearch.trim()) qs.set("q", state.currentSearch.trim());

      qs.set("take", "500");
      qs.set("skip", "0");

      // ‚úÖ Permiss√£o: admin v√™ tudo, outros filtram por company
      if (!window.__auth?.isAdmin) {
        const companyId = getUserCompanyId();
        qs.set("related_table", "company");
        qs.set("related_id", companyId || "00000000-0000-0000-0000-000000000000");
      }

      return qs.toString();
    }

    // confirm compat√≠vel com override que retorna Promise
    async function confirmAsync(message, options) {
      try {
        const result = window.confirm(message, options);
        return await Promise.resolve(result);
      } catch {
        return false;
      }
    }

    // ---------------------------
    // API wrappers
    // ---------------------------
    async function readJsonSafe(response) {
      const text = await response.text();
      if (!text) return {};
      try { return JSON.parse(text); } catch { return { message: text }; }
    }

    async function apiGet(url) {
      const res = await fetch(url, { method: "GET", headers: { "Accept": "application/json" } });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || "Erro ao buscar dados");
      return data;
    }

    async function apiPost(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Accept": "application/json", "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || "Erro ao salvar");
      return data;
    }

    async function apiDelete(url) {
      const res = await fetch(url, { method: "DELETE", headers: { "Accept": "application/json" } });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || "Erro ao excluir");
      return data;
    }

    // ---------------------------
    // Selection + rendering
    // ---------------------------
    function clearSelection() {
      state.selected.clear();
      $("#itemsGrid .file-box").removeClass("is-selected");
      updateTopActions();
    }

    function applySelectionClasses() {
      $("#itemsGrid .file-box").removeClass("is-selected");
      for (const selId of state.selected) {
        $('#itemsGrid .file-box[data-id="' + selId + '"]').addClass("is-selected");
      }
      updateTopActions();
    }

    function setSelected(id, single) {
      if (single) state.selected.clear();
      state.selected.add(id);
      applySelectionClasses();
    }

    function toggleSelected(id) {
      if (state.selected.has(id)) state.selected.delete(id);
      else state.selected.add(id);
      applySelectionClasses();
    }

    function renderGrid(items) {
      const $grid = $("#itemsGrid");
      $grid.empty();

      const list = Array.isArray(items) ? items : [];
      state.lastLoadedItems = list;

      if (list.length === 0) {
        $grid.append('<div class="col-lg-12 text-muted">Nenhum item encontrado.</div>');
        clearSelection();
        return;
      }

      list.forEach(function (item) {
        const id = item.id;
        const name = escapeHtml(item.name || item.filename || "Sem nome");
        const added = formatDate(item.created_at);
        const iconHtml = iconFor(item);

        $grid.append(`
          <div class="file-box" data-id="${escapeHtml(id)}" style="position:relative;">
            <!-- NEW: selection badge (click to toggle multi selection) -->
            <div class="select-badge" title="Selecionar">
              <i class="fa fa-check"></i>
            </div>

            <div class="file">
              <a href="javascript:void(0)" class="doc-hit" data-id="${escapeHtml(id)}" style="display:block;">
                <span class="corner"></span>
                <div class="icon">${iconHtml}</div>
                <div class="file-name">
                  ${name}
                  <br />
                  <small>Adicionado: ${escapeHtml(added || "-")}</small>
                </div>
              </a>
            </div>
          </div>
        `);
      });

      // click on empty area clears selection
      $("#itemsGrid").off("click.bg").on("click.bg", function (e) {
        if ($(e.target).closest(".file-box").length === 0) clearSelection();
      });

      // NEW: badge click toggles selection (no Ctrl needed)
      $("#itemsGrid .select-badge").off("click.sel").on("click.sel", function (e) {
        e.preventDefault();
        e.stopPropagation();
        const id = String($(this).closest(".file-box").data("id"));
        if (!id) return;
        toggleSelected(id);
      });

      // single click select, double click open
      $(".doc-hit").off("click").on("click", async function (e) {
        e.preventDefault();
        e.stopPropagation();

        const id = String($(this).data("id"));
        const now = Date.now();
        const isDouble = (state.lastClick.id === id && (now - state.lastClick.ts) < 320);
        state.lastClick = { id: id, ts: now };

        const item = state.lastLoadedItems.find(x => x.id === id);
        if (!item) return;

        // Keep Ctrl behavior too, but now: if user already has selection, clicking other items adds to selection
        const multi = !!(e.ctrlKey || e.metaKey) || state.selected.size > 0;

        if (isDouble) {
          await openItem(item);
          return;
        }

        if (multi) toggleSelected(id);
        else setSelected(id, true);
      });

      applySelectionClasses();
    }

    async function openItem(item) {
      if (!item) return;

      if (isFolder(item)) {
        state.navStack.push({ parentId: state.currentParentId, name: item.name || "Pasta" });
        state.currentParentId = item.id;
        await loadCurrentFolder();
        return;
      }

      if (isLink(item)) {
        // NEW: Drive link uses object_key
        const url = isDriveLink(item)
          ? (item.object_key || item.external_key || "")
          : (item.external_key || item.object_key || "");

        if (url) window.open(url, "_blank", "noopener,noreferrer");
        return;
      }

      // FILE
      try {
        showLoading(true);
        const dl = await apiGet("/api/documents/" + encodeURIComponent(item.id) + "/presign-download");
        const url = dl?.url || dl?.downloadUrl || dl?.signedUrl;
        if (!url) throw new Error("N√£o foi poss√≠vel gerar o link de download.");
        window.open(url, "_blank", "noopener,noreferrer");
      } catch (err) {
        alert(err?.message || "Erro ao baixar arquivo.");
      } finally {
        showLoading(false);
      }
    }

    // ---------------------------
    // Left folders
    // ---------------------------
    async function loadLeftFolders() {
      try {
        const qs = new URLSearchParams();
        qs.set("parent_id", "null");
        qs.set("item_type", "FOLDER");
        qs.set("take", "500");
        qs.set("skip", "0");

        if (!window.__auth?.isAdmin) {
          const companyId = getUserCompanyId();
          qs.set("related_table", "company");
          qs.set("related_id", companyId || "00000000-0000-0000-0000-000000000000");
        }

        const q = ($("#txtSearchLeft").val() || "").trim();
        if (q) qs.set("q", q);

        const data = await apiGet("/api/documents?" + qs.toString());
        const list = Array.isArray(data) ? data : [];

        const $ul = $("#leftFolders");
        $ul.empty();

        if (list.length === 0) {
          $ul.append('<li class="text-muted">Nenhuma pasta.</li>');
          return;
        }

        list.forEach(function (f) {
          $ul.append(`
            <li>
              <a href="javascript:void(0)" class="left-folder" data-id="${escapeHtml(f.id)}" data-name="${escapeHtml(f.name || "Pasta")}">
                <i class="fa fa-folder"></i> ${escapeHtml(f.name || "Pasta")}
              </a>
            </li>
          `);
        });

        $(".left-folder").off("click").on("click", async function (e) {
          e.preventDefault();
          const folderId = String($(this).data("id"));
          const folderName = String($(this).data("name") || "Pasta");

          state.navStack = [{ parentId: null, name: folderName }];
          state.currentParentId = folderId;
          await loadCurrentFolder();
        });
      } catch (e) {
        $("#leftFolders").html('<li class="text-danger">Erro ao carregar pastas.</li>');
      }
    }

    async function loadCurrentFolder() {
      try {
        updateTopActions();
        showLoading(true);

        const query = buildListQuery();
        const data = await apiGet("/api/documents?" + query);

        renderGrid(data);
        clearSelection(); // reset selection on navigation/load
        await loadLeftFolders();
      } catch (e) {
        $("#itemsGrid").html('<div class="col-lg-12 text-danger">' + escapeHtml(e?.message || "Erro ao carregar") + '</div>');
      } finally {
        updateTopActions();
        showLoading(false);
      }
    }

    // ---------------------------
    // Upload flow
    // ---------------------------
    function getExtFromName(fileName) {
      const n = String(fileName || "");
      const idx = n.lastIndexOf(".");
      if (idx <= 0 || idx >= n.length - 1) return null;
      return n.substring(idx + 1).toLowerCase();
    }

    async function doUpload(file, accountId, displayNameRaw, progressCb) {
      const fileName = file.name;
      const displayName = displayNameRaw || fileName;
      const mimeType = file.type || "application/octet-stream";
      const ext = getExtFromName(fileName);

      progressCb && progressCb(5, "Criando registro no banco...");

      const createPayload = {
        account_id: accountId,
        parent_id: state.currentParentId,
        item_type: "FILE",
        name: displayName,
        filename: fileName,
        ext: ext,
        mime_type: mimeType
      };

      if (!window.__auth?.isAdmin) {
        createPayload.related_table = "company";
        createPayload.related_id = getUserCompanyId();
      }

      const created = await apiPost("/api/documents", createPayload);
      const docId = created?.id;
      if (!docId) throw new Error("Falha ao criar registro do documento.");

      progressCb && progressCb(20, "Gerando URL de upload...");

      const presign = await apiPost("/api/documents/" + encodeURIComponent(docId) + "/presign-upload", {
        fileName: fileName,
        contentType: mimeType,
        size: file.size
      });

      const putUrl = presign?.url;
      const putHeaders = presign?.headers || { "Content-Type": mimeType };
      const objectKey = presign?.object_key || presign?.key || null;

      if (!putUrl) throw new Error("N√£o foi poss√≠vel gerar a URL de upload.");

      progressCb && progressCb(45, "Enviando arquivo para o Cloudflare R2...");

      const putRes = await fetch(putUrl, { method: "PUT", headers: putHeaders, body: file });
      if (!putRes.ok) {
        const t = await putRes.text().catch(() => "");
        throw new Error(("Upload falhou (" + putRes.status + "). " + (t || "")).trim());
      }

      const etag = putRes.headers.get("etag") || presign?.etag || null;

      progressCb && progressCb(85, "Finalizando (atualizando status no banco)...");

      await apiPost("/api/documents/" + encodeURIComponent(docId) + "/complete-upload", {
        upload_status: "UPLOADED",
        object_key: objectKey,
        etag: etag,
        mime_type: mimeType,
        size_bytes: file.size
      });

      progressCb && progressCb(100, "Conclu√≠do!");
      return docId;
    }

    // ---------------------------
    // Side modal forms
    // ---------------------------
    function openNewFolderSideModal() {
      openSideModal({
        title: "Nova Pasta",
        okText: "Criar",
        cancelText: "Cancelar",
        bodyHtml: `
          <div class="form-group">
            <label>Nome</label>
            <input id="sm_folderName" type="text" class="form-control" maxlength="255" placeholder="Ex: Contratos" />
            <div id="sm_folderError" class="text-danger" style="margin-top:8px; display:none;"></div>
          </div>
        `,
        onOk: async function () {
          const name = ($("#sm_folderName").val() || "").trim();
          $("#sm_folderError").hide().text("");

          if (!name) {
            $("#sm_folderError").show().text("Informe o nome da pasta.");
            return true;
          }

          const accountId = getAccountIdForCreate();
          if (!accountId) {
            $("#sm_folderError").show().text("N√£o foi poss√≠vel identificar o account_id para criar.");
            return true;
          }

          try {
            showLoading(true);

            const payload = {
              account_id: accountId,
              parent_id: state.currentParentId,
              item_type: "FOLDER",
              name: name,
              filename: null,
              storage_provider: "NONE"
            };

            if (!window.__auth?.isAdmin) {
              payload.related_table = "company";
              payload.related_id = getUserCompanyId();
            }

            await apiPost("/api/documents", payload);
            await loadCurrentFolder();
            return false;
          } catch (e) {
            $("#sm_folderError").show().text(e?.message || "Erro ao criar pasta.");
            return true;
          } finally {
            showLoading(false);
          }
        }
      });

      setTimeout(function () { $("#sm_folderName").focus(); }, 150);
    }

    // NEW: Drive link -> create record only (object_key)
    function openNewLinkSideModal() {
      openSideModal({
        title: "Link do Drive",
        okText: "Salvar",
        cancelText: "Cancelar",
        bodyHtml: `
          <div class="form-group">
            <label>Nome</label>
            <input id="sm_linkName" type="text" class="form-control" maxlength="255" placeholder="Ex: Pasta do Google Drive" />
          </div>
          <div class="form-group">
            <label>URL</label>
            <input id="sm_linkUrl" type="text" class="form-control" maxlength="1000" placeholder="https://drive.google.com/..." />
            <small class="text-muted">O link ser√° salvo no campo <strong>object_key</strong>.</small>
          </div>
          <div id="sm_linkError" class="text-danger" style="display:none;"></div>
        `,
        onOk: async function () {
          const name = ($("#sm_linkName").val() || "").trim();
          const url = ($("#sm_linkUrl").val() || "").trim();
          $("#sm_linkError").hide().text("");

          if (!name) { $("#sm_linkError").show().text("Informe o nome."); return true; }
          if (!url || !/^https?:\/\//i.test(url)) { $("#sm_linkError").show().text("Informe uma URL v√°lida (http/https)."); return true; }

          const accountId = getAccountIdForCreate();
          if (!accountId) { $("#sm_linkError").show().text("N√£o foi poss√≠vel identificar o account_id para criar."); return true; }

          try {
            showLoading(true);

            const payload = {
              account_id: accountId,
              parent_id: state.currentParentId,
              item_type: "LINK",
              name: name,
              filename: null,

              // ‚úÖ requested: save link in object_key
              object_key: url,

              // mark as Drive link for UI behavior
              storage_provider: "DRIVE"
            };

            if (!window.__auth?.isAdmin) {
              payload.related_table = "company";
              payload.related_id = getUserCompanyId();
            }

            await apiPost("/api/documents", payload);
            await loadCurrentFolder();
            return false;
          } catch (e) {
            $("#sm_linkError").show().text(e?.message || "Erro ao salvar link.");
            return true;
          } finally {
            showLoading(false);
          }
        }
      });

      setTimeout(function () { $("#sm_linkName").focus(); }, 150);
    }

    function openUploadSideModal() {
      openSideModal({
        title: "Upload de Documento",
        okText: "Enviar",
        cancelText: "Cancelar",
        bodyHtml: `
          <div class="alert alert-info" style="margin-bottom:10px;">
            Selecione apenas um arquivo.
          </div>

          <div class="form-group">
            <label>Arquivo</label>
            <input id="sm_uploadFile" type="file" class="form-control" />
          </div>

          <div class="form-group">
            <label>Nome</label>
            <input id="sm_uploadDisplayName" type="text" class="form-control" maxlength="255"
              placeholder="Vamos preencher automaticamente com o nome do arquivo" />
            <small class="text-muted">Voc√™ pode alterar o nome antes de enviar.</small>
          </div>

          <div id="sm_uploadProgress" style="display:none;">
            <div class="progress progress-striped active">
              <div id="sm_uploadProgressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <small id="sm_uploadProgressText" class="text-muted"></small>
          </div>

          <div id="sm_uploadError" class="text-danger" style="display:none;"></div>
        `,
        onOk: async function () {
          const input = document.getElementById("sm_uploadFile");
          const file = input && input.files && input.files[0];
          const displayNameRaw = ($("#sm_uploadDisplayName").val() || "").trim();
          $("#sm_uploadError").hide().text("");

          if (!file) { $("#sm_uploadError").show().text("Selecione um arquivo."); return true; }

          const accountId = getAccountIdForCreate();
          if (!accountId) { $("#sm_uploadError").show().text("N√£o foi poss√≠vel identificar o account_id para enviar."); return true; }

          try {
            showLoading(true);
            $("#sm_uploadProgress").show();

            await doUpload(file, accountId, displayNameRaw, function (pct, text) {
              $("#sm_uploadProgressBar").css("width", String(Math.max(0, Math.min(100, pct || 0))) + "%");
              $("#sm_uploadProgressText").text(text || "");
            });

            await loadCurrentFolder();
            return false;
          } catch (e) {
            $("#sm_uploadError").show().text(e?.message || "Erro no upload.");
            return true;
          } finally {
            showLoading(false);
          }
        }
      });

      // NEW: auto-fill "Nome" when user picks file
      setTimeout(function () {
        const $file = $("#sm_uploadFile");
        const $name = $("#sm_uploadDisplayName");

        $file.off("change.__autoname").on("change.__autoname", function () {
          const f = this.files && this.files[0];
          if (!f) return;

          // always set to filename (user can edit after)
          $name.val(f.name || "");
          try { $name.focus(); } catch {}
        });

        // focus file input first
        try { document.getElementById("sm_uploadFile")?.focus(); } catch {}
      }, 50);
    }

    // ---------------------------
    // Delete / Open selected
    // ---------------------------
    async function deleteSelected() {
      if (state.selected.size === 0) return;

      const ok = await confirmAsync("Confirma excluir " + state.selected.size + " item(ns)?", { danger: true, okText: "Excluir", cancelText: "Cancelar" });
      if (!ok) return;

      try {
        showLoading(true);
        const ids = Array.from(state.selected);
        for (const id of ids) {
          await apiDelete("/api/documents/" + encodeURIComponent(id));
        }
        await loadCurrentFolder();
        await loadLeftFolders();
      } catch (e) {
        alert(e?.message || "Erro ao excluir.");
      } finally {
        showLoading(false);
      }
    }

    async function openSelected() {
      if (state.selected.size !== 1) return;
      const id = Array.from(state.selected)[0];
      const item = state.lastLoadedItems.find(x => x.id === id);
      if (!item) return;
      await openItem(item);
    }

    // ---------------------------
    // Search-as-you-type (debounce)
    // ---------------------------
    function debounce(fn, waitMs) {
      let t = null;
      return function () {
        const args = arguments;
        clearTimeout(t);
        t = setTimeout(() => fn.apply(null, args), waitMs);
      };
    }

    const runRightSearchDebounced = debounce(async function () {
      state.currentSearch = ($("#txtSearch").val() || "").trim();
      await loadCurrentFolder();
    }, 280);

    const runLeftSearchDebounced = debounce(async function () {
      await loadLeftFolders();
    }, 280);

    // ---------------------------
    // Wire UI
    // ---------------------------
    $(document).ready(async function () {
      state.currentParentId = null;
      state.navStack = [];
      updateTopActions();

      await loadCurrentFolder();
      await loadLeftFolders();

      $("#btnBack").on("click", async function () {
        state.navStack.pop();
        if (state.navStack.length === 0) state.currentParentId = null;
        await loadCurrentFolder();
      });

      $("#btnNewFolder").on("click", function (e) { e.preventDefault(); openNewFolderSideModal(); });
      $("#btnUploadDoc").on("click", function (e) { e.preventDefault(); openUploadSideModal(); });
      $("#btnNewLink").on("click", function (e) { e.preventDefault(); openNewLinkSideModal(); });

      $("#btnDeleteSelected").on("click", deleteSelected);
      $("#btnOpenSelected").on("click", openSelected);

      // RIGHT search: trigger while typing (and keep Enter + button)
      $("#btnSearch").on("click", async function () {
        state.currentSearch = ($("#txtSearch").val() || "").trim();
        await loadCurrentFolder();
      });

      $("#txtSearch").on("input keyup", function () {
        runRightSearchDebounced();
      });

      $("#txtSearch").on("keydown", async function (e) {
        if (e.key === "Enter") {
          state.currentSearch = ($("#txtSearch").val() || "").trim();
          await loadCurrentFolder();
        }
      });

      // LEFT search: trigger while typing (and keep Enter + button)
      $("#btnSearchLeft").on("click", loadLeftFolders);

      $("#txtSearchLeft").on("input keyup", function () {
        runLeftSearchDebounced();
      });

      $("#txtSearchLeft").on("keydown", function (e) {
        if (e.key === "Enter") loadLeftFolders();
      });

      // Quick upload
      $("#btnAddQuickUpload").on("click", function () {
        const input = document.getElementById("fileQuickInput");
        if (input) input.click();
      });

      $("#fileQuickInput").on("change", async function () {
        const file = this.files && this.files[0];
        this.value = "";
        if (!file) return;

        const accountId = getAccountIdForCreate();
        if (!accountId) {
          alert("N√£o foi poss√≠vel identificar o account_id para enviar o arquivo.");
          return;
        }

        try {
          showLoading(true);
          await doUpload(file, accountId, "", null);
          await loadCurrentFolder();
        } catch (e) {
          alert(e?.message || "Erro no upload.");
        } finally {
          showLoading(false);
        }
      });

      // Prevent dropdown page jump
      $(".dropdown-item").on("click", function (e) { e.preventDefault(); });
    });
  })();
</script>

