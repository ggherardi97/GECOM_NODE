<link rel="stylesheet" href="../Assets/inspinia/css/plugins/daterangepicker/daterangepicker-bs3.css">
<style>
  .ibox-title {
    padding: 15px 90px 20px 15px;
  }
.text-muted{
display: none !important;
}
  .sv-actions{
    margin-left: unset !important;
  }
  th.sortable {
    cursor: pointer;
    user-select: none;
  }

  th.sortable .sort-indicator {
    margin-left: 6px;
    font-size: 11px;
    opacity: .75;
  }

  .clicker {
    cursor: pointer;
  }

  /* Bulk actions bar (igual clientes) */
  .bulk-actions {
    display: none;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    background: #f3f3f4;
    border: 1px solid #e7eaec;
    border-radius: 4px;
    margin-bottom: 10px;
  }

  .bulk-actions .count {
    font-weight: 600;
  }

  .bulk-actions .btn {
    margin: 0;
  }
  .sv-actions { margin-left: unset !important; }
  #invoicesSavedViewsHost .sv-bar { margin-top: -2px; }
  th.sv-fixed-col, td.sv-fixed-col { display: table-cell !important; visibility: visible !important; }
  .sv-date-filter .input-group-addon { padding: 3px 8px; cursor: pointer; }

  /* Role-based UI */
  .admin-only { }
  .not-admin .admin-only { display: none !important; }
</style>

<div class="row animated fadeInRight" style="margin-top:25px;">
  <div class="col-lg-12">
    <div class="ibox">
      <div class="ibox-title">
        <div id="invoicesSavedViewsHost"></div>
        <div class="ibox-tools">
          <a href="/NewInvoice" name="btn_act_new" class="btn btn-sm btn-primary admin-only" id="btnNewInvoice">
            <%= t('page.invoices.toolbar.newInvoice') %>
          </a>
        </div>
      </div>

      <div class="ibox-content">

        <!-- Bulk actions -->
        <div id="bulkActions" class="bulk-actions admin-only">
          <span class="count"><%= t('page.invoices.toolbar.selected') %> <span id="selectedCount">0</span></span>

          <button id="btnBulkSend" type="button" class="btn btn-success btn-sm">
            <i class="fa fa-send"></i> <%= t('page.invoices.toolbar.sendToClient') %>
          </button>
          <button id="btnBulkClone" type="button" class="btn btn-warning btn-sm">
            <i class="fa fa-clone"></i> <%= t('page.invoices.actions.clone') %>
          </button>

          <button id="btnBulkDelete" type="button" class="btn btn-danger btn-sm">
            <i class="fa fa-trash"></i> <%= t('page.invoices.toolbar.delete') %>
          </button>

          <button id="btnClearSelection" type="button" class="btn btn-white btn-sm">
            <%= t('page.invoices.toolbar.clearSelection') %>
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-striped" id="invoices">
            <thead>
              <!-- Filters -->
              <tr id="invoicesFiltersRow">
                <th style="width:40px;" class="admin-only sv-fixed-col" data-field="__select" data-sv-fixed="left">
                  <input id="chkSelectAll" type="checkbox" title="<%= t('page.invoices.bulk.selectAll') %>">
                </th>
                <th data-field="rowNumber"></th>
                <th data-field="invoice_number"><input class="form-control input-sm" data-filter="invoice_number" placeholder="<%= t('page.invoices.filters.invoiceNumber') %>" /></th>
                <th data-field="company"><input class="form-control input-sm" data-filter="company" placeholder="<%= t('page.invoices.filters.company') %>" /></th>
                <th data-field="status">
                  <select class="form-control input-sm" data-filter="status_config_id" id="statusFilter">
                    <option value=""><%= t('page.invoices.filters.all') %></option>
                  </select>
                </th>

                <th data-field="subtotal"><input class="form-control input-sm" data-filter="subtotal" placeholder="<%= t('page.invoices.columns.subtotal') %>" /></th>
                <!-- âœ… NEW: desconto antes de impostos -->
                <th data-field="discount_amount"><input class="form-control input-sm" data-filter="discount_amount" placeholder="<%= t('page.invoices.columns.discount') %>" /></th>
                <th data-field="tax_total"><input class="form-control input-sm" data-filter="tax_total" placeholder="<%= t('page.invoices.columns.taxes') %>" /></th>
                <th data-field="total"><input class="form-control input-sm" data-filter="total" placeholder="<%= t('page.invoices.columns.total') %>" /></th>
                <!-- âœ… REMOVED: issued_at (Emitida) -->
                <th class="sv-date-filter" data-field="due_at">
                  <div class="input-group">
                    <input id="dueAtRangeFilter" type="text" class="form-control input-sm" placeholder="<%= t('page.layout.savedViews.dateRangePlaceholder') %>" autocomplete="off" />
                    <span class="input-group-addon" id="dueAtRangeBtn"><i class="fa fa-calendar"></i></span>
                  </div>
                  <input id="dueAtFromFilter" type="hidden" />
                  <input id="dueAtToFilter" type="hidden" />
                </th>
              </tr>

              <!-- Headers -->
              <tr id="invoicesHeaderRow">
                <th style="width:40px;" class="admin-only sv-fixed-col" data-sort-key="__select" data-field="__select" data-sv-fixed="left"></th>
                <th style="width:60px;" class="sortable" data-sort="rowNumber" data-sort-key="rowNumber" data-field="rowNumber"># <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort="invoice_number" data-sort-key="invoice_number" data-field="invoice_number"><%= t('page.invoices.columns.invoice') %> <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort="company" data-sort-key="company" data-field="company"><%= t('page.invoices.columns.company') %> <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort="status" data-sort-key="status" data-field="status"><%= t('page.invoices.columns.status') %> <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort="subtotal" data-sort-key="subtotal" data-field="subtotal"><%= t('page.invoices.columns.subtotal') %> <span class="sort-indicator"></span></th>
                <!-- âœ… NEW -->
                <th class="sortable" data-sort="discount_amount" data-sort-key="discount_amount" data-field="discount_amount"><%= t('page.invoices.columns.discount') %> <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort="tax_total" data-sort-key="tax_total" data-field="tax_total"><%= t('page.invoices.columns.taxes') %> <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort="total" data-sort-key="total" data-field="total"><%= t('page.invoices.columns.total') %> <span class="sort-indicator"></span></th>
                <!-- âœ… REMOVED -->
                <th class="sortable" data-sort="due_at" data-sort-key="due_at" data-field="due_at"><%= t('page.invoices.columns.dueDate') %> <span class="sort-indicator"></span></th>
              </tr>
            </thead>

            <tbody id="invoiceLines"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="../Assets/inspinia/js/plugins/fullcalendar/moment.min.js"></script>
<script src="../Assets/inspinia/js/plugins/daterangepicker/daterangepicker.js"></script>
<script>

      $("#pageName").text("<%= t('page.invoices.pageTitle') %>");
      $("#subSecoundPageName").text("");
      $("#subpageName").text("<%= t('page.invoices.pageTitle') %>");
      $("#subpageName").attr("href", "Invoices");
      $("#path").hide();

  // --------------------
  // Auth / Roles (from layout.ejs)
  // --------------------
  const auth = (window && window.__auth) ? window.__auth : {};
  const authRole = String(auth.role || auth.userRole || "").toUpperCase();

  const isAdmin =
    auth.isAdmin === true ||
    authRole === "ADMIN" ||
    (Array.isArray(auth.roles) && auth.roles.map(r => String(r).toUpperCase()).includes("ADMIN"));

  const companyId =
    auth.companyId ||
    auth.company_id ||
    auth.company?.id ||
    auth.company?.company_id ||
    null;

  // Apply a CSS flag on body to hide admin-only sections
  (function applyRoleCss() {
    const body = document.body;
    if (!body) return;
    if (!isAdmin) body.classList.add("not-admin");
  })();

  // --------------------
  // State
  // --------------------
  let invoices = [];
  let filteredInvoices = [];
  let sortState = { key: null, dir: "asc" };
  let invoiceStatusOptions = [];
  const invoiceStatusByConfigId = {};
  const invoiceStatusByLegacy = {};
  const savedViewsState = { viewId: null, name: "", columns: [], columns_order: [], filters: [], sort: [] };

  const selectedInvoiceIds = new Set();
  const filterState = {
    invoice_number: "",
    company: "",
    status_config_id: "",
    subtotal: "",
    discount_amount: "", // âœ… NEW
    tax_total: "",
    total: "",
    due_at: "",
    due_at_from: "",
    due_at_to: "",
  };

  // --------------------
  // Utils
  // --------------------
  function escapeHtml(value) {
    if (value == null) return "";
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function toNumber(value) {
    const raw = String(value ?? "").trim();
    if (!raw) return 0;
    const normalized = raw
      .replace(/\s+/g, "")
      .replace(/[^\d,.\-]/g, "")
      .replace(/\.(?=\d{3}(\D|$))/g, "")
      .replace(",", ".");
    const n = Number(normalized);
    return Number.isFinite(n) ? n : 0;
  }

  function formatDate(v) {
    if (!v) return "";
    const d = new Date(v);
    if (Number.isNaN(d.getTime())) return "";
    return d.toLocaleDateString("pt-BR");
  }

  function parsePtDateToTs(value, endOfDay) {
    const raw = String(value || "").trim();
    const m = raw.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (!m) return NaN;
    const h = endOfDay ? 23 : 0;
    const min = endOfDay ? 59 : 0;
    const sec = endOfDay ? 59 : 0;
    const d = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]), h, min, sec, endOfDay ? 999 : 0);
    return d.getTime();
  }

  function extractCompanyName(inv) {
    return (
      inv?.companies?.company_name ||
      inv?.company?.company_name ||
      inv?.company_name ||
      inv?.companyName ||
      ""
    );
  }

  function extractCurrency(inv) {
    const rel = inv?.currencies || inv?.currency || null;
    const code =
      rel?.code ||
      rel?.iso_code ||
      rel?.currency_code ||
      inv?.currency_code ||
      inv?.currencyCode ||
      null;

    const symbol =
      rel?.symbol ||
      inv?.currency_symbol ||
      inv?.currencySymbol ||
      null;

    const decimals = Number.isFinite(Number(rel?.decimals)) ? Number(rel.decimals) : 2;

    return { code, symbol, decimals };
  }

  function formatMoney(value, inv) {
    const n = toNumber(value);
    const { code, symbol, decimals } = extractCurrency(inv);

    if (code) {
      try {
        return new Intl.NumberFormat("pt-BR", {
          style: "currency",
          currency: code,
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals,
        }).format(n);
      } catch (e) {
        // ignore invalid currency code
      }
    }

    const num = new Intl.NumberFormat("pt-BR", {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals,
    }).format(n);

    if (symbol) return `${symbol} ${num}`;
    return num;
  }

  function normalizeStatusConfigId(value) {
    const id = String(value || "").trim();
    return id || "";
  }

  function getInvoiceLegacyStatus(inv) {
    const n = Number(inv?.status);
    return Number.isFinite(n) ? n : null;
  }

  function getInvoiceStatusConfigId(inv) {
    return normalizeStatusConfigId(
      inv?.status_config_id ??
      inv?.statusConfigId ??
      inv?.status_config?.id ??
      inv?.statusConfig?.id ??
      ""
    );
  }

  function getInvoiceStatusDirect(inv) {
    const direct = inv?.status_config || inv?.statusConfig || null;
    return direct && typeof direct === "object" ? direct : null;
  }

  function getStatusOptionBySelection(selectionValue) {
    const key = String(selectionValue || "").trim();
    if (!key) return null;
    const byId = invoiceStatusByConfigId[key];
    if (byId) return byId;
    if (key.startsWith("legacy:")) {
      const legacy = Number(key.slice("legacy:".length));
      if (Number.isFinite(legacy)) return invoiceStatusByLegacy[legacy] || null;
    }
    return null;
  }

  function getStatusSelectionByLegacy(legacyStatus) {
    if (!Number.isFinite(legacyStatus)) return "";
    const byLegacy = invoiceStatusByLegacy[legacyStatus];
    if (!byLegacy) return `legacy:${legacyStatus}`;
    return byLegacy.id ? byLegacy.id : `legacy:${legacyStatus}`;
  }

  function statusLabel(statusConfigId, legacyStatus, statusConfig) {
    const directLabel = String(statusConfig?.label || "").trim();
    if (directLabel) return directLabel;

    const byId = invoiceStatusByConfigId[normalizeStatusConfigId(statusConfigId)];
    if (byId?.label) return byId.label;

    if (Number.isFinite(legacyStatus)) {
      const byLegacy = invoiceStatusByLegacy[legacyStatus];
      if (byLegacy?.label) return byLegacy.label;
      return `Status ${legacyStatus}`;
    }

    return "-";
  }

  function statusColor(statusConfigId, legacyStatus, statusConfig) {
    const directColor = String(statusConfig?.color || "").trim();
    if (directColor) return directColor;

    const byId = invoiceStatusByConfigId[normalizeStatusConfigId(statusConfigId)];
    if (byId?.color) return byId.color;

    if (Number.isFinite(legacyStatus)) {
      const byLegacy = invoiceStatusByLegacy[legacyStatus];
      return String(byLegacy?.color || "").trim();
    }

    return "";
  }

  function getDefaultInvoiceStatusOptions() {
    return [
      { id: "", legacy: 0, label: "<%= t('page.invoices.status.draft') %>", color: "" },
      { id: "", legacy: 1, label: "<%= t('page.invoices.status.active') %>", color: "" },
      { id: "", legacy: 2, label: "<%= t('page.invoices.status.expired') %>", color: "" },
      { id: "", legacy: 3, label: "<%= t('page.invoices.status.billed') %>", color: "" },
      { id: "", legacy: 4, label: "<%= t('page.invoices.status.paid') %>", color: "" },
    ];
  }

  function toRows(data) {
    if (Array.isArray(data)) return data;
    if (Array.isArray(data?.data)) return data.data;
    if (Array.isArray(data?.rows)) return data.rows;
    if (Array.isArray(data?.items)) return data.items;
    return [];
  }

  async function loadStatusConfigs() {
    try {
      const resp = await fetch("/api/status-configs?entity=INVOICE&active=true", {
        method: "GET",
        headers: { Accept: "application/json" }
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) throw new Error(data?.message || "<%= t('page.invoices.errors.loadFailed') %>");

      const options = toRows(data)
        .map((row) => ({
          id: normalizeStatusConfigId(row?.id),
          legacy: Number(row?.legacy_int_value),
          label: String(row?.label || "").trim(),
          color: String(row?.color || "").trim(),
          sort: Number(row?.sort_order || 0),
        }))
        .filter((x) => x.id && x.label)
        .sort((a, b) => (a.sort - b.sort) || String(a.label).localeCompare(String(b.label), "pt-BR"));

      invoiceStatusOptions = options.length ? options : getDefaultInvoiceStatusOptions();
    } catch (e) {
      console.warn("loadStatusConfigs invoice fallback:", e);
      invoiceStatusOptions = getDefaultInvoiceStatusOptions();
    }

    Object.keys(invoiceStatusByConfigId).forEach((k) => delete invoiceStatusByConfigId[k]);
    Object.keys(invoiceStatusByLegacy).forEach((k) => delete invoiceStatusByLegacy[k]);
    invoiceStatusOptions.forEach((opt) => {
      if (opt.id) invoiceStatusByConfigId[opt.id] = opt;
      if (Number.isFinite(opt.legacy) && !invoiceStatusByLegacy[opt.legacy]) invoiceStatusByLegacy[opt.legacy] = opt;
    });
  }

  function renderStatusFilterOptions() {
    const statusEl = document.getElementById("statusFilter");
    if (!statusEl) return;
    const current = String(filterState.status_config_id || "");
    const allLabel = "<%= t('page.invoices.filters.all') %>";
    const options = invoiceStatusOptions
      .filter((x) => isAdmin || Number(x.legacy) !== 0);

    statusEl.innerHTML = `<option value="">${escapeHtml(allLabel)}</option>`;
    options.forEach((opt) => {
      const option = document.createElement("option");
      option.value = String(opt.id || `legacy:${opt.legacy}`);
      option.textContent = opt.label;
      statusEl.appendChild(option);
    });

    if (options.some((x) => String(x.id || `legacy:${x.legacy}`) === current)) {
      statusEl.value = current;
    } else {
      if (isAdmin) {
        statusEl.value = "";
        filterState.status_config_id = "";
      } else {
        const active = options.find((x) => Number(x.legacy) === 1) || options[0] || null;
        const selected = active ? String(active.id || `legacy:${active.legacy}`) : "";
        statusEl.value = selected;
        filterState.status_config_id = selected;
      }
    }
  }

  function setBulkActionsVisible(isVisible) {
    const bar = document.getElementById("bulkActions");
    if (!bar) return;
    bar.style.display = isVisible ? "flex" : "none";
  }

  function updateBulkUI() {
    if (!isAdmin) return;

    const countEl = document.getElementById("selectedCount");
    if (countEl) countEl.textContent = String(selectedInvoiceIds.size);

    setBulkActionsVisible(selectedInvoiceIds.size > 0);

    const chkAll = document.getElementById("chkSelectAll");
    if (chkAll) {
      const rowChecks = document.querySelectorAll("input.invoice-check");
      const total = rowChecks.length;
      const checked = Array.from(rowChecks).filter((x) => x.checked).length;
      chkAll.checked = total > 0 && checked === total;
      chkAll.indeterminate = checked > 0 && checked < total;
    }
  }

  async function runWithConcurrency(items, limit, worker) {
    const queue = [...items];
    const workers = Array.from({ length: Math.min(limit, items.length) }, async () => {
      while (queue.length > 0) {
        const item = queue.shift();
        await worker(item);
      }
    });
    await Promise.all(workers);
  }

  // --------------------
  // API
  // --------------------
  function fetchInvoices() {
    const qs = new URLSearchParams();
    const selectedStatus = String(filterState.status_config_id || "").trim();
    const selectedOption = getStatusOptionBySelection(selectedStatus);

    // Non-admin: filter by company_id == auth.company_id
    if (!isAdmin && companyId) {
      qs.set("company_id", String(companyId));
    }

    if (selectedStatus) {
      if (selectedOption?.id) qs.set("status_config_id", selectedOption.id);
      else if (Number.isFinite(selectedOption?.legacy)) qs.set("status", String(selectedOption.legacy));
    } else if (!isAdmin) {
      const active = invoiceStatusByLegacy[1];
      if (active?.id) qs.set("status_config_id", active.id);
      else qs.set("status", "1");
    }

    const url = qs.toString() ? `/api/invoices?fields=header&${qs.toString()}` : `/api/invoices?fields=header`;

    return fetch(url, { headers: { Accept: "application/json" } })
      .then(r => r.json());
  }

  async function patchInvoiceStatus(invoiceId, statusSelection) {
    const option = getStatusOptionBySelection(statusSelection);
    const payload = {};
    if (option?.id) payload.status_config_id = option.id;
    if (Number.isFinite(option?.legacy)) payload.status = option.legacy;
    if (Object.keys(payload).length === 0) {
      const fallback = Number(statusSelection);
      payload.status = Number.isFinite(fallback) ? fallback : 1;
    }

    const resp = await fetch(`/api/invoices/${encodeURIComponent(invoiceId)}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json", Accept: "application/json" },
      body: JSON.stringify(payload),
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data?.message || "<%= t('page.invoices.errors.updateStatusFailed') %>");
    return data;
  }

  async function deleteInvoiceById(invoiceId) {
    const resp = await fetch(`/api/invoices/${encodeURIComponent(invoiceId)}`, {
      method: "DELETE",
      headers: { Accept: "application/json" },
    });

    if (resp.status === 204) return {};
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data?.message || "<%= t('page.invoices.errors.deleteFailed') %>");
    return data;
  }

  async function cloneInvoiceById(invoiceId) {
    const resp = await fetch(`/api/invoices/${encodeURIComponent(invoiceId)}/clone`, {
      method: "POST",
      headers: { Accept: "application/json", "Content-Type": "application/json" },
      body: JSON.stringify({}),
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data?.message || "<%= t('page.invoices.errors.cloneFailed') %>");
    return data;
  }

  // --------------------
  // Modal helpers (GlobalModal do layout)
  // --------------------
  function showConfirmModal(title, bodyHtml, confirmText, confirmBtnClass) {
    const modalBtn = document.getElementById("modalButton");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const btnSave = document.getElementById("saveModal");
    const btnClose = document.getElementById("closeModal");

    if (!modalBtn || !modalTitle || !modalBody || !btnSave || !btnClose) {
      const ok = confirm(title);
      return Promise.resolve(ok);
    }

    modalTitle.textContent = title;
    modalBody.innerHTML = bodyHtml;

    btnSave.textContent = confirmText || "<%= t('page.invoices.modal.confirm') %>";

    btnSave.classList.remove("btn-primary", "btn-danger", "btn-success", "btn-warning");
    btnSave.classList.add(confirmBtnClass || "btn-primary");

    btnClose.textContent = "<%= t('page.invoices.modal.cancel') %>";

    return new Promise((resolve) => {
      const cleanup = () => {
        btnSave.onclick = null;
        btnClose.onclick = null;

        btnSave.classList.remove("btn-danger", "btn-success", "btn-warning");
        btnSave.classList.add("btn-primary");
        btnSave.textContent = "<%= t('page.invoices.modal.save') %>";
        btnClose.textContent = "<%= t('page.invoices.modal.close') %>";
      };

      btnSave.onclick = () => { cleanup(); resolve(true); };
      btnClose.onclick = () => { cleanup(); resolve(false); };

      modalBtn.click();
    });
  }

  // --------------------
  // Mapping / normalize
  // --------------------
  function normalizeInvoice(inv, index) {
    const companyName = extractCompanyName(inv);
    const legacyStatus = getInvoiceLegacyStatus(inv);
    const statusConfigId = getInvoiceStatusConfigId(inv);
    const statusConfig = getInvoiceStatusDirect(inv);
    const selectionValue = statusConfigId || (Number.isFinite(legacyStatus) ? `legacy:${legacyStatus}` : "");
    return {
      raw: inv,
      id: String(inv?.id || ""),
      company_id: String(inv?.company_id || inv?.companyId || ""),
      invoice_number: inv?.invoice_number || inv?.invoiceNumber || "",
      company: companyName,
      status: Number.isFinite(legacyStatus) ? legacyStatus : 0,
      status_config_id: statusConfigId,
      status_selection: selectionValue,
      status_label: statusLabel(statusConfigId, legacyStatus, statusConfig),
      status_color: statusColor(statusConfigId, legacyStatus, statusConfig),
      subtotal: inv?.subtotal ?? 0,
      discount_amount: inv?.discount_amount ?? inv?.discountAmount ?? 0, // âœ… NEW
      tax_total: inv?.tax_total ?? inv?.taxTotal ?? 0,
      total: inv?.total ?? 0,
      rowNumber: Number(index || 0) + 1,
      // issued_at removido da UI (mas pode continuar existindo no payload sem problema)
      due_at: inv?.due_at ?? inv?.dueAt ?? null,
    };
  }

  // --------------------
  // Filtering / Sorting
  // --------------------
  function applyFilters() {
    const f = filterState;

    const contains = (value, term) => {
      const v = String(value ?? "").toLowerCase();
      const t = String(term ?? "").toLowerCase().trim();
      if (!t) return true;
      return v.includes(t);
    };

    filteredInvoices = invoices.filter((x) => {
      const inv = x.raw;
      const selectedStatus = String(f.status_config_id || "").trim();
      const selectedOption = getStatusOptionBySelection(selectedStatus);
      const dueTs = x.due_at ? new Date(x.due_at).getTime() : NaN;
      const dueFromTs = parsePtDateToTs(f.due_at_from, false);
      const dueToTs = parsePtDateToTs(f.due_at_to, true);
      const dueRangeOk =
        (Number.isNaN(dueFromTs) || (!Number.isNaN(dueTs) && dueTs >= dueFromTs)) &&
        (Number.isNaN(dueToTs) || (!Number.isNaN(dueTs) && dueTs <= dueToTs));

      return (
        contains(x.invoice_number, f.invoice_number) &&
        contains(x.company, f.company) &&
        (
          !selectedStatus
            ? true
            : (
                (selectedOption?.id && String(x.status_config_id || "") === String(selectedOption.id)) ||
                (Number.isFinite(selectedOption?.legacy) && Number(x.status) === Number(selectedOption.legacy))
              )
        ) &&
        contains(formatMoney(x.subtotal, inv), f.subtotal) &&
        contains(formatMoney(x.discount_amount, inv), f.discount_amount) &&
        contains(formatMoney(x.tax_total, inv), f.tax_total) &&
        contains(formatMoney(x.total, inv), f.total) &&
        dueRangeOk
      );
    });

    if (sortState.key) {
      sortData(sortState.key, true);
      return;
    }

    renderTable(filteredInvoices);
  }

  function compareValues(a, b) {
    if (a == null && b == null) return 0;
    if (a == null) return -1;
    if (b == null) return 1;

    if (a instanceof Date && b instanceof Date) return a.getTime() - b.getTime();
    if (typeof a === "number" && typeof b === "number") return a - b;

    return String(a).localeCompare(String(b), "pt-BR", { numeric: true, sensitivity: "base" });
  }

  function sortData(key, silent) {
    if (!silent) {
      if (sortState.key === key) sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
      else { sortState.key = key; sortState.dir = "asc"; }
    }

    const dirFactor = sortState.dir === "asc" ? 1 : -1;

    filteredInvoices.sort((a, b) => {
      let av;
      let bv;

      if (key === "company") { av = a.company; bv = b.company; }
      else if (key === "status") { av = a.status_label; bv = b.status_label; }
      else if (key === "subtotal" || key === "discount_amount" || key === "tax_total" || key === "total" || key === "rowNumber") {
        av = toNumber(a[key]); bv = toNumber(b[key]);
      }
      else if (key === "due_at") {
        av = a[key] ? new Date(a[key]) : null;
        bv = b[key] ? new Date(b[key]) : null;
      }
      else {
        av = a[key]; bv = b[key];
      }

      return compareValues(av, bv) * dirFactor;
    });

    renderTable(filteredInvoices);
  }

  // --------------------
  // Render
  // --------------------
  function openInvoiceRow(rowId) {
    if (isAdmin) {
      window.location = `/NewInvoice?id=${encodeURIComponent(rowId)}`;
      return;
    }

    const url = `/api/invoices/${encodeURIComponent(rowId)}/print`;
    window.open(url, "_blank", "noopener,noreferrer");
  }

  function renderTable(list) {
    const tbody = document.getElementById("invoiceLines");
    tbody.innerHTML = "";

    if (!Array.isArray(list) || list.length === 0) {
      tbody.innerHTML = `<tr><td colspan="${isAdmin ? 10 : 9}"><%= t('page.invoices.empty.noResults') %></td></tr>`;
      updateBulkUI();
      return;
    }

    list.forEach((row, idx) => {
      const inv = row.raw;
      const tr = document.createElement("tr");
      tr.className = "clicker";

      tr.addEventListener("click", () => {
        openInvoiceRow(row.id);
      });

      const isChecked = selectedInvoiceIds.has(String(row.id));

      const adminFirstCol = isAdmin
        ? `
          <td class="admin-only">
            <input
              class="invoice-check"
              type="checkbox"
              data-id="${escapeHtml(String(row.id))}"
              ${isChecked ? "checked" : ""}
              title="<%= t('page.invoices.bulk.selectOne') %>"
            />
          </td>
        `
        : "";

      tr.innerHTML = `
        ${adminFirstCol}
        <td>${escapeHtml(idx + 1)}</td>
        <td>${escapeHtml(row.invoice_number)}</td>
        <td>${escapeHtml(row.company || "")}</td>
        <td>${row.status_color ? `<span class="label" style="background-color:${escapeHtml(row.status_color)};color:#fff;">${escapeHtml(row.status_label)}</span>` : escapeHtml(row.status_label)}</td>
        <td>${escapeHtml(formatMoney(row.subtotal, inv))}</td>
        <td>${escapeHtml(formatMoney(row.discount_amount, inv))}</td> <!-- âœ… NEW -->
        <td>${escapeHtml(formatMoney(row.tax_total, inv))}</td>
        <td><strong>${escapeHtml(formatMoney(row.total, inv))}</strong></td>
        <td>${escapeHtml(formatDate(row.due_at))}</td>
      `;

      if (isAdmin) {
        const chk = tr.querySelector("input.invoice-check");
        chk.addEventListener("click", function (e) {
          e.stopPropagation();
          const id = String(this.getAttribute("data-id") ?? "");
          if (!id) return;

          if (this.checked) selectedInvoiceIds.add(id);
          else selectedInvoiceIds.delete(id);

          updateBulkUI();
        });
      }

      tbody.appendChild(tr);
    });

    updateBulkUI();
  }

  function updateSortIndicators() {
    document.querySelectorAll("#invoicesHeaderRow th.sortable").forEach((th) => {
      const indicator = th.querySelector(".sort-indicator");
      if (!indicator) return;
      const key = String(th.dataset.sort || "");
      if (sortState.key === key) indicator.textContent = sortState.dir === "asc" ? "â–²" : "â–¼";
      else indicator.textContent = "";
    });
  }

  function initDueAtRangeFilter() {
    const $range = $("#dueAtRangeFilter");
    if (!$range.length) return;
    const $from = $("#dueAtFromFilter");
    const $to = $("#dueAtToFilter");

    if ($range.data("daterangepicker")) $range.data("daterangepicker").remove();
    if ($.fn.daterangepicker && window.moment) {
      $range.daterangepicker({
        autoUpdateInput: false,
        locale: {
          format: "DD/MM/YYYY",
          cancelLabel: "<%= t('page.layout.savedViews.clearLabel') %>",
          applyLabel: "<%= t('page.layout.savedViews.applyLabel') %>",
          fromLabel: "<%= t('page.layout.savedViews.fromLabel') %>",
          toLabel: "<%= t('page.layout.savedViews.toLabel') %>",
          daysOfWeek: ["Do", "Se", "Te", "Qa", "Qi", "Se", "Sa"],
          monthNames: ["Janeiro", "Fevereiro", "MarÃ§o", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]
        }
      });

      $range.off("apply.daterangepicker.inv").on("apply.daterangepicker.inv", function (_ev, picker) {
        const from = picker.startDate.format("DD/MM/YYYY");
        const to = picker.endDate.format("DD/MM/YYYY");
        $from.val(from);
        $to.val(to);
        $range.val(`${from} - ${to}`);
        filterState.due_at_from = from;
        filterState.due_at_to = to;
        filterState.due_at = $range.val();
        applyFilters();
      });

      $range.off("cancel.daterangepicker.inv").on("cancel.daterangepicker.inv", function () {
        $from.val("");
        $to.val("");
        $range.val("");
        filterState.due_at_from = "";
        filterState.due_at_to = "";
        filterState.due_at = "";
        applyFilters();
      });
    }

    $("#dueAtRangeBtn").off("click.inv").on("click.inv", function (e) {
      e.preventDefault();
      e.stopPropagation();
      if ($range.data("daterangepicker")) $range.data("daterangepicker").show();
      else $range.focus();
    });
  }

  function getAllColumnKeys() {
    return $("#invoicesHeaderRow th.sortable")
      .map(function () { return String($(this).data("sort-key") || ""); })
      .get()
      .filter(Boolean);
  }

  function tryTriggerAny(selectors) {
    for (const s of selectors) {
      const el = $(s);
      if (el.length) {
        el.trigger("click");
        return true;
      }
    }
    return false;
  }

  function ensureSavedViewsExtraButtons() {
    const host = $("#invoicesSavedViewsHost");
    if (!host.length) return;
    const actions = host.find(".sv-actions").length ? host.find(".sv-actions").first() : host;

    if (!$("#btnSaveCurrentInvoicesView").length) {
      actions.append(`<button id="btnSaveCurrentInvoicesView" class="btn btn-white btn-xs sv-actionbar-btn" style="margin-left:8px;" title="<%= t('page.layout.savedViews.saveCurrentTitle') %>"><i class="fa fa-check"></i> <%= t('page.layout.savedViews.saveLabel') %></button>`);
    }

    // Keep only default small delete icon from SavedViewsGrid.
    $("#btnDeleteCurrentInvoicesView").remove();

    $("#btnSaveCurrentInvoicesView").off("click.svSaveCurrent").on("click.svSaveCurrent", function (e) {
      e.preventDefault();
      e.stopPropagation();

      const did = tryTriggerAny(["#sv_btnSave", "[data-action='save']", ".sv-btn-save"]);
      if (did) return;

      if (savedViewsState.viewId) {
        (async () => {
          try {
            const payload = {
              name: savedViewsState.name || undefined,
              definition_json: {
                columns: savedViewsState.columns,
                columns_order: savedViewsState.columns_order,
                filters: captureFiltersForSavedView(),
                sort: sortState.key ? [{ field: sortState.key, dir: sortState.dir }] : [],
              },
            };
            await fetch(`/api/saved-views/${encodeURIComponent(savedViewsState.viewId)}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json", Accept: "application/json" },
              body: JSON.stringify(payload),
            });
            if (typeof window.SavedViewsGrid?.reload === "function") window.SavedViewsGrid.reload();
          } catch (err) {
            console.error(err);
          }
        })();
        return;
      }

      tryTriggerAny(["#sv_btnSaveAs", "[data-action='saveas']", ".sv-btn-saveas"]);
    });

    // Delete action is handled by default SavedViewsGrid icon.
  }

  function captureFiltersForSavedView() {
    const filters = [];
    Object.entries(filterState).forEach(([k, v]) => {
      const value = String(v || "").trim();
      if (!value) return;
      if (k === "due_at_from") filters.push({ field: "due_at", op: "gte", value });
      else if (k === "due_at_to") filters.push({ field: "due_at", op: "lte", value });
      else if (k !== "due_at") filters.push({ field: k, op: k === "status_config_id" ? "eq" : "contains", value });
    });
    return filters;
  }

  function applyFiltersFromSavedView(def) {
    Object.keys(filterState).forEach((k) => { filterState[k] = ""; });
    document.querySelectorAll("#invoicesFiltersRow [data-filter]").forEach((el) => { el.value = ""; });
    $("#dueAtFromFilter,#dueAtToFilter,#dueAtRangeFilter").val("");

    (def.filters || []).forEach((f) => {
      const field = String(f.field || "");
      const value = String(f.value || "");
      const op = String(f.op || "").toLowerCase();
      if (!value) return;
      if (field === "due_at" && op === "gte") filterState.due_at_from = value;
      else if (field === "due_at" && op === "lte") filterState.due_at_to = value;
      else if (field === "status") {
        const legacy = Number(value);
        if (Number.isFinite(legacy)) {
          const byLegacy = invoiceStatusByLegacy[legacy];
          filterState.status_config_id = byLegacy?.id || `legacy:${legacy}`;
        } else {
          filterState.status_config_id = String(value || "").trim();
        }
      }
      else if (Object.prototype.hasOwnProperty.call(filterState, field)) filterState[field] = value;
    });

    renderStatusFilterOptions();

    document.querySelectorAll("#invoicesFiltersRow [data-filter]").forEach((el) => {
      const key = String(el.getAttribute("data-filter") || "");
      if (key && Object.prototype.hasOwnProperty.call(filterState, key)) el.value = filterState[key];
    });

    $("#dueAtFromFilter").val(filterState.due_at_from || "");
    $("#dueAtToFilter").val(filterState.due_at_to || "");
    if (filterState.due_at_from && filterState.due_at_to) filterState.due_at = `${filterState.due_at_from} - ${filterState.due_at_to}`;
    $("#dueAtRangeFilter").val(filterState.due_at || "");
  }

  function applySortFromSavedView(def) {
    const first = Array.isArray(def.sort) ? def.sort[0] : null;
    const key = String(first?.field || "").trim();
    const dir = String(first?.dir || "asc").toLowerCase() === "desc" ? "desc" : "asc";
    if (!key) {
      sortState.key = null;
      sortState.dir = "asc";
      renderTable(filteredInvoices);
      updateSortIndicators();
      return;
    }
    sortState.key = key;
    sortState.dir = dir;
    sortData(key, true);
    updateSortIndicators();
  }

  // --------------------
  // Events
  // --------------------
  document.querySelectorAll("#invoicesHeaderRow th.sortable").forEach(th => {
    th.addEventListener("click", () => {
      sortData(th.dataset.sort);
      updateSortIndicators();
    });
  });

  const chkSelectAll = document.getElementById("chkSelectAll");
  if (chkSelectAll && isAdmin) {
    chkSelectAll.addEventListener("click", function (e) {
      e.stopPropagation();
      const rows = document.querySelectorAll("input.invoice-check");
      const shouldCheck = this.checked;

      rows.forEach((c) => {
        const id = String(c.getAttribute("data-id") ?? "");
        if (!id) return;
        c.checked = shouldCheck;
        if (shouldCheck) selectedInvoiceIds.add(id);
        else selectedInvoiceIds.delete(id);
      });

      updateBulkUI();
    });
  }

  document.querySelectorAll("#invoicesFiltersRow [data-filter]").forEach((el) => {
    const tag = String(el.tagName || "").toUpperCase();
    const evt = tag === "SELECT" ? "change" : "input";

    el.addEventListener(evt, function () {
      const key = String(this.getAttribute("data-filter") || "");
      if (!key) return;
      filterState[key] = String(this.value || "");
      if (key === "status_config_id") {
        loadInvoices(true).catch((err) => {
          console.error("status filter reload error:", err);
          alert(err?.message || "<%= t('page.invoices.errors.loadFailed') %>");
        });
        return;
      }
      applyFilters();
    });
  });

  const btnClear = document.getElementById("btnClearSelection");
  if (btnClear && isAdmin) {
    btnClear.addEventListener("click", function () {
      selectedInvoiceIds.clear();
      document.querySelectorAll("input.invoice-check").forEach((x) => x.checked = false);
      const chkAll = document.getElementById("chkSelectAll");
      if (chkAll) { chkAll.checked = false; chkAll.indeterminate = false; }
      updateBulkUI();
    });
  }

  const btnSend = document.getElementById("btnBulkSend");
  if (btnSend && isAdmin) {
    btnSend.addEventListener("click", async function () {
      const ids = Array.from(selectedInvoiceIds);
      if (ids.length === 0) return;

      const ok = await showConfirmModal(
        "<%= t('page.invoices.bulkSend.title') %>",
        `
          <p><%= t('page.invoices.bulkSend.bodyTextFirst') %> <strong>${escapeHtml(ids.length)}</strong> <%= t('page.invoices.bulkSend.bodyLine2') %> <strong><%= t('page.invoices.status.active') %></strong>.</p>
          <p><%= t('page.invoices.bulkSend.confirmQuestion') %></p>
        `,
        "<%= t('page.invoices.bulkSend.confirmButton') %>",
        "btn-success"
      );

      if (!ok) return;

      btnSend.disabled = true;

      try {
        const activeOption = invoiceStatusByLegacy[1];
        const activeSelection = activeOption?.id ? activeOption.id : "legacy:1";
        await runWithConcurrency(ids, 5, async (id) => {
          await patchInvoiceStatus(id, activeSelection);
        });

        await loadInvoices(true);
      } catch (err) {
        console.error("bulk send error:", err);
        alert(err?.message || "<%= t('page.invoices.errors.bulkSendFailed') %>");
      } finally {
        btnSend.disabled = false;
      }
    });
  }

  const btnClone = document.getElementById("btnBulkClone");
  if (btnClone && isAdmin) {
    btnClone.addEventListener("click", async function () {
      const ids = Array.from(selectedInvoiceIds);
      if (ids.length === 0) return;
      if (ids.length > 1) {
        alert("Selecione apenas 1 invoice para clonar.");
        return;
      }

      const sourceId = String(ids[0] || "").trim();
      if (!sourceId) return;

      const ok = await showConfirmModal(
        "<%= t('page.invoices.clone.title') %>",
        `<p><%= t('page.invoices.clone.confirmQuestion') %></p>`,
        "<%= t('page.invoices.clone.confirmButton') %>",
        "btn-warning"
      );
      if (!ok) return;

      btnClone.disabled = true;
      try {
        const created = await cloneInvoiceById(sourceId);
        const newId = String(created?.id || "").trim();
        if (!newId) throw new Error("<%= t('page.invoices.errors.cloneNoId') %>");
        window.location.href = `/NewInvoice?id=${encodeURIComponent(newId)}`;
      } catch (err) {
        console.error("bulk clone error:", err);
        alert(err?.message || "<%= t('page.invoices.errors.cloneFailed') %>");
      } finally {
        btnClone.disabled = false;
      }
    });
  }

  const btnDelete = document.getElementById("btnBulkDelete");
  if (btnDelete && isAdmin) {
    btnDelete.addEventListener("click", async function () {
      const ids = Array.from(selectedInvoiceIds);
      if (ids.length === 0) return;

      const ok = await showConfirmModal(
        "<%= t('page.invoices.bulkDelete.title') %>",
        `
          <p><%= t('page.invoices.bulkDelete.bodyTextFirst') %> <strong>${escapeHtml(ids.length)}</strong> <%= t('page.invoices.bulkDelete.bodyLine2') %></p>
          <p class="text-danger"><%= t('page.invoices.bulkDelete.warning') %></p>
          <p><%= t('page.invoices.bulkDelete.confirmQuestion') %></p>
        `,
        "<%= t('page.invoices.bulkDelete.confirmButton') %>",
        "btn-danger"
      );

      if (!ok) return;

      btnDelete.disabled = true;

      try {
        await runWithConcurrency(ids, 5, async (id) => {
          await deleteInvoiceById(id);
        });

        await loadInvoices(true);
      } catch (err) {
        console.error("bulk delete error:", err);
        alert(err?.message || "<%= t('page.invoices.errors.bulkDeleteFailed') %>");
      } finally {
        btnDelete.disabled = false;
      }
    });
  }

  // --------------------
  // Load
  // --------------------
  async function loadInvoices(keepFilters) {
    const spinnerOverlay = document.getElementById("globalSpinner");
        spinnerOverlay.classList.add("is-visible");
        spinnerOverlay.setAttribute("aria-hidden", "false");
    const data = await fetchInvoices();
        spinnerOverlay.classList.remove("is-visible");
        spinnerOverlay.setAttribute("aria-hidden", "true");

    const rows = Array.isArray(data)
      ? data
      : (data?.data ?? data?.rows ?? data?.invoices ?? []);

    invoices = rows.map((inv, idx) => normalizeInvoice(inv, idx));

    // âœ… Non-admin: remove rascunhos (status 0)
    if (!isAdmin) {
      invoices = invoices.filter((x) => Number(x.status) !== 0);
    }

    filteredInvoices = [...invoices];

    if (keepFilters) applyFilters();
    else renderTable(filteredInvoices);
    updateSortIndicators();

    if (isAdmin) {
      selectedInvoiceIds.clear();
      const chkAll = document.getElementById("chkSelectAll");
      if (chkAll) { chkAll.checked = false; chkAll.indeterminate = false; }
      updateBulkUI();
    }
  }

  (async function initInvoicesPage() {
    await loadStatusConfigs();
    renderStatusFilterOptions();
    initDueAtRangeFilter();
    await loadInvoices(false);

    const allKeys = getAllColumnKeys();
    savedViewsState.columns = allKeys.slice();
    savedViewsState.columns_order = allKeys.slice();

    await window.SavedViewsGrid.init({
      entityName: "invoices",
      hostSelector: "#invoicesSavedViewsHost",
      tableSelector: "#invoices",
      headerRowSelector: "#invoices thead tr:eq(1)",
      filtersRowSelector: "#invoices thead tr:eq(0)",
      getAllColumnKeys: () => getAllColumnKeys(),
      fallbackViewName: "",
      includeFallbackOption: false,
      fallbackDefinition: { columns: allKeys.slice(), columns_order: allKeys.slice(), filters: [], sort: [] },
      getCurrentState: () => {
        const domOrder = $("#invoicesHeaderRow th.sortable").map(function () { return String($(this).data("sort-key") || ""); }).get().filter(Boolean);
        const visible = $("#invoicesHeaderRow th.sortable:visible").map(function () { return String($(this).data("sort-key") || ""); }).get().filter(Boolean);
        savedViewsState.columns_order = domOrder.length ? domOrder : savedViewsState.columns_order;
        savedViewsState.columns = visible.length ? visible : savedViewsState.columns;
        savedViewsState.filters = captureFiltersForSavedView();
        savedViewsState.sort = sortState.key ? [{ field: sortState.key, dir: sortState.dir }] : [];
        return Object.assign({}, savedViewsState);
      },
      applyState: ({ viewId, name, definition, _fromColumnsModal }) => {
        savedViewsState.viewId = viewId;
        savedViewsState.name = name || "";
        if (_fromColumnsModal === true) {
          initDueAtRangeFilter();
          return;
        }
        applyFiltersFromSavedView(definition || {});
        applySortFromSavedView(definition || {});
        initDueAtRangeFilter();
        loadInvoices(true)
          .then(() => {
            updateSortIndicators();
            ensureSavedViewsExtraButtons();
          })
          .catch((e) => {
            console.error("saved view reload error:", e);
          });
      },
      onAfterApply: () => {
        initDueAtRangeFilter();
        loadInvoices(true)
          .then(() => {
            updateSortIndicators();
            ensureSavedViewsExtraButtons();
          })
          .catch((e) => {
            console.error("saved view reload error:", e);
          });
      }
    });
    setTimeout(ensureSavedViewsExtraButtons, 120);
  })().catch((err) => {
    console.error("init invoices error:", err);
    const tbody = document.getElementById("invoiceLines");
    if (tbody) tbody.innerHTML = `<tr><td colspan="${isAdmin ? 10 : 9}">${escapeHtml(err?.message || "<%= t('page.invoices.errors.loadFailed') %>")}</td></tr>`;
  });
</script>

