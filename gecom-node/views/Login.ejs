<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>GECOM | <%= t('page.login.pageTitle') %></title>
    <link rel="shortcut icon" href="../Pages/favicon.ico" type="image/x-icon" />
    <link rel="icon" href="../Pages/favicon.ico" type="image/x-icon" />
    <link href="../Assets/inspinia/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../Assets/inspinia/font-awesome/css/font-awesome.css" rel="stylesheet" />
    <link href="../Assets/inspinia/css/animate.css" rel="stylesheet" />
    <link href="../Assets/inspinia/css/style.css" rel="stylesheet" />
    <script src="../Assets/js/pages/Login.js"></script>
    <style>
        .loginscreen.middle-box {
            width: 350px;
        }
        body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 200%;
  height: 100%;
  background-image: url("../Assets/img/gecom_bk3.png");
  background-repeat: repeat-x;
  background-size: auto 100%;
  opacity: 0.25;
  z-index: -1;
  animation: moveBackground 120s linear infinite;
}

@keyframes moveBackground {
  from {
    transform: translateX(0);
  }
  to {
    transform: translateX(-50%);
  }
}

    </style>
</head>
<body class="gray-bg" style="display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; position: relative;">
    <!-- <img src="../Assets/img/LogoGecom.jpg" style="position: fixed; min-width: 100%; min-height: 100%; opacity: 0.1;" /> -->
    <button type="button" class="btn btn-primary" style="display: none;" data-toggle="modal" id="modalLoginButton" data-target="#loginModal">
        <%= t('page.login.modal.hiddenTriggerLabel') %>
    </button>
    <div class="modal inmodal fade" id="loginModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only"><%= t('page.login.modal.close') %></span></button>
                    <h4 class="modal-title" id="modalTitle"></h4>
                    <!-- <small class="font-bold">Lorem Ipsum is simply dummy text of the printing and typesetting industry.</small> -->
                </div>
                <div class="modal-body" id="loginModalBody">

                </div>
                <div class="modal-footer">
                    <button onclick="window.location = '/'" type="button" class="btn btn-white" data-dismiss="modal"><%= t('page.login.modal.close') %></button>
                </div>
            </div>
        </div>
    </div>
    <!-- Login Form -->
    <form id="loginForm" class="middle-box text-center loginscreen animated fadeInDown" style="transform: scale(1.2); transform-origin: center; background-color: white; padding: 25px; border-radius: 5px;">
        <h3><%= t('page.login.welcomeTitle') %></h3>
        <div id="world-map" style="height: 100px; margin-top: 20px;"></div>
        <p style="margin-top: 20px; font-size: 12px;">
            <%= t('page.login.subtitle') %>
        </p>

        <div class="form-group">
            <input type="email" class="form-control" placeholder="<%= t('page.login.fields.emailPlaceholder') %>" id="email" required />
        </div>
        <div class="form-group">
            <input type="password" class="form-control" placeholder="<%= t('page.login.fields.passwordPlaceholder') %>" id="password" required />
        </div>
        <button type="submit" class="btn btn-primary block full-width m-b"><%= t('page.login.actions.login') %></button>

        <a onclick="changeView('#forgotPassword')"><small><%= t('page.login.actions.forgotPasswordLink') %></small></a>
        <p style="display: none;" class="text-muted text-center"><small><%= t('page.login.actions.hasAccessNumber') %></small></p>
        <a style="display: none;" class="btn btn-sm btn-white btn-block" onclick="changeView('#acessNumberForm')"><%= t('page.login.actions.accessNumberCta') %></a>
    </form>

    <!-- Access Number Form -->
    <form id="acessNumberForm" class="middle-box text-center loginscreen animated fadeInDown" style="transform: scale(1.2); transform-origin: center; background-color: white; padding: 25px; border-radius: 5px; display: none;">
        <h3><%= t('page.login.actions.accessNumberTitle') %></h3>
        <p style="margin-top: 20px; font-size: 12px;">
            <%= t('page.login.actions.accessNumberHelp') %>
        </p>
        <div class="form-group">
            <input type="text" class="form-control" placeholder="<%= t('page.login.fields.accessNumberPlaceholder') %>" name="number" required />
        </div>
        <a href="PublicProcessDetail" class="btn btn-primary block full-width m-b"><%= t('page.login.actions.access') %></a>
        <a class="btn btn-sm btn-white btn-block" onclick="changeView('#loginForm')">
            <i class="fa fa-arrow-left me-1"></i><%= t('page.login.actions.backToLogin') %>
        </a>
    </form>

    <!-- Forgot Password Form -->
    <form id="forgotPassword" class="middle-box text-center loginscreen animated fadeInDown" style="transform: scale(1.2); transform-origin: center; background-color: white; padding: 25px; border-radius: 5px; display: none;">
        <h3><%= t('page.login.forgot.title') %></h3>
        <p style="margin-top: 20px; font-size: 12px;">
            <%= t('page.login.forgot.help') %>
        </p>
        <div class="form-group">
            <input type="text" class="form-control" id="forgotEmail" name="forgotEmail" required />
        </div>
        <a onclick="onForgotPassword()" style="color: white;" class="btn btn-primary block full-width m-b"><%= t('page.login.actions.sendResetEmail') %></a>
        <a class="btn btn-sm btn-white btn-block" onclick="changeView('#loginForm')">
            <i class="fa fa-arrow-left me-1"></i><%= t('page.login.actions.backToLogin') %>
        </a>
    </form>

    <!-- ResetPassword Form -->
    <form id="resetPassword" class="middle-box text-center loginscreen animated fadeInDown" style="transform: scale(1.2); transform-origin: center; background-color: white; padding: 25px; border-radius: 5px; display: none;">
        <h3><%= t('page.login.reset.newPassword') %></h3>
        <p style="margin-top: 20px; font-size: 12px;">
            <%= t('page.login.reset.newPasswordHelp') %>
        </p>
        <div class="form-group">
            <input type="password" class="form-control" id="newPassword" required />
        </div>
        <p style="margin-top: 20px; font-size: 12px;">
            <%= t('page.login.reset.confirmPassword') %>
        </p>
        <div class="form-group">
            <input type="password" class="form-control" id="confirmPassword" required />
        </div>
        <a onclick="onResetPassword()" style="color: white;" class="btn btn-primary block full-width m-b"><%= t('page.login.reset.confirmNewPassword') %></a>
        <a class="btn btn-sm btn-white btn-block" onclick="changeView('#loginForm')">
            <i class="fa fa-arrow-left me-1"></i><%= t('page.login.actions.backToLogin') %>
        </a>
    </form>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../Assets/inspinia/js/popper.min.js"></script>
    <script src="../Assets/inspinia/js/bootstrap.js"></script>
    <script src="../Assets/inspinia/js/plugins/jvectormap/jquery-jvectormap-2.0.2.min.js"></script>
    <script src="../Assets/inspinia/js/plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>

    <script>
        function changeView(id) {
            $("#loginForm, #acessNumberForm, #forgotPassword, #resetPassword").hide();
            $(id).show();
      localStorage.removeItem("gecom.profilePictureCache");
      // opcional: também zera o currentUser antigo
      localStorage.removeItem("currentUser");

            // Pequena melhoria: focar no campo principal da tela
            if (id === "#loginForm") {
                setTimeout(() => $("#email").focus(), 50);
            }
            if (id === "#forgotPassword") {
                setTimeout(() => $("#forgotEmail").focus(), 50);
            }
            if (id === "#resetPassword") {
                setTimeout(() => $("#newPassword").focus(), 50);
            }
        }

        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        function showModalMessage(title, message) {
            $("#modalTitle").text(title || "<%= t('page.login.messages.defaultModalTitle') %>");
            $("#loginModalBody").html("<p>" + (message || "") + "</p>");
            $("#modalLoginButton").click();
        }

        function initViewFromUrl() {
                const token = getQueryParam("token");
                const userId = getQueryParam("userId");
            if (token != null && userId != null) {

                if (!token || !userId) {
                    changeView("#loginForm");
                    showModalMessage("<%= t('page.login.messages.invalidLinkTitle') %>", "<%= t('page.login.messages.invalidLinkBody') %>");
                    return;
                }

                changeView("#resetPassword");
            } else {
                changeView("#loginForm");
            }
        }

        async function onForgotPassword() {
            var email = $("#forgotEmail").val();

            if (!email) {
                showModalMessage("<%= t('page.login.messages.forgotPasswordTitle') %>", "<%= t('page.login.messages.forgotPasswordEmailRequired') %>");
                return;
            }

            const resp = await fetch("/auth/forgot-password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email })
            });

            const data = await resp.json().catch(() => ({}));

            if (!resp.ok) {
                showModalMessage("<%= t('page.login.messages.forgotPasswordTitle') %>", data.message || "<%= t('page.login.messages.forgotPasswordRequestFail') %>");
                return;
            }

            showModalMessage("<%= t('page.login.messages.forgotPasswordTitle') %>", data.message || "<%= t('page.login.messages.forgotPasswordRequestSuccess') %>");
        }

        async function onResetPassword() {
            const token = getQueryParam("token");
            const userId = getQueryParam("userId");

            if (!token || !userId) {
                showModalMessage("<%= t('page.login.messages.invalidLinkTitle') %>", "<%= t('page.login.messages.invalidLinkBody') %>");
                return;
            }

            const newPassword = $("#newPassword").val();
            const confirmPassword = $("#confirmPassword").val();

            if (!newPassword || !confirmPassword) {
                showModalMessage("<%= t('page.login.messages.resetPasswordTitle') %>", "<%= t('page.login.messages.resetPasswordFillBoth') %>");
                return;
            }

            if (newPassword !== confirmPassword) {
                showModalMessage("<%= t('page.login.messages.resetPasswordTitle') %>", "<%= t('page.login.messages.resetPasswordMismatch') %>");
                return;
            }

            const payload = {
                user_id: userId,
                token: token,
                new_password: newPassword,
                confirm_password: confirmPassword
            };

            const resp = await fetch("/auth/reset-password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await resp.json().catch(() => ({}));

            if (!resp.ok) {
                showModalMessage("<%= t('page.login.messages.resetPasswordTitle') %>", data.message || "<%= t('page.login.messages.resetPasswordFail') %>");
                return;
            }

            // Limpa URL, volta para o login, foca no email e mostra o modal de sucesso
            window.history.replaceState({}, document.title, "/");
            changeView("#loginForm");

            // Limpa campos do reset
            $("#newPassword").val("");
            $("#confirmPassword").val("");

            showModalMessage("<%= t('page.login.messages.resetPasswordSuccessTitle') %>", data.message || "<%= t('page.login.messages.resetPasswordSuccessBody') %>");

            // Foco no email após abrir o modal
            setTimeout(() => $("#email").focus(), 200);
        }

        document.getElementById("loginForm").addEventListener("submit", async (event) => {
            event.preventDefault();

            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            try {
                const response = await fetch("/auth/login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    showModalMessage("<%= t('page.login.actions.login') %>", error.message || "<%= t('page.login.messages.loginFail') %>");
                    return;
                }

               const meResp = await fetch(`/api/auth/me`, {
                method: "GET",
                headers: { "Accept": "application/json" },
                credentials: "same-origin"
                });

                const me = await meResp.json().catch(() => ({}));

                if (meResp.ok && me && me.id) {
                    localStorage.setItem("currentUser", JSON.stringify(me));
                    localStorage.setItem("currentUserId", String(me.id));
                    localStorage.setItem("companyId", String(me.company_id));
                }

                window.location.href = "/Default";
            }
            catch (err) {
                showModalMessage("<%= t('page.login.actions.login') %>", "<%= t('page.login.messages.unexpectedError') %>");
            }
        });

        $(document).ready(function () {
            initViewFromUrl();

            var mapData = {
                "US": 498, "SA": 200, "CA": 1300, "DE": 220, "FR": 540,
                "CN": 120, "AU": 760, "BR": 550, "IN": 200, "GB": 120, "RU": 2000
            };

            $('#world-map').vectorMap({
                map: 'world_mill_en',
                backgroundColor: "transparent",
                zoomButtons: false,
                regionStyle: {
                    initial: {
                        fill: '#e4e4e4',
                        "fill-opacity": 1,
                        stroke: 'none',
                        "stroke-width": 0,
                        "stroke-opacity": 0
                    }
                },
                series: {
                    regions: [{
                        values: mapData,
                        scale: ["#1ab394", "#22d6b1"],
                        normalizeFunction: 'polynomial'
                    }]
                }
            });
        });
    </script>
</body>
</html>
