<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <title>GECOM - Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Novo Processo links -->
  <link href="../Assets/inspinia/css/plugins/iCheck/custom.css" rel="stylesheet">
  <link href="../Assets/inspinia/css/plugins/steps/jquery.steps.css" rel="stylesheet">
  <link href="../Assets/inspinia/css/plugins/dropzone/basic.css" rel="stylesheet">
  <link href="../Assets/inspinia/css/plugins/dropzone/dropzone.css" rel="stylesheet">
  <link href="../Assets/inspinia/css/plugins/datapicker/datepicker3.css" rel="stylesheet">

  <!-- Ãcone -->
  <link rel="shortcut icon" href="/Pages/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="/Pages/favicon.ico" type="image/x-icon" />

  <!-- CSS -->
  <link href="/Assets/inspinia/css/bootstrap.min.css" rel="stylesheet" />
  <link href="/Assets/inspinia/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
  <link href="/Assets/inspinia/css/animate.css" rel="stylesheet" />
  <link href="/Assets/inspinia/css/style.css" rel="stylesheet" />
  <link href="/Assets/inspinia/css/plugins/morris/morris-0.4.3.min.css" rel="stylesheet" />


  <!-- JS head (fix: load order + single jQuery) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/Assets/inspinia/js/popper.min.js"></script>
  <script src="/Assets/inspinia/js/bootstrap.min.js"></script>

  <script src="/Assets/inspinia/js/plugins/metisMenu/jquery.metisMenu.js"></script>
  <script src="/Assets/inspinia/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
  <script src="/Assets/inspinia/js/plugins/pace/pace.min.js"></script>

  <script src="/Assets/inspinia/js/inspinia.js"></script>

  <script src="/Assets/inspinia/js/plugins/validate/jquery.validate.min.js"></script>
  <script src="/Assets/inspinia/js/plugins/steps/jquery.steps.min.js"></script>

  <script src="/Assets/js/functionalities/dynamicsModal.js"></script>
  <script src="/Assets/js/enums/globalEnum.js"></script>
  <script src="/Assets/js/authContext.js"></script>

  <!-- i18next -->
  <!-- <script src="/Assets/inspinia/js/plugins/i18next/i18next.min.js"></script> -->
  <script src="https://unpkg.com/i18next@23.12.2/i18next.min.js"></script>


  <%- typeof headerLink !=='undefined' ? headerLink : '' %>
    <style>
      body.mini-navbar .menuDivider {
        display: none !important;
      }

      .dynamic-modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: 999998;
      }

      .dynamic-modal {
        display: none;
        position: fixed;
        top: 0;
        right: 0;
        height: 100%;
        z-index: 999999;
        background-color: #fafafa;
        width: 430px;
        /* parecido com quick create */
        padding: 20px;
        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);
        overflow-y: auto;
      }

      .dynamic-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .dynamic-modal-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }

      .dynamic-modal-close {
        border: none;
        background: none;
        font-size: 22px;
        line-height: 1;
        cursor: pointer;
      }

      .dynamic-modal-body {
        margin-bottom: 20px;
      }

      .dynamic-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding-top: 10px;
      }

      .gecom-spinner-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, .65);
        z-index: 1000000;
        /* maior que seus modais */
        align-items: center;
        justify-content: center;
      }

      .gecom-spinner-overlay.is-visible {
        display: flex;
      }

      .gecom-spinner-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .gecom-spinner-text {
        font-weight: 600;
        color: #333;
      }

      .menuDivider {
        width: 100%;
        text-align: left;
        color: white !important;
        padding-bottom: 5px !important;
      }

      .menuDivider:hover {
        background-color: unset !important;
      }

      .rounded-circle {
        width: 65px !important;
        height: 65px;
        border-radius: 50%;
        object-fit: cover;
        object-position: center;
      }
    </style>
</head>

<body>
  <!-- Global Spinner Overlay -->
  <div id="globalSpinner" class="gecom-spinner-overlay" aria-hidden="true">
    <div class="gecom-spinner-content">
      <div class="sk-spinner sk-spinner-wandering-cubes">
        <div class="sk-cube1"></div>
        <div class="sk-cube2"></div>
      </div>
      <div class="gecom-spinner-text" id="globalSpinnerText" style="display:none;"></div>
    </div>
  </div>

  <div id="wrapper">
    <!-- Sidebar -->
    <nav class="navbar-default navbar-static-side" role="navigation">
      <div class="sidebar-collapse">
        <ul class="nav metismenu" id="side-menu">
          <li class="nav-header text-center">
            <div class="dropdown profile-element">
              <span>
                <img id="currentUserAvatar" alt="image" class="rounded-circle" style="width: 75px;" src="">
              </span>

              <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                <span id="currentUserName" class="block m-t-xs font-bold">User Name</span>
                <span class="text-muted text-xs block">GECOM <b class="caret"></b></span>
              </a>

              <ul class="dropdown-menu animated fadeInRight m-t-xs">
                <li id="profilePage"><a href="/Profile" data-i18n="page.layout.menu.profile">Perfil</a></li>
                <li class="divider"></li>
                <li><a onclick="LogOut()" data-i18n="page.layout.menu.logout">Sair</a></li>
              </ul>
            </div>
            <div class="logo-element">G+</div>
          </li>

          <li>
            <a href="/Default">
              <i class="fa fa-home"></i>
              <span class="nav-label" data-i18n="page.layout.menu.dashboard">Dashboard</span>
            </a>
          </li>

          <li><a class="menuDivider" style="padding-top:20px;">Services</a></li>

          <li id="clientTab" style="display: none;">
            <a href="/Clientes">
              <i class="fa fa-users"></i>
              <span class="nav-label" data-i18n="page.layout.menu.clients">Clientes</span>
            </a>
          </li>

          <li>
            <a href="/Processos">
              <i class="fa fa-file"></i>
              <span class="nav-label" data-i18n="page.layout.menu.processes">Processos</span>
            </a>
          </li>

          <li>
            <a href="/MyDocuments">
              <i class="fa fa-folder"></i>
              <span class="nav-label" data-i18n="page.layout.menu.myDocuments">Meus Documentos</span>
            </a>
          </li>

          <li><a class="menuDivider" style="padding-top:20px;">Sales</a></li>

          <li>
            <a href="/Invoices">
              <i class="fa fa-money"></i>
              <span class="nav-label" data-i18n="page.layout.menu.invoices">Invoices</span>
            </a>
          </li>

          <li id="productTab" style="display: none;">
            <a href="/Products">
              <i class="fa fa-cube"></i>
              <span class="nav-label" data-i18n="page.layout.menu.products">Produtos</span>
            </a>
          </li>

          <!-- âœ… opcional: botÃµes simples pra testar troca de idioma -->
          <!--
          <li style="padding:10px 20px;">
            <button class="btn btn-xs btn-white" onclick="setLanguage('pt-BR')">PT</button>
            <button class="btn btn-xs btn-white" onclick="setLanguage('en')">EN</button>
            <button class="btn btn-xs btn-white" onclick="setLanguage('es')">ES</button>
          </li>
          -->

        </ul>
      </div>
    </nav>

    <div id="page-wrapper" class="gray-bg">
      <div class="row border-bottom">
        <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0;">
          <div class="navbar-header">
            <a class="navbar-minimalize minimalize-styl-2 btn btn-primary" href="#"><i class="fa fa-bars"></i></a>
          </div>

          <ul class="nav navbar-top-links navbar-right">
            <!-- Language selector -->
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="false">
                ðŸŒŽ <span id="langLabel">PT</span> <b class="caret"></b>
              </a>
              <ul class="dropdown-menu dropdown-user">
                <li><a href="#" onclick="return window.GECOM_LANG.go('pt-BR');">ðŸ‡§ðŸ‡· PortuguÃªs</a></li>
                <li><a href="#" onclick="return window.GECOM_LANG.go('en');">ðŸ‡ºðŸ‡¸ English</a></li>
                <li><a href="#" onclick="return window.GECOM_LANG.go('es');">ðŸ‡ªðŸ‡¸ EspaÃ±ol</a></li>
              </ul>
            </li>

            <li>
              <a href="#" onclick="LogOut()">
                <i class="fa fa-sign-out"></i>
                <span data-i18n="page.layout.menu.logout">Sair</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>


      <div id="masterHeader" class="row wrapper border-bottom white-bg page-heading">
        <div class="col-lg-10">
          <h2 id="pageName"></h2>
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a id="subpageName">Home</a>
            </li>
            <li class="breadcrumb-item" id="path" style="display: none;">
              <a id="subSecoundPageName">Forms</a>
            </li>
            <li class="breadcrumb-item active" id="subpath" style="display: none;">
              <strong id="subpathName">Wizard</strong>
            </li>
          </ol>
        </div>
        <div class="col-lg-2"></div>
      </div>

      <!-- Render page content here -->
      <%- body %>

        <!-- Footer -->
        <div class="footer">
          <div class="float-right" data-i18n="page.layout.appTitle">Sistema G+</div>
          <div><strong>Copyright</strong> <span data-i18n="page.layout.footer.copyright">G+ Â©</span></div>
        </div>
    </div>
  </div>

  <!-- Side Modal (global) -->
  <div id="dynamicModalOverlay" class="dynamic-modal-overlay"></div>

  <div id="dynamicModal" class="dynamic-modal">
    <div class="dynamic-modal-header">
      <h3 id="dynamicModalTitle" class="dynamic-modal-title"></h3>
      <button type="button" id="dynamicModalCloseBtn" class="dynamic-modal-close">&times;</button>
    </div>

    <div id="dynamicModalBody" class="dynamic-modal-body">
      <!-- Dynamic content here -->
    </div>

    <div class="dynamic-modal-footer">
      <button type="button" id="dynamicModalCancelBtn" class="btn btn-default" data-i18n="page.layout.modal.cancel">
        Cancelar
      </button>
      <button type="button" id="dynamicModalOkBtn" class="btn btn-primary" data-i18n="page.layout.modal.ok">
        OK
      </button>
    </div>
  </div>

  <button type="button" class="btn btn-primary" style="display: none;" data-toggle="modal" id="modalButton"
    data-target="#GlobalModal">
    Large Modal
  </button>

  <div class="modal inmodal fade" id="GlobalModal" tabindex="-1" role="dialog" aria-hidden="true" style="z-index: 9999999999 !important;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
              class="sr-only">Close</span></button>
          <h4 class="modal-title" id="modalTitle"></h4>
        </div>

        <div class="modal-body" id="modalBody"></div>

        <div class="modal-footer">
          <button id="saveModal" type="button" class="btn btn-primary" data-dismiss="modal"
            data-i18n="page.layout.modal.save">OK</button>
          <button id="closeModal" type="button" class="btn btn-white" data-dismiss="modal"
            data-i18n="page.layout.modal.close">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <%- typeof script !=='undefined' ? script : '' %>
    <%- typeof scripts !=='undefined' ? scripts : '' %>

      <script>
        async function LogOut() {
          try {
            await fetch("/auth/logout", {
              method: "POST",
              headers: { "Content-Type": "application/json" }
            });

            localStorage.removeItem("gecom.profilePictureCache");
            localStorage.removeItem("currentUser");
            window.location.href = "/";
          }
          catch (err) {
            // uses i18next if ready, otherwise fallback
            var msg = (window.t ? window.t("page.layout.modal.close", { defaultValue: "Unexpected error" }) : "Unexpected error");
            alert(msg);
          }
        }
      </script>

      <!-- MudanÃ§a de idioma -->
<script>
  (function () {
    // Prevent double-installation
    if (window.GECOM_LANG) return;

    var SUPPORTED = ["pt-BR", "en", "es"];
    var DEFAULT_LANG = "pt-BR";

    // Where your translation JSON files live:
    // Create these files:
    //   /Assets/i18n/pt-BR.json
    //   /Assets/i18n/en.json
    //   /Assets/i18n/es.json
    function getI18nUrl(lang) {
      return "/locales/" + encodeURIComponent(lang) + "/common.json";
    }

    function normalize(raw) {
      var v = String(raw || "").trim();
      if (!v) return null;
      v = v.replace("_", "-");
      var lower = v.toLowerCase();
      if (lower === "pt" || lower === "pt-br") return "pt-BR";
      if (lower === "en") return "en";
      if (lower === "es") return "es";
      return v;
    }

    function getCookie(name) {
      try {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(";").shift());
        return null;
      } catch { return null; }
    }

    function setCookie(name, value) {
      try {
        document.cookie = name + "=" + encodeURIComponent(value) + "; path=/; SameSite=Lax";
      } catch { }
    }

    function getLangFromUrl() {
      try {
        var u = new URL(window.location.href);
        return normalize(u.searchParams.get("lang"));
      } catch { return null; }
    }

    function setLangOnCurrentUrl(lang) {
      try {
        var u = new URL(window.location.href);
        u.searchParams.set("lang", lang);
        window.location.href = u.pathname + u.search + u.hash;
      } catch {
        window.location.search = "?lang=" + encodeURIComponent(lang);
      }
    }

    function updateLabel(lang) {
      var el = document.getElementById("langLabel");
      if (!el) return;
      var v = String(lang || "").toUpperCase();
      if (v === "PT-BR") v = "PT";
      el.textContent = v;
    }

    function shouldRewriteHref(href) {
      if (!href) return false;
      if (href.startsWith("#")) return false;
      if (href.startsWith("javascript:")) return false;
      if (href.startsWith("mailto:")) return false;
      if (href.startsWith("tel:")) return false;
      if (href.startsWith("/auth/")) return false;
      return true;
    }

    function withLangParam(href, lang) {
      try {
        var abs = new URL(href, window.location.origin);
        if (abs.origin !== window.location.origin) return href;
        abs.searchParams.set("lang", lang);
        return abs.pathname + abs.search + abs.hash;
      } catch {
        return href;
      }
    }

    function rewriteLinks(lang) {
      try {
        document.querySelectorAll("a[href]").forEach(function (a) {
          if (a.getAttribute("data-toggle")) return; // dropdown toggles
          var href = a.getAttribute("href");
          if (!shouldRewriteHref(href)) return;
          a.setAttribute("href", withLangParam(href, lang));
        });
      } catch { }
    }

    // ---------- i18next load + apply ----------
    async function loadTranslations(lang) {
      // You can also inject translations via window.__I18N_RESOURCES if you want
      // window.__I18N_RESOURCES = { "pt-BR": {...}, "en": {...}, "es": {...} }
      try {
        if (window.__I18N_RESOURCES && window.__I18N_RESOURCES[lang]) {
          return window.__I18N_RESOURCES[lang];
        }
      } catch { }

      var url = getI18nUrl(lang);
      var resp = await fetch(url, { method: "GET", headers: { "Accept": "application/json" }, cache: "no-store" });
      if (!resp.ok) throw new Error("Failed to load i18n: " + url + " (" + resp.status + ")");
      return await resp.json();
    }

    function applyI18nToDom() {
      if (!window.i18next || typeof window.i18next.t !== "function") return;

      // Expose window.t for your existing code (alerts, modals, etc.)
      window.t = function (key, options) {
        try { return window.i18next.t(key, options || {}); } catch { return (options && options.defaultValue) ? options.defaultValue : key; }
      };

      // Apply to elements with data-i18n="some.key"
      document.querySelectorAll("[data-i18n]").forEach(function (el) {
        var key = el.getAttribute("data-i18n");
        if (!key) return;

        // Optional: allow attribute translations:
        // <input data-i18n="page.x.y" data-i18n-attr="placeholder">
        var attr = el.getAttribute("data-i18n-attr");
        var value = window.t(key, { defaultValue: el.textContent });

        if (attr) {
          el.setAttribute(attr, value);
          return;
        }

        // Default: textContent
        el.textContent = value;
      });
    }

    async function initI18n(lang) {
      if (!window.i18next) {
        console.warn("i18next not loaded.");
        return;
      }

      document.documentElement.setAttribute("lang", lang);

      var resources = await loadTranslations(lang);

      await window.i18next.init({
        lng: lang,
        fallbackLng: DEFAULT_LANG,
        resources: (function () {
          var pack = {};
          pack[lang] = { translation: resources };
          return pack;
        })(),
        interpolation: { escapeValue: false }
      });

      applyI18nToDom();
    }

    // Decide language (URL wins, then cookie, then default)
    var lang = getLangFromUrl() || normalize(getCookie("gecom_lang")) || DEFAULT_LANG;
    if (!SUPPORTED.includes(lang)) lang = DEFAULT_LANG;

    // Persist and apply "lang UI"
    setCookie("gecom_lang", lang);
    updateLabel(lang);
    rewriteLinks(lang);

    // Init i18next + apply translations
    initI18n(lang).catch(function (e) {
      console.warn("i18n init failed:", e);
      // Still keep UI consistent even if JSON missing
    });

    // Expose API for the dropdown
    window.GECOM_LANG = {
      current: function () { return lang; },
      go: function (lng) {
        var next = normalize(lng) || DEFAULT_LANG;
        if (!SUPPORTED.includes(next)) next = DEFAULT_LANG;
        setCookie("gecom_lang", next);
        setLangOnCurrentUrl(next);
        return false;
      },
      rerender: function () {
        // In case you inject HTML dynamically and want to re-apply translations
        try { applyI18nToDom(); } catch { }
      }
    };

    // Keep links updated if DOM changes
    try {
      var target = document.getElementById("page-wrapper") || document.body;
      if (target && window.MutationObserver) {
        var tmr = null;
        var obs = new MutationObserver(function () {
          if (tmr) clearTimeout(tmr);
          tmr = setTimeout(function () {
            rewriteLinks(lang);
            applyI18nToDom();
          }, 50);
        });
        obs.observe(target, { childList: true, subtree: true });
      }
    } catch { }
  })();
</script>


      <!-- Loader com global spin e validaÃ§Ã£o de sessÃ£o -->
      <script>
        (function () {
          // Prevent double-installation
          if (window.__authFetchInterceptorInstalled) return;
          window.__authFetchInterceptorInstalled = true;

          // ---------------- Global Spinner (counter-based) ----------------
          const spinnerOverlay = document.getElementById("globalSpinner");
          const spinnerText = document.getElementById("globalSpinnerText");

          let pendingCount = 0;
          let hideTimer = null;

          function spinnerRender() {
            if (!spinnerOverlay) return;

            if (pendingCount > 0) {
              if (hideTimer) clearTimeout(hideTimer);
              spinnerOverlay.classList.add("is-visible");
              spinnerOverlay.setAttribute("aria-hidden", "false");
              return;
            }

            // Small delay avoids flicker for very fast requests
            hideTimer = setTimeout(() => {
              spinnerOverlay.classList.remove("is-visible");
              spinnerOverlay.setAttribute("aria-hidden", "true");
              if (spinnerText) {
                spinnerText.style.display = "none";
                spinnerText.textContent = "";
              }
            }, 150);
          }

          function spinnerShow(message) {
            pendingCount++;
            if (spinnerText && message) {
              spinnerText.textContent = String(message);
              spinnerText.style.display = "block";
            }
            spinnerRender();
          }

          function spinnerHide() {
            pendingCount = Math.max(0, pendingCount - 1);
            spinnerRender();
          }

          function spinnerReset() {
            pendingCount = 0;
            spinnerRender();
          }

          async function spinnerWrap(promiseOrFn, message) {
            spinnerShow(message);
            try {
              const p = typeof promiseOrFn === "function" ? promiseOrFn() : promiseOrFn;
              return await p;
            } finally {
              spinnerHide();
            }
          }

          window.GECOM = window.GECOM || {};
          window.GECOM.spinner = { show: spinnerShow, hide: spinnerHide, reset: spinnerReset, wrap: spinnerWrap };

          // ---------------- Session expired modal (Bootstrap GlobalModal) ----------------
          function openSessionExpiredModal() {
            // Avoid opening multiple times
            if (window.__gecomSessionExpiredShown) return;
            window.__gecomSessionExpiredShown = true;

            const modalBtn = document.getElementById("modalButton");
            const modalTitle = document.getElementById("modalTitle");
            const modalBody = document.getElementById("modalBody");
            const btnSave = document.getElementById("saveModal");
            const btnClose = document.getElementById("closeModal");

            // Fallback if modal not found
            if (!modalBtn || !modalTitle || !modalBody || !btnSave || !btnClose) {
              alert("Sua sessÃ£o expirou. FaÃ§a login novamente.");
              window.location.href = "/";
              return;
            }

            var title = window.t ? window.t("page.layout.session.expiredTitle", { defaultValue: "SessÃ£o expirada" }) : "SessÃ£o expirada";
            var line1 = window.t ? window.t("page.layout.session.expiredBody", { defaultValue: "Sua sessÃ£o expirou ou vocÃª perdeu autorizaÃ§Ã£o." }) : "Sua sessÃ£o expirou ou vocÃª perdeu autorizaÃ§Ã£o.";
            var line2 = window.t ? window.t("page.layout.session.expiredBody2", { defaultValue: "VocÃª precisa fazer login novamente." }) : "VocÃª precisa fazer login novamente.";
            var goLogin = window.t ? window.t("page.layout.session.goToLogin", { defaultValue: "Ir para Login" }) : "Ir para Login";

            modalTitle.textContent = title;
            modalBody.innerHTML = `<p>${line1}</p><p>${line2}</p>`;

            btnSave.textContent = goLogin;
            btnSave.classList.remove("btn-danger");
            btnSave.classList.add("btn-primary");

            btnClose.textContent = window.t ? window.t("page.layout.modal.close", { defaultValue: "Fechar" }) : "Fechar";

            const cleanup = () => {
              btnSave.onclick = null;
              btnClose.onclick = null;

              // Restore defaults (translated)
              btnSave.textContent = window.t ? window.t("page.layout.modal.save", { defaultValue: "Salvar" }) : "Save";
              btnClose.textContent = window.t ? window.t("page.layout.modal.close", { defaultValue: "Fechar" }) : "Close";
              btnSave.classList.remove("btn-danger");
              btnSave.classList.add("btn-primary");
            };

            const goToLogin = () => {
              cleanup();
              window.location.href = "/";
            };

            btnSave.onclick = goToLogin;
            btnClose.onclick = goToLogin;

            modalBtn.click();
          }

          // ---------------- Refresh flow (single-flight) ----------------
          let refreshPromise = null;

          async function refreshAccessToken() {
            if (refreshPromise) return refreshPromise;

            refreshPromise = (async () => {
              const resp = await fetch("/auth/refresh", {
                method: "POST",
                headers: { Accept: "application/json" },
                credentials: "same-origin",
                cache: "no-store"
              });

              if (!resp.ok) throw new Error("Refresh failed");
              return true;
            })();

            try {
              return await refreshPromise;
            } finally {
              refreshPromise = null;
            }
          }

          // ---------------- Helpers: decide when to show spinner ----------------
          function shouldIgnoreSpinner(url) {
            if (!url) return false;

            if (
              url.includes("/auth/refresh") ||
              url.includes("/auth/logout") ||
              url.includes("/profile-picture") ||
              url.includes("/api/currencies")
            ) return true;

            const lower = url.toLowerCase();
            if (
              lower.includes("/assets/") ||
              lower.endsWith(".css") ||
              lower.endsWith(".js") ||
              lower.endsWith(".png") ||
              lower.endsWith(".jpg") ||
              lower.endsWith(".jpeg") ||
              lower.endsWith(".svg") ||
              lower.endsWith(".gif") ||
              lower.endsWith(".webp") ||
              lower.endsWith(".ico") ||
              lower.endsWith(".woff") ||
              lower.endsWith(".woff2") ||
              lower.endsWith(".ttf") ||
              lower.endsWith(".map")
            ) return true;

            return false;
          }

          // ---------------- jQuery Ajax global hook ----------------
          if (window.jQuery) {
            jQuery(document).ajaxStart(function () { spinnerShow(); });
            jQuery(document).ajaxStop(function () { spinnerReset(); });
          }

          // ---------------- Fetch interceptor ----------------
          const originalFetch = window.fetch.bind(window);

          window.fetch = async function (input, init) {
            const requestUrl = typeof input === "string" ? input : (input && input.url) || "";

            const isAuthRefresh = requestUrl.includes("/auth/refresh");
            const isAuthLogout = requestUrl.includes("/auth/logout");
            if (isAuthRefresh || isAuthLogout) {
              return originalFetch(input, init);
            }

            const safeInit = init ? { ...init } : {};
            if (!safeInit.credentials) safeInit.credentials = "same-origin";

            const ignoreSpinner = shouldIgnoreSpinner(requestUrl);
            if (!ignoreSpinner) spinnerShow();

            try {
              let response = await originalFetch(input, safeInit);

              if (response.status !== 401) return response;

              try {
                await refreshAccessToken();
              } catch (e) {
                console.warn("Token refresh failed:", e);
                openSessionExpiredModal();
                return response;
              }

              response = await originalFetch(input, safeInit);

              if (response.status === 401) {
                openSessionExpiredModal();
              }

              return response;
            } finally {
              if (!ignoreSpinner) spinnerHide();
            }
          };

          // ---------------- Periodic auth check (every ~5 minutes) ----------------
          const SESSION_PING_MS = 1000 * 60 * 5; // 5 minutes
          const SESSION_PING_URL = "/api/currencies?is_active=1";

          let sessionPingTimer = null;

          function hasCurrentUser() {
            try {
              const raw = localStorage.getItem("currentUser");
              if (!raw) return false;
              const obj = JSON.parse(raw);
              return !!obj?.id;
            } catch {
              return false;
            }
          }

          async function sessionPing() {
            if (!hasCurrentUser()) return;

            try {
              const resp = await originalFetch(SESSION_PING_URL, {
                method: "GET",
                headers: { Accept: "application/json" },
                credentials: "same-origin",
                cache: "no-store"
              });

              if (resp.status === 401 || resp.status === 403) {
                console.warn("Session ping unauthorized:", resp.status);
                openSessionExpiredModal();
                return;
              }

              if (!resp.ok) {
                console.warn("Session ping non-ok:", resp.status);
              }
            } catch (e) {
              console.warn("Session ping failed (network):", e);
            }
          }

          function startSessionPing() {
            if (sessionPingTimer) clearInterval(sessionPingTimer);

            setTimeout(sessionPing, 30 * 1000);

            sessionPingTimer = setInterval(() => {
              if (document.visibilityState === "visible") sessionPing();
            }, SESSION_PING_MS);
          }

          document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") sessionPing();
          });

          startSessionPing();
        })();
      </script>

      <script src="../Assets/js/globalSpinner.js"></script>

      <!-- Script de permissÃµes -->
      <script>
        (function () {
          try {
            const raw = localStorage.getItem("currentUser");
            if (!raw) return;

            const user = JSON.parse(raw);

            const name = (user && (user.full_name || user.name)) ? String(user.full_name || user.name).trim() : "";
            const el = document.getElementById("currentUserName");
            if (el && name) el.textContent = name;

            if (window.__auth.isUser) {
              $('a[name="btn_act_new"]').hide();
              $('button[name="btn_act_new"]').hide();
              $('button[name="btn_act_new_manager"]').hide();
              $('#profilePage"]').hide();
              $('input[name="btn_act_new"]').hide();//
            }
            else if (window.__auth.isManager) {
              $('button[name="btn_act_new_manager"]').hide();
            }
            else if (window.__auth.isAdmin) {
              $("#clientTab").show();
              $("#productTab").show();
            }

          } catch (e) {
            console.warn("Failed to load currentUser from localStorage:", e);
          }
        })();
      </script>

      <!-- Esse script aplica foto de perfil -->
      <script>
        (function () {
          // English comments only
          const DEFAULT_AVATAR = "/Assets/inspinia/img/user.png";
          const CACHE_KEY = "gecom.profilePictureCache"; // single cache entry for current user
          const CACHE_TTL_MS = 1000 * 60 * 60 * 24 * 3; // 3 days

          function safeJsonParse(raw) {
            try { return JSON.parse(raw); } catch { return null; }
          }

          function getCurrentUserFromStorage() {
            const raw = localStorage.getItem("currentUser");
            if (!raw) return null;
            return safeJsonParse(raw);
          }

          function getCachedPicture(userId) {
            const raw = localStorage.getItem(CACHE_KEY);
            if (!raw) return null;

            const cache = safeJsonParse(raw);
            if (!cache) return null;

            if (String(cache.userId || "") !== String(userId || "")) return null;

            const savedAt = Number(cache.savedAt || 0);
            if (!savedAt || (Date.now() - savedAt) > CACHE_TTL_MS) return null;

            const value = String(cache.value || "");
            if (!value) return null;

            return value;
          }

          function setCachedPicture(userId, dataUrl) {
            try {
              if (!dataUrl) return;
              localStorage.setItem(CACHE_KEY, JSON.stringify({
                userId: String(userId),
                value: String(dataUrl),
                savedAt: Date.now()
              }));
            } catch (e) {
              console.warn("Failed to cache profile picture:", e);
            }
          }

          async function loadPictureFromApi(userId) {
            const resp = await fetch(`/api/users/me/profile-picture`, {
              method: "GET",
              headers: { Accept: "application/json" }
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) return null;

            const pic = data?.base64;
            return (typeof pic === "string" && pic.trim().length > 0) ? pic : null;
          }

          function setUserAvatar(imgElementId, avatarValue) {
            const img = document.getElementById(imgElementId);
            if (!img) return;

            const raw = (avatarValue ?? "").toString().trim();
            if (!raw) return;

            // If it's already a URL or already a data URI, use as-is
            if (raw.startsWith("data:image/") || raw.startsWith("http://") || raw.startsWith("https://")) {
              img.src = raw;
              setCachedPicture(userId, raw);
              return;
            }

            // If it's base64 only, assume PNG (because your string starts with iVBOR...)
            // Remove accidental prefix if it came as "base64,xxxxx"
            const base64 = raw.includes("base64,") ? raw.split("base64,").pop().trim() : raw;

            img.src = `data:image/png;base64,${base64}`;            
              setCachedPicture(userId, `data:image/png;base64,${base64}`);
          }
          async function applyAvatar() {
            const user = getCurrentUserFromStorage();
            const userId = user?.id;
            const img = document.getElementById("currentUserAvatar");
            if (!img || !userId) return;

            const cached = getCachedPicture(userId);
            if (cached) {
              setUserAvatar("currentUserAvatar", cached);
              return;
            }

            const pic = await loadPictureFromApi(userId);
            if (pic) {
              setUserAvatar("currentUserAvatar", pic);
            } else {
              img.src = DEFAULT_AVATAR;
            }
          }

          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", applyAvatar);
          } else {
            applyAvatar();
          }
        })();
      </script>

      <!-- Esse script altera o alert nativo do navegador para nosso modal -->
      <script>
        (function () {
          if (window.__gecomDialogOverridden) return;
          window.__gecomDialogOverridden = true;

          const originalAlert = window.alert;
          const originalConfirm = window.confirm;

          function getModalElements() {
            return {
              modalBtn: document.getElementById("modalButton"),
              modalTitle: document.getElementById("modalTitle"),
              modalBody: document.getElementById("modalBody"),
              btnSave: document.getElementById("saveModal"),
              btnClose: document.getElementById("closeModal"),
            };
          }

          function tt(key, fallback) {
            try {
              if (window.t) return window.t(key, { defaultValue: fallback });
              return fallback;
            } catch {
              return fallback;
            }
          }

          /* =========================
             ALERT (fire-and-forget)
             ========================= */
          window.alert = function (message, options) {
            const { modalBtn, modalTitle, modalBody, btnSave, btnClose } = getModalElements();

            if (!modalBtn || !modalTitle || !modalBody || !btnSave || !btnClose) {
              originalAlert(message);
              return;
            }

            const opts = options || {};
            modalTitle.textContent = opts.title || tt("page.clientDetails.globalModal.confirmTitle", "Aviso");
            modalBody.innerHTML = `<p>${String(message || "")}</p>`;

            btnSave.textContent = opts.okText || tt("page.layout.modal.ok", "OK");
            btnSave.className = "btn btn-primary";
            btnClose.style.display = "none";

            const cleanup = () => {
              btnSave.onclick = null;
              btnClose.style.display = "";
              btnSave.textContent = tt("page.layout.modal.save", "Salvar");
            };

            btnSave.onclick = () => cleanup();
            modalBtn.click();
          };

          /* =========================
             CONFIRM (Promise<boolean>)
             ========================= */
          window.confirm = function (message, options) {
            const { modalBtn, modalTitle, modalBody, btnSave, btnClose } = getModalElements();

            if (!modalBtn || !modalTitle || !modalBody || !btnSave || !btnClose) {
              return Promise.resolve(originalConfirm(message));
            }

            const opts = options || {};

            modalTitle.textContent = opts.title || tt("page.clientDetails.globalModal.confirmTitle", "ConfirmaÃ§Ã£o");
            modalBody.innerHTML = `<p>${String(message || "")}</p>`;

            btnSave.textContent = opts.okText || tt("page.clientDetails.globalModal.confirmOk", "Confirmar");
            btnClose.textContent = opts.cancelText || tt("page.clientDetails.globalModal.cancel", "Cancelar");

            btnSave.className = opts.danger ? "btn btn-danger" : "btn btn-primary";

            return new Promise((resolve) => {
              const cleanup = () => {
                btnSave.onclick = null;
                btnClose.onclick = null;
                btnSave.className = "btn btn-primary";
                btnSave.textContent = tt("page.layout.modal.save", "Salvar");
                btnClose.textContent = tt("page.layout.modal.close", "Fechar");
              };

              btnSave.onclick = () => { cleanup(); resolve(true); };
              btnClose.onclick = () => { cleanup(); resolve(false); };

              modalBtn.click();
            });
          };

        })();
      </script>

</body>

</html>