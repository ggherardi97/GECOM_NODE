<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <title>GECOM - Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Novo Processo links -->
  <link href="/Assets/inspinia/css/plugins/iCheck/custom.css" rel="stylesheet">
  <link href="/Assets/inspinia/css/plugins/steps/jquery.steps.css" rel="stylesheet">
  <link href="/Assets/inspinia/css/plugins/dropzone/basic.css" rel="stylesheet">
  <link href="/Assets/inspinia/css/plugins/dropzone/dropzone.css" rel="stylesheet">
  <link href="/Assets/inspinia/css/plugins/datapicker/datepicker3.css" rel="stylesheet">

  <!-- Ãcone -->
  <link id="gecomFaviconShortcut" rel="shortcut icon" href="/Pages/favicon.ico" type="image/x-icon" />
  <link id="gecomFavicon" rel="icon" href="/Pages/favicon.ico" type="image/x-icon" />

  <!-- CSS -->
  <link href="/Assets/inspinia/css/bootstrap.min.css" rel="stylesheet" />
  <link href="/Assets/inspinia/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
  <link href="/Assets/inspinia/css/animate.css" rel="stylesheet" />
  <link href="/Assets/inspinia/css/style.css" rel="stylesheet" />
  <link href="/Assets/inspinia/css/plugins/morris/morris-0.4.3.min.css" rel="stylesheet" />


  <!-- JS head (fix: load order + single jQuery) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/Assets/inspinia/js/popper.min.js"></script>
  <script src="/Assets/inspinia/js/bootstrap.min.js"></script>

  <script src="/Assets/inspinia/js/plugins/metisMenu/jquery.metisMenu.js"></script>
  <script src="/Assets/inspinia/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
  <script src="/Assets/inspinia/js/plugins/pace/pace.min.js"></script>

  <script src="/Assets/inspinia/js/inspinia.js"></script>

  <script src="/Assets/inspinia/js/plugins/validate/jquery.validate.min.js"></script>
  <script src="/Assets/inspinia/js/plugins/steps/jquery.steps.min.js"></script>

  <script src="/Assets/js/functionalities/dynamicsModal.js"></script>
  <script src="/Assets/js/functionalities/savedViewsGrid.js"></script>
  <script src="/js/common/tenantsApi.js"></script>
  <script src="/js/common/aiApi.js"></script>
  <script src="/js/gecom-ai.js"></script>
  <script src="/Assets/js/enums/globalEnum.js"></script>
  <script src="/Assets/js/authContext.js"></script>
  <script>
    window.__billingBootstrapMode = <%= (typeof billingBootstrapMode !== 'undefined' && billingBootstrapMode) ? 'true' : 'false' %>;
  </script>

  <!-- i18next -->
  <!-- <script src="/Assets/inspinia/js/plugins/i18next/i18next.min.js"></script> -->
  <script src="https://unpkg.com/i18next@23.12.2/i18next.min.js"></script>


  <%- typeof headerLink !=='undefined' ? headerLink : '' %>
    <style>
      :root {
        --gecom-primary: #1ab394;
        --gecom-nav-bg: #2f4050;
        --gecom-nav-text: #a7b1c2;
        --gecom-topbar-bg: #ffffff;
      }

      .btn-primary,
      .label-primary,
      .badge-primary {
        background-color: var(--gecom-primary) !important;
        border-color: var(--gecom-primary) !important;
      }

      .navbar-default,
      .navbar-static-side,
      .sidebar-collapse,
      .sidebar-area-switcher {
        background-color: var(--gecom-nav-bg) !important;
      }

      .nav > li > a,
      .nav.metismenu > li > a > .nav-label,
      .nav.metismenu .menuDivider {
        color: var(--gecom-nav-text) !important;
      }

      .nav-header .dropdown-toggle span,
      .nav-header .logo-element {
        color: #fff !important;
      }

      .navbar-static-top {
        background-color: var(--gecom-topbar-bg) !important;
      }

      body.gecom-layout-dark #page-wrapper,
      body.gecom-layout-dark .gray-bg {
        background-color: #1f252b !important;
      }

      body.gecom-layout-dark .wrapper-content,
      body.gecom-layout-dark .ibox-content,
      body.gecom-layout-dark .ibox-title {
        background-color: #2a3138 !important;
        color: #d7dde3 !important;
      }

      body.mini-navbar .menuDivider {
        display: none !important;
      }
.sv-picker{
  height: 35px !important;
}
      .dynamic-modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: 999998;
      }

      .dynamic-modal {
        display: none;
        position: fixed;
        top: 0;
        right: 0;
        height: 100%;
        z-index: 999999;
        background-color: #fafafa;
        width: 480px;
        /* parecido com quick create */
        padding: 20px;
        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);
        overflow-y: auto;
      }

      .dynamic-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .dynamic-modal-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }

      .dynamic-modal-close {
        border: none;
        background: none;
        font-size: 22px;
        line-height: 1;
        cursor: pointer;
      }

      .dynamic-modal-body {
        margin-bottom: 20px;
      }

      /* Side modal form grid alignment (avoid clipped bootstrap rows) */
      .dynamic-modal-body .row {
        margin-left: 0;
        margin-right: 0;
      }

      .dynamic-modal-body .row > [class*="col-"] {
        padding-left: 6px;
        padding-right: 6px;
      }

      .dynamic-modal-body .row > [class*="col-"]:first-child {
        padding-left: 0;
      }

      .dynamic-modal-body .row > [class*="col-"]:last-child {
        padding-right: 0;
      }

      .dynamic-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding-top: 10px;
      }

      .gecom-spinner-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, .65);
        z-index: 1000000;
        /* maior que seus modais */
        align-items: center;
        justify-content: center;
      }

      .gecom-spinner-overlay.is-visible {
        display: flex;
      }

      .gecom-spinner-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .gecom-spinner-text {
        font-weight: 600;
        color: #333;
      }

      .menuDivider {
        width: 100%;
        text-align: left;
        color: white !important;
        padding-bottom: 5px !important;
      }

      .menuDivider:hover {
        background-color: unset !important;
      }

      #side-menu {
            max-height: 77%;
        overflow-y: auto;
        overflow-x: hidden;
        padding-bottom: 12px;
        scrollbar-width: thin;
        scrollbar-color: #1f2e3b #2f4050;
      }

      .navbar-static-side .sidebar-collapse {
        position: relative;
        height: 100vh;
        overflow: hidden;
      }

      #side-menu::-webkit-scrollbar {
        width: 6px;
      }

      #side-menu::-webkit-scrollbar-track {
        background: #2f4050;
      }

      #side-menu::-webkit-scrollbar-thumb {
        background: #1f2e3b;
        border-radius: 8px;
      }

      #side-menu::-webkit-scrollbar-thumb:hover {
        background: #18242e;
      }

      .sidebar-area-hidden {
        display: none !important;
      }

      .sidebar-module-hidden {
        display: none !important;
      }

      .sidebar-area-switcher {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        border-top: 1px solid #2f4050;
        background: #293846;
        z-index: 25;
        overflow: visible;
      }

      .sidebar-area-trigger {
        width: 100%;
        border: 0;
        background: transparent;
        color: #fff;
        text-align: left;
        padding: 12px 14px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .sidebar-area-trigger:focus {
        outline: none;
      }

      .sidebar-area-icon {
        width: 24px;
        height: 24px;
        border-radius: 3px;
        background: #1ab394;
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
      }

      .sidebar-area-label {
        flex: 1;
        font-weight: 600;
      }

      .sidebar-area-panel {
        display: none;
        position: absolute;
        left: 0;
        right: 0;
        bottom: calc(100% - 1px);
        border: 1px solid #d7d7d7;
        border-bottom: 0;
        background: #f7f7f7;
        color: #222;
        padding: 8px 0;
        box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.12);
      }

      .sidebar-area-panel.is-open {
        display: block;
      }

      .sidebar-area-panel-title {
        padding: 6px 14px 10px 14px;
        color: #666;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .sidebar-area-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 14px;
        color: #333;
        text-decoration: none;
      }

      .sidebar-area-option:hover {
        background: #ececec;
        color: #222;
        text-decoration: none;
      }

      .sidebar-area-option.is-active {
        font-weight: 700;
      }

      .sidebar-area-option .fa-check {
        visibility: hidden;
        color: #1ab394;
      }

      .sidebar-area-option.is-active .fa-check {
        visibility: visible;
      }

      body.mini-navbar .sidebar-area-switcher {
        display: none;
      }

      .rounded-circle {
        width: 55px !important;
        height: 55px;
        border-radius: 50%;
        object-fit: cover;
        object-position: center;
      }

      .top-notification-item {
        padding: 10px 14px;
        border-bottom: 1px solid #f1f1f1;
      }

      .top-notification-item.is-read {
        background: #eef9f5;
      }

      .top-notification-title {
        font-weight: 600;
        margin-bottom: 4px;
        color: #333;
      }

      .top-notification-message {
        color: #666;
        font-size: 12px;
        line-height: 1.35;
      }

      .top-notification-time {
        color: #999;
        font-size: 11px;
      }

      .gecom-ai-top-search {
        position: relative;
      }

      .gecom-ai-top-search .ai-top-btn {
        color: #676a6c;
      }

      .gecom-ai-top-search .ai-top-input-wrap {
        position: absolute;
        top: 44px;
        right: 0;
        width: 420px;
        background: #fff;
        border: 1px solid #e7eaec;
        border-radius: 4px;
        box-shadow: 0 4px 14px rgba(0, 0, 0, .08);
        padding: 10px;
        z-index: 1002;
        display: none;
      }

      .gecom-ai-top-search.is-open .ai-top-input-wrap {
        display: block;
      }

      .gecom-ai-top-search .ai-top-results {
        max-height: 320px;
        overflow-y: auto;
        margin-top: 8px;
      }

      .gecom-ai-top-search .ai-top-group {
        border: 1px solid #f0f0f0;
        border-radius: 4px;
        margin-bottom: 8px;
      }

      .gecom-ai-top-search .ai-top-group-title {
        font-size: 11px;
        text-transform: uppercase;
        color: #999;
        margin: 0;
        padding: 6px 8px;
        border-bottom: 1px solid #f4f4f4;
        background: #fafafa;
      }

      .gecom-ai-top-search .ai-top-item {
        padding: 8px;
        border-bottom: 1px solid #f7f7f7;
      }

      .gecom-ai-top-search .ai-top-item:last-child {
        border-bottom: none;
      }

      .gecom-ai-top-search .ai-top-item-sub {
        font-size: 12px;
        color: #888;
      }

      @media (max-width: 768px) {
        .gecom-ai-top-search .ai-top-input-wrap {
          width: 300px;
          right: -70px;
        }
      }
  .text-muted { display:none !important; }
    </style>
</head>

<body>
  <script>
    (function () {
      try {
        if (localStorage.getItem("gecom.sidebar.collapsed") === "1") {
          document.body.classList.add("mini-navbar");
        }
      } catch {}
    })();
  </script>
  <!-- Global Spinner Overlay -->
  <div id="globalSpinner" class="gecom-spinner-overlay" aria-hidden="true">
    <div class="gecom-spinner-content">
      <div class="sk-spinner sk-spinner-wandering-cubes">
        <div class="sk-cube1"></div>
        <div class="sk-cube2"></div>
      </div>
      <div class="gecom-spinner-text" id="globalSpinnerText" style="display:none;"></div>
    </div>
  </div>

  <div id="wrapper">
    <!-- Sidebar -->
      <!-- <nav class="navbar-default navbar-static-side" role="navigation" style="position:fixed;">
      <div class="sidebar-collapse">
        <ul class="nav metismenu" id="side-menu">
          <li class="nav-header text-center">
            <div class="dropdown profile-element">
              <span>
                <img id="currentUserAvatar" alt="image" class="rounded-circle" style="width: 75px;" src="">
              </span>

              <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                <span id="currentUserName" class="block m-t-xs font-bold">User Name</span>
                <span class="text-muted text-xs block">GECOM <b class="caret"></b></span>
              </a>

              <ul class="dropdown-menu animated fadeInRight m-t-xs">
                <li id="profilePage"><a href="/Profile" data-i18n="page.layout.menu.profile">Perfil</a></li>
                <li class="divider"></li>
                <li><a onclick="LogOut()" data-i18n="page.layout.menu.logout">Sair</a></li>
              </ul>
            </div>
            <div class="logo-element">G+</div>
          </li>

          <li>
            <a href="/Default">
              <i class="fa fa-home"></i>
              <span class="nav-label" data-i18n="page.layout.menu.dashboard">Dashboard</span>
            </a>
          </li>
          
          <li id="myActivitiesTab" style="display: none;">
            <a href="/MyActivities">
              <i class="fa fa-tasks"></i>
              <span class="nav-label" data-i18n="page.layout.menu.myActivities"><%= t('page.layout.menu.myActivities') %></span>
            </a>
          </li>

          <li id="aiHubTab" style="display: none;">
            <a href="/AI">
              <i class="fa fa-magic"></i>
              <span class="nav-label" data-i18n="page.layout.menu.ai">AI</span>
            </a>
          </li>

          <li><a class="menuDivider" style="padding-top:20px;" data-i18n="page.layout.menu.services"><%= t('page.layout.menu.services') %></a></li>

          <li id="clientTab" style="display: none;">
            <a href="/Clientes">
              <i class="fa fa-users"></i>
              <span class="nav-label" data-i18n="page.layout.menu.clients">Clientes</span>
            </a>
          </li>

          <li>
            <a href="/Processos">
              <i class="fa fa-file"></i>
              <span class="nav-label" data-i18n="page.layout.menu.processes">Processos</span>
            </a>
          </li>

          <li>
            <a href="/MyDocuments">
              <i class="fa fa-folder"></i>
              <span class="nav-label" data-i18n="page.layout.menu.myDocuments">Meus Documentos</span>
            </a>
          </li>

          <li><a class="menuDivider" style="padding-top:20px;" data-i18n="page.layout.menu.sales"><%= t('page.layout.menu.sales') %></a></li>

          <li>
            <a href="/Invoices">
              <i class="fa fa-money"></i>
              <span class="nav-label" data-i18n="page.layout.menu.invoices">Invoices</span>
            </a>
          </li>

          <li id="calculoAduaneiro">
            <a href="/calculo-aduaneiro">
              <i class="fa fa-balance-scale"></i>
              <span class="nav-label" data-i18n="page.layout.menu.customsCalculation"><%= t('page.layout.menu.customsCalculation') %></span>
            </a>
          </li>

          <li id="productTab" style="display: none;">
            <a href="/Products">
              <i class="fa fa-cube"></i>
              <span class="nav-label" data-i18n="page.layout.menu.products">Produtos</span>
            </a>
          </li>

          <li id="leadsTab" style="display: none;">
            <a href="/leads/pipeline">
              <i class="fa fa-filter"></i>
              <span class="nav-label" data-i18n="page.layout.menu.leads"><%= t('page.layout.menu.leads') %></span>
            </a>
          </li>

          <li id="configDivider" style="display: none;"><a class="menuDivider" style="padding-top:20px;" data-i18n="page.layout.menu.settings"><%= t('page.layout.menu.settings') %></a></li>
          <li id='notificationList' style="display: none;">
            <a href="/Notifications">
              <i class="fa fa-bell"></i>
              <span class="nav-label" data-i18n="page.layout.menu.notifications"><%= t('page.layout.menu.notifications') %></span>
            </a>
          </li>
          <li id="statusConfigsMenu" style="display: none;">
            <a href="/configuracoes/status">
              <i class="fa fa-sliders"></i>
              <span class="nav-label" data-i18n="page.layout.menu.statusConfigs"><%= t('page.layout.menu.statusConfigs') %></span>
            </a>
          </li>
        </ul>
      </div>
    </nav> -->
    <nav class="navbar-default navbar-static-side" role="navigation" style="height: 100% !important;position:fixed;">
      <div class="sidebar-collapse">
        <ul class="nav metismenu">
          <li class="nav-header text-center">
            <div class="dropdown profile-element">
              <span>
                <img id="currentUserAvatar" alt="image" class="rounded-circle" style="width: 75px;" src="">
              </span>

              <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                <span id="currentUserName" class="block m-t-xs font-bold">User Name</span>
                <span class="text-muted text-xs block">GECOM <b class="caret"></b></span>
              </a>

              <ul class="dropdown-menu animated fadeInRight m-t-xs">
                <li id="profilePage"><a href="/Profile" data-i18n="page.layout.menu.profile">Perfil</a></li>
                <li class="divider"></li>
                <li><a onclick="LogOut()" data-i18n="page.layout.menu.logout">Sair</a></li>
              </ul>
            </div>
            <div class="logo-element">G+</div>
          </li>
        </ul>
        <ul class="nav metismenu" id="side-menu">
                 
          <li data-areas="home,all">
            <a href="/Default">
              <i class="fa fa-home"></i>
              <span class="nav-label" data-i18n="page.layout.menu.dashboard">Dashboard</span>
            </a>
          </li>
          
          <li data-areas="home,all" id="myActivitiesTab" style="display: none;">
            <a href="/MyActivities">
              <i class="fa fa-tasks"></i>
              <span class="nav-label">Minhas Atividades</span>
            </a>
          </li>

          <li data-areas="home,all" id="aiHubTab" style="display: none;">
            <a href="/AI">
              <i class="fa fa-magic"></i>
              <span class="nav-label">IA</span>
            </a>
          </li>
          <li id="tenantMenuMountPoint" data-areas="home,all" style="display:none !important;"></li>

          <li  data-areas="home" ><a class="menuDivider" style="padding-top:20px;" data-i18n="page.layout.menu.services"><%= t('page.layout.menu.services') %></a></li>

          <li data-managed="tenant" data-home-template="1" data-entity="companies" data-areas="home" id="clientTab" style="display: none;">
            <a href="/Clientes">
              <i class="fa fa-users"></i>
              <span class="nav-label" data-i18n="page.layout.menu.clients">Clientes</span>
            </a>
          </li>

          <li data-managed="tenant" data-home-template="1" data-entity="processes" data-areas="home">
            <a href="/Processos">
              <i class="fa fa-file"></i>
              <span class="nav-label" data-i18n="page.layout.menu.processes">Processos</span>
            </a>
          </li>

          <li  data-areas="home" >
            <a href="/MyDocuments">
              <i class="fa fa-folder"></i>
              <span class="nav-label" data-i18n="page.layout.menu.myDocuments">Meus Documentos</span>
            </a>
          </li>

          <li  data-areas="home" ><a class="menuDivider" style="padding-top:20px;" data-i18n="page.layout.menu.sales"><%= t('page.layout.menu.sales') %></a></li>

          <li data-managed="tenant" data-home-template="1" data-entity="invoices" data-areas="home">
            <a href="/Invoices">
              <i class="fa fa-money"></i>
              <span class="nav-label" data-i18n="page.layout.menu.invoices">Invoices</span>
            </a>
          </li>

          <li  data-areas="home"  id="calculoAduaneiro">
            <a href="/calculo-aduaneiro">
              <i class="fa fa-balance-scale"></i>
              <span class="nav-label" data-i18n="page.layout.menu.customsCalculation"><%= t('page.layout.menu.customsCalculation') %></span>
            </a>
          </li>

          <li data-managed="tenant" data-home-template="1" data-entity="products" data-areas="home" id="productTab" style="display: none;">
            <a href="/Products">
              <i class="fa fa-cube"></i>
              <span class="nav-label" data-i18n="page.layout.menu.products">Produtos</span>
            </a>
          </li>

          <li data-managed="tenant" data-home-template="1" data-entity="leads" data-areas="home" id="leadsTab" style="display: none;">
            <a href="/leads/pipeline">
              <i class="fa fa-filter"></i>
              <span class="nav-label" data-i18n="page.layout.menu.leads"><%= t('page.layout.menu.leads') %></span>
            </a>
          </li>

          <li data-areas="home,sales" id="automationsTab" style="display: none;">
            <a href="/automations">
              <i class="fa fa-bolt"></i>
              <span class="nav-label">Automações</span>
            </a>
          </li>

          <li  data-areas="home"  id="configDivider" style="display: none;"><a class="menuDivider" style="padding-top:20px;" data-i18n="page.layout.menu.settings"><%= t('page.layout.menu.settings') %></a></li>
          <li  data-areas="home"  id='notificationList' style="display: none;">
            <a href="/Notifications">
              <i class="fa fa-bell"></i>
              <span class="nav-label" data-i18n="page.layout.menu.notifications"><%= t('page.layout.menu.notifications') %></span>
            </a>
          </li>
          <li  data-areas="home" id="statusConfigsMenu" style="display: none;">
            <a href="/configuracoes/status">
              <i class="fa fa-sliders"></i>
              <span class="nav-label" data-i18n="page.layout.menu.statusConfigs"><%= t('page.layout.menu.statusConfigs') %></span>
            </a>
          </li>
          <li data-areas="home,settings" id="configMainMenu" style="display: none;">
            <a href="/configuracoes">
              <i class="fa fa-cogs"></i>
              <span class="nav-label" data-i18n="page.layout.menu.settingsCenter"><%= t('page.layout.menu.settingsCenter', { defaultValue: 'Configuracoes' }) %></span>
            </a>
          </li>

          <li data-areas="service"><a class="menuDivider" style="padding-top:20px;">Services</a></li>

          <li data-managed="tenant" data-entity="companies" id="clientTabService" style="display: none;" data-areas="service">
            <a href="/Clientes">
              <i class="fa fa-users"></i>
              <span class="nav-label" data-i18n="page.layout.menu.clients">Clientes</span>
            </a>
          </li>

          <li data-managed="tenant" data-entity="processes" data-areas="service">
            <a href="/Processos">
              <i class="fa fa-file"></i>
              <span class="nav-label" data-i18n="page.layout.menu.processes">Processos</span>
            </a>
          </li>

          <li data-areas="service">
            <a href="/MyDocuments">
              <i class="fa fa-folder"></i>
              <span class="nav-label" data-i18n="page.layout.menu.myDocuments">Meus Documentos</span>
            </a>
          </li>

          <li data-areas="service">
            <a href="/servico/incidentes">
              <i class="fa fa-ticket"></i>
              <span class="nav-label">Incidentes</span>
            </a>
          </li>
          <li data-areas="service">
            <a href="/servico/filas">
              <i class="fa fa-random"></i>
              <span class="nav-label">Filas</span>
            </a>
          </li>
          <li data-areas="service">
            <a href="/servico/filas/membros">
              <i class="fa fa-users"></i>
              <span class="nav-label">Filas - Membros</span>
            </a>
          </li>
          <li data-areas="service">
            <a href="/servico/ativos">
              <i class="fa fa-desktop"></i>
              <span class="nav-label">Ativos</span>
            </a>
          </li>
          <li data-areas="service">
            <a href="/servico/assuntos">
              <i class="fa fa-tags"></i>
              <span class="nav-label">Assuntos</span>
            </a>
          </li>
          <li data-areas="service">
            <a href="/servico/recursos">
              <i class="fa fa-cogs"></i>
              <span class="nav-label">Recursos</span>
            </a>
          </li>
          <li data-areas="service">
            <a href="/servico/recursos/agendamentos">
              <i class="fa fa-calendar-check-o"></i>
              <span class="nav-label">Recursos - Agendamentos</span>
            </a>
          </li>
          <li data-areas="service">
            <a href="/servico/tarefas">
              <i class="fa fa-tasks"></i>
              <span class="nav-label">Tarefas</span>
            </a>
          </li>

          <li data-areas="sales"><a class="menuDivider" style="padding-top:20px;">Sales</a></li>

          <li data-managed="tenant" data-entity="invoices" data-areas="sales">
            <a href="/Invoices">
              <i class="fa fa-money"></i>
              <span class="nav-label" data-i18n="page.layout.menu.invoices">Invoices</span>
            </a>
          </li>

          <li data-managed="tenant" data-entity="products" data-areas="sales">
            <a href="/Products">
              <i class="fa fa-cube"></i>
              <span class="nav-label" data-i18n="page.layout.menu.products">Produtos</span>
            </a>
          </li>

          <li data-managed="tenant" data-entity="leads" data-areas="sales">
            <a href="/leads/pipeline">
              <i class="fa fa-filter"></i>
              <span class="nav-label" data-i18n="page.layout.menu.leads"><%= t('page.layout.menu.leads') %></span>
            </a>
          </li>

          <li data-managed="tenant" data-entity="opportunities" data-areas="sales">
            <a href="/Opportunities">
              <i class="fa fa-bullseye"></i>
              <span class="nav-label">Opportunities</span>
            </a>
          </li>

          <li data-managed="tenant" data-entity="contracts" data-areas="sales">
            <a href="/Contracts">
              <i class="fa fa-file-text-o"></i>
              <span class="nav-label">Contracts</span>
            </a>
          </li>

          <li data-areas="finance"><a class="menuDivider" style="padding-top:20px;" data-i18n="page.layout.menu.finance"><%= t('page.layout.menu.finance') %></a></li>
          <li data-managed="tenant" data-entity="financial_receivables" data-areas="finance">
            <a href="/FinanceReceivables">
              <i class="fa fa-arrow-circle-o-down"></i>
              <span class="nav-label" data-i18n="page.layout.menu.financeReceivables"><%= t('page.layout.menu.financeReceivables') %></span>
            </a>
          </li>
          <li data-managed="tenant" data-entity="financial_payables" data-areas="finance">
            <a href="/FinancePayables">
              <i class="fa fa-arrow-circle-o-up"></i>
              <span class="nav-label" data-i18n="page.layout.menu.financePayables"><%= t('page.layout.menu.financePayables') %></span>
            </a>
          </li>
          <li data-areas="finance">
            <a href="/FinanceBankAccounts">
              <i class="fa fa-university"></i>
              <span class="nav-label" data-i18n="page.layout.menu.financeBanks"><%= t('page.layout.menu.financeBanks') %></span>
            </a>
          </li>
          <li data-areas="finance">
            <a href="/FinanceBankMovements">
              <i class="fa fa-exchange"></i>
              <span class="nav-label" data-i18n="page.layout.menu.financeMovements"><%= t('page.layout.menu.financeMovements') %></span>
            </a>
          </li>
          <li data-areas="finance">
            <a href="/FinanceCashFlow">
              <i class="fa fa-line-chart"></i>
              <span class="nav-label" data-i18n="page.layout.menu.financeCashFlow"><%= t('page.layout.menu.financeCashFlow') %></span>
            </a>
          </li>
          <li data-areas="finance">
            <a href="/FinanceCategories">
              <i class="fa fa-tags"></i>
              <span class="nav-label" data-i18n="page.layout.menu.financeCategories"><%= t('page.layout.menu.financeCategories') %></span>
            </a>
          </li>
          <li data-areas="finance">
            <a href="/FinanceCostCenters">
              <i class="fa fa-sitemap"></i>
              <span class="nav-label" data-i18n="page.layout.menu.financeCostCenters"><%= t('page.layout.menu.financeCostCenters') %></span>
            </a>
          </li>

          <li data-areas="hr"><a class="menuDivider" style="padding-top:20px;" data-i18n="page.layout.menu.hr"><%= t('page.layout.menu.hr') %></a></li>
          <li data-areas="hr">
            <a href="/HRDepartments">
              <i class="fa fa-sitemap"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrDepartments"><%= t('page.layout.menu.hrDepartments') %></span>
            </a>
          </li>
          <li data-areas="hr">
            <a href="/HRPositions">
              <i class="fa fa-briefcase"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrPositions"><%= t('page.layout.menu.hrPositions') %></span>
            </a>
          </li>
          <li data-areas="hr">
            <a href="/HRWorkLocations">
              <i class="fa fa-map-marker"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrWorkLocations"><%= t('page.layout.menu.hrWorkLocations') %></span>
            </a>
          </li>
          <li data-managed="tenant" data-entity="hr_employees" data-areas="hr">
            <a href="/HREmployees">
              <i class="fa fa-users"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrEmployees"><%= t('page.layout.menu.hrEmployees') %></span>
            </a>
          </li>
          <li data-areas="hr">
            <a href="/HRAssignments">
              <i class="fa fa-random"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrAssignments"><%= t('page.layout.menu.hrAssignments') %></span>
            </a>
          </li>
          <li data-areas="hr">
            <a href="/HRWorkSchedules">
              <i class="fa fa-calendar"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrWorkSchedules"><%= t('page.layout.menu.hrWorkSchedules') %></span>
            </a>
          </li>
          <li data-areas="hr">
            <a href="/HRLeaveTypes">
              <i class="fa fa-list"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrLeaveTypes"><%= t('page.layout.menu.hrLeaveTypes') %></span>
            </a>
          </li>
          <li data-areas="hr">
            <a href="/HRLeaveRequests">
              <i class="fa fa-plane"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrLeaveRequests"><%= t('page.layout.menu.hrLeaveRequests') %></span>
            </a>
          </li>
          <li data-areas="hr">
            <a href="/HRSkills">
              <i class="fa fa-graduation-cap"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrSkills"><%= t('page.layout.menu.hrSkills') %></span>
            </a>
          </li>
          <li data-areas="hr">
            <a href="/HRCertifications">
              <i class="fa fa-certificate"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrCertifications"><%= t('page.layout.menu.hrCertifications') %></span>
            </a>
          </li>
          <li data-areas="hr">
            <a href="/HRLifecycleTemplates">
              <i class="fa fa-columns"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrLifecycleTemplates"><%= t('page.layout.menu.hrLifecycleTemplates') %></span>
            </a>
          </li>
          <li data-areas="hr">
            <a href="/HREmployeeLifecycles">
              <i class="fa fa-tasks"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrEmployeeLifecycles"><%= t('page.layout.menu.hrEmployeeLifecycles') %></span>
            </a>
          </li>
          <li data-areas="hr">
            <a href="/HRLifecycleKanban">
              <i class="fa fa-th-large"></i>
              <span class="nav-label" data-i18n="page.layout.menu.hrLifecycleKanban"><%= t('page.layout.menu.hrLifecycleKanban') %></span>
            </a>
          </li>

          <li data-areas="po"><a class="menuDivider" style="padding-top:20px;" data-i18n="page.layout.menu.projectOperations"><%= t('page.layout.menu.projectOperations') %></a></li>
          <li data-areas="po">
            <a href="/POProjects">
              <i class="fa fa-folder-open"></i>
              <span class="nav-label" data-i18n="page.layout.menu.poProjects"><%= t('page.layout.menu.poProjects') %></span>
            </a>
          </li>
          <li data-areas="po">
            <a href="/POProjectProcesses">
              <i class="fa fa-link"></i>
              <span class="nav-label" data-i18n="page.layout.menu.poProjectProcesses"><%= t('page.layout.menu.poProjectProcesses') %></span>
            </a>
          </li>
          <li data-areas="po">
            <a href="/POMilestones">
              <i class="fa fa-flag"></i>
              <span class="nav-label" data-i18n="page.layout.menu.poMilestones"><%= t('page.layout.menu.poMilestones') %></span>
            </a>
          </li>
          <li data-areas="po">
            <a href="/PODeliverables">
              <i class="fa fa-dropbox"></i>
              <span class="nav-label" data-i18n="page.layout.menu.poDeliverables"><%= t('page.layout.menu.poDeliverables') %></span>
            </a>
          </li>
          <li data-areas="po">
            <a href="/POChecklists">
              <i class="fa fa-list-ul"></i>
              <span class="nav-label" data-i18n="page.layout.menu.poChecklists"><%= t('page.layout.menu.poChecklists') %></span>
            </a>
          </li>
          <li data-areas="po">
            <a href="/POChecklistItems">
              <i class="fa fa-check-square-o"></i>
              <span class="nav-label" data-i18n="page.layout.menu.poChecklistItems"><%= t('page.layout.menu.poChecklistItems') %></span>
            </a>
          </li>
          <li data-managed="tenant" data-entity="po_work_orders" data-areas="po">
            <a href="/POWorkOrders">
              <i class="fa fa-wrench"></i>
              <span class="nav-label" data-i18n="page.layout.menu.poWorkOrders"><%= t('page.layout.menu.poWorkOrders') %></span>
            </a>
          </li>
          <li data-areas="po">
            <a href="/POWorkOrderAssignments">
              <i class="fa fa-users"></i>
              <span class="nav-label" data-i18n="page.layout.menu.poWorkOrderAssignments"><%= t('page.layout.menu.poWorkOrderAssignments') %></span>
            </a>
          </li>
          <li data-areas="po">
            <a href="/POWorkOrderAppointments">
              <i class="fa fa-calendar"></i>
              <span class="nav-label" data-i18n="page.layout.menu.poWorkOrderAppointments"><%= t('page.layout.menu.poWorkOrderAppointments') %></span>
            </a>
          </li>
          <li data-areas="po">
            <a href="/POProjectStatuses">
              <i class="fa fa-sliders"></i>
              <span class="nav-label" data-i18n="page.layout.menu.poConfigurations"><%= t('page.layout.menu.poConfigurations') %></span>
            </a>
          </li>

          <li data-areas="settings,service"><a class="menuDivider" style="padding-top:20px;">Serviço</a></li>
          <li data-areas="settings,service">
            <a href="/servico/sla/politicas">
              <i class="fa fa-shield"></i>
              <span class="nav-label">SLA - Políticas</span>
            </a>
          </li>
          <li data-areas="settings,service">
            <a href="/servico/sla/kpis">
              <i class="fa fa-line-chart"></i>
              <span class="nav-label">SLA - KPIs</span>
            </a>
          </li>
          <li data-areas="settings,service">
            <a href="/servico/sla/instancias">
              <i class="fa fa-clone"></i>
              <span class="nav-label">SLA - Instâncias</span>
            </a>
          </li>
          <li data-areas="settings,service">
            <a href="/servico/sla/instancias-kpi">
              <i class="fa fa-sliders"></i>
              <span class="nav-label">SLA - Instâncias KPI</span>
            </a>
          </li>
          <li data-areas="settings,service">
            <a href="/servico/sla/eventos">
              <i class="fa fa-bolt"></i>
              <span class="nav-label">SLA - Eventos</span>
            </a>
          </li>
          <li data-areas="settings,service">
            <a href="/servico/calendarios">
              <i class="fa fa-calendar"></i>
              <span class="nav-label">Calendários</span>
            </a>
          </li>
          <li data-areas="settings,service">
            <a href="/servico/calendarios/regras">
              <i class="fa fa-calendar-plus-o"></i>
              <span class="nav-label">Calendários - Regras</span>
            </a>
          </li>
          <li data-areas="settings,service">
            <a href="/servico/calendarios/excecoes">
              <i class="fa fa-calendar-times-o"></i>
              <span class="nav-label">Calendários - Exceções</span>
            </a>
          </li>
          <li data-areas="settings,service">
            <a href="/servico/tarefas/tipos">
              <i class="fa fa-list-alt"></i>
              <span class="nav-label">Tarefas - Tipos</span>
            </a>
          </li>
          <li data-areas="settings,sales"><a class="menuDivider" style="padding-top:20px;">Sales</a></li>
          <li data-areas="settings,sales">
            <a href="/SalesApprovals">
              <i class="fa fa-check-square-o"></i>
              <span class="nav-label">Aprovações</span>
            </a>
          </li>
          <li data-areas="settings,sales">
            <a href="/PriceTables">
              <i class="fa fa-table"></i>
              <span class="nav-label">Tabelas de Preço</span>
            </a>
          </li>
          <li data-areas="settings,sales">
            <a href="/SalesGoals">
              <i class="fa fa-flag"></i>
              <span class="nav-label">Metas</span>
            </a>
          </li>
          <li data-areas="settings,sales">
            <a href="/SalesCommissions">
              <i class="fa fa-percent"></i>
              <span class="nav-label">Comissões</span>
            </a>
          </li>
          <li style="display: none;" data-areas="settings">
            <a href="/Notifications">
              <i class="fa fa-bell"></i>
              <span class="nav-label">Notificações</span>
            </a>
          </li>

        </ul>
        <div class="sidebar-area-switcher" id="sidebarAreaSwitcher">
          <button type="button" class="sidebar-area-trigger" id="sidebarAreaTrigger" aria-expanded="false" aria-controls="sidebarAreaPanel">
            <span class="sidebar-area-icon" id="sidebarAreaIcon">S</span>
            <span class="sidebar-area-label" id="sidebarAreaLabel">Serviço</span>
            <i class="fa fa-chevron-up"></i>
          </button>
          <div class="sidebar-area-panel" id="sidebarAreaPanel">
            <div class="sidebar-area-panel-title">Alterar área</div>
            <div id="sidebarAreaOptions"></div>
          </div>
        </div>
      </div>
    </nav>

    <div id="page-wrapper" class="gray-bg">
      <div class="row border-bottom">
        <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0;">
          <div class="navbar-header">
            <a class="navbar-minimalize minimalize-styl-2 btn btn-primary" href="#"><i class="fa fa-bars"></i></a>
          </div>

          <ul class="nav navbar-top-links navbar-right">
            <li class="dropdown">
              <a class="dropdown-toggle count-info" data-toggle="dropdown" href="#" aria-expanded="false">
                <i class="fa fa-bell"></i>
                <span class="label label-primary" id="topNotificationsBadge" style="display:none;">0</span>
              </a>
              <ul class="dropdown-menu dropdown-alerts" id="topNotificationsList" style="min-width: 360px; max-width: 420px; max-height: 420px; overflow-y: auto;">
                <li><a href="#"><div>Carregando notificações...</div></a></li>
              </ul>
            </li>

            <li id="aiTopSearchLi" class="gecom-ai-top-search" style="display:none;">
              <a href="#" class="ai-top-btn" id="aiTopSearchToggle" title="Busca global">
                <i class="fa fa-search"></i>
              </a>
              <div class="ai-top-input-wrap" id="aiTopSearchPanel">
                <input id="aiTopSearchInput" type="text" class="form-control input-sm" placeholder="Buscar clientes, processos, invoices e produtos..." />
                <div id="aiTopSearchStatus" class="text-muted small" style="margin-top:6px; display:none;"></div>
                <div id="aiTopSearchResults" class="ai-top-results"></div>
              </div>
            </li>

            <!-- Language selector -->
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="false">
                <span id="langLabel">PT</span> <b class="caret"></b>
              </a>
              <ul class="dropdown-menu dropdown-user">
                <li><a href="#" onclick="return window.GECOM_LANG.go('pt-BR');">Português</a></li>
                <li><a href="#" onclick="return window.GECOM_LANG.go('en');">English</a></li>
                <li><a href="#" onclick="return window.GECOM_LANG.go('es');">Español</a></li>
              </ul>
            </li>

            <li>
              <a href="#" onclick="LogOut()">
                <i class="fa fa-sign-out"></i>
                <span data-i18n="page.layout.menu.logout">Sair</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>


      <div id="masterHeader" class="row wrapper border-bottom white-bg page-heading">
        <div class="col-lg-10">
          <h2 id="pageName"></h2>
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a id="subpageName">Home</a>
            </li>
            <li class="breadcrumb-item" id="path" style="display: none;">
              <a id="subSecoundPageName">Forms</a>
            </li>
            <li class="breadcrumb-item active" id="subpath" style="display: none;">
              <strong id="subpathName">Wizard</strong>
            </li>
          </ol>
        </div>
        <div class="col-lg-2"></div>
      </div>

      <!-- Render page content here -->
      <%- body %>

        <!-- Footer -->
        <div class="footer">
          <div class="float-right" data-i18n="page.layout.appTitle">Sistema G+</div>
          <div><strong>Copyright</strong> <span data-i18n="page.layout.footer.copyright">G+ ©</span></div>
        </div>
    </div>
  </div>

  <!-- Side Modal (global) -->
  <div id="dynamicModalOverlay" class="dynamic-modal-overlay"></div>

  <div id="dynamicModal" class="dynamic-modal">
    <div class="dynamic-modal-header">
      <h3 id="dynamicModalTitle" class="dynamic-modal-title"></h3>
      <button type="button" id="dynamicModalCloseBtn" class="dynamic-modal-close">&times;</button>
    </div>

    <div id="dynamicModalBody" class="dynamic-modal-body">
      <!-- Dynamic content here -->
    </div>

    <div class="dynamic-modal-footer">
      <button type="button" id="dynamicModalCancelBtn" class="btn btn-default" data-i18n="page.layout.modal.cancel">
        Cancelar
      </button>
      <button type="button" id="dynamicModalOkBtn" class="btn btn-primary" data-i18n="page.layout.modal.ok">
        OK
      </button>
    </div>
  </div>

  <button type="button" class="btn btn-primary" style="display: none;" data-toggle="modal" id="modalButton"
    data-target="#GlobalModal">
    Large Modal
  </button>

  <div class="modal inmodal fade" id="GlobalModal" tabindex="-1" role="dialog" aria-hidden="true" style="z-index: 9999999999 !important;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
              class="sr-only">Close</span></button>
          <h4 class="modal-title" id="modalTitle"></h4>
        </div>

        <div class="modal-body" id="modalBody"></div>

        <div class="modal-footer">
          <button id="saveModal" type="button" class="btn btn-primary" data-dismiss="modal"
            data-i18n="page.layout.modal.ok">OK</button>
          <button id="closeModal" type="button" class="btn btn-white" data-dismiss="modal"
            data-i18n="page.layout.modal.close">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <%- typeof script !=='undefined' ? script : '' %>
    <%- typeof scripts !=='undefined' ? scripts : '' %>
      <script>
        window.__features = Object.assign({}, window.__features || {}, {
          enableAI: <%- JSON.stringify(!!enableAI) %>
        });
      </script>

      <script>
        (function () {
          const SIDEBAR_AREA_KEY = "gecom.sidebar.area";
          const sidebarAreaLabels = new Map();
          const tenantManagedNodesByEntity = new Map();
          let tenantManagedReady = false;
          const FIXED_MODULE_AREAS = new Set(["service", "sales", "finance", "hr", "po"]);
          let enabledModuleAreas = new Set(["service", "sales", "finance", "hr", "po"]);

          function normalizeText(value) {
            return String(value == null ? "" : value).trim();
          }

          function safeHtml(value) {
            return String(value == null ? "" : value)
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
          }

          async function readJsonSafe(resp) {
            const text = await resp.text().catch(() => "");
            if (!text) return {};
            try {
              return JSON.parse(text);
            } catch {
              return {};
            }
          }

          function inferAreaFromModuleCode(code) {
            const normalized = normalizeText(code).toUpperCase();
            const out = [];
            const include = (area) => {
              if (!out.includes(area)) out.push(area);
            };

            if (normalized.includes("SERVICE") || normalized.includes("SUPPORT") || normalized.includes("HELPDESK") || normalized.includes("OPS")) include("service");
            if (normalized.includes("SALES") || normalized.includes("CRM") || normalized.includes("COMMERCIAL")) include("sales");
            if (normalized.includes("FINANCE") || normalized.includes("FINANCIAL")) include("finance");
            if (normalized.includes("HR") || normalized.includes("HUMAN") || normalized.includes("PEOPLE")) include("hr");
            if (normalized.includes("PROJECT") || normalized.includes("OPERATIONS") || normalized.includes("PO_")) include("po");
            return out;
          }

          function normalizeEnabledAreasPayload(payload) {
            const explicitAreas = Array.isArray(payload?.enabledAreas) ? payload.enabledAreas : [];
            const byModules = Array.isArray(payload?.enabledModules) ? payload.enabledModules : [];

            const areas = explicitAreas.length
              ? explicitAreas
              : byModules.flatMap((code) => inferAreaFromModuleCode(code));

            const normalized = areas
              .map((area) => normalizeText(area).toLowerCase())
              .filter((area) => FIXED_MODULE_AREAS.has(area));

            return new Set(normalized);
          }

          function isAreaEnabled(area) {
            const normalized = normalizeText(area).toLowerCase();
            if (!FIXED_MODULE_AREAS.has(normalized)) return true;
            return enabledModuleAreas.has(normalized);
          }

          function isItemAllowedByModuleAreas(areaTokens) {
            const moduleTokens = areaTokens.filter((token) => FIXED_MODULE_AREAS.has(token));
            if (!moduleTokens.length) return true;
            return moduleTokens.every((token) => enabledModuleAreas.has(token));
          }

          function defaultAreaLabel(area) {
            if (area === "home") return "Home";
            if (area === "service") return window.t ? window.t("page.layout.menu.services", { defaultValue: "Servicos" }) : "Servicos";
            if (area === "sales") return window.t ? window.t("page.layout.menu.sales", { defaultValue: "Sales" }) : "Sales";
            if (area === "finance") return window.t ? window.t("page.layout.menu.finance", { defaultValue: "Financeiro" }) : "Financeiro";
            if (area === "hr") return window.t ? window.t("page.layout.menu.hr", { defaultValue: "RH" }) : "RH";
            if (area === "po") return window.t ? window.t("page.layout.menu.projectOperations", { defaultValue: "Project & Operations" }) : "Project & Operations";
            if (area === "settings") return window.t ? window.t("page.layout.menu.settings", { defaultValue: "Configuracoes" }) : "Configuracoes";
            const clean = normalizeText(area);
            if (!clean) return "Home";
            return clean.charAt(0).toUpperCase() + clean.slice(1);
          }

          function getSidebarAreaLabel(area) {
            return sidebarAreaLabels.get(area) || defaultAreaLabel(area);
          }

          function getSidebarAreaIcon(area) {
            const label = getSidebarAreaLabel(area);
            const clean = String(label || area || "S").replace(/[^A-Za-z0-9]/g, "");
            return clean ? clean.charAt(0).toUpperCase() : "S";
          }

          function getSidebarAreaIds() {
            const ids = [];
            document.querySelectorAll("#side-menu [data-areas]").forEach((item) => {
              const raw = normalizeText(item.getAttribute("data-areas"));
              if (!raw) return;
              raw
                .split(",")
                .map((token) => normalizeText(token).toLowerCase())
                .filter(Boolean)
                .forEach((token) => {
                  if (token === "all") return;
                  if (!isAreaEnabled(token)) return;
                  if (!ids.includes(token)) ids.push(token);
                });
            });
            if (!ids.length) ids.push("home");
            return ids;
          }

          function normalizeSidebarArea(area) {
            const value = normalizeText(area).toLowerCase();
            const allAreas = getSidebarAreaIds();
            if (allAreas.includes(value)) return value;
            if (allAreas.includes("home")) return "home";
            return allAreas[0];
          }

          function renderSidebarAreaOptions(currentArea) {
            const container = document.getElementById("sidebarAreaOptions");
            if (!container) return;

            const areaIds = getSidebarAreaIds();
            container.innerHTML = areaIds
              .map(
                (area) => `<a href="#" class="sidebar-area-option${area === currentArea ? " is-active" : ""}" data-area="${safeHtml(area)}">
                  <span>${safeHtml(getSidebarAreaLabel(area))}</span><i class="fa fa-check"></i>
                </a>`,
              )
              .join("");

            container.querySelectorAll(".sidebar-area-option[data-area]").forEach((option) => {
              option.addEventListener("click", function (ev) {
                ev.preventDefault();
                const area = normalizeSidebarArea(option.getAttribute("data-area"));
                applySidebarArea(area);
                setSidebarPanelOpen(false);
              });
            });
          }

          function applySidebarArea(area) {
            const currentArea = normalizeSidebarArea(area);
            const items = document.querySelectorAll("#side-menu [data-areas]");
            items.forEach((item) => {
              const raw = String(item.getAttribute("data-areas") || "");
              const areas = raw.split(",").map((x) => x.trim().toLowerCase()).filter(Boolean);
              const moduleAllowed = isItemAllowedByModuleAreas(areas);
              const visibleByArea = areas.includes("all") || areas.includes(currentArea);
              const visible = moduleAllowed && visibleByArea;
              item.classList.toggle("sidebar-module-hidden", !moduleAllowed);
              item.classList.toggle("sidebar-area-hidden", !visible);
            });

            const areaLabel = document.getElementById("sidebarAreaLabel");
            const areaIcon = document.getElementById("sidebarAreaIcon");
            if (areaLabel) areaLabel.textContent = getSidebarAreaLabel(currentArea);
            if (areaIcon) areaIcon.textContent = getSidebarAreaIcon(currentArea);

            document.querySelectorAll(".sidebar-area-option[data-area]").forEach((option) => {
              const optionArea = normalizeSidebarArea(option.getAttribute("data-area"));
              option.classList.toggle("is-active", optionArea === currentArea);
            });

            try {
              localStorage.setItem(SIDEBAR_AREA_KEY, currentArea);
            } catch {}
          }

          function initTenantManagedMenuNodes() {
            if (tenantManagedReady) return;
            tenantManagedReady = true;

            const nodes = Array.from(
              document.querySelectorAll("#side-menu li[data-managed='tenant'][data-home-template='1'][data-entity]"),
            );
            nodes.forEach((node) => {
              const entity = normalizeText(node.getAttribute("data-entity")).toLowerCase();
              if (!entity) return;
              if (!tenantManagedNodesByEntity.has(entity)) {
                tenantManagedNodesByEntity.set(entity, node);
                return;
              }
              node.remove();
            });
          }

          function createTenantMenuNode(item) {
            const li = document.createElement("li");
            li.setAttribute("data-managed", "tenant");
            li.setAttribute("data-entity", normalizeText(item?.entity).toLowerCase());
            li.setAttribute("data-generated", "1");
            li.innerHTML = `<a href="${safeHtml(normalizeText(item?.route) || "#")}">
              <i class="fa ${safeHtml(normalizeText(item?.icon) || "fa-circle-o")}"></i>
              <span class="nav-label">${safeHtml(normalizeText(item?.label) || normalizeText(item?.entity) || "Item")}</span>
            </a>`;
            return li;
          }

          function renderTenantMenu(config) {
            initTenantManagedMenuNodes();

            const sideMenu = document.getElementById("side-menu");
            const mountPoint = document.getElementById("tenantMenuMountPoint");
            if (!sideMenu || !mountPoint) return;

            const areas = Array.isArray(config?.areas) ? config.areas : [];
            if (!areas.length) return;

            const RESERVED_FIXED_AREAS = new Set(["service", "sales", "finance", "hr", "po", "settings"]);

            sidebarAreaLabels.clear();
            sidebarAreaLabels.set("home", "Home");
            areas.forEach((area) => {
              const areaId = normalizeText(area?.id).toLowerCase();
              const areaLabel = normalizeText(area?.label);
              if (!areaId || !areaLabel) return;
              if (RESERVED_FIXED_AREAS.has(areaId) && areaId !== "home") return;
              sidebarAreaLabels.set(areaId, areaId === "home" ? "Home" : areaLabel);
            });

            document
              .querySelectorAll("#side-menu li[data-generated='1'], #side-menu li[data-managed-divider='tenant']")
              .forEach((node) => {
                node.remove();
              });

            tenantManagedNodesByEntity.forEach((node) => {
              if (node.parentElement === sideMenu) sideMenu.removeChild(node);
            });

            const fragment = document.createDocumentFragment();
            const usedEntityByArea = new Set();

            areas
              .slice()
              .sort((a, b) => Number(a?.order || 0) - Number(b?.order || 0))
              .forEach((area) => {
                const areaId = normalizeText(area?.id).toLowerCase();
                if (!areaId) return;
                if (RESERVED_FIXED_AREAS.has(areaId) && areaId !== "home") return;

                if (areaId !== "home") {
                  const divider = document.createElement("li");
                  divider.setAttribute("data-areas", areaId);
                  divider.setAttribute("data-managed-divider", "tenant");
                  divider.innerHTML = `<a class="menuDivider" style="padding-top:20px;">${safeHtml(
                    normalizeText(area?.label) || areaId,
                  )}</a>`;
                  fragment.appendChild(divider);
                }

                const items = Array.isArray(area?.items) ? area.items.slice() : [];
                items
                  .sort((a, b) => Number(a?.order || 0) - Number(b?.order || 0))
                  .forEach((item) => {
                    const entity = normalizeText(item?.entity).toLowerCase();
                    if (!entity) return;
                    const areaEntityKey = `${areaId}::${entity}`;
                    if (usedEntityByArea.has(areaEntityKey)) return;
                    usedEntityByArea.add(areaEntityKey);

                    const templateNode = areaId === "home" ? tenantManagedNodesByEntity.get(entity) : null;
                    const li = templateNode || createTenantMenuNode(item);
                    const a = li.querySelector("a");
                    const icon = li.querySelector("i.fa");
                    const label = li.querySelector(".nav-label");

                    li.setAttribute("data-areas", areaId);
                    li.setAttribute("data-managed", "tenant");
                    li.setAttribute("data-entity", entity);
                    li.setAttribute("data-generated", "1");
                    if (!templateNode) li.removeAttribute("id");

                    if (a) a.setAttribute("href", normalizeText(item?.route) || "#");
                    if (icon) icon.className = `fa ${normalizeText(item?.icon) || "fa-circle-o"}`;
                    if (label) label.textContent = normalizeText(item?.label) || normalizeText(item?.entity) || "Item";

                    fragment.appendChild(li);
                  });
              });

            sideMenu.insertBefore(fragment, mountPoint.nextSibling);
          }

          async function fetchTenantTheme() {
            if (window.__billingBootstrapMode === true) return null;
            try {
              const resp = await fetch("/api/admin/theme", {
                method: "GET",
                headers: { Accept: "application/json" },
              });
              if (!resp.ok) return null;
              return await readJsonSafe(resp);
            } catch {
              return null;
            }
          }

          function applyTenantTheme(theme) {
            const t = theme || {};
            const root = document.documentElement;
            root.style.setProperty("--gecom-primary", normalizeText(t.primary_color) || "#1ab394");
            root.style.setProperty("--gecom-nav-bg", normalizeText(t.nav_bg_color) || "#2f4050");
            root.style.setProperty("--gecom-nav-text", normalizeText(t.nav_text_color) || "#a7b1c2");
            root.style.setProperty("--gecom-topbar-bg", normalizeText(t.topbar_bg_color) || "#ffffff");

            const mode = normalizeText(t.layout_mode).toUpperCase();
            document.body.classList.toggle("gecom-layout-dark", mode === "DARK");

            const favicon = normalizeText(t.favicon_url);
            if (favicon) {
              const ico1 = document.getElementById("gecomFavicon");
              const ico2 = document.getElementById("gecomFaviconShortcut");
              if (ico1) ico1.setAttribute("href", favicon);
              if (ico2) ico2.setAttribute("href", favicon);
            }

            const logoUrl = normalizeText(t.logo_url);
            document.querySelectorAll(".logo-element").forEach((el) => {
              if (logoUrl) {
                el.innerHTML = `<img src="${safeHtml(logoUrl)}" alt="Logo" style="max-width:26px;max-height:26px;" />`;
                return;
              }
              el.textContent = "G+";
            });
          }

          async function fetchTenantMenuConfig() {
            if (window.__billingBootstrapMode === true) return null;
            try {
              const resp = await fetch("/api/admin/menu", {
                method: "GET",
                headers: { Accept: "application/json" },
              });
              if (!resp.ok) return null;
              const payload = await readJsonSafe(resp);
              return payload?.config_json || null;
            } catch {
              return null;
            }
          }

          async function fetchTenantModuleAccess() {
            if (window.__billingBootstrapMode === true) return null;
            try {
              const resp = await fetch("/api/me/modules", {
                method: "GET",
                headers: { Accept: "application/json" },
              });
              if (!resp.ok) return null;
              return await readJsonSafe(resp);
            } catch {
              return null;
            }
          }

          async function applyTenantThemeAndMenu() {
            const [theme, menu, moduleAccess] = await Promise.all([
              fetchTenantTheme(),
              fetchTenantMenuConfig(),
              fetchTenantModuleAccess(),
            ]);
            const nextEnabledAreas = normalizeEnabledAreasPayload(moduleAccess || {});
            enabledModuleAreas =
              moduleAccess == null ? new Set(["service", "sales", "finance", "hr", "po"]) : nextEnabledAreas;
            if (theme) applyTenantTheme(theme);
            if (menu) renderTenantMenu(menu);
          }

          function setSidebarPanelOpen(open) {
            const panel = document.getElementById("sidebarAreaPanel");
            const trigger = document.getElementById("sidebarAreaTrigger");
            if (!panel || !trigger) return;
            panel.classList.toggle("is-open", !!open);
            trigger.setAttribute("aria-expanded", open ? "true" : "false");
          }

          async function initSidebarAreaSwitcher() {
            const trigger = document.getElementById("sidebarAreaTrigger");
            const panel = document.getElementById("sidebarAreaPanel");
            if (!trigger || !panel) return;

            await applyTenantThemeAndMenu();

            let savedArea = "home";
            try {
              savedArea = normalizeSidebarArea(localStorage.getItem(SIDEBAR_AREA_KEY));
            } catch {}

            renderSidebarAreaOptions(savedArea);
            applySidebarArea(savedArea);

            trigger.addEventListener("click", function () {
              const isOpen = panel.classList.contains("is-open");
              setSidebarPanelOpen(!isOpen);
            });

            document.addEventListener("click", function (ev) {
              const switcher = document.getElementById("sidebarAreaSwitcher");
              if (!switcher) return;
              if (switcher.contains(ev.target)) return;
              setSidebarPanelOpen(false);
            });
          }

          function persistSidebarState() {
            try {
              const collapsed = document.body.classList.contains("mini-navbar") ? "1" : "0";
              localStorage.setItem("gecom.sidebar.collapsed", collapsed);
            } catch {}
          }

          document.addEventListener("click", function (ev) {
            const trigger = ev.target && ev.target.closest ? ev.target.closest(".navbar-minimalize") : null;
            if (!trigger) return;
            setTimeout(persistSidebarState, 80);
          });

          function pickCompanyId() {
            return (
              window.__auth?.company_id ||
              window.__auth?.companyId ||
              window.__auth?.company?.id ||
              window.__auth?.company?.company_id ||
              null
            );
          }

          function isAdminUser() {
            const role = String(window.__auth?.role || window.__auth?.user_role || "").trim().toLowerCase();
            return (
              window.__auth?.is_admin === true ||
              window.__auth?.isAdmin === true ||
              window.__auth?.user?.is_admin === true ||
              window.__auth?.user?.isAdmin === true ||
              role === "admin" ||
              role === "administrator"
            );
          }

          function normalizeArrayResponse(data) {
            if (Array.isArray(data)) return data;
            if (Array.isArray(data?.data)) return data.data;
            if (Array.isArray(data?.rows)) return data.rows;
            if (Array.isArray(data?.items)) return data.items;
            return [];
          }

          function isReadNotification(n) {
            if (n?.is_read === true) return true;
            if (n?.isRead === true) return true;
            if (n?.read_at || n?.readAt) return true;
            return false;
          }

          function inActiveWindow(n, now) {
            if (n?.is_active === false) return false;
            if (n?.isActive === false) return false;

            const startsAt = n?.starts_at || n?.startsAt || null;
            const expiresAt = n?.expires_at || n?.expiresAt || null;

            const s = startsAt ? new Date(startsAt) : null;
            const e = expiresAt ? new Date(expiresAt) : null;

            if (s && !Number.isNaN(s.getTime()) && now < s) return false;
            if (e && !Number.isNaN(e.getTime()) && now > e) return false;
            return true;
          }

          function sortByDateDesc(a, b) {
            const da = new Date(a?.created_at || a?.createdAt || a?.starts_at || a?.startsAt || 0).getTime();
            const db = new Date(b?.created_at || b?.createdAt || b?.starts_at || b?.startsAt || 0).getTime();
            return db - da;
          }

          function escapeHtml(value) {
            if (value == null) return "";
            return String(value)
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
          }

          function formatDateTimePtBr(value) {
            if (!value) return "-";
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return "-";
            return d.toLocaleString("pt-BR");
          }

          async function fetchTopNotifications(companyId) {
            const q = new URLSearchParams();
            if (companyId) q.set("company_id", String(companyId));
            q.set("is_active", "true");
            q.set("include_expired", "true");

            const res = await fetch(`/api/notifications/admin?${q.toString()}`, {
              method: "GET",
              headers: { Accept: "application/json" }
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data?.message || `HTTP ${res.status}`);
            return normalizeArrayResponse(data);
          }

          async function fetchTopNotificationsSafe(companyId) {
            try {
              return await fetchTopNotifications(companyId);
            } catch {
              const res = await fetch("/api/notifications/my", {
                method: "GET",
                headers: { Accept: "application/json" }
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok) return [];
              const rows = normalizeArrayResponse(data);
              if (isAdminUser()) return rows;
              return rows.filter(n => String(n?.company_id || n?.companyId || "") === String(companyId));
            }
          }

          function buildTop5Notifications(items) {
            const now = new Date();
            return (items || [])
              .filter(n => inActiveWindow(n, now))
              .sort(sortByDateDesc)
              .slice(0, 5);
          }

          function renderTopNotifications(items) {
            const list = document.getElementById("topNotificationsList");
            const badge = document.getElementById("topNotificationsBadge");
            if (!list || !badge) return;

            const rows = buildTop5Notifications(items);
            badge.textContent = String(rows.length);
            badge.style.display = rows.length ? "inline-block" : "none";

            if (!rows.length) {
              list.innerHTML = `<li><a href="#"><div>${escapeHtml(window.t ? window.t("page.layout.topbar.noActiveNotifications", { defaultValue: "Nenhuma notificação ativa." }) : "Nenhuma notificação ativa.")}</div></a></li>
                                <li class="divider"></li>
                                <li><a href="/Notifications"><div class="text-center link-block">${escapeHtml(window.t ? window.t("page.layout.topbar.viewAll", { defaultValue: "Ver todas" }) : "Ver todas")}</div></a></li>`;
              return;
            }

            list.innerHTML = rows.map(n => {
              const id = String(n?.id || "");
              const title = escapeHtml(String(n?.title || (window.t ? window.t("page.layout.topbar.defaultNotificationTitle", { defaultValue: "Notificação" }) : "Notificação")));
              const msg = escapeHtml(String(n?.message || "").trim() || "-");
              const when = formatDateTimePtBr(n?.created_at || n?.createdAt || n?.starts_at || n?.startsAt);
              const readClass = isReadNotification(n) ? "is-read" : "";
              const href = id ? `/NewNotification?id=${encodeURIComponent(id)}` : "/Notifications";

              return `
                <li>
                  <a href="${href}">
                    <div class="top-notification-item ${readClass}">
                      <div class="top-notification-title">${title}</div>
                      <div class="top-notification-message">${msg}</div>
                      <div class="top-notification-time">${escapeHtml(when)}</div>
                    </div>
                  </a>
                </li>
              `;
            }).join("") + `
              <li class="divider"></li>
              <li><a href="/Notifications"><div class="text-center link-block">${escapeHtml(window.t ? window.t("page.layout.topbar.viewAll", { defaultValue: "Ver todas" }) : "Ver todas")}</div></a></li>
            `;
          }

          window.GECOM_NOTIFICATIONS = window.GECOM_NOTIFICATIONS || {};
          window.GECOM_NOTIFICATIONS.fetchTopByCompany = async function () {
            const companyId = pickCompanyId();
            if (!companyId && !isAdminUser()) return [];
            const rows = await fetchTopNotificationsSafe(companyId || null);
            return buildTop5Notifications(rows);
          };

          window.GECOM_NOTIFICATIONS.renderTopBar = async function () {
            const rows = await window.GECOM_NOTIFICATIONS.fetchTopByCompany();
            renderTopNotifications(rows);
          };

          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", function () {
              initSidebarAreaSwitcher().catch(console.error);
              window.GECOM_NOTIFICATIONS.renderTopBar().catch(console.error);
              persistSidebarState();
            });
          } else {
            initSidebarAreaSwitcher().catch(console.error);
            window.GECOM_NOTIFICATIONS.renderTopBar().catch(console.error);
            persistSidebarState();
          }
        })();
      </script>

      <script>
        (function () {
          function debounce(fn, wait) {
            let timer = null;
            return function () {
              const ctx = this;
              const args = arguments;
              clearTimeout(timer);
              timer = setTimeout(function () {
                fn.apply(ctx, args);
              }, wait);
            };
          }

          function esc(v) {
            if (v == null) return "";
            return String(v)
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
          }

          function groupByEntity(items) {
            const groups = {};
            (items || []).forEach((item) => {
              const key = String(item?.entityName || item?.entity_name || "outros");
              if (!groups[key]) groups[key] = [];
              groups[key].push(item);
            });
            return groups;
          }

          function setStatus(text) {
            const el = document.getElementById("aiTopSearchStatus");
            if (!el) return;
            if (!text) {
              el.style.display = "none";
              el.textContent = "";
              return;
            }
            el.style.display = "block";
            el.textContent = text;
          }

          function normalizeArrayResponse(data) {
            if (Array.isArray(data)) return data;
            if (Array.isArray(data?.data)) return data.data;
            if (Array.isArray(data?.rows)) return data.rows;
            if (Array.isArray(data?.items)) return data.items;
            return [];
          }

          async function readJsonSafe(response) {
            const text = await response.text();
            if (!text) return {};
            try { return JSON.parse(text); } catch { return { message: text }; }
          }

          async function getJson(url) {
            const res = await fetch(url, { method: "GET", headers: { Accept: "application/json" } });
            const data = await readJsonSafe(res);
            if (!res.ok) throw new Error(data?.message || `HTTP ${res.status}`);
            return data;
          }

          function pickId(row) {
            return row?.id || row?.Id || row?.product_id || row?.invoice_id || row?.process_id || row?.company_id || null;
          }

          function normalizeIndexFromEntity(entityName, rows) {
            const source = String(entityName || "").toLowerCase();
            const mapped = [];
            (rows || []).forEach((row) => {
              const id = pickId(row);
              if (!id) return;

              if (source === "companies") {
                mapped.push({
                  entityName: "Clientes",
                  id,
                  title: row?.company_name || row?.fantasy_name || row?.legal_name || row?.name || `Cliente ${id}`,
                  subtitle: row?.email || row?.phone || "",
                  href: `/ClientDetails?id=${encodeURIComponent(String(id))}`
                });
              } else if (source === "processes") {
                mapped.push({
                  entityName: "Processos",
                  id,
                  title: row?.process_number || row?.name || `Processo ${id}`,
                  subtitle: row?.companies?.company_name || row?.company_name || row?.status || "",
                  href: `/ProcessDetail?id=${encodeURIComponent(String(id))}`
                });
              } else if (source === "invoices") {
                mapped.push({
                  entityName: "Invoices",
                  id,
                  title: row?.invoice_number || row?.number || `Invoice ${id}`,
                  subtitle: row?.companies?.company_name || row?.company_name || row?.status || "",
                  href: `/NewInvoice?id=${encodeURIComponent(String(id))}`
                });
              } else if (source === "products") {
                mapped.push({
                  entityName: "Produtos",
                  id,
                  title: row?.name || row?.product_name || row?.sku || `Produto ${id}`,
                  subtitle: row?.sku || row?.description || "",
                  href: `/ProductDetail?id=${encodeURIComponent(String(id))}`
                });
              }
            });
            return mapped;
          }

          function filterRowsByQuery(rows, query) {
            const q = String(query || "").toLowerCase();
            return (rows || []).filter((row) => {
              const text = [
                row?.title, row?.subtitle, row?.name, row?.company_name, row?.process_number,
                row?.invoice_number, row?.product_name, row?.email, row?.phone, row?.sku, row?.status
              ].map((v) => String(v || "").toLowerCase()).join(" ");
              return text.includes(q);
            });
          }

          function limitResults(rows, maxPerGroup) {
            return (rows || []).slice(0, maxPerGroup);
          }

          function renderResults(items) {
            const root = document.getElementById("aiTopSearchResults");
            if (!root) return;
            root.innerHTML = "";

            if (!items.length) {
              setStatus("Nenhum resultado.");
              return;
            }

            setStatus("");
            const groups = groupByEntity(items);
            Object.keys(groups).forEach((entityName) => {
              const rows = groups[entityName].map((item) => {
                const title = esc(item?.title || item?.name || item?.id || "-");
                const subtitle = esc(item?.subtitle || "");
                const href = String(item?.href || item?.url || "");
                const content = `
                  <div class="ai-top-item">
                    <div><strong>${title}</strong></div>
                    ${subtitle ? `<div class="ai-top-item-sub">${subtitle}</div>` : ""}
                  </div>
                `;
                if (!href) return content;
                return `<a href="${href}" style="text-decoration:none; color:inherit;">${content}</a>`;
              }).join("");

              root.insertAdjacentHTML("beforeend", `
                <div class="ai-top-group">
                  <p class="ai-top-group-title">${esc(entityName)}</p>
                  ${rows}
                </div>
              `);
            });
          }

          const indexCache = {
            companies: null,
            processes: null,
            invoices: null,
            products: null
          };

          async function loadIndexes() {
            if (!indexCache.companies) {
              indexCache.companies = normalizeArrayResponse(await getJson("/api/companies?fields=summary"));
            }
            if (!indexCache.processes) {
              indexCache.processes = normalizeArrayResponse(await getJson("/api/processes"));
            }
            if (!indexCache.invoices) {
              indexCache.invoices = normalizeArrayResponse(await getJson("/api/invoices?fields=summary"));
            }
            if (!indexCache.products) {
              indexCache.products = normalizeArrayResponse(await getJson("/api/products"));
            }
          }

          async function runTopSearch() {
            const input = document.getElementById("aiTopSearchInput");
            if (!input) return;
            const query = String(input.value || "").trim();
            if (!query) {
              const root = document.getElementById("aiTopSearchResults");
              if (root) root.innerHTML = "";
              setStatus("");
              return;
            }

            setStatus("Buscando...");
            try {
              await loadIndexes();
              const all = [
                ...normalizeIndexFromEntity("companies", filterRowsByQuery(indexCache.companies, query)),
                ...normalizeIndexFromEntity("processes", filterRowsByQuery(indexCache.processes, query)),
                ...normalizeIndexFromEntity("invoices", filterRowsByQuery(indexCache.invoices, query)),
                ...normalizeIndexFromEntity("products", filterRowsByQuery(indexCache.products, query))
              ];

              const groupedLimited = [];
              const grouped = groupByEntity(all);
              Object.keys(grouped).forEach((group) => {
                groupedLimited.push(...limitResults(grouped[group], 6));
              });

              renderResults(groupedLimited);
            } catch (err) {
              setStatus(err?.message || "Falha ao buscar.");
            }
          }

          const debouncedSearch = debounce(runTopSearch, 400);

          function initTopSearch() {
            const li = document.getElementById("aiTopSearchLi");
            const toggle = document.getElementById("aiTopSearchToggle");
            const panel = document.getElementById("aiTopSearchPanel");
            const input = document.getElementById("aiTopSearchInput");
            if (!li || !toggle || !panel || !input) return;

            li.style.display = "";

            toggle.addEventListener("click", function (ev) {
              ev.preventDefault();
              li.classList.toggle("is-open");
              if (li.classList.contains("is-open")) {
                setTimeout(() => input.focus(), 10);
              }
            });

            input.addEventListener("input", debouncedSearch);
            input.addEventListener("keydown", function (ev) {
              if (ev.key === "Escape") li.classList.remove("is-open");
            });

            document.addEventListener("click", function (ev) {
              if (!li.classList.contains("is-open")) return;
              if (li.contains(ev.target)) return;
              li.classList.remove("is-open");
            });
          }

          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", initTopSearch);
          } else {
            initTopSearch();
          }
        })();
      </script>

      <script>
        async function LogOut() {
          try {
            await fetch("/auth/logout", {
              method: "POST",
              headers: { "Content-Type": "application/json" }
            });

            localStorage.removeItem("gecom.profilePictureCache");
            localStorage.removeItem("currentUser");
            window.location.href = "/";
          }
          catch (err) {
            // uses i18next if ready, otherwise fallback
            var msg = (window.t ? window.t("page.layout.modal.close", { defaultValue: "Unexpected error" }) : "Unexpected error");
            alert(msg);
          }
        }
      </script>

      <!-- MudanÃ§a de idioma -->
<script>
  (function () {
    // Prevent double-installation
    if (window.GECOM_LANG) return;

    var SUPPORTED = ["pt-BR", "en", "es"];
    var DEFAULT_LANG = "pt-BR";

    // Where your translation JSON files live:
    // Create these files:
    //   /Assets/i18n/pt-BR.json
    //   /Assets/i18n/en.json
    //   /Assets/i18n/es.json
    function getI18nUrl(lang) {
      return "/locales/" + encodeURIComponent(lang) + "/common.json";
    }

    function normalize(raw) {
      var v = String(raw || "").trim();
      if (!v) return null;
      v = v.replace("_", "-");
      var lower = v.toLowerCase();
      if (lower === "pt" || lower === "pt-br") return "pt-BR";
      if (lower === "en") return "en";
      if (lower === "es") return "es";
      return v;
    }

    function getCookie(name) {
      try {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(";").shift());
        return null;
      } catch { return null; }
    }

    function setCookie(name, value) {
      try {
        document.cookie = name + "=" + encodeURIComponent(value) + "; path=/; SameSite=Lax";
      } catch { }
    }

    function getLangFromUrl() {
      try {
        var u = new URL(window.location.href);
        return normalize(u.searchParams.get("lang"));
      } catch { return null; }
    }

    function setLangOnCurrentUrl(lang) {
      try {
        var u = new URL(window.location.href);
        u.searchParams.set("lang", lang);
        window.location.href = u.pathname + u.search + u.hash;
      } catch {
        window.location.search = "?lang=" + encodeURIComponent(lang);
      }
    }

    function updateLabel(lang) {
      var el = document.getElementById("langLabel");
      if (!el) return;
      var v = String(lang || "").toUpperCase();
      if (v === "PT-BR") v = "PT";
      el.textContent = v;
    }

    function shouldRewriteHref(href) {
      if (!href) return false;
      if (href.startsWith("#")) return false;
      if (href.startsWith("javascript:")) return false;
      if (href.startsWith("mailto:")) return false;
      if (href.startsWith("tel:")) return false;
      if (href.startsWith("/auth/")) return false;
      return true;
    }

    function withLangParam(href, lang) {
      try {
        var abs = new URL(href, window.location.origin);
        if (abs.origin !== window.location.origin) return href;
        abs.searchParams.set("lang", lang);
        return abs.pathname + abs.search + abs.hash;
      } catch {
        return href;
      }
    }

    function rewriteLinks(lang) {
      try {
        document.querySelectorAll("a[href]").forEach(function (a) {
          if (a.getAttribute("data-toggle")) return; // dropdown toggles
          var href = a.getAttribute("href");
          if (!shouldRewriteHref(href)) return;
          a.setAttribute("href", withLangParam(href, lang));
        });
      } catch { }
    }

    // ---------- i18next load + apply ----------
    async function loadTranslations(lang) {
      // You can also inject translations via window.__I18N_RESOURCES if you want
      // window.__I18N_RESOURCES = { "pt-BR": {...}, "en": {...}, "es": {...} }
      try {
        if (window.__I18N_RESOURCES && window.__I18N_RESOURCES[lang]) {
          return window.__I18N_RESOURCES[lang];
        }
      } catch { }

      var url = getI18nUrl(lang);
      var resp = await fetch(url, { method: "GET", headers: { "Accept": "application/json" }, cache: "no-store" });
      if (!resp.ok) throw new Error("Failed to load i18n: " + url + " (" + resp.status + ")");
      return await resp.json();
    }

    function applyI18nToDom() {
      if (!window.i18next || typeof window.i18next.t !== "function") return;

      // Expose window.t for your existing code (alerts, modals, etc.)
      window.t = function (key, options) {
        try { return window.i18next.t(key, options || {}); } catch { return (options && options.defaultValue) ? options.defaultValue : key; }
      };

      // Apply to elements with data-i18n="some.key"
      document.querySelectorAll("[data-i18n]").forEach(function (el) {
        var key = el.getAttribute("data-i18n");
        if (!key) return;

        // Optional: allow attribute translations:
        // <input data-i18n="page.x.y" data-i18n-attr="placeholder">
        var attr = el.getAttribute("data-i18n-attr");
        var value = window.t(key, { defaultValue: el.textContent });

        if (attr) {
          el.setAttribute(attr, value);
          return;
        }

        // Default: textContent
        el.textContent = value;
      });
    }

    async function initI18n(lang) {
      if (!window.i18next) {
        console.warn("i18next not loaded.");
        return;
      }

      document.documentElement.setAttribute("lang", lang);

      var resources = await loadTranslations(lang);

      await window.i18next.init({
        lng: lang,
        fallbackLng: DEFAULT_LANG,
        resources: (function () {
          var pack = {};
          pack[lang] = { translation: resources };
          return pack;
        })(),
        interpolation: { escapeValue: false }
      });

      applyI18nToDom();
    }

    // Decide language (URL wins, then cookie, then default)
    var lang = getLangFromUrl() || normalize(getCookie("gecom_lang")) || DEFAULT_LANG;
    if (!SUPPORTED.includes(lang)) lang = DEFAULT_LANG;

    // Persist and apply "lang UI"
    setCookie("gecom_lang", lang);
    updateLabel(lang);
    rewriteLinks(lang);

    // Init i18next + apply translations
    initI18n(lang).catch(function (e) {
      console.warn("i18n init failed:", e);
      // Still keep UI consistent even if JSON missing
    });

    // Expose API for the dropdown
    window.GECOM_LANG = {
      current: function () { return lang; },
      go: function (lng) {
        var next = normalize(lng) || DEFAULT_LANG;
        if (!SUPPORTED.includes(next)) next = DEFAULT_LANG;
        setCookie("gecom_lang", next);
        setLangOnCurrentUrl(next);
        return false;
      },
      rerender: function () {
        // In case you inject HTML dynamically and want to re-apply translations
        try { applyI18nToDom(); } catch { }
      }
    };

    // Keep links updated if DOM changes
    try {
      var target = document.getElementById("page-wrapper") || document.body;
      if (target && window.MutationObserver) {
        var tmr = null;
        var obs = new MutationObserver(function () {
          if (tmr) clearTimeout(tmr);
          tmr = setTimeout(function () {
            rewriteLinks(lang);
            applyI18nToDom();
          }, 50);
        });
        obs.observe(target, { childList: true, subtree: true });
      }
    } catch { }
  })();
</script>


      <!-- Loader com global spin e validaÃ§Ã£o de sessÃ£o -->
      <script>
        (function () {
          // Prevent double-installation
          if (window.__authFetchInterceptorInstalled) return;
          window.__authFetchInterceptorInstalled = true;
          const isBillingBootstrapMode = window.__billingBootstrapMode === true;

          // ---------------- Global Spinner (counter-based) ----------------
          const spinnerOverlay = document.getElementById("globalSpinner");
          const spinnerText = document.getElementById("globalSpinnerText");

          let pendingCount = 0;
          let hideTimer = null;

          function spinnerRender() {
            if (!spinnerOverlay) return;

            if (pendingCount > 0) {
              if (hideTimer) clearTimeout(hideTimer);
              spinnerOverlay.classList.add("is-visible");
              spinnerOverlay.setAttribute("aria-hidden", "false");
              return;
            }

            // Small delay avoids flicker for very fast requests
            hideTimer = setTimeout(() => {
              spinnerOverlay.classList.remove("is-visible");
              spinnerOverlay.setAttribute("aria-hidden", "true");
              if (spinnerText) {
                spinnerText.style.display = "none";
                spinnerText.textContent = "";
              }
            }, 150);
          }

          function spinnerShow(message) {
            pendingCount++;
            if (spinnerText && message) {
              spinnerText.textContent = String(message);
              spinnerText.style.display = "block";
            }
            spinnerRender();
          }

          function spinnerHide() {
            pendingCount = Math.max(0, pendingCount - 1);
            spinnerRender();
          }

          function spinnerReset() {
            pendingCount = 0;
            spinnerRender();
          }

          async function spinnerWrap(promiseOrFn, message) {
            spinnerShow(message);
            try {
              const p = typeof promiseOrFn === "function" ? promiseOrFn() : promiseOrFn;
              return await p;
            } finally {
              spinnerHide();
            }
          }

          window.GECOM = window.GECOM || {};
          window.GECOM.spinner = { show: spinnerShow, hide: spinnerHide, reset: spinnerReset, wrap: spinnerWrap };

          // ---------------- Session expired modal (Bootstrap GlobalModal) ----------------
          function openSessionExpiredModal() {
            if (isBillingBootstrapMode) return;
            // Avoid opening multiple times
            if (window.__gecomSessionExpiredShown) return;
            window.__gecomSessionExpiredShown = true;

            const modalBtn = document.getElementById("modalButton");
            const modalTitle = document.getElementById("modalTitle");
            const modalBody = document.getElementById("modalBody");
            const btnSave = document.getElementById("saveModal");
            const btnClose = document.getElementById("closeModal");

            // Fallback if modal not found
            if (!modalBtn || !modalTitle || !modalBody || !btnSave || !btnClose) {
              alert("Sua sessÃ£o expirou. FaÃ§a login novamente.");
              window.location.href = "/";
              return;
            }

            var title = window.t ? window.t("page.layout.session.expiredTitle", { defaultValue: "Sessão expirada" }) : "Sessão expirada";
            var line1 = window.t ? window.t("page.layout.session.expiredBody", { defaultValue: "Sua sessão expirou ou você perdeu autorização." }) : "Sua sessão expirou ou você perdeu autorização.";
            var line2 = window.t ? window.t("page.layout.session.expiredBody2", { defaultValue: "Você precisa fazer login novamente." }) : "Você precisa fazer login novamente.";
            var goLogin = window.t ? window.t("page.layout.session.goToLogin", { defaultValue: "Ir para Login" }) : "Ir para Login";

            modalTitle.textContent = title;
            modalBody.innerHTML = `<p>${line1}</p><p>${line2}</p>`;

            btnSave.textContent = goLogin;
            btnSave.classList.remove("btn-danger");
            btnSave.classList.add("btn-primary");

            btnClose.textContent = window.t ? window.t("page.layout.modal.close", { defaultValue: "Fechar" }) : "Fechar";

            const cleanup = () => {
              btnSave.onclick = null;
              btnClose.onclick = null;

              // Restore defaults (translated)
              btnSave.textContent = window.t ? window.t("page.layout.modal.save", { defaultValue: "Salvar" }) : "Save";
              btnClose.textContent = window.t ? window.t("page.layout.modal.close", { defaultValue: "Fechar" }) : "Close";
              btnSave.classList.remove("btn-danger");
              btnSave.classList.add("btn-primary");
            };

            const goToLogin = () => {
              cleanup();
              window.location.href = "/";
            };

            btnSave.onclick = goToLogin;
            btnClose.onclick = goToLogin;

            modalBtn.click();
          }

          // ---------------- Refresh flow (single-flight) ----------------
          let refreshPromise = null;

          async function refreshAccessToken() {
            if (refreshPromise) return refreshPromise;

            refreshPromise = (async () => {
              const resp = await fetch("/auth/refresh", {
                method: "POST",
                headers: { Accept: "application/json" },
                credentials: "same-origin",
                cache: "no-store"
              });

              if (!resp.ok) throw new Error("Refresh failed");
              return true;
            })();

            try {
              return await refreshPromise;
            } finally {
              refreshPromise = null;
            }
          }

          // ---------------- Helpers: decide when to show spinner ----------------
          function shouldIgnoreSpinner(url) {
            if (!url) return false;

            if (
              url.includes("/auth/refresh") ||
              url.includes("/auth/logout") ||
              url.includes("/profile-picture") ||
              url.includes("/api/currencies")
            ) return true;

            const lower = url.toLowerCase();
            if (
              lower.includes("/assets/") ||
              lower.endsWith(".css") ||
              lower.endsWith(".js") ||
              lower.endsWith(".png") ||
              lower.endsWith(".jpg") ||
              lower.endsWith(".jpeg") ||
              lower.endsWith(".svg") ||
              lower.endsWith(".gif") ||
              lower.endsWith(".webp") ||
              lower.endsWith(".ico") ||
              lower.endsWith(".woff") ||
              lower.endsWith(".woff2") ||
              lower.endsWith(".ttf") ||
              lower.endsWith(".map")
            ) return true;

            return false;
          }

          // ---------------- jQuery Ajax global hook ----------------
          if (window.jQuery) {
            jQuery(document).ajaxStart(function () { spinnerShow(); });
            jQuery(document).ajaxStop(function () { spinnerReset(); });
          }

          // ---------------- Fetch interceptor ----------------
          const originalFetch = window.fetch.bind(window);

          window.fetch = async function (input, init) {
            const requestUrl = typeof input === "string" ? input : (input && input.url) || "";

            const isAuthRefresh = requestUrl.includes("/auth/refresh");
            const isAuthLogout = requestUrl.includes("/auth/logout");
            if (isAuthRefresh || isAuthLogout) {
              return originalFetch(input, init);
            }

            const safeInit = init ? { ...init } : {};
            if (!safeInit.credentials) safeInit.credentials = "same-origin";

            const ignoreSpinner = shouldIgnoreSpinner(requestUrl);
            if (!ignoreSpinner) spinnerShow();

            try {
              let response = await originalFetch(input, safeInit);

              if (response.status !== 401 || isBillingBootstrapMode) return response;

              try {
                await refreshAccessToken();
              } catch (e) {
                console.warn("Token refresh failed:", e);
                openSessionExpiredModal();
                return response;
              }

              response = await originalFetch(input, safeInit);

              if (response.status === 401) {
                openSessionExpiredModal();
              }

              return response;
            } finally {
              if (!ignoreSpinner) spinnerHide();
            }
          };

          // ---------------- Periodic auth check (every ~5 minutes) ----------------
          const SESSION_PING_MS = 1000 * 60 * 5; // 5 minutes
          const SESSION_PING_URL = "/api/currencies?is_active=1";

          let sessionPingTimer = null;

          function hasCurrentUser() {
            try {
              const raw = localStorage.getItem("currentUser");
              if (!raw) return false;
              const obj = JSON.parse(raw);
              return !!obj?.id;
            } catch {
              return false;
            }
          }

          async function sessionPing() {
            if (isBillingBootstrapMode) return;
            if (!hasCurrentUser()) return;

            try {
              const resp = await originalFetch(SESSION_PING_URL, {
                method: "GET",
                headers: { Accept: "application/json" },
                credentials: "same-origin",
                cache: "no-store"
              });

              if (resp.status === 401 || resp.status === 403) {
                console.warn("Session ping unauthorized:", resp.status);
                openSessionExpiredModal();
                return;
              }

              if (!resp.ok) {
                console.warn("Session ping non-ok:", resp.status);
              }
            } catch (e) {
              console.warn("Session ping failed (network):", e);
            }
          }

          function startSessionPing() {
            if (sessionPingTimer) clearInterval(sessionPingTimer);

            setTimeout(sessionPing, 30 * 1000);

            sessionPingTimer = setInterval(() => {
              if (document.visibilityState === "visible") sessionPing();
            }, SESSION_PING_MS);
          }

          document.addEventListener("visibilitychange", () => {
            if (isBillingBootstrapMode) return;
            if (document.visibilityState === "visible") sessionPing();
          });

          if (!isBillingBootstrapMode) startSessionPing();
        })();
      </script>

      <script src="/Assets/js/globalSpinner.js"></script>

      <!-- Script de permissÃµes -->
      <script>
        (function () {
          try {
            const raw = localStorage.getItem("currentUser");
            if (!raw) return;

            const user = JSON.parse(raw);

            const name = (user && (user.full_name || user.name)) ? String(user.full_name || user.name).trim() : "";
            const el = document.getElementById("currentUserName");
            if (el && name) el.textContent = name;

            if (window.__auth.isUser) {
              $('a[name="btn_act_new"]').hide();
              $('button[name="btn_act_new"]').hide();
              $('button[name="btn_act_new_manager"]').hide();
              $("#profilePage").hide();
              $('input[name="btn_act_new"]').hide();//
            }
            else if (window.__auth.isManager) {
              $('button[name="btn_act_new_manager"]').hide();
              $("#automationsTab").show();
            }
            else if (window.__auth.isAdmin) {
              $("#myActivitiesTab").show();
              $("#calculoAduaneiro").show();
              if (window.__features?.enableAI) $("#aiHubTab").show();
              $("#clientTab").show();
              $("#clientTabService").show();
              $("#productTab").show();
              $("#leadsTab").show();
              $("#automationsTab").show();
              $("#configDivider").show();
              $("#notificationList").show();
              $("#statusConfigsMenu").show();
              $("#configMainMenu").show();
            }

          } catch (e) {
            console.warn("Failed to load currentUser from localStorage:", e);
          }
        })();
      </script>

      <!-- Esse script aplica foto de perfil -->
      <script>
        (function () {
          // English comments only
          const DEFAULT_AVATAR = "/Assets/inspinia/img/user.png";
          const CACHE_KEY = "gecom.profilePictureCache"; // single cache entry for current user
          const CACHE_TTL_MS = 1000 * 60 * 60 * 24 * 3; // 3 days

          function safeJsonParse(raw) {
            try { return JSON.parse(raw); } catch { return null; }
          }

          function getCurrentUserFromStorage() {
            const raw = localStorage.getItem("currentUser");
            if (!raw) return null;
            return safeJsonParse(raw);
          }

          function getCachedPicture(userId) {
            const raw = localStorage.getItem(CACHE_KEY);
            if (!raw) return null;

            const cache = safeJsonParse(raw);
            if (!cache) return null;

            if (String(cache.userId || "") !== String(userId || "")) return null;

            const savedAt = Number(cache.savedAt || 0);
            if (!savedAt || (Date.now() - savedAt) > CACHE_TTL_MS) return null;

            const value = String(cache.value || "");
            if (!value) return null;

            return value;
          }

          function setCachedPicture(userId, dataUrl) {
            try {
              if (!dataUrl) return;
              localStorage.setItem(CACHE_KEY, JSON.stringify({
                userId: String(userId),
                value: String(dataUrl),
                savedAt: Date.now()
              }));
            } catch (e) {
              console.warn("Failed to cache profile picture:", e);
            }
          }

          async function loadPictureFromApi(userId) {
            const resp = await fetch(`/api/users/me/profile-picture`, {
              method: "GET",
              headers: { Accept: "application/json" }
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) return null;

            const pic = data?.base64;
            return (typeof pic === "string" && pic.trim().length > 0) ? pic : null;
          }

          function setUserAvatar(imgElementId, avatarValue) {
            const img = document.getElementById(imgElementId);
            if (!img) return;

            const raw = (avatarValue ?? "").toString().trim();
            if (!raw) return;

            // If it's already a URL or already a data URI, use as-is
            if (raw.startsWith("data:image/") || raw.startsWith("http://") || raw.startsWith("https://")) {
              img.src = raw;
              setCachedPicture(userId, raw);
              return;
            }

            // If it's base64 only, assume PNG (because your string starts with iVBOR...)
            // Remove accidental prefix if it came as "base64,xxxxx"
            const base64 = raw.includes("base64,") ? raw.split("base64,").pop().trim() : raw;

            img.src = `data:image/png;base64,${base64}`;            
              setCachedPicture(userId, `data:image/png;base64,${base64}`);
          }
          async function applyAvatar() {
            const user = getCurrentUserFromStorage();
            const userId = user?.id;
            const img = document.getElementById("currentUserAvatar");
            if (!img || !userId) return;

            const cached = getCachedPicture(userId);
            if (cached) {
              setUserAvatar("currentUserAvatar", cached);
              return;
            }

            const pic = await loadPictureFromApi(userId);
            if (pic) {
              setUserAvatar("currentUserAvatar", pic);
            } else {
              img.src = DEFAULT_AVATAR;
            }
          }

          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", applyAvatar);
          } else {
            applyAvatar();
          }
        })();
      </script>

      <!-- Esse script altera o alert nativo do navegador para nosso modal -->
      <script>
        (function () {
          if (window.__gecomDialogOverridden) return;
          window.__gecomDialogOverridden = true;

          const originalAlert = window.alert;
          const originalConfirm = window.confirm;

          function getModalElements() {
            return {
              modalBtn: document.getElementById("modalButton"),
              modalTitle: document.getElementById("modalTitle"),
              modalBody: document.getElementById("modalBody"),
              btnSave: document.getElementById("saveModal"),
              btnClose: document.getElementById("closeModal"),
            };
          }

          function tt(key, fallback) {
            try {
              if (window.t) return window.t(key, { defaultValue: fallback });
              return fallback;
            } catch {
              return fallback;
            }
          }

          /* =========================
             ALERT (fire-and-forget)
             ========================= */
          window.alert = function (message, options) {
            const { modalBtn, modalTitle, modalBody, btnSave, btnClose } = getModalElements();

            if (!modalBtn || !modalTitle || !modalBody || !btnSave || !btnClose) {
              originalAlert(message);
              return;
            }

            const opts = options || {};
            modalTitle.textContent = opts.title || tt("page.clientDetails.globalModal.confirmTitle", "Aviso");
            modalBody.innerHTML = `<p>${String(message || "")}</p>`;

            btnSave.textContent = opts.okText || tt("page.layout.modal.ok", "OK");
            btnSave.className = "btn btn-primary";
            btnClose.style.display = "none";

            const cleanup = () => {
              btnSave.onclick = null;
              btnClose.style.display = "";
              btnSave.textContent = tt("page.layout.modal.save", "Salvar");
            };

            btnSave.onclick = () => cleanup();
            modalBtn.click();
          };

          /* =========================
             CONFIRM (Promise<boolean>)
             ========================= */
          window.confirm = function (message, options) {
            const { modalBtn, modalTitle, modalBody, btnSave, btnClose } = getModalElements();

            if (!modalBtn || !modalTitle || !modalBody || !btnSave || !btnClose) {
              return Promise.resolve(originalConfirm(message));
            }

            const opts = options || {};

            modalTitle.textContent = opts.title || tt("page.clientDetails.globalModal.confirmTitle", "Confirmacao");
            modalBody.innerHTML = `<p>${String(message || "")}</p>`;

            btnSave.textContent = opts.okText || tt("page.clientDetails.globalModal.confirmOk", "Confirmar");
            btnClose.textContent = opts.cancelText || tt("page.clientDetails.globalModal.cancel", "Cancelar");

            btnSave.className = opts.danger ? "btn btn-danger" : "btn btn-primary";

            return new Promise((resolve) => {
              const cleanup = () => {
                btnSave.onclick = null;
                btnClose.onclick = null;
                btnSave.className = "btn btn-primary";
                btnSave.textContent = tt("page.layout.modal.save", "Salvar");
                btnClose.textContent = tt("page.layout.modal.close", "Fechar");
              };

              btnSave.onclick = () => { cleanup(); resolve(true); };
              btnClose.onclick = () => { cleanup(); resolve(false); };

              modalBtn.click();
            });
          };

        })();
      </script>

</body>

</html>









