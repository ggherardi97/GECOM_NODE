<style>
    .fa {
        margin-right: 5px;
    }
</style>

<% contentFor('headerLink') %>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <% %>

        <div class="row">
            <div class="col-lg-10">
                <div class="wrapper wrapper-content animated fadeInUp">
                    <div class="ibox">
                        <div class="ibox-content">

                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="m-b-md">
                                        <a name="btn_act_new" href="javascript:void(0)"
                                            class="btn btn-white btn-xs float-right" onclick="openEditProject()">Editar
                                            projeto</a>
                                        <h2 id="projectName">Processo</h2>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-6">
                                    <dl class="row mb-0">
                                        <div class="col-sm-4 text-sm-right">
                                            <dt>Status:</dt>
                                        </div>
                                        <div class="col-sm-8 text-sm-left">
                                            <dd class="mb-1"><span class="label label-primary" id="state">-</span></dd>
                                        </div>
                                    </dl>

                                    <dl class="row mb-0" style="display: none;">
                                        <div class="col-sm-4 text-sm-right">
                                            <dt>Criado por:</dt>
                                        </div>
                                        <div class="col-sm-8 text-sm-left">
                                            <dd class="mb-1" id="contactName">-</dd>
                                        </div>
                                    </dl>

                                    <dl class="row mb-0">
                                        <div class="col-sm-4 text-sm-right">
                                            <dt>Invoice:</dt>
                                        </div>
                                        <div class="col-sm-8 text-sm-left">
                                            <dd class="mb-1" id="invoiceNumber">-</dd>
                                        </div>
                                    </dl>

                                    <dl class="row mb-0">
                                        <div class="col-sm-4 text-sm-right">
                                            <dt>Cliente:</dt>
                                        </div>
                                        <div class="col-sm-8 text-sm-left">
                                            <dd class="mb-1">
                                                <a href="javascript:void(0)" class="text-navy" id="companyName">-</a>
                                            </dd>
                                        </div>
                                    </dl>
                                </div>

                                <div class="col-lg-6" id="cluster_info">
                                    <dl class="row mb-0">
                                        <div class="col-sm-4 text-sm-right">
                                            <dt>Data Estimada de Entrega:</dt>
                                        </div>
                                        <div class="col-sm-8 text-sm-left">
                                            <dd class="mb-1" id="shipDateText">-</dd>
                                        </div>
                                    </dl>

                                    <dl class="row mb-0">
                                        <div class="col-sm-4 text-sm-right">
                                            <dt>Início do Processo:</dt>
                                        </div>
                                        <div class="col-sm-8 text-sm-left">
                                            <dd class="mb-1" id="createdOnText">-</dd>
                                        </div>
                                    </dl>

                                    <!-- Participants REMOVIDO -->
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-12">
                                    <dl class="row mb-0">
                                        <div class="col-sm-2 text-sm-right">
                                            <dt>Concluído:</dt>
                                        </div>
                                        <div class="col-sm-10 text-sm-left">
                                            <dd>
                                                <div class="progress m-b-1">
                                                    <div id="completedBar" style="width: 0%;"
                                                        class="progress-bar progress-bar-striped progress-bar-animated">
                                                    </div>
                                                </div>
                                                <small>
                                                    Projeto concluído em <strong id="completedPercentText">0%</strong>.
                                                </small>
                                            </dd>
                                        </div>
                                    </dl>
                                </div>
                            </div>

                            <div class="row m-t-sm">
                                <div class="col-lg-12">
                                    <div class="panel blank-panel">
                                        <div class="panel-heading">
                                            <div class="panel-options">
                                                <ul class="nav nav-tabs">
                                                    <li><a class="nav-link active" href="#tab-1"
                                                            data-toggle="tab">Timeline</a></li>
                                                    <li id="history_timeline" style="display: none;"><a class="nav-link"
                                                            href="#tab-2" data-toggle="tab">Histórico do Processo</a>
                                                    </li>
                                                    <li><a class="nav-link" href="#tab-3"
                                                            data-toggle="tab">Transportes</a></li>
                                                    <li><a class="nav-link" href="#tab-4" onclick="loadMapLeft()"
                                                            data-toggle="tab">Trajetória</a></li>
                                                </ul>
                                            </div>
                                        </div>

                                        <div class="panel-body">
                                            <div class="tab-content">

                                                <!-- Timeline -->
                                                <div class="tab-pane active" id="tab-1">
                                                    <div class="col-lg-12">
                                                        <div class="ibox">
                                                            <div id="ibox-content">

                                                                <!-- <div class="clearfix" style="margin-bottom: 10px;">
                              <button name="btn_act_new" class="btn btn-sm btn-primary" onclick="openAddEventModal()">
                                Adicionar evento
                              </button>
                            </div> -->

                                                                <div id="vertical-timeline"
                                                                    class="vertical-container dark-timeline center-orientation">
                                                                    <div class="vertical-timeline-block">
                                                                        <div class="vertical-timeline-icon navy-bg">
                                                                            <i class="fa fa-briefcase"></i>
                                                                        </div>
                                                                        <div class="vertical-timeline-content">
                                                                            <h2>Carregando...</h2>
                                                                            <p>Buscando eventos do processo.</p>
                                                                            <span
                                                                                class="vertical-date"><small>—</small></span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Histórico -->
                                                <div class="tab-pane" id="tab-2">
                                                    <div class="panel-body" style="padding-top:0px;">
                                                        
                                                        <div class="row"><div class="col-lg-8">
                                                            
                                                        </div>
                                                        <div class="clearfix col-lg-4" style="margin-bottom: 10px;text-align: end;">
                                                            <button class="btn btn-sm btn-primary" name="btn_act_new"
                                                                onclick="openAddEventModal()">
                                                                Adicionar evento
                                                            </button>
                                                        </div>
</div>
                                                        <div class="table-responsive">
                                                            <table class="table table-striped table-bordered">
                                                                <thead>
                                                                    <tr>
                                                                        <th style="width: 120px;">Status</th>
                                                                        <th>Título</th>
                                                                        <th style="width: 170px;">Começo</th>
                                                                        <th style="width: 170px;">Fim</th>
                                                                        <th>Descrição</th>
                                                                        <th style="width: 90px;text-align: center;">
                                                                            Ações</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="historyLines">
                                                                    <tr>
                                                                        <td colspan="6">Carregando...</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Transportes -->
                                                <div class="tab-pane" id="tab-3">
                                                    <div class="panel-body" style="padding-top:0px;">
                                                        <div class="table-responsive">
                                                            <div class="clearfix" style="margin-bottom: 10px;float:inline-end;">
                                                                <button class="btn btn-sm btn-primary"
                                                                    onclick="openAddTransportModal()" name="btn_act_new_manager">
                                                                    Adicionar transporte
                                                                </button>
                                                            </div>

                                                            <table class="table table-striped table-bordered">
                                                                <thead>
                                                                    <tr>
                                                                         <th>Empresa</th>
    <th>Tipo</th>
    <th>Status</th>
    <th>Origem</th>
    <th>Destino</th>
    <th>Previsão Saída</th>
    <th>Previsão Chegada</th>
                                                                        <th style="width: 90px; text-align:center;">
                                                                            Ações</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="transportsTbody">
                                                                    <tr>
                                                                        <td colspan="7">Carregando...</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="tab-pane" id="tab-4">
                                                    <div id="map" style="height: 500px;"></div>
                                                </div>

                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Lateral (mantida como está no layout original) -->
            <div class="col-lg-2">
                <div class="wrapper wrapper-content project-manager">
                    <h4>Descrição do Processo</h4>
                    <img src="../Assets/inspinia/img/zender_logo.png" class="img-fluid">
                    <p class="small">
                        Importação de carros antigos. Esse processo em específico se destina a trazer 2 carros antigos
                        da china ao brasil.
                    </p>
                    <p class="small font-bold">
                        <span><i class="fa fa-circle text-warning"></i>Prioridade Alta</span>
                    </p>
                    <br />
                    <br />
                    <h4>Documentos do processo</h4>
<small id="processDocsHint" class="text-muted">Carregando documentos...</small>
<br />
<br />

<div id="processDocsFolderHeader" style="display:none; margin-bottom:8px;">
  <i class="fa fa-folder-open"></i>
  <strong id="processDocsFolderName"></strong>
</div>

<ul class="list-unstyled project-files" id="processDocsList">
  <li class="text-muted">Carregando...</li>
</ul>

<div class="m-t-md">
  <button type="button" class="btn btn-xs btn-primary" name="btn_act_new" onclick="openProcessUploadSideModal()">
    <i class="fa fa-upload"></i> Adicionar Documentos
  </button>
</div>
                </div>
            </div>
        </div>

        <!-- Side Modal (mesmo padrão do ClientDetails) -->
        <div id="sideModalOverlay"
            style="position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:2050; display:none;"></div>
        <div id="sideModal"
            style="position:fixed; top:0; right:0; height:100%; width:520px; max-width:92vw; background:#fff; z-index:2060; transform:translateX(100%); transition:transform .18s ease; box-shadow:-10px 0 30px rgba(0,0,0,0.2); display:flex; flex-direction:column;">
            <div
                style="padding:16px 18px; border-bottom:1px solid #e7eaec; display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <div>
                    <h3 id="sideModalTitle" style="margin:0; font-size:16px; font-weight:700;">Modal</h3>
                    <div id="sideModalSubtitle" style="color:#888; font-size:12px;"></div>
                </div>
                <button class="btn btn-white btn-sm" id="sideModalClose"><i class="fa fa-times"></i></button>
            </div>
            <div id="sideModalBody" style="padding:16px 18px; overflow:auto; flex:1;"></div>
            <div
                style="padding:12px 18px; border-top:1px solid #e7eaec; display:flex; gap:8px; justify-content:flex-end;">
                <button class="btn btn-white" id="sideModalCancel">Cancelar</button>
                <button class="btn btn-primary" id="sideModalOk">Salvar</button>
            </div>
        </div>

        <% contentFor('scripts') %>
            <!-- Jvectormap (mantido do layout original) -->
            <script src="../Assets/inspinia/js/plugins/jvectormap/jquery-jvectormap-2.0.2.min.js"></script>
            <script src="../Assets/inspinia/js/plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
            <% %>

                <script>
                    // =========================
                    // State
                    // =========================
                    let processId = null;
                    let processRaw = null;
                    let transportStatusesCache = null;
const transportStatusById = new Map(); // id -> object
const transportTypeById = new Map();

const COUNTRIES = [
  "Brasil",
  "Argentina",
  "Chile",
  "Colômbia",
  "México",
  "Estados Unidos",
  "Canadá",
  "Portugal",
  "Espanha",
  "França",
  "Alemanha",
  "Itália",
  "Reino Unido",
  "Holanda",
  "Bélgica",
  "Suíça",
  "Suécia",
  "Noruega",
  "Dinamarca",
  "Polônia",
  "Irlanda",
  "China",
  "Japão",
  "Coreia do Sul",
  "Índia",
  "Emirados Árabes Unidos",
  "Arábia Saudita",
  "Turquia",
  "Austrália",
  "Nova Zelândia",
  "África do Sul"
];


function normalizeArrayResponse(data) {
  if (Array.isArray(data)) return data;
  if (Array.isArray(data?.data)) return data.data;
  if (Array.isArray(data?.rows)) return data.rows;
  if (Array.isArray(data?.items)) return data.items;
  return [];
}

async function preloadTransportLookups() {
  // Already loaded? skip
  if (transportStatusesCache?.length && transportTypesCache?.length) return;

  const [statusesRes, typesRes] = await Promise.all([
    fetch("/api/transport-statuses", { headers: { Accept: "application/json" } }),
    fetch("/api/transport-types", { headers: { Accept: "application/json" } }),
  ]);

  const statusesJson = await statusesRes.json().catch(() => ({}));
  const typesJson = await typesRes.json().catch(() => ({}));

  transportStatusesCache = normalizeArrayResponse(statusesJson);
  transportTypesCache = normalizeArrayResponse(typesJson);

  transportStatusById.clear();
  transportTypeById.clear();

  transportStatusesCache.forEach((s) => {
    if (s?.id) transportStatusById.set(String(s.id), s);
  });

  transportTypesCache.forEach((t) => {
    if (t?.id) transportTypeById.set(String(t.id), t);
  });
}

function getTransportStatusName(id) {
  const key = String(id || "");
  return transportStatusById.get(key)?.name || key || "-";
}

function getTransportTypeName(id) {
  const key = String(id || "");
  return transportTypeById.get(key)?.name || key || "-";
}

function buildCountryOptions(selectedValue) {
  const selected = String(selectedValue || "").trim();
  return COUNTRIES
    .map((c) => {
      const isSelected = selected && c === selected ? "selected" : "";
      return `<option value="${escapeHtml(c)}" ${isSelected}>${escapeHtml(c)}</option>`;
    })
    .join("");
}

function applyPhoneMask($input) {
  if (!$input || !$input.length) return;

  // If jQuery Mask Plugin exists
  if (typeof $input.mask === "function") {
    // BR: supports 10 or 11 digits (dynamic)
    const behavior = function (val) {
      const digits = String(val || "").replace(/\D/g, "");
      return digits.length > 10 ? "(00) 00000-0000" : "(00) 0000-00009";
    };

    $input.mask(behavior, {
      onKeyPress: function (val, e, field, options) {
        field.mask(behavior.apply({}, arguments), options);
      }
    });

    return;
  }

  // Fallback: keep only digits and format (very simple)
  $input.on("input", function () {
    const digits = this.value.replace(/\D/g, "").slice(0, 11);
    let out = digits;

    if (digits.length >= 2) out = `(${digits.slice(0, 2)}) ${digits.slice(2)}`;
    if (digits.length > 6 && digits.length <= 10) {
      out = `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`;
    } else if (digits.length > 6) {
      out = `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`;
    }

    this.value = out;
  });
}

                    // =========================
                    // Init
                    // =========================
                    $(document).ready(function () {
                        $("#pageName").text("Detalhes do Processo");
                        $("#subSecoundPageName").text("Detalhes do Processo");
                        $("#subpageName").text("Processos");
                        $("#subpageName").attr("href", "Processos");
                        $("#path").show();

                        if (window.__auth.isAdmin) {
                            $("#history_timeline").show();
                        }

                        try {
                            const url = new URL(window.location.href);
                            processId = url.searchParams.get("id");

                            if (!processId) {
                                alert("Parâmetro ausente: id");
                                return;
                            }

                            loadProcessDetail(processId);
                            wireSideModal();
                        } catch (e) {
                            console.error("Init error:", e);
                            alert("Erro ao iniciar a página.");
                        }
                    });

                    async function loadProcessDetail(id) {
                        try {
                            const result = await $.ajax({
                                url: `/api/processes/${encodeURIComponent(id)}`,
                                method: "GET",
                                dataType: "json"
                            });

                            // payload já vem com: transports[] e events[]
                            processRaw = result;

                            fillHeader(processRaw);
                            renderTimeline(processRaw?.events || []);
                            renderHistory(processRaw?.events || []);
                            await preloadTransportLookups();
                            renderTransports(processRaw?.transports || []);
                        
                            await loadProcessDocuments();
} catch (e) {
                            console.error("loadProcessDetail error:", e);
                            alert("Erro ao carregar dados do processo.");
                        }
                    }

                    let transportTypesCache = null;
                    async function getTransportStatuses() {
                        if (transportStatusesCache) return transportStatusesCache;

                        const data = await apiGet("/api/transport-statuses");
                        transportStatusesCache = Array.isArray(data) ? data : (data?.data ?? data?.items ?? []);
                        return transportStatusesCache;
                    }

                    async function getTransportTypes() {
                        if (transportTypesCache) return transportTypesCache;

                        const data = await apiGet("/api/transport-types");
                        transportTypesCache = Array.isArray(data) ? data : (data?.data ?? data?.items ?? []);
                        return transportTypesCache;
                    }

                    async function openAddTransportModal() {
                        if (!processId) {
                            alert("Processo não encontrado.");
                            return;
                        }

                        const [statuses, types] = await Promise.all([
                            getTransportStatuses(),
                            getTransportTypes()
                        ]);

                        const statusOptions = (statuses || []).map(s => {
                            const id = String(s?.id ?? "");
                            const name = String(s?.name ?? s?.status_name ?? id);
                            return `<option value="${escapeHtml(id)}">${escapeHtml(name)}</option>`;
                        }).join("");

                        const typeOptions = (types || []).map(t => {
                            const id = String(t?.id ?? "");
                            const name = String(t?.name ?? t?.type_name ?? id);
                            return `<option value="${escapeHtml(id)}">${escapeHtml(name)}</option>`;
                        }).join("");

                  const html = `
  <div class="form-group">
    <label for="txtTransportCompany">Transportadora</label>
    <input id="txtTransportCompany" class="form-control" />
  </div>

  <div class="form-group">
    <label for="selOrigin">Origem</label>
    <select id="selOrigin" class="form-control">
      <option value="">Selecione...</option>
      ${buildCountryOptions("")}
    </select>
  </div>

  <div class="form-group">
    <label for="selDestination">Destino</label>
    <select id="selDestination" class="form-control">
      <option value="">Selecione...</option>
      ${buildCountryOptions("")}
    </select>
  </div>

  <div class="form-group">
    <label for="txtContactPhone">Telefone de contato</label>
    <input id="txtContactPhone" class="form-control" />
  </div>

  <div class="form-group">
    <label for="selTransportType">Tipo de transporte</label>
    <select id="selTransportType" class="form-control">
      <option value="">Selecione...</option>
      ${typeOptions}
    </select>
  </div>

  <div class="form-group">
    <label for="selTransportStatus">Status do transporte</label>
    <select id="selTransportStatus" class="form-control">
      <option value="">Selecione...</option>
      ${statusOptions}
    </select>
  </div>

  <div class="form-group">
    <label for="dtDeparture">Saída prevista</label>
    <input id="dtDeparture" type="date" class="form-control" />
  </div>

  <div class="form-group">
    <label for="dtArrival">Chegada prevista</label>
    <input id="dtArrival" type="date" class="form-control" />
  </div>
`;


                       SideModal.open({
  title: "Adicionar transporte",
  okText: "Criar",
  html,
  onOk: async function () {
    const payload = {
      process_id: String(processId),
      transport_company: String($("#txtTransportCompany").val() || "").trim() || null,
      origin: $("#selOrigin").val() || null,
      destination: $("#selDestination").val() || null,
      contact_phone: String($("#txtContactPhone").val() || "").trim() || null,
      transport_type_id: $("#selTransportType").val() || null,
      transport_status_id: $("#selTransportStatus").val() || null,
      departure_forecast: $("#dtDeparture").val()
        ? new Date($("#dtDeparture").val() + "T00:00:00.000Z").toISOString()
        : null,
      arrival_forecast: $("#dtArrival").val()
        ? new Date($("#dtArrival").val() + "T00:00:00.000Z").toISOString()
        : null
    };

    await apiPost("/api/transports", payload);
    await loadProcessDetail(processId);
  }
});
setTimeout(() => applyPhoneMask($("#txtContactPhone")), 0);

                    }

                    window.openAddTransportModal = openAddTransportModal;


                    async function apiDelete(url) {
                        const r = await fetch(url, {
                            method: "DELETE",
                            headers: { Accept: "application/json" }
                        });

                        const text = await r.text();
                        let data = {};
                        try { data = text ? JSON.parse(text) : {}; } catch { data = { message: text }; }

                        if (!r.ok) throw new Error(data?.message || "Erro na requisição.");
                        return data;
                    }
                    async function deleteTransport(transportId) {
                        if (!transportId) return;

                        const ok = await confirm("Deseja excluir este transporte?");
                        if (!ok) return;

                        await apiDelete(`/api/transports/${encodeURIComponent(String(transportId))}`);
                        await loadProcessDetail(processId); // recarrega (1 GET)
                    }

                    window.deleteTransport = deleteTransport;

                    async function deleteEvent(eventId) {
                        if (!eventId) return;

                        const ok = await confirm("Deseja excluir este evento?");
                        if (!ok) return;

                        await apiDelete(`/api/events/${encodeURIComponent(eventId)}`);
                        await loadProcessDetail(processId);
                    }
                    window.deleteEvent = deleteEvent;

                    async function apiDelete(url) {
                        const r = await fetch(url, {
                            method: "DELETE",
                            headers: { Accept: "application/json" }
                        });
                        const text = await r.text();
                        let data = {};
                        try { data = text ? JSON.parse(text) : {}; } catch { data = { message: text }; }
                        if (!r.ok) throw new Error(data?.message || "Erro na requisição.");
                        return data;
                    }

                    // =========================
                    // Utils
                    // =========================
                    function escapeHtml(value) {
                        if (value == null) return "";
                        return String(value)
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/\"/g, "&quot;")
                            .replace(/'/g, "&#039;");
                    }

                    function clampPercent(v) {
                        const n = Number(v ?? 0);
                        if (Number.isNaN(n)) return 0;
                        return Math.max(0, Math.min(100, Math.round(n)));
                    }

                    // Date-only formatter (dd/mm/yyyy) SEM bug de timezone
                    function formatDateOnlyPtBR(iso) {
                        if (!iso) return "-";
                        const s = String(iso);
                        if (s.length < 10) return "-";
                        const ymd = s.slice(0, 10); // YYYY-MM-DD
                        const parts = ymd.split("-");
                        if (parts.length !== 3) return "-";
                        const yyyy = parts[0];
                        const mm = parts[1];
                        const dd = parts[2];
                        return `${dd}/${mm}/${yyyy}`;
                    }

                    function formatDateTimePtBR(iso) {
                        if (!iso) return "—";
                        const d = new Date(iso);
                        if (Number.isNaN(d.getTime())) return "—";
                        return d.toLocaleString("pt-BR");
                    }

                    function toDatetimeLocalValue(value) {
                        if (!value) return "";
                        const d = new Date(value);
                        if (Number.isNaN(d.getTime())) return "";
                        const pad = (n) => String(n).padStart(2, "0");
                        const yyyy = d.getFullYear();
                        const MM = pad(d.getMonth() + 1);
                        const dd = pad(d.getDate());
                        const hh = pad(d.getHours());
                        const mm = pad(d.getMinutes());
                        return `${yyyy}-${MM}-${dd}T${hh}:${mm}`;
                    }

                    function toDateValue(value) {
                        if (!value) return "";
                        const s = String(value);
                        return s.slice(0, 10);
                    }

                    async function apiGet(url) {
                        const r = await fetch(url, { headers: { Accept: "application/json" } });
                        const text = await r.text();
                        let data = {};
                        try { data = text ? JSON.parse(text) : {}; } catch { data = { message: text }; }
                        if (!r.ok) throw new Error(data?.message || "Erro na requisição.");
                        return data;
                    }

                    async function apiPost(url, body) {
                        const r = await fetch(url, {
                            method: "POST",
                            headers: { "Content-Type": "application/json", Accept: "application/json" },
                            body: JSON.stringify(body ?? {})
                        });
                        const text = await r.text();
                        let data = {};
                        try { data = text ? JSON.parse(text) : {}; } catch { data = { message: text }; }
                        if (!r.ok) throw new Error(data?.message || "Erro na requisição.");
                        return data;
                    }

                    async function apiPatch(url, body) {
                        const r = await fetch(url, {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json", Accept: "application/json" },
                            body: JSON.stringify(body ?? {})
                        });
                        const text = await r.text();
                        let data = {};
                        try { data = text ? JSON.parse(text) : {}; } catch { data = { message: text }; }
                        if (!r.ok) throw new Error(data?.message || "Erro na requisição.");
                        return data;
                    }

                    // =========================
                    // Header bind
                    // =========================
                    function fillHeader(p) {
                        const number = p?.process_number || "-";
                        $("#projectName").text(`${number}`);

                        const status = p?.status;
                        $("#state")
                            .text(ProcessStatusEnum.getLabel(status))
                            .removeClass()
                            .addClass(`label ${ProcessStatusEnum.getCssClass(status)}`);

                        $("#contactName").text(p?.users?.full_name || "-");
                        $("#invoiceNumber").text(p?.invoice || "-");
                        $("#companyName").text(p?.companies?.company_name || "-");

                        // ship_date -> Data Estimada de Entrega
                        $("#shipDateText").text(formatDateOnlyPtBR(p?.ship_date));
                        $("#createdOnText").text(formatDateOnlyPtBR(p?.created_on));

                        const completed = clampPercent(p?.completed);
                        $("#completedBar").css("width", `${completed}%`);
                        $("#completedPercentText").text(`${completed}%`);
                    }

                    // =========================
                    // Events render
                    // =========================
                    function typeToMeta(type) {
                        const t = Number(type ?? 0);
                        switch (t) {
                            case 8: return { icon: "fa fa-briefcase", btn: null, label: "Informação", color: "#1ab394 !important" };
                            case 1: return { icon: "fa fa-file-text", btn: { text: "Download documento" }, label: "Documento", color: "#1c84c6 !important" };
                            case 2: return { icon: "fa fa-phone", btn: null, label: "Reunião / Telefonema", color: "#f8ac59 !important" };
                            case 3: return { icon: "fa fa-coffee", btn: null, label: "Reunião presencial / Café", color: "#23c6c8 !important" };
                            case 4: return { icon: "fa fa-plane", btn: null, label: "Informação - Aérea", color: "#e1bb00 !important" };
                            case 5: return { icon: "fa fa-ship", btn: null, label: "Informação - Marítimo", color: "#445fad !important" };
                            case 6: return { icon: "fa fa-truck", btn: null, label: "Informação - terrestre", color: "#a17f72 !important" };
                            case 7: return { icon: "fa fa-check-circle-o", btn: null, label: "Processo finalizado", color: "#dc3545 !important" };
                            case 9: return { icon: "fa fa-envelope-o", btn: null, label: "Email", color: "#1c84c6 !important" };
                            default: return { icon: "fa fa-info-circle", btn: null, label: "Evento" };
                        }
                    }

                    function renderTimeline(list) {
                        const container = document.getElementById("vertical-timeline");
                        if (!container) return;

                        container.innerHTML = "";

                        const rows = Array.isArray(list) ? list : [];
                        if (rows.length === 0) {
                            container.innerHTML = `
        <div class="vertical-timeline-block">
          <div class="vertical-timeline-icon navy-bg"><i class="fa fa-briefcase"></i></div>
          <div class="vertical-timeline-content">
            <h2>Nenhum evento</h2>
            <p>Não há eventos cadastrados para este processo.</p>
            <span class="vertical-date"><small>—</small></span>
          </div>
        </div>`;
                            return;
                        }

                        // newest first
                        const sorted = [...rows].sort((a, b) => new Date(b?.start_time ?? 0) - new Date(a?.start_time ?? 0));

                        sorted.forEach((ev) => {
                            const meta = typeToMeta(ev?.type);
                            const title = escapeHtml(ev?.title || "Evento");
                            const desc = escapeHtml(ev?.description || "");
                            const start = ev?.start_time ? formatDateTimePtBR(ev.start_time) : "—";
                            const end = ev?.end_time ? formatDateTimePtBR(ev.end_time) : null;

                            // Documento: mostrar botão, mas por enquanto sem upload: se não existir URL, desabilita
                            const docUrl = ev?.document_url || ev?.file_url || ev?.url || null;
                            let btnHtml = "";
                            if (meta.btn) {
                                if (docUrl) {
                                    btnHtml = `<a href="${escapeHtml(docUrl)}" target="_blank" class="btn btn-sm btn-success">${escapeHtml(meta.btn.text)}</a>`;
                                } else {
                                    btnHtml = `<a href="javascript:void(0)" class="btn btn-sm btn-success disabled" onclick="alert('Documento ainda não disponível para download.')">${escapeHtml(meta.btn.text)}</a>`;
                                }
                            }

                            const block = document.createElement("div");
                            block.className = "vertical-timeline-block";
                            block.innerHTML = `
        <div class="vertical-timeline-icon navy-bg" style='background-color: ${meta.color}'>
          <i class="${escapeHtml(meta.icon)}"></i>
        </div>
        <div class="vertical-timeline-content">
          <h2>${title}</h2>
          ${desc ? `<p>${desc}</p>` : ""}
          ${btnHtml}
          <span class="vertical-date">
            ${escapeHtml(meta.label)}<br>
            <small>${escapeHtml(start)}${end ? ` — ${escapeHtml(end)}` : ""}</small>
          </span>
        </div>
      `;
                            container.appendChild(block);
                        });
                    }
                    let transportsCache = [];
                    function renderHistory(list) {
                        const tbody = document.getElementById("historyLines");
                        if (!tbody) return;

                        tbody.innerHTML = "";

                        const rows = Array.isArray(list) ? list : [];
                        if (rows.length === 0) {
                            tbody.innerHTML = `<tr><td colspan="6">Nenhum evento encontrado.</td></tr>`;
                            return;
                        }

                        // newest first
                        const sorted = [...rows].sort((a, b) => new Date(b?.start_time ?? 0) - new Date(a?.start_time ?? 0));

                        sorted.forEach((ev) => {
                            const isActive = Number(ev?.status ?? 0) === 0;
                            const statusText = isActive ? "Ativo" : "Concluído";
                            const statusClass = isActive ? "label-primary" : "label-success";

                            const title = escapeHtml(ev?.title || "");
                            const start = ev?.start_time ? escapeHtml(formatDateTimePtBR(ev.start_time)) : "—";
                            const end = ev?.end_time ? escapeHtml(formatDateTimePtBR(ev.end_time)) : "—";
                            const desc = escapeHtml(ev?.description || "");
                            const eventId = String(ev?.id || "");

                            const tr = document.createElement("tr");
                            tr.innerHTML = `
        <td><span class="label ${statusClass}">${statusText}</span></td>
        <td>${title}</td>
        <td>${start}</td>
        <td>${end}</td>
        <td><p class="small">${desc}</p></td>
        <td style='text-align: center;' >
          <button class="btn btn-xs btn-danger"onclick="deleteEvent('${escapeHtml(eventId)}')">
            <i class="fa fa-trash" style='    margin-right: 0px !important;'></i>
          </button>
        </td>
      `;
                            tbody.appendChild(tr);
                        });

                    }

function renderTransports(list) {
  transportsCache = Array.isArray(list) ? list : [];
  window.transportsCache = transportsCache;
  const tbody = document.getElementById("transportsTbody");
  if (!tbody) return;

  tbody.innerHTML = "";

  const rows = Array.isArray(list) ? list : [];
  if (rows.length === 0) {
    // Agora são 8 colunas (incluindo Tipo)
    tbody.innerHTML = `<tr><td colspan="8">Nenhum transporte encontrado.</td></tr>`;
    return;
  }

  rows.forEach((t) => {
    const statusName = getTransportStatusName(t?.transport_status_id);
    const typeName = getTransportTypeName(t?.transport_type_id);

    const tr = document.createElement("tr");
    tr.style.cursor = "pointer";
    let disabled = "";

    if (window.__auth.isAdmin) {
      tr.addEventListener("click", function () {
        openEditTransportModal(t);
    disabled = "disabled='disabled'";
      });
    }


    tr.innerHTML = `
      <td>${escapeHtml(t?.transport_company || "-")}</td>
      <td>${escapeHtml(typeName || "-")}</td>
      <td>${escapeHtml(t?.origin || "-")}</td>
      <td>${escapeHtml(t?.destination || "-")}</td>
      <td>${escapeHtml(statusName || "-")}</td>
      <td>${escapeHtml(formatDateOnlyPtBR(t?.departure_forecast))}</td>
      <td>${escapeHtml(formatDateOnlyPtBR(t?.arrival_forecast))}</td>

      <td style="text-align:center; white-space:nowrap;">
        <button ${disabled} class="btn btn-xs btn-info" title="Editar"
          onclick="event.stopPropagation(); editTransportById('${escapeHtml(String(t?.id || ""))}')">
          <i style='margin: 0px !important;' class="fa fa-pencil"></i>
        </button>

        <button ${disabled} class="btn btn-xs btn-danger" title="Excluir"
          onclick="event.stopPropagation(); deleteTransport('${escapeHtml(String(t?.id || ""))}')">
          <i style='margin: 0px !important;' class="fa fa-trash"></i>
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

                    function editTransportById(transportId) {
                        const t = (transportsCache || []).find(x => String(x?.id) === String(transportId));
                        if (!t) {
                            alert("Transporte não encontrado.");
                            return;
                        }
                        openEditTransportModal(t);
                    }
                    window.editTransportById = editTransportById;

                    async function getTransportStatuses() {
                        if (transportStatusesCache) return transportStatusesCache;
                        const data = await apiGet("/api/transport-statuses"); // mesmo endpoint do NovoProcesso
                        transportStatusesCache = Array.isArray(data) ? data : (data?.data ?? data?.items ?? []);
                        return transportStatusesCache;
                    }

async function openEditTransportModal(t) {
  const id = String(t?.id || "");
  if (!id) return;

  // Load lookups (cached)
  const [statuses, types] = await Promise.all([
    getTransportStatuses(),
    getTransportTypes()
  ]);

  const currentStatusId = String(t?.transport_status_id || "");
  const currentTypeId = String(t?.transport_type_id || "");

  const statusOptions = (statuses || [])
    .map((s) => {
      const sid = String(s?.id ?? "");
      const name = String(s?.name ?? s?.status_name ?? sid);
      const selected = sid === currentStatusId ? "selected" : "";
      return `<option value="${escapeHtml(sid)}" ${selected}>${escapeHtml(name)}</option>`;
    })
    .join("");

  const typeOptions = (types || [])
    .map((x) => {
      const tid = String(x?.id ?? "");
      const name = String(x?.name ?? x?.type_name ?? tid);
      const selected = tid === currentTypeId ? "selected" : "";
      return `<option value="${escapeHtml(tid)}" ${selected}>${escapeHtml(name)}</option>`;
    })
    .join("");

  const html = `
    <div class="form-group">
      <label for="txtTransportCompany">Transportadora</label>
      <input id="txtTransportCompany" class="form-control" value="${escapeHtml(t?.transport_company || "")}" />
    </div>

    <div class="form-group">
      <label for="selOrigin">Origem</label>
      <select id="selOrigin" class="form-control">
        <option value="">Selecione...</option>
        ${buildCountryOptions(t?.origin)}
      </select>
    </div>

    <div class="form-group">
      <label for="selDestination">Destino</label>
      <select id="selDestination" class="form-control">
        <option value="">Selecione...</option>
        ${buildCountryOptions(t?.destination)}
      </select>
    </div>

    <div class="form-group">
      <label for="txtContactPhone">Telefone de contato</label>
      <input id="txtContactPhone" class="form-control" value="${escapeHtml(t?.contact_phone || "")}" />
    </div>

    <div class="form-group">
      <label for="selTransportType">Tipo de transporte</label>
      <select id="selTransportType" class="form-control">
        <option value="">Selecione...</option>
        ${typeOptions}
      </select>
    </div>

    <div class="form-group">
      <label for="selTransportStatus">Status do transporte</label>
      <select id="selTransportStatus" class="form-control">
        <option value="">Selecione...</option>
        ${statusOptions}
      </select>
    </div>

    <div class="form-group">
      <label for="dtDeparture">Saída prevista</label>
      <input id="dtDeparture" type="date" class="form-control" value="${escapeHtml(toDateValue(t?.departure_forecast))}" />
    </div>

    <div class="form-group">
      <label for="dtArrival">Chegada prevista</label>
      <input id="dtArrival" type="date" class="form-control" value="${escapeHtml(toDateValue(t?.arrival_forecast))}" />
    </div>
  `;

  SideModal.open({
    title: "Editar transporte",
    html,
    onOk: async function () {
      const payload = {
        transport_company: String($("#txtTransportCompany").val() || "").trim() || null,
        origin: $("#selOrigin").val() || null,
        destination: $("#selDestination").val() || null,
        contact_phone: String($("#txtContactPhone").val() || "").trim() || null,
        transport_type_id: $("#selTransportType").val() || null,
        transport_status_id: $("#selTransportStatus").val() || null,
        departure_forecast: $("#dtDeparture").val()
          ? new Date($("#dtDeparture").val() + "T00:00:00.000Z").toISOString()
          : null,
        arrival_forecast: $("#dtArrival").val()
          ? new Date($("#dtArrival").val() + "T00:00:00.000Z").toISOString()
          : null
      };

      await apiPatch(`/api/transports/${encodeURIComponent(id)}`, payload);
      await loadProcessDetail(processId); // 1 GET refresh
    }
  });

  // Apply phone mask after modal renders
  setTimeout(() => applyPhoneMask($("#txtContactPhone")), 0);
}

                    // =========================
                    // Side modal: Edit process (PATCH)
                    // =========================
                    function openEditProject() {
                        if (!processRaw) return;

                        const completed = clampPercent(processRaw?.completed);
                        const shipLocal = toDatetimeLocalValue(processRaw?.ship_date); // ✅ preenche com a data atual
                        const status = Number(processRaw?.status ?? 0);

                        const html = `
      <div class="form-group">
        <label for="txtCompleted">Concluído (0 a 100)</label>
        <input id="txtCompleted" type="number" min="0" max="100" class="form-control" value="${escapeHtml(String(completed))}" />
      </div>

      <div class="form-group">
        <label for="dtShip">Data estimada de entrega</label>
        <input id="dtShip" type="datetime-local" class="form-control" value="${escapeHtml(shipLocal)}" />
      </div>

      <div class="form-group">
        <label for="selStatus">Status</label>
        <select id="selStatus" class="form-control">
          <option value="0" ${status === 0 ? "selected" : ""}>Rascunho</option>
          <option value="1" ${status === 1 ? "selected" : ""}>Em andamento</option>
          <option value="2" ${status === 2 ? "selected" : ""}>Próximo do prazo</option>
          <option value="3" ${status === 3 ? "selected" : ""}>Atrasado</option>
          <option value="4" ${status === 4 ? "selected" : ""}>Finalizado</option>
        </select>
      </div>
    `;

                        SideModal.open({
                            title: "Editar projeto",
                            html,
                            onOk: async function () {
                                const payload = {
                                    completed: clampPercent($("#txtCompleted").val()),
                                    status: Number($("#selStatus").val()),
                                    ship_date: $("#dtShip").val() ? new Date($("#dtShip").val()).toISOString() : null
                                };

                                await apiPatch(`/api/processes/${encodeURIComponent(processId)}`, payload);
                                await loadProcessDetail(processId); // 1 GET
                            }
                        });
                    }
                    window.openEditProject = openEditProject;

                    // =========================
                    // Side modal: Add event (POST)
                    // =========================
                    function openAddEventModal() {
                        const html = `
      <div class="form-group">
        <label for="selEventType">Tipo</label>
        <select id="selEventType" class="form-control">
          <option value="1">1 - Documento</option>
          <option value="2">2 - Reunião / Telefonema</option>
          <option value="3">3 - Reunião presencial / Café</option>
          <option value="4">4 - Info Aéreo</option>
          <option value="5">5 - Info Marítimo</option>
          <option value="6">6 - Info terrestre</option>
          <option value="7">7 - Processo finalizado</option>
          <option value="8">8 - Informação (Genérica)</option>
          <option value="9">9 - Email</option>
        </select>
      </div>

      <div class="form-group">
        <label for="txtEventTitle">Título</label>
        <input id="txtEventTitle" class="form-control" />
      </div>

      <div class="form-group">
        <label for="txtEventDescription">Descrição</label>
        <textarea id="txtEventDescription" class="form-control" rows="4"></textarea>
      </div>

      <div class="form-group">
        <label for="dtStart">Início</label>
        <input id="dtStart" type="datetime-local" class="form-control" />
      </div>

      <div class="form-group">
        <label for="dtEnd">Fim</label>
        <input id="dtEnd" type="datetime-local" class="form-control" />
      </div>
    `;

                        SideModal.open({
                            title: "Adicionar evento",
                            okText: "Criar",
                            html,
                            onOk: async function () {
                                const payload = {
                                    related_table: "process",
                                    related_id: String(processId),
                                    type: Number($("#selEventType").val()),
                                    title: String($("#txtEventTitle").val() || "").trim() || "(Sem título)",
                                    description: String($("#txtEventDescription").val() || "").trim() || null,
                                    start_time: $("#dtStart").val() ? new Date($("#dtStart").val()).toISOString() : new Date().toISOString(),
                                    end_time: $("#dtEnd").val() ? new Date($("#dtEnd").val()).toISOString() : null
                                };

                                await apiPost("/api/events", payload);
                                await loadProcessDetail(processId); // 1 GET
                            }
                        });
                    }
                    window.openAddEventModal = openAddEventModal;

                    // =========================
                    // SideModal helper
                    // =========================
                    const SideModal = (function () {
                        const $overlay = $("#sideModalOverlay");
                        const $modal = $("#sideModal");
                        const $title = $("#sideModalTitle");
                        const $subtitle = $("#sideModalSubtitle");
                        const $body = $("#sideModalBody");
                        const $btnOk = $("#sideModalOk");
                        const $btnCancel = $("#sideModalCancel");
                        const $btnClose = $("#sideModalClose");

                        function close() {
                            $modal.css("transform", "translateX(100%)");
                            $overlay.hide();
                            $body.html("");
                            $title.text("Modal");
                            $subtitle.text("");
                            $btnOk.prop("disabled", false);
                            $btnOk.off("click");
                            $btnCancel.off("click");
                            $btnClose.off("click");
                            $overlay.off("click");
                        }

                        function open(opts) {
                            const title = opts?.title ?? "Modal";
                            const subtitle = opts?.subtitle ?? "";
                            const html = opts?.html ?? "";
                            const okText = opts?.okText ?? "Salvar";
                            const cancelText = opts?.cancelText ?? "Cancelar";
                            const onOk = opts?.onOk;

                            $title.text(title);
                            $subtitle.text(subtitle);
                            $body.html(html);
                            $btnOk.text(okText);
                            $btnCancel.text(cancelText);

                            $overlay.show();
                            $modal.css("transform", "translateX(0)");

                            $btnClose.on("click", function () { close(); });
                            $btnCancel.on("click", function () { close(); });
                            $overlay.on("click", function () { close(); });

                            $btnOk.on("click", async function () {
                                if (typeof onOk !== "function") { close(); return; }
                                try {
                                    $btnOk.prop("disabled", true);
                                    await onOk();
                                    close();
                                } catch (e) {
                                    console.error("SideModal onOk error:", e);
                                    $btnOk.prop("disabled", false);
                                    alert(e?.message || "Erro ao salvar.");
                                }
                            });
                        }

                        return { open, close };
                    })();

                    function wireSideModal() {
                        // already wired via SideModal.open
                    }


                    // =========================
// Process documents (sidebar)
// =========================
let processDocsFolder = null; // folder doc item
let processDocsItems = [];    // child items

function getAccountIdForCreate() {
  const id =
    window.__auth?.accountId ||
    window.__auth?.account_id ||
    window.__auth?.account?.id ||
    window.__auth?.tenant_id ||
    window.__auth?.admin_account_id ||
    null;

  if (id) return String(id);

  const companyId = window.__auth?.company_id || window.__auth?.companyId || null;
  return companyId ? String(companyId) : null;
}

function isFolderDoc(item) {
  return String(item?.item_type || "").toUpperCase() === "FOLDER";
}
function isLinkDoc(item) {
  return String(item?.item_type || "").toUpperCase() === "LINK";
}
function iconForDoc(item) {
  if (isFolderDoc(item)) return '<i class="fa fa-folder"></i>';

  if (isLinkDoc(item)) return '<i class="fa fa-link"></i>';

  const ext = String(item?.ext || "").toLowerCase();
  const mime = String(item?.mime_type || "").toLowerCase();

  if (mime.startsWith("image/")) return '<i class="fa fa-file-image-o"></i>';
  if (mime.startsWith("video/")) return '<i class="fa fa-film"></i>';
  if (mime.startsWith("audio/")) return '<i class="fa fa-music"></i>';
  if (ext === "pdf") return '<i class="fa fa-file-pdf-o"></i>';
  if (ext === "xls" || ext === "xlsx" || mime.includes("spreadsheet")) return '<i class="fa fa-bar-chart-o"></i>';
  if (ext === "doc" || ext === "docx") return '<i class="fa fa-file-word-o"></i>';
  return '<i class="fa fa-file"></i>';
}

async function loadProcessDocuments() {
  if (!processId) return;

  const $hint = $("#processDocsHint");
  const $folderHeader = $("#processDocsFolderHeader");
  const $folderName = $("#processDocsFolderName");
  const $list = $("#processDocsList");

  try {
    $hint.text("Carregando documentos...");
    $list.html('<li class="text-muted">Carregando...</li>');
    $folderHeader.hide();
    processDocsFolder = null;
    processDocsItems = [];

    // 1) Find folder of this process (usually root folder with process name)
    const folderRes = await apiGet(`/api/documents?parent_id=null&item_type=FOLDER&related_table=process&related_id=${encodeURIComponent(String(processId))}`);
    const folders = normalizeArrayResponse(folderRes);

    // If backend returns an object with array props, normalizeArrayResponse handles it.
    processDocsFolder = folders.length ? folders[0] : null;

    if (!processDocsFolder) {
      $hint.text("Nenhuma pasta encontrada para este processo.");
      $list.html('<li class="text-muted">Nenhum documento encontrado.</li>');
      return;
    }

    $folderName.text(processDocsFolder?.name || "Pasta do processo");
    $folderHeader.show();

    // 2) Load children (files/links) from that folder
    const childrenRes = await apiGet(`/api/documents?parent_id=${encodeURIComponent(String(processDocsFolder.id))}`);
    const children = normalizeArrayResponse(childrenRes);

    processDocsItems = (children || []).filter((x) => String(x?.item_type || "").toUpperCase() !== "FOLDER");

    renderProcessDocuments();
    $hint.text("Clique no documento para abrir.");
  } catch (e) {
    console.error("loadProcessDocuments error:", e);
    $hint.text("Erro ao carregar documentos.");
    $list.html('<li class="text-danger">Erro ao carregar documentos.</li>');
  }
}

function renderProcessDocuments() {
  const $list = $("#processDocsList");

  if (!processDocsFolder) {
    $list.html('<li class="text-muted">Nenhum documento encontrado.</li>');
    return;
  }

  if (!processDocsItems.length) {
    $list.html('<li class="text-muted">Nenhum arquivo nesta pasta.</li>');
    return;
  }

  const html = processDocsItems.map((d) => {
    const id = String(d?.id || "");
    const name = escapeHtml(d?.name || d?.filename || "Sem nome");
    const icon = iconForDoc(d);
    return `<li><a href="javascript:void(0)" onclick="openProcessDocById('${escapeHtml(id)}')">${icon}${name}</a></li>`;
  }).join("");

  $list.html(html);
}

async function openProcessDocById(id) {
  const item = (processDocsItems || []).find((x) => String(x?.id) === String(id));
  if (!item) return;

  // LINK: open directly
  if (isLinkDoc(item)) {
    const url = item?.object_key || item?.external_key || "";
    if (url) window.open(url, "_blank", "noopener,noreferrer");
    return;
  }

  // FILE: presign download and open
  try {
    window.GECOM?.spinner?.show("Abrindo documento...");
    const dl = await apiGet("/api/documents/" + encodeURIComponent(String(item.id)) + "/presign-download");
    const url = dl?.url || dl?.downloadUrl || dl?.signedUrl;
    if (!url) throw new Error("Não foi possível gerar o link de download.");
    window.open(url, "_blank", "noopener,noreferrer");
  } catch (e) {
    alert(e?.message || "Erro ao abrir documento.");
  } finally {
    window.GECOM?.spinner?.hide();
  }
}
window.openProcessDocById = openProcessDocById;

// ---------------------------
// Upload flow (same contract as MyDocuments)
// ---------------------------
function getExtFromName(fileName) {
  const n = String(fileName || "");
  const idx = n.lastIndexOf(".");
  if (idx <= 0 || idx >= n.length - 1) return null;
  return n.substring(idx + 1).toLowerCase();
}

async function ensureProcessFolderExists() {
  if (processDocsFolder?.id) return processDocsFolder;

  // Try reload first
  await loadProcessDocuments();
  if (processDocsFolder?.id) return processDocsFolder;

  const accountId = getAccountIdForCreate();
  if (!accountId) throw new Error("Não foi possível identificar o account_id para criar documento.");

  const processName = String(processRaw?.name || $("#projectName").text() || "Processo").trim();

  const createdFolder = await apiPost("/api/documents", {
    account_id: accountId,
    parent_id: null,
    item_type: "FOLDER",
    name: processName,
    filename: null,
    storage_provider: "R2",
    related_table: "process",
    related_id: String(processId)
  });

  processDocsFolder = createdFolder;
  return processDocsFolder;
}

async function doUploadToProcessFolder(file, displayNameRaw, progressCb) {
  const folder = await ensureProcessFolderExists();
  const accountId = getAccountIdForCreate();
  if (!accountId) throw new Error("Não foi possível identificar o account_id para enviar.");

  const fileName = file.name;
  const displayName = displayNameRaw || fileName;
  const mimeType = file.type || "application/octet-stream";
  const ext = getExtFromName(fileName);

  progressCb && progressCb(5, "Criando registro no banco...");

  const created = await apiPost("/api/documents", {
    account_id: accountId,
    parent_id: String(folder.id),
    item_type: "FILE",
    name: displayName,
    filename: fileName,
    ext: ext,
    mime_type: mimeType,
    related_table: "process",
    related_id: String(processId)
  });

  const docId = created?.id;
  if (!docId) throw new Error("Falha ao criar registro do documento.");

  progressCb && progressCb(20, "Gerando URL de upload...");

  const presign = await apiPost("/api/documents/" + encodeURIComponent(String(docId)) + "/presign-upload", {
    fileName: fileName,
    contentType: mimeType,
    size: file.size
  });

  const putUrl = presign?.url;
  const putHeaders = presign?.headers || { "Content-Type": mimeType };
  const objectKey = presign?.object_key || presign?.key || null;

  if (!putUrl) throw new Error("Não foi possível gerar a URL de upload.");

  progressCb && progressCb(45, "Enviando arquivo para o Cloudflare R2...");

  const putRes = await fetch(putUrl, { method: "PUT", headers: putHeaders, body: file });
  if (!putRes.ok) {
    const t = await putRes.text().catch(() => "");
    throw new Error(("Upload falhou (" + putRes.status + "). " + (t || "")).trim());
  }

  const etag = putRes.headers.get("etag") || presign?.etag || null;

  progressCb && progressCb(85, "Finalizando...");

  await apiPost("/api/documents/" + encodeURIComponent(String(docId)) + "/complete-upload", {
    upload_status: "UPLOADED",
    object_key: objectKey,
    etag: etag,
    mime_type: mimeType,
    size_bytes: file.size
  });

  progressCb && progressCb(100, "Concluído!");
  return docId;
}

function openProcessUploadSideModal() {
  SideModal.open({
    title: "Upload de Documento",
    okText: "Enviar",
    html: `
      <div class="alert alert-info" style="margin-bottom:10px;">
        Selecione apenas um arquivo.
      </div>

      <div class="form-group">
        <label>Arquivo</label>
        <input id="sm_uploadFile" type="file" class="form-control" />
      </div>

      <div class="form-group">
        <label>Nome</label>
        <input id="sm_uploadDisplayName" type="text" class="form-control" maxlength="255"
          placeholder="Vamos preencher automaticamente com o nome do arquivo" />
        <small class="text-muted">Você pode alterar o nome antes de enviar.</small>
      </div>

      <div id="sm_uploadProgress" style="display:none;">
        <div class="progress progress-striped active">
          <div id="sm_uploadProgressBar" class="progress-bar" style="width: 0%"></div>
        </div>
        <small id="sm_uploadProgressText" class="text-muted"></small>
      </div>

      <div id="sm_uploadError" class="text-danger" style="display:none;"></div>
    `,
    onOk: async function () {
      const input = document.getElementById("sm_uploadFile");
      const file = input && input.files && input.files[0];
      const displayNameRaw = ($("#sm_uploadDisplayName").val() || "").trim();
      $("#sm_uploadError").hide().text("");

      if (!file) { $("#sm_uploadError").show().text("Selecione um arquivo."); return true; }

      try {
        window.GECOM?.spinner?.show("Enviando documento...");
        $("#sm_uploadProgress").show();

        await doUploadToProcessFolder(file, displayNameRaw, function (pct, text) {
          $("#sm_uploadProgressBar").css("width", String(Math.max(0, Math.min(100, pct || 0))) + "%");
          $("#sm_uploadProgressText").text(text || "");
        });

        // refresh sidebar
        await loadProcessDocuments();
        return false;
      } catch (e) {
        $("#sm_uploadError").show().text(e?.message || "Erro no upload.");
        return true;
      } finally {
        window.GECOM?.spinner?.hide();
      }
    }
  });

  // auto-fill name
  setTimeout(function () {
    const $file = $("#sm_uploadFile");
    const $name = $("#sm_uploadDisplayName");

    $file.off("change.__autoname").on("change.__autoname", function () {
      const f = this.files && this.files[0];
      if (!f) return;
      $name.val(f.name || "");
      try { $name.focus(); } catch {}
    });
  }, 30);
}
window.openProcessUploadSideModal = openProcessUploadSideModal;

                </script>

                <script>
                    function loadMapLeft() {
  setTimeout(function () {
    // Reuse same map instance (avoid "Map container is already initialized")
    if (window.__trackingMap) {
      try { window.__trackingMap.remove(); } catch { /* ignore */ }
      window.__trackingMap = null;
    }

    const mapEl = document.getElementById("map");
    if (!mapEl) return;

    // Leaflet map
    const map = L.map("map").setView([0, 0], 2);
    window.__trackingMap = map;

    // Base tiles
    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    // Country "average" coordinates (enough for v1)
    // Tip: if you want global coverage, you can fetch lat/lng from a Countries API and cache it (see notes in chat).
    const COUNTRY_COORDS = {
      "Brasil": [-14.2350, -51.9253],
      "Brazil": [-14.2350, -51.9253],
      "China": [35.8617, 104.1954],
      "Índia": [20.5937, 78.9629],
      "India": [20.5937, 78.9629],
      "Portugal": [39.3999, -8.2245],
      "África do Sul": [-30.5595, 22.9375],
      "South Africa": [-30.5595, 22.9375],
      "Argentina": [-38.4161, -63.6167],
      "Chile": [-35.6751, -71.5430],
      "Colômbia": [4.5709, -74.2973],
      "Colombia": [4.5709, -74.2973],
      "México": [23.6345, -102.5528],
      "Mexico": [23.6345, -102.5528],
      "Estados Unidos": [37.0902, -95.7129],
      "United States": [37.0902, -95.7129],
      "Canadá": [56.1304, -106.3468],
      "Canada": [56.1304, -106.3468],
      "Espanha": [40.4637, -3.7492],
      "Spain": [40.4637, -3.7492],
      "França": [46.2276, 2.2137],
      "France": [46.2276, 2.2137],
      "Alemanha": [51.1657, 10.4515],
      "Germany": [51.1657, 10.4515],
      "Itália": [41.8719, 12.5674],
      "Italy": [41.8719, 12.5674],
      "Reino Unido": [55.3781, -3.4360],
      "United Kingdom": [55.3781, -3.4360],
      "Holanda": [52.1326, 5.2913],
      "Netherlands": [52.1326, 5.2913],
      "Bélgica": [50.5039, 4.4699],
      "Belgium": [50.5039, 4.4699],
      "Suíça": [46.8182, 8.2275],
      "Switzerland": [46.8182, 8.2275],
      "Japão": [36.2048, 138.2529],
      "Japan": [36.2048, 138.2529],
      "Coreia do Sul": [35.9078, 127.7669],
      "South Korea": [35.9078, 127.7669],
      "Emirados Árabes Unidos": [23.4241, 53.8478],
      "United Arab Emirates": [23.4241, 53.8478],
      "Austrália": [-25.2744, 133.7751],
      "Australia": [-25.2744, 133.7751],
      "Nova Zelândia": [-40.9006, 174.8860],
      "New Zealand": [-40.9006, 174.8860]
    };

    function getCoords(countryName) {
      const key = String(countryName || "").trim();
      return COUNTRY_COORDS[key] || null;
    }
function getTransportLineColor(transportType) {
  if (!transportType) return '#999';

  const type = transportType.toLowerCase();

  switch (type) {
    case 'maritimo':
    case 'marítimo':
    case 'sea':
    case 'ocean':
      return '#1c84c6'; // azul

    case 'aereo':
    case 'aéreo':
    case 'air':
      return '#1ab394'; // verde

    case 'terrestre':
    case 'road':
    case 'land':
      return '#8b5a2b'; // marrom

    default:
      return '#999'; // fallback cinza
  }
}

    const transports = Array.isArray(window.transportsCache) ? window.transportsCache : [];
    const routes = transports
      .map(t => ({
        origin: String(t?.origin || "").trim(),
        destination: String(t?.destination || "").trim(),
        status: String(getTransportStatusName(t?.transport_status_id) || "").trim()
      }))
      .filter(r => r.origin && r.destination);

    if (!routes.length) {
      map.setView([0, 0], 2);
      return;
    }

    const allLatLngs = [];
    routes.forEach((r) => {
      const o = getCoords(r.origin);
      const d = getCoords(r.destination);

      // If we don't know the coords, skip the route (v1).
      // You can improve this later by geocoding/countries-api.
      if (!o || !d) return;

      // Markers
      const oMarker = L.marker(o).addTo(map).bindPopup(`<b>${escapeHtml(r.origin)}</b>`);
      const dMarker = L.marker(d).addTo(map).bindPopup(`<b>${escapeHtml(r.destination)}</b>`);

      // Route line
      const latlngs = [o, d];
      const line = L.polyline(latlngs, { weight: 3 }).addTo(map);
      line.bindPopup(`<b>${escapeHtml(r.origin)} → ${escapeHtml(r.destination)}</b><br/><small>Status: ${escapeHtml(r.status || "-")}</small>`);

      allLatLngs.push(...latlngs);
    });

    if (allLatLngs.length) {
      map.fitBounds(L.latLngBounds(allLatLngs), { padding: [24, 24] });
    } else {
      map.setView([0, 0], 2);
    }
  }, 500);
}</script>