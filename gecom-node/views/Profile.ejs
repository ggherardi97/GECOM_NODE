<style>
  .img-fluid {
    max-width: 80% !important;
    height: auto;
  }

  p {
    margin-top: 0;
    margin-bottom: 5px;
  }

  /* Contact card actions (icons like ClientDetail) */
  .user-card-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 10px;
    z-index: 3;
  }

  .user-card-actions .action-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f3f4;
    border: 1px solid #e7eaec;
    cursor: pointer;
  }

  .user-card-actions .action-icon:hover {
    background: #e7eaec;
  }

  .user-avatar-round {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #e7eaec;
    background: #fff;
  }

  .muted {
    color: #888;
    font-size: 12px;
  }

  .profile-card {
    position: relative;
    cursor: default;
  }

  .profile-info-dl dt {
    font-weight: 600;
    color: #666;
  }

  .profile-info-dl dd {
    margin-bottom: 6px;
  }

  /* Users list (tab 2) */
  .user-card {
    position: relative;
    cursor: pointer;
  }

  .user-card:hover {
    box-shadow: 0 0 0 3px rgba(26, 179, 148, 0.10);
  }

  .user-badge {
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 12px;
    display: inline-block;
  }

  .user-badge.admin {
    background: rgba(220, 38, 38, 0.12);
    color: rgb(220, 38, 38);
    border: 1px solid rgba(220, 38, 38, 0.25);
  }

  .user-badge.manager {
    background: rgba(23, 162, 184, 0.12);
    color: rgb(23, 162, 184);
    border: 1px solid rgba(23, 162, 184, 0.25);
  }

  .user-badge.user {
    background: rgba(108, 117, 125, 0.12);
    color: rgb(108, 117, 125);
    border: 1px solid rgba(108, 117, 125, 0.25);
  }

  .user-status-pill {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 12px;
    display: inline-block;
    border: 1px solid rgba(0,0,0,0.08);
  }

  .user-status-pill.active {
    background: rgba(26, 179, 148, 0.12);
    color: rgb(26, 179, 148);
    border-color: rgba(26, 179, 148, 0.25);
  }

  .user-status-pill.inactive {
    background: rgba(220, 53, 69, 0.10);
    color: rgb(220, 53, 69);
    border-color: rgba(220, 53, 69, 0.20);
  }

  /* Password strength */
  .pw-meter {
    height: 10px;
    width: 100%;
    background: #eee;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid #e7eaec;
  }

  .pw-meter > div {
    height: 100%;
    width: 0%;
    background: #1ab394;
  }

  .pw-reqs li {
    margin-bottom: 4px;
  }
</style>

<div class="row">
  <div class="col-lg-12">
    <div class="wrapper wrapper-content animated fadeInUp">
      <div class="ibox">
        <div class="ibox-content">

          <!-- Header -->
          <div class="row">
            <div class="col-lg-12">
              <div class="m-b-md">
                <a onclick="openEditMyProfile()" class="btn btn-white btn-xs float-right" style="margin-left:8px;">
                  <%= t('page.profile.actions.editMyData') %>
                </a>
                <a onclick="openChangePassword()" style="color:#fff;" class="btn btn-primary btn-xs float-right">
                  <%= t('page.profile.actions.changePassword') %>
                </a>

                <h2 id="myName"></h2>
                <small class="text-muted"><%= t('page.profile.subtitle') %></small>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col-lg-6">
              <dl class="row mb-0">
                <div class="col-sm-4 text-sm-right"><dt><%= t('page.profile.labels.email') %></dt></div>
                <div class="col-sm-8 text-sm-left"><dd class="mb-1" id="myEmail"></dd></div>
              </dl>
              <dl class="row mb-0">
                <div class="col-sm-4 text-sm-right"><dt><%= t('page.profile.labels.phone') %></dt></div>
                <div class="col-sm-8 text-sm-left"><dd class="mb-1" id="myPhone"></dd></div>
              </dl>
            </div>
            <div class="col-lg-6">
              <dl class="row mb-0">
                <div class="col-sm-4 text-sm-right"><dt><%= t('page.profile.labels.company') %></dt></div>
                <div class="col-sm-8 text-sm-left"><dd class="mb-1" id="myCompanyName">-</dd></div>
              </dl>
              <dl class="row mb-0">
                <div class="col-sm-4 text-sm-right"><dt><%= t('page.profile.labels.permission') %></dt></div>
                <div class="col-sm-8 text-sm-left"><dd class="mb-1" id="myRole">-</dd></div>
              </dl>
            </div>
          </div>

          <div class="row" style="margin-top:15px;">
            <div class="col-lg-12">
              <div class="panel blank-panel">
                <div class="panel-heading">
                  <div class="panel-options">
                    <ul class="nav nav-tabs">
                      <li><a class="nav-link active" href="#tab-1" data-toggle="tab"><%= t('page.profile.tabs.myProfile') %></a></li>
                      <li id="tabUsersLi" style="display:none;"><a class="nav-link" href="#tab-2" data-toggle="tab"><%= t('page.profile.tabs.companyUsers') %></a></li>
                    </ul>
                  </div>
                </div>

                <div class="panel-body">
                  <div class="tab-content">

                    <!-- TAB 1 - Meu perfil -->
                    <div class="tab-pane active" id="tab-1">
                      <div class="row">
                        <div class="col-lg-12">
                          <div class="contact-box profile-card" style="cursor:default;">
                            <div class="row">

                              <div class="col-4">
                                <div class="text-center">
                                  <img id="myAvatar" alt="image" class="user-avatar-round m-t-xs" src="/Assets/inspinia/img/user.png">
                                  <div class="m-t-xs font-bold" id="myRoleBadge"></div>
                                </div>
                              </div>

                              <div class="col-8">
                                <h3><strong id="myName2"></strong></h3>
                                <p><i class="fa fa-envelope"></i> <span id="myEmail2"></span></p>
                                <p><i class="fa fa-phone"></i> <span id="myPhone2"></span></p>
                                <p class="text-muted" style="margin-bottom:0;">
                                  <i class="fa fa-lock"></i> <%= t('page.profile.hints.passwordStrength') %>
                                </p>
                              </div>

                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- TAB 2 - Usuários da empresa -->
                    <div class="tab-pane" id="tab-2">
                      <div class="row" style="margin-bottom: 10px;">
                        <div class="col-lg-12 text-right">
                          <button id="btnNewUser" type="button" class="btn btn-primary btn-sm" onclick="openNewCompanyUser()">
                            <i class="fa fa-plus"></i> <%= t('page.profile.actions.newUser') %>
                          </button>
                        </div>
                      </div>

                      <div class="row" id="companyUsersContainer">
                        <!-- Cards renderizados aqui -->
                      </div>
                    </div>

                  </div>
                </div>

              </div>
            </div>
          </div>

        </div><!-- ibox-content -->
      </div><!-- ibox -->
    </div><!-- wrapper -->
  </div><!-- col -->
</div><!-- row -->

<script>
  // i18n helpers for JS template strings
  const I18N_PROFILE = {
    editMyData: "<%= t('page.profile.actions.editMyData') %>",
    changePassword: "<%= t('page.profile.actions.changePassword') %>",
    newUser: "<%= t('page.profile.actions.newUser') %>",
    passwordStrengthHint: "<%= t('page.profile.hints.passwordStrength') %>",
    pageTitle: "<%= t('page.profile.pageTitle') %>"
  };

  (function () {
    const DEFAULT_AVATAR = "/Assets/inspinia/img/user.png";

    // -------------------- Utils --------------------
    function escapeHtml(value) {
      if (value == null) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function safeJsonParse(raw) {
      try { return raw ? JSON.parse(raw) : null; } catch { return null; }
    }

    function normalizeString(value) {
      return String(value ?? "").trim();
    }

    function normalizePhone(value) {
      return String(value ?? "").trim();
    }

    function isNonEmptyString(value) {
      return typeof value === "string" && value.trim().length > 0;
    }

    function isValidEmail(email) {
      const v = String(email ?? "").trim();
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }

    function isImageFile(file) {
      const type = String(file?.type || "").toLowerCase();
      return type.startsWith("image/");
    }

    function buildPatchOnlyChanged(originalObj, currentObj, fields) {
      const payload = {};
      let hasChanges = false;

      for (const f of fields) {
        const originalValue = f.normalize(originalObj[f.key]);
        const currentValue = f.normalize(f.read());

        if (originalValue !== currentValue) {
          f.write(payload, currentValue);
          hasChanges = true;
        }
      }

      return { hasChanges, payload };
    }

    function generateTempPassword() {
      const letters = "abcdefghijklmnopqrstuvwxyz";
      const upper = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const digits = "0123456789";
      const specials = "@$!%*#?&";
      const rand = (s) => s[Math.floor(Math.random() * s.length)];

      let pwd = "";
      pwd += "Tmp";
      pwd += rand(specials);
      pwd += rand(upper);
      for (let i = 0; i < 10; i++) pwd += rand(letters + digits);
      pwd += rand(digits);
      return pwd;
    }

    function roleToBadge(role) {
      const r = String(role || "").toUpperCase();
      if (r === "ADMIN") return { text: "Admin", css: "user-badge admin" };
      if (r === "MANAGER") return { text: "Manager", css: "user-badge manager" };
      return { text: "User", css: "user-badge user" };
    }

    function statusToPill(status) {
      const s = String(status || "").toUpperCase();
      if (s === "INACTIVE" || s === "INATIVO") return { text: "Inativo", css: "user-status-pill inactive" };
      return { text: "Ativo", css: "user-status-pill active" };
    }

    function normalizeStatusToSelectValue(status) {
      const s = String(status ?? "").toUpperCase();
      if (s === "INACTIVE" || s === "INATIVO") return "INACTIVE";
      return "ACTIVE";
    }

    function mapSelectValueToApiStatus(selectValue) {
      const v = String(selectValue ?? "").toUpperCase();
      return v === "INACTIVE" ? "INACTIVE" : "ACTIVE";
    }

    // -------------------- Profile picture cache --------------------
    function getCachedProfilePicture(userId) {
      try {
        if (!userId) return "";
        return String(localStorage.getItem("profile_picture_" + userId) || "");
      } catch {
        return "";
      }
    }

    function setCachedProfilePicture(userId, dataUrl) {
      try {
        if (!userId) return;
        if (!dataUrl) localStorage.removeItem("profile_picture_" + userId);
        else localStorage.setItem("profile_picture_" + userId, String(dataUrl));
      } catch { }
    }

    // -------------------- API --------------------
    async function readJsonSafe(response) {
      const text = await response.text();
      if (!text) return {};
      try { return JSON.parse(text); } catch { return { message: text }; }
    }

    async function apiGet(url) {
      const res = await fetch(url, { method: "GET", headers: { "Accept": "application/json" } });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || "Erro ao buscar dados");
      return data;
    }

    async function apiPost(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Accept": "application/json", "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || "Erro ao salvar");
      return data;
    }

    async function apiPatch(url, body) {
      const res = await fetch(url, {
        method: "PATCH",
        headers: { "Accept": "application/json", "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || "Erro ao atualizar");
      return data;
    }

    async function apiDelete(url) {
      const res = await fetch(url, { method: "DELETE", headers: { "Accept": "application/json" } });
      const data = await readJsonSafe(res);
      if (!res.ok) throw new Error(data?.message || "Erro ao excluir");
      return data;
    }

    // -------------------- DOM helpers --------------------
    function setText(selector, value) {
      const el = document.querySelector(selector);
      if (el) el.textContent = value ?? "";
    }

    function setHtml(selector, html) {
      const el = document.querySelector(selector);
      if (el) el.innerHTML = html ?? "";
    }

    function show(selector) {
      const el = document.querySelector(selector);
      if (el) el.style.display = "";
    }

    function hide(selector) {
      const el = document.querySelector(selector);
      if (el) el.style.display = "none";
    }

    // -------------------- Password strength --------------------
    function calcPasswordStrength(pwd) {
      const v = String(pwd || "");
      let score = 0;

      if (v.length >= 8) score += 1;
      if (v.length >= 12) score += 1;
      if (/[A-Z]/.test(v)) score += 1;
      if (/[a-z]/.test(v)) score += 1;
      if (/[0-9]/.test(v)) score += 1;
      if (/[^A-Za-z0-9]/.test(v)) score += 1;

      score = Math.max(0, Math.min(6, score));
      const pct = Math.round((score / 6) * 100);
      return { score, pct };
    }

    function renderStrength(pwd) {
      const r = calcPasswordStrength(pwd);
      $("#pwMeterFill").css("width", r.pct + "%");
      $("#pwScoreText").text(r.pct + "%");
      return r;
    }

    // -------------------- Global: SideModal (expected from layout) --------------------
    function ensureSideModal() {
      if (window.SideModal && typeof window.SideModal.open === "function") return true;
      alert("SideModal global não encontrado no layout. Verifique o JS do layout.");
      return false;
    }

    // -------------------- Auth/context --------------------
    function getAuth() {
      return window.__auth || safeJsonParse(localStorage.getItem("auth")) || {};
    }

    function isAdminOrManager(auth) {
      const role = String(auth?.role || auth?.user?.role || "").toUpperCase();
      return role === "ADMIN" || role === "MANAGER";
    }

    function getMyUserId(auth) {
      return auth?.id || auth?.user_id || auth?.user?.id || null;
    }

    function getMyCompanyId(auth) {
      return auth?.company_id || auth?.companyId || auth?.company?.id || null;
    }

    // -------------------- Rendering --------------------
    function fillMyCard(me, company) {
      const fullName = me?.full_name ?? me?.fullName ?? "-";
      const email = me?.email ?? "-";
      const phone = me?.phonenumber ?? me?.phone ?? "-";
      const companyName = company?.company_name ?? company?.name ?? "-";
      const role = me?.role ?? "-";

      setText("#myName", fullName);
      setText("#myName2", fullName);
      setText("#myEmail", email);
      setText("#myEmail2", email);
      setText("#myPhone", phone);
      setText("#myPhone2", phone);
      setText("#myCompanyName", companyName);
      setText("#myRole", role);

      const badge = roleToBadge(role);
      setHtml("#myRoleBadge", `<span class="${badge.css}">${escapeHtml(badge.text)}</span>`);

      // avatar from cache (this page uses base64 cache)
      const cachedPic = getCachedProfilePicture(me?.id);
      const avatar = cachedPic || DEFAULT_AVATAR;
      $("#myAvatar").attr("src", avatar);
    }

    function renderCompanyUsers(users, meId) {
      const $container = $("#companyUsersContainer");
      $container.empty();

      const list = Array.isArray(users) ? users : [];
      if (!list.length) {
        $container.append('<div class="col-lg-12"><p class="text-muted">Nenhum usuário encontrado para esta empresa.</p></div>');
        return;
      }

      list.forEach(function (u, idx) {
        const fullName = u?.full_name ?? u?.fullName ?? "-";
        const email = u?.email ?? "-";
        const phone = u?.phonenumber ?? u?.phone ?? "";
        const role = u?.role ?? "USER";
        const status = u?.status ?? "ACTIVE";

        const badge = roleToBadge(role);
        const pill = statusToPill(status);

        const cached = getCachedProfilePicture(u?.id);
        const avatar = cached || DEFAULT_AVATAR;

        const isMe = (String(u?.id || "") === String(meId || ""));

        const html = `
          <div class="col-lg-3">
            <div class="contact-box user-card" onclick="openEditCompanyUser(${idx});">
              <div class="user-card-actions">
                <div class="action-icon" title="Editar" onclick="event.stopPropagation(); openEditCompanyUser(${idx});">
                  <i class="fa fa-pencil"></i>
                </div>
                ${isMe ? "" : `
                  <div class="action-icon" title="Excluir" onclick="event.stopPropagation(); deleteCompanyUser(${idx});">
                    <i class="fa fa-trash"></i>
                  </div>
                `}
              </div>

              <a class="row" style="cursor:pointer;">
                <div class="col-4">
                  <div class="text-center">
                    <img alt="image" class="rounded-circle m-t-xs img-fluid user-avatar-round" src="${escapeHtml(avatar)}">
                    <div class="m-t-xs font-bold">${escapeHtml(badge.text)}</div>
                  </div>
                </div>
                <div class="col-8">
                  <h3 style="margin-top:0;"><strong>${escapeHtml(fullName)}</strong></h3>
                  <p><i class="fa fa-envelope"></i> ${escapeHtml(email)}</p>
                  ${phone ? `<p><i class="fa fa-phone"></i> ${escapeHtml(phone)}</p>` : ""}
                  <p style="margin-bottom:0;">
                    <span class="${pill.css}">${escapeHtml(pill.text)}</span>
                    ${isMe ? `<span class="muted" style="margin-left:8px;">(Você)</span>` : ""}
                  </p>
                </div>
              </a>
            </div>
          </div>
        `;

        $container.append(html);
      });

      window.__companyUsers = list;
    }

    // -------------------- Modals --------------------
    function readFileAsDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ""));
        reader.onerror = () => reject(new Error("Falha ao ler o arquivo."));
        reader.readAsDataURL(file);
      });
    }

    async function openEditMyProfile() {
      if (!ensureSideModal()) return;

      try {
        const auth = getAuth();
        const myId = getMyUserId(auth);
        if (!myId) { alert("Não foi possível identificar seu user_id."); return; }

        const me = await apiGet("/api/users/" + encodeURIComponent(myId));
        const cachedPic = getCachedProfilePicture(me.id);

        const original = {
          fullName: normalizeString(me?.full_name ?? me?.fullName ?? ""),
          phone: normalizePhone(me?.phonenumber ?? me?.phone ?? ""),
          // Do NOT pull from me.profile_picture (it should not be in payload). Use cache if present.
          profilePicture: normalizeString(cachedPic ?? "")
        };

        const html = `
          <div class="form-group">
            <label for="txtMyName">Nome</label>
            <input id="txtMyName" class="form-control" value="${escapeHtml(original.fullName)}" />
          </div>

          <div class="form-group">
            <label for="txtMyPhone">Telefone</label>
            <input id="txtMyPhone" class="form-control" value="${escapeHtml(original.phone)}" placeholder="+5511961381234" />
          </div>

          <div class="form-group">
            <label>Foto de perfil</label>
            <div style="display:flex; gap:12px; align-items:center;">
              <img id="imgPreview" src="${escapeHtml(original.profilePicture || DEFAULT_AVATAR)}" style="width:64px; height:64px; border-radius:50%; object-fit:cover; border:1px solid #e7eaec;" />
              <div style="flex:1;">
                <input type="file" id="fileProfilePic" accept="image/*" class="form-control" />
                <small class="text-muted">Máximo 5MB.</small>
              </div>
            </div>
          </div>

          <input type="hidden" id="hidProfilePic" value="${escapeHtml(original.profilePicture)}" />
        `;

        SideModal.open({
          title: "Editar meu perfil",
          html: html,
          onOk: async function () {
            try {
              const current = {
                fullName: $("#txtMyName").val(),
                phone: $("#txtMyPhone").val(),
                profilePicture: $("#hidProfilePic").val()
              };

              const diff = buildPatchOnlyChanged(
                {
                  fullName: original.fullName,
                  phone: original.phone,
                  profilePicture: original.profilePicture
                },
                current,
                [
                  { key: "fullName", read: () => current.fullName, normalize: normalizeString, write: (p, v) => { p.full_name = v; } },
                  { key: "phone", read: () => current.phone, normalize: normalizePhone, write: (p, v) => { p.phonenumber = v; } },
                  // profile_picture is not persisted by backend yet; we keep in cache
                  { key: "profilePicture", read: () => current.profilePicture, normalize: normalizeString, write: (_p, _v) => { } }
                ]
              );

              if (diff.hasChanges) {
                await apiPatch("/api/users/" + encodeURIComponent(me.id), diff.payload);
              }

              // Save picture in cache (even if backend doesn't store it yet)
              setCachedProfilePicture(me.id, normalizeString(current.profilePicture));

              location.reload();
            } catch (err) {
              console.error(err);
              alert(err?.message || "Erro ao salvar seu perfil.");
            }
          }
        });

        setTimeout(function () {
          $("#fileProfilePic").off("change.__pic").on("change.__pic", async function () {
            const f = this.files && this.files[0];
            if (!f) return;

            if (!isImageFile(f)) {
              alert("Selecione um arquivo de imagem.");
              $(this).val("");
              return;
            }

            const maxBytes = 5 * 1024 * 1024;
            if (f.size > maxBytes) {
              alert("Imagem maior que 5MB. Reduza o tamanho do arquivo.");
              $(this).val("");
              return;
            }

            try {
              const dataUrl = await readFileAsDataUrl(f);
              $("#imgPreview").attr("src", dataUrl);
              $("#hidProfilePic").val(dataUrl);
            } catch (e) {
              alert(e?.message || "Falha ao ler arquivo.");
            }
          });
        }, 50);

      } catch (e) {
        console.error(e);
        alert(e?.message || "Erro ao carregar seu perfil.");
      }
    }

    window.openEditMyProfile = openEditMyProfile;

    function openChangePassword() {
      if (!ensureSideModal()) return;

      const html = `
        <div class="form-group">
          <label for="txtNewPassword">Nova senha</label>
          <input id="txtNewPassword" type="password" class="form-control" placeholder="********" />
        </div>

        <div class="form-group">
          <label for="txtConfirmPassword">Confirmar nova senha</label>
          <input id="txtConfirmPassword" type="password" class="form-control" placeholder="********" />
        </div>

        <div class="form-group">
          <label>Força:</label>
          <div class="pw-meter"><div id="pwMeterFill"></div></div>
          <small class="text-muted">Score: <span id="pwScoreText">0%</span></small>
        </div>

        <div class="form-group">
          <label>Requisitos:</label>
          <ul class="pw-reqs text-muted" style="padding-left:18px;">
            <li>12+ caracteres</li>
            <li>Maiúscula e minúscula</li>
            <li>Número</li>
            <li>Símbolo</li>
          </ul>
        </div>
      `;

      SideModal.open({
        title: "Trocar senha",
        html: html,
        onOk: async function () {
          try {
            const auth = getAuth();
            const myId = getMyUserId(auth);
            if (!myId) { alert("Não foi possível identificar seu user_id."); return; }

            const pwd = String($("#txtNewPassword").val() || "");
            const confirmPwd = String($("#txtConfirmPassword").val() || "");

            if (!pwd || pwd.length < 8) { alert("Informe uma senha com pelo menos 8 caracteres."); return; }
            if (pwd !== confirmPwd) { alert("As senhas não conferem."); return; }

            await apiPatch("/api/users/" + encodeURIComponent(myId), { password: pwd });

            alert("Senha atualizada com sucesso!");
          } catch (e) {
            console.error(e);
            alert(e?.message || "Erro ao atualizar senha.");
          }
        }
      });

      setTimeout(function () {
        $("#txtNewPassword").on("input keyup", function () {
          renderStrength(String($(this).val() || ""));
        });
      }, 30);
    }

    window.openChangePassword = openChangePassword;

    async function openNewCompanyUser() {
      if (!ensureSideModal()) return;

      const auth = getAuth();
      if (!isAdminOrManager(auth)) {
        alert("Manager/Admin conseguem gerenciar usuários da empresa.");
        return;
      }

      const companyId = getMyCompanyId(auth);
      if (!companyId) { alert("Não foi possível identificar seu company_id."); return; }

      const html = `
        <div class="form-group">
          <label for="txtNewUserName">Nome</label>
          <input id="txtNewUserName" class="form-control" />
        </div>

        <div class="form-group">
          <label for="txtNewUserEmail">Email</label>
          <input id="txtNewUserEmail" class="form-control" />
        </div>

        <div class="form-group">
          <label for="txtNewUserPhone">Telefone</label>
          <input id="txtNewUserPhone" class="form-control" placeholder="+5511961381234" />
        </div>

        <div class="form-group">
          <label for="selNewUserRole">Permissão</label>
          <select id="selNewUserRole" class="form-control">
            <option value="USER" selected>User</option>
            <option value="MANAGER">Manager</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>

        <div class="form-group">
          <label for="selNewUserStatus">Status</label>
          <select id="selNewUserStatus" class="form-control">
            <option value="ACTIVE" selected>Ativo</option>
            <option value="INACTIVE">Inativo</option>
          </select>
        </div>

        <div class="form-group" style="margin-top:10px;">
          <div class="checkbox">
            <label>
              <input type="checkbox" id="chkFirstAccess" checked />
              Enviar acesso (primeiro acesso)
            </label>
          </div>
        </div>
      `;

      SideModal.open({
        title: "Novo usuário",
        html: html,
        onOk: async function () {
          try {
            const fullName = normalizeString($("#txtNewUserName").val());
            const email = normalizeString($("#txtNewUserEmail").val());
            const phone = normalizePhone($("#txtNewUserPhone").val());
            const role = normalizeString($("#selNewUserRole").val()) || "USER";
            const status = mapSelectValueToApiStatus($("#selNewUserStatus").val());
            const firstAccess = $("#chkFirstAccess").is(":checked") === true;

            if (!isNonEmptyString(fullName)) { alert("Informe o Nome."); return; }
            if (!isNonEmptyString(email) || !isValidEmail(email)) { alert("Informe um Email válido."); return; }

            const tempPassword = generateTempPassword();

            const payload = {
              full_name: fullName,
              email: email,
              password: tempPassword,
              role: role === "ADMIN" ? "ADMIN" : (role === "MANAGER" ? "MANAGER" : "USER"),
              phonenumber: phone,
              first_access: firstAccess,
              company_id: companyId,
              status: status
            };

            await apiPost("/api/users", payload);

            location.reload();
          } catch (e) {
            console.error(e);
            alert(e?.message || "Erro ao criar usuário.");
          }
        }
      });
    }

    window.openNewCompanyUser = openNewCompanyUser;

    async function openEditCompanyUser(index) {
      if (!ensureSideModal()) return;

      const auth = getAuth();
      if (!isAdminOrManager(auth)) {
        alert("Manager/Admin conseguem gerenciar usuários da empresa.");
        return;
      }

      const users = window.__companyUsers || [];
      const u = users[index];
      if (!u?.id) return;

      const original = {
        fullName: normalizeString(u?.full_name ?? u?.fullName ?? ""),
        email: normalizeString(u?.email ?? ""),
        phone: normalizePhone(u?.phonenumber ?? u?.phone ?? ""),
        role: normalizeString(u?.role ?? "USER"),
        status: normalizeString(u?.status ?? "ACTIVE")
      };

      const statusValue = normalizeStatusToSelectValue(original.status);

      const html = `
        <div class="form-group">
          <label for="txtName">Nome</label>
          <input id="txtName" class="form-control" value="${escapeHtml(original.fullName)}" />
        </div>

        <div class="form-group">
          <label for="txtEmail">Email</label>
          <input id="txtEmail" class="form-control" value="${escapeHtml(original.email)}" />
        </div>

        <div class="form-group">
          <label for="txtPhoneNumber">Telefone</label>
          <input id="txtPhoneNumber" class="form-control" value="${escapeHtml(original.phone)}" />
        </div>

        <div class="form-group">
          <label for="txtRole">Permissão</label>
          <select id="txtRole" class="form-control">
            <option value="USER" ${original.role.toUpperCase() === "USER" ? "selected" : ""}>User</option>
            <option value="MANAGER" ${original.role.toUpperCase() === "MANAGER" ? "selected" : ""}>Manager</option>
            <option value="ADMIN" ${original.role.toUpperCase() === "ADMIN" ? "selected" : ""}>Admin</option>
          </select>
        </div>

        <div class="form-group">
          <label for="selStatus">Status</label>
          <select id="selStatus" class="form-control">
            <option value="ACTIVE" ${original.status.toUpperCase() === "ACTIVE" ? "selected" : ""}>Ativo</option>
            <option value="INACTIVE" ${original.status.toUpperCase() === "INACTIVE" ? "selected" : ""}>Inativo</option>
          </select>
        </div>

        <small class="text-muted">
          Dica: para foto do usuário, use "${I18N_PROFILE.editMyData}" logado nesse usuário (por enquanto).
        </small>
      `;

      SideModal.open({
        title: "Editar usuário",
        html: html,
        onOk: async function () {
          try {
            const current = {
              fullName: $("#txtName").val(),
              email: $("#txtEmail").val(),
              phone: $("#txtPhoneNumber").val(),
              role: $("#txtRole").val(),
              status: mapSelectValueToApiStatus($("#selStatus").val())
            };

            const diff = buildPatchOnlyChanged(
              {
                fullName: original.fullName,
                email: original.email,
                phone: original.phone,
                role: original.role,
                status: original.status
              },
              current,
              [
                { key: "fullName", read: () => current.fullName, normalize: normalizeString, write: (p, v) => { p.full_name = v; } },
                { key: "email", read: () => current.email, normalize: normalizeString, write: (p, v) => { p.email = v; } },
                { key: "phone", read: () => current.phone, normalize: normalizePhone, write: (p, v) => { p.phonenumber = v; } },
                { key: "role", read: () => current.role, normalize: normalizeString, write: (p, v) => { p.role = v; } },
                { key: "status", read: () => current.status, normalize: normalizeString, write: (p, v) => { p.status = v; } },
              ]
            );

            if (!diff.hasChanges) return;

            await apiPatch("/api/users/" + encodeURIComponent(u.id), diff.payload);
            location.reload();
          } catch (e) {
            console.error(e);
            alert(e?.message || "Erro ao salvar usuário.");
          }
        }
      });
    }

    window.openEditCompanyUser = openEditCompanyUser;

    async function deleteCompanyUser(index) {
      const auth = getAuth();
      if (!isAdminOrManager(auth)) {
        alert("Manager/Admin conseguem gerenciar usuários da empresa.");
        return;
      }

      const users = window.__companyUsers || [];
      const u = users[index];
      if (!u?.id) return;

      const meId = getMyUserId(auth);
      if (String(u.id) === String(meId)) {
        alert("Você não pode excluir seu próprio usuário.");
        return;
      }

      const ok = confirm("Confirma excluir este usuário?");
      if (!ok) return;

      try {
        await apiDelete("/api/users/" + encodeURIComponent(u.id));
        location.reload();
      } catch (e) {
        console.error(e);
        alert(e?.message || "Erro ao excluir usuário.");
      }
    }

    window.deleteCompanyUser = deleteCompanyUser;

    // -------------------- Init --------------------
    async function init() {
      $("#masterHeader").hide();
      $("#pageName").text("<%= t('page.profile.pageTitle') %>");
      $("#subpageName").text("<%= t('page.profile.pageTitle') %>");
      $("#subSecoundPageName").text("<%= t('page.profile.pageTitle') %>");

      try {
        const auth = getAuth();
        const myId = getMyUserId(auth);
        const companyId = getMyCompanyId(auth);

        if (!myId) {
          alert("Não foi possível identificar seu user_id.");
          return;
        }

        // Load me + company in parallel (best effort)
        const results = await Promise.all([
          apiGet("/api/users/" + encodeURIComponent(myId)),
          companyId ? apiGet("/api/companies/" + encodeURIComponent(companyId)) : Promise.resolve(null)
        ]);

        const me = results[0];
        const company = results[1];

        fillMyCard(me, company);

        const canManage = isAdminOrManager(auth);
        if (canManage) {
          $("#tabUsersLi").show();

          // List company users
          if (companyId) {
            // best effort - if you have a specific endpoint, swap this call
            const usersResp = await apiGet("/api/users?company_id=" + encodeURIComponent(companyId));
            const users = Array.isArray(usersResp) ? usersResp : (usersResp?.data || usersResp?.items || []);
            renderCompanyUsers(users, myId);
          }
        } else {
          $("#tabUsersLi").hide();
        }

      } catch (e) {
        console.error(e);
        alert(e?.message || "Erro ao carregar página de perfil.");
      }
    }

    $(document).ready(function () {
      if (typeof $ === "function") {
        init();
      } else {
        init();
      }
    });
  })();
</script>
