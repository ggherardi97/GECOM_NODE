<style>
  .ibox-title { padding: 15px 90px 20px 15px; }
  .clicker { cursor: pointer; }

  /* Bulk actions bar */
  .bulk-actions {
    display: none;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    background: #f3f3f4;
    border: 1px solid #e7eaec;
    border-radius: 4px;
    margin-bottom: 10px;
  }

  .bulk-actions .count {
    font-weight: 600;
  }

  .bulk-actions .btn { margin: 0; }
</style>
<div class="wrapper wrapper-content animated fadeInRight" style="padding-top: 25px;">
  <div class="row">
  <div class="col-lg-12">
    <div class="ibox">
      <div class="ibox-title">
        <h5><%= t('page.clients.pageTitle') %></th></h5>
        <div class="ibox-tools">
          <!-- ferramentas removidas -->
        </div>
      </div>

      <div class="ibox-content">
        <div class="row">
          <div class="col-sm-3">
            <div class="input-group mb-3">
              <input
                type="text"
                class="form-control form-control-sm"
                id="searchinput"
                placeholder="<%= t('page.clients.placeholders.searchCompanyName') %>">
              <div class="input-group-append">
                <button class="btn btn-sm btn-primary" type="button"><%= t('page.clients.toolbar.search') %></button>
              </div>
            </div>
          </div>

          <div class="col-sm-9 m-b-xs">
            <a type="button" name="btn_act_new" class="btn btn-sm btn-primary" href="NewClient" style="float: inline-end;"><%= t('page.clients.toolbar.newClient') %></a>
          </div>
        </div>

        <!-- Bulk actions (shown only when selection exists) -->
        <div id="bulkActions" class="bulk-actions">
          <span class="count"><%= t('page.clients.toolbar.selecionados') %>: <span id="selectedCount">0</span></span>
          <button id="btnBulkDelete" type="button" class="btn btn-danger btn-sm">
            <i class="fa fa-trash"></i> <%= t('page.clients.toolbar.remove') %>
          </button>
          <button id="btnClearSelection" type="button" class="btn btn-white btn-sm">
            <%= t('page.clients.toolbar.clearSelection') %>
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-striped" id="clientes">
            <thead>
              <tr>
                <!-- NEW: selection column -->
                <th style="width:40px;">
                  <input id="chkSelectAll" type="checkbox" title="<%= t('page.clients.bulk.selectAll') %>">
                </th>
                <th>#</th>
                <th><%= t('page.clients.columns.name') %></th>
                <th><%= t('page.clients.columns.contatoPrincipal') %></th>
                <th><%= t('page.clients.columns.phone') %></th>
                <th><%= t('page.clients.columns.setor') %></th>
                <th><%= t('page.clients.columns.ninvoices') %></th>
                <th><%= t('page.clients.columns.createdAt') %></th>
                <th><%= t('page.clients.columns.cnpj') %></th>
              </tr>
            </thead>
            <tbody id="lines"></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>
</div>

<% contentFor('scripts') %>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.tooltip.min.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.spline.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.resize.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.pie.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.symbol.js"></script>
<script src="../Assets/inspinia/js/plugins/peity/jquery.peity.min.js"></script>
<script src="../Assets/inspinia/js/demo/peity-demo.js"></script>

<script src="../Assets/inspinia/js/inspinia.js"></script>
<script src="../Assets/inspinia/js/plugins/pace/pace.min.js"></script>

<script src="../Assets/inspinia/js/plugins/jquery-ui/jquery-ui.min.js"></script>

<script src="../Assets/inspinia/js/plugins/jvectormap/jquery-jvectormap-2.0.2.min.js"></script>
<script src="../Assets/inspinia/js/plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>

<script src="../Assets/inspinia/js/plugins/sparkline/jquery.sparkline.min.js"></script>
<script src="../Assets/inspinia/js/demo/sparkline-demo.js"></script>

<script src="../Assets/inspinia/js/plugins/chartJs/Chart.min.js"></script>
<% %>

<script>
  // -------------------- Global cache --------------------
  let clients = [];

  // Cache userId -> full_name
  const userNameCache = new Map();

  // Bulk selection (company ids)
  const selectedCompanyIds = new Set();

  // -------------------- Utils --------------------
  function escapeHtml(value) {
    if (value == null) return "";
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function formatDate(value) {
    if (!value) return "";
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) return String(value);
    return d.toLocaleDateString("pt-BR");
  }

  function isNonEmptyString(value) {
    return typeof value === "string" && value.trim().length > 0;
  }

  function setBulkActionsVisible(isVisible) {
    const bar = document.getElementById("bulkActions");
    if (!bar) return;
    bar.style.display = isVisible ? "flex" : "none";
  }

  function updateBulkUI() {
    const countEl = document.getElementById("selectedCount");
    if (countEl) countEl.textContent = String(selectedCompanyIds.size);

    setBulkActionsVisible(selectedCompanyIds.size > 0);

    // keep header checkbox in sync
    const chkAll = document.getElementById("chkSelectAll");
    if (chkAll) {
      // consider only currently rendered rows
      const rowChecks = document.querySelectorAll("input.company-check");
      const total = rowChecks.length;
      const checked = Array.from(rowChecks).filter((x) => x.checked).length;
      chkAll.checked = total > 0 && checked === total;
      chkAll.indeterminate = checked > 0 && checked < total;
    }
  }

  // -------------------- API --------------------
  async function fetchCompanies() {
    const resp = await fetch("/api/companies", {
      method: "GET",
      headers: { Accept: "application/json" },
    });

    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) {
      const msg = data?.message || "<%= t('page.clients.messages.loadFail') %>";
      throw new Error(msg);
    }
    return data;
  }

  async function fetchUserById(userId) {
    const resp = await fetch(`/api/users/${encodeURIComponent(userId)}`, {
      method: "GET",
      headers: { Accept: "application/json" },
    });

    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) return null;
    return data;
  }

  async function deleteCompanyById(companyId) {
    const resp = await fetch(`/api/companies/${encodeURIComponent(companyId)}`, {
      method: "DELETE",
      headers: { Accept: "application/json" },
    });

    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) {
      throw new Error(data?.message || "<%= t('page.clients.messages.deleteFailSingle') %>");
    }
    return data;
  }

  // Concurrency limiter (no external libs)
  async function runWithConcurrency(items, limit, worker) {
    const queue = [...items];
    const workers = Array.from({ length: Math.min(limit, items.length) }, async () => {
      while (queue.length > 0) {
        const item = queue.shift();
        await worker(item);
      }
    });
    await Promise.all(workers);
  }

  async function resolveUserNames(userIds) {
    const uniqueIds = [...new Set(userIds.filter(isNonEmptyString))];
    const toFetch = uniqueIds.filter((id) => !userNameCache.has(id));
    if (toFetch.length === 0) return;

    const concurrency = 5;
    await runWithConcurrency(toFetch, concurrency, async (id) => {
      const user = await fetchUserById(id);
      const fullName = user?.full_name ?? user?.fullName ?? user?.name ?? "";
      userNameCache.set(id, isNonEmptyString(fullName) ? String(fullName).trim() : "");
    });
  }

  // -------------------- Mapping --------------------
  function mapCompanyToClient(company, index) {
    const id = company.id ?? company.company_id ?? company.companyId ?? String(index + 1);

    const sector =
      company.sector ??
      company.company_sector ??
      company.sector_name ??
      null;

    const userId = company.user_id ?? company.userId ?? "";

    return {
      Id: String(id),
      CompanyName: company.company_name ?? "",
      ContactName: "",
      Phone: company.phone ?? "",
      Email: company.email ?? "",
      UserId: userId,

      CreatedOn: company.created_on ?? company.createdAt ?? company.created_at ?? "",
      CompanyNumber: company.company_number ?? "",
      Sector: sector && String(sector).trim() ? String(sector).trim() : "<%= t('page.clients.defaults.sector') %>",
      NumberOfInvoices: company.number_of_invoices ?? "",
    };
  }

  // -------------------- Render --------------------
  function renderCompaniesTable(list) {
    const tbody = document.querySelector("#lines");
    if (!tbody) return;

    tbody.innerHTML = "";

    if (!list || list.length === 0) {
      tbody.innerHTML = `<tr><td colspan="9"><%= t('page.clients.messages.noneFound') %></td></tr>`;
      return;
    }

    list.forEach((c, idx) => {
      const tr = document.createElement("tr");
      tr.className = "clicker";

      // Row click -> details
      tr.addEventListener("click", function () {
        redirectToProcess(c.Id);
      });

      const isChecked = selectedCompanyIds.has(String(c.Id));

      tr.innerHTML = `
        <td>
          <input
            class="company-check"
            type="checkbox"
            data-id="${escapeHtml(String(c.Id))}"
            ${isChecked ? "checked" : ""}
            title="<%= t('page.clients.ui.select') %>"
          />
        </td>
        <td>${escapeHtml(idx + 1)}</td>
        <td>${escapeHtml(c.CompanyName)}</td>
        <td>${escapeHtml(c.ContactName)}</td>
        <td>${escapeHtml(c.Phone)}</td>
        <td>${escapeHtml(c.Sector)}</td>
        <td>${escapeHtml(c.NumberOfInvoices ?? "")}</td>
        <td>${escapeHtml(formatDate(c.CreatedOn))}</td>
        <td>${escapeHtml(c.CompanyNumber)}</td>
      `;

      // Stop propagation on checkbox click (avoid redirect)
      const chk = tr.querySelector("input.company-check");
      chk.addEventListener("click", function (e) {
        e.stopPropagation();
        const id = String(this.getAttribute("data-id") ?? "");
        if (!id) return;

        if (this.checked) selectedCompanyIds.add(id);
        else selectedCompanyIds.delete(id);

        updateBulkUI();
      });

      tbody.appendChild(tr);
    });

    updateBulkUI();
  }

  // -------------------- Load --------------------
  async function loadCompanies() {
    try {
      const apiData = await fetchCompanies();

      const rows = Array.isArray(apiData)
        ? apiData
        : (apiData.data ?? apiData.rows ?? apiData.companies ?? [apiData]);

      clients = rows.map(mapCompanyToClient);

      // Resolve contact names
      const userIds = clients.map((c) => c.UserId);
      await resolveUserNames(userIds);

      for (const c of clients) {
        const name = c.UserId ? userNameCache.get(c.UserId) : "";
        c.ContactName = isNonEmptyString(name) ? name : (c.ContactName || "");
      }

      renderCompaniesTable(clients);
    } catch (err) {
      console.error("loadCompanies error:", err);
      const tbody = document.querySelector("#lines");
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan="9">${escapeHtml(err.message || "<%= t('page.clients.messages.loadUnexpected') %>")}</td></tr>`;
      }
    }
  }

  // -------------------- Navigation --------------------
  function redirectToProcess(id) {
    const selectedClient = clients.find((c) => c.Id === String(id));
    if (!selectedClient) {
      console.error("Client not found for id:", id);
      return;
    }

    localStorage.setItem("selectedClientId", String(selectedClient.Id));
    localStorage.setItem("selectedClient", JSON.stringify(selectedClient));
    window.location = "ClientDetails";
  }

  // -------------------- Bulk delete (GlobalModal) --------------------
  function showBulkDeleteConfirm(selectedIds) {
    if (!Array.isArray(selectedIds) || selectedIds.length === 0) {
      return Promise.resolve(false);
    }

    const qty = selectedIds.length;

    // GlobalModal elements from layout
    const modalBtn = document.getElementById("modalButton");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const btnSave = document.getElementById("saveModal");
    const btnClose = document.getElementById("closeModal");

    // Fallback if modal not found
    if (!modalBtn || !modalTitle || !modalBody || !btnSave || !btnClose) {
      const ok = confirm(`<%= t('page.clients.modalRemove.confirmFallbackPrefix') %> ${qty} <%= t('page.clients.modalRemove.confirmFallbackSuffix') %>`);
      return Promise.resolve(ok);
    }

    modalTitle.textContent = "<%= t('page.clients.modalRemove.title') %>";
    modalBody.innerHTML = `
      <p><%= t('page.clients.modalRemove.line1') %> <strong>${escapeHtml(qty)}</strong></p>
      <p class="text-danger"><%= t('page.clients.modalRemove.line2') %></p>
      <p><%= t('page.clients.modalRemove.confirm') %></p>
    `;

    // Make "Save" look like delete
    btnSave.textContent = "<%= t('page.clients.toolbar.remove') %>";
    btnSave.classList.remove("btn-primary");
    btnSave.classList.add("btn-danger");

    btnClose.textContent = "<%= t('page.layout.modal.cancel') %>";

    return new Promise((resolve) => {
      const cleanup = () => {
        btnSave.onclick = null;
        btnClose.onclick = null;

        // restore default styles/text
        btnSave.classList.remove("btn-danger");
        btnSave.classList.add("btn-primary");
        btnSave.textContent = "<%= t('page.layout.modal.save') %>";
        btnClose.textContent = "<%= t('page.layout.modal.close') %>";
      };

      btnSave.onclick = () => {
        cleanup();
        resolve(true);
      };

      btnClose.onclick = () => {
        cleanup();
        resolve(false);
      };

      // Open modal by clicking hidden button (your requirement)
      modalBtn.click();
    });
  }

  async function executeBulkDelete() {
    const ids = Array.from(selectedCompanyIds);
    if (ids.length === 0) return;

    const confirmed = await showBulkDeleteConfirm(ids);
    if (!confirmed) return;

    const btn = document.getElementById("btnBulkDelete");
    const oldText = btn ? btn.innerHTML : "";
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> <%= t('page.clients.ui.removing') %>...`;
    }

    try {
      // Delete with limited concurrency
      const concurrency = 5;
      const failures = [];

      await runWithConcurrency(ids, concurrency, async (id) => {
        try {
          await deleteCompanyById(id);
        } catch (e) {
          failures.push({ id, message: e?.message || "<%= t('page.clients.messages.deleteFail') %>" });
        }
      });

      if (failures.length > 0) {
        console.warn("Bulk delete failures:", failures);
        alert(`<%= t('page.clients.messages.bulkSomeFailedPrefix') %> (${failures.length}). <%= t('page.clients.messages.bulkSomeFailedSuffix') %>`);
      }

      // Remove deleted rows from local list (only those successful)
      const failedIds = new Set(failures.map((x) => String(x.id)));
      const removedIds = ids.filter((id) => !failedIds.has(String(id)));

      clients = clients.filter((c) => !removedIds.includes(String(c.Id)));

      // Clear selection
      removedIds.forEach((id) => selectedCompanyIds.delete(String(id)));

      // Re-render with remaining
      renderCompaniesTable(clients);
    } catch (err) {
      console.error("executeBulkDelete error:", err);
      alert(err?.message || "<%= t('page.clients.messages.bulkUnexpected') %>");
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = oldText || `<i class="fa fa-trash"></i> <%= t('page.clients.toolbar.remove') %>`;
      }
      updateBulkUI();
    }
  }

  function clearSelection() {
    selectedCompanyIds.clear();
    document.querySelectorAll("input.company-check").forEach((x) => (x.checked = false));
    updateBulkUI();
  }

  // -------------------- Events --------------------
  function bindBulkEvents() {
    const chkAll = document.getElementById("chkSelectAll");
    const btnDelete = document.getElementById("btnBulkDelete");
    const btnClear = document.getElementById("btnClearSelection");

    if (chkAll) {
      chkAll.addEventListener("click", function (e) {
        e.stopPropagation();

        const checks = document.querySelectorAll("input.company-check");
        checks.forEach((chk) => {
          const id = String(chk.getAttribute("data-id") ?? "");
          if (!id) return;

          chk.checked = this.checked;

          if (this.checked) selectedCompanyIds.add(id);
          else selectedCompanyIds.delete(id);
        });

        updateBulkUI();
      });
    }

    if (btnDelete) btnDelete.addEventListener("click", executeBulkDelete);
    if (btnClear) btnClear.addEventListener("click", clearSelection);
  }

  // -------------------- Init --------------------
  $(document).ready(function () {
    if (!window.Auth || !window.Auth.requireLogin()) return;

     const canAccess = window.__auth.isAdmin;
      if (!canAccess) {
        window.location.href = "/Default"; // ou "/Processos"
        return;
      }

    $("#pageName").text("<%= t('page.clients.pageTitle') %>");
    $("#subpageName").text("<%= t('page.clients.pageTitle') %>");

    bindBulkEvents();
    loadCompanies();

    $("#searchinput").on("keyup change", function () {
      const value = $(this).val().toLowerCase();
      $("#clientes tbody tr").filter(function () {
        // filter by company name (3rd column now, because we added checkbox + #)
        $(this).toggle($(this).find("td").eq(2).text().toLowerCase().indexOf(value) > -1);
      });
    });
  });
</script>
