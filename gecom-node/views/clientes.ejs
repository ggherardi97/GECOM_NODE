<link rel="stylesheet" href="../Assets/inspinia/css/plugins/daterangepicker/daterangepicker-bs3.css">
<style>
  .ibox-title { padding: 15px 90px 20px 15px; }
  .clicker { cursor: pointer; }
  .sv-actions { margin-left: unset !important; }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable .sort-indicator { margin-left: 6px; font-size: 11px; opacity: .75; }
  #clientsSavedViewsHost .sv-bar { margin-top: -2px; }
  th.sv-fixed-col, td.sv-fixed-col { display: table-cell !important; visibility: visible !important; }
  .sv-date-filter .input-group-addon { padding: 3px 8px; cursor: pointer; }

  /* Bulk actions bar */
  .bulk-actions {
    display: none;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    background: #f3f3f4;
    border: 1px solid #e7eaec;
    border-radius: 4px;
    margin-bottom: 10px;
  }
.text-muted{
display: none !important;
}
  .sv-actions{
    margin-left: unset !important;
  }
  .bulk-actions .count {
    font-weight: 600;
  }

  .bulk-actions .btn { margin: 0; }
</style>
<div class="wrapper wrapper-content animated fadeInRight" style="padding-top: 25px;">
  <div class="row">
  <div class="col-lg-12">
    <div class="ibox">
      <div class="ibox-title" style="display: flex;padding-right: 0px !important;">
        <div class="col-lg-11">
        <div id="clientsSavedViewsHost"></div>
        </div>
        <div class="col-lg-1">
          <div class="">
            <a type="button" name="btn_act_new" class="btn btn-sm btn-primary" href="NewClient" style="float: inline-end;"><%= t('page.clients.toolbar.newClient') %></a>
          </div>
        </div>
      </div>

      <div class="ibox-content">
        <div class="row">

          
        </div>

        <!-- Bulk actions (shown only when selection exists) -->
        <div id="bulkActions" class="bulk-actions">
          <span class="count"><%= t('page.clients.toolbar.selecionados') %>: <span id="selectedCount">0</span></span>
          <button id="btnBulkDelete" type="button" class="btn btn-danger btn-sm">
            <i class="fa fa-trash"></i> <%= t('page.clients.toolbar.remove') %>
          </button>
          <button id="btnClearSelection" type="button" class="btn btn-white btn-sm">
            <%= t('page.clients.toolbar.clearSelection') %>
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-striped" id="clientes">
            <thead>
              <tr id="clientsFiltersRow">
                <th class="sv-fixed-col" data-field="__select" data-sv-fixed="left" style="width:40px;"></th>
                <th data-field="rowNumber"></th>
                <th data-field="CompanyName"><input type="text" class="form-control input-sm" placeholder="<%= t('page.clients.columns.name') %>" /></th>
                <th data-field="ContactName"><input type="text" class="form-control input-sm" placeholder="<%= t('page.clients.columns.contatoPrincipal') %>" /></th>
                <th data-field="Phone"><input type="text" class="form-control input-sm" placeholder="<%= t('page.clients.columns.phone') %>" /></th>
                <th data-field="Sector"><input type="text" class="form-control input-sm" placeholder="<%= t('page.clients.columns.setor') %>" /></th>
                <th data-field="NumberOfInvoices"><input type="text" class="form-control input-sm" placeholder="<%= t('page.clients.columns.ninvoices') %>" /></th>
                <th class="sv-date-filter" data-field="CreatedOn">
                  <div class="input-group">
                    <input id="clientsCreatedRangeFilter" type="text" class="form-control input-sm" placeholder="<%= t('page.layout.savedViews.dateRangePlaceholder') %>" autocomplete="off" />
                    <span class="input-group-addon" id="clientsCreatedRangeBtn"><i class="fa fa-calendar"></i></span>
                  </div>
                  <input id="clientsCreatedFromFilter" type="hidden" />
                  <input id="clientsCreatedToFilter" type="hidden" />
                </th>
                <th data-field="CompanyNumber"><input type="text" class="form-control input-sm" placeholder="<%= t('page.clients.columns.cnpj') %>" /></th>
              </tr>
              <tr id="clientsHeaderRow">
                <!-- NEW: selection column -->
                <th class="sv-fixed-col" data-sort-key="__select" data-field="__select" data-sv-fixed="left" style="width:40px;">
                  <input id="chkSelectAll" type="checkbox" title="<%= t('page.clients.bulk.selectAll') %>">
                </th>
                <th class="sortable" data-sort-key="rowNumber" data-field="rowNumber"># <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort-key="CompanyName" data-field="CompanyName"><%= t('page.clients.columns.name') %> <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort-key="ContactName" data-field="ContactName"><%= t('page.clients.columns.contatoPrincipal') %> <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort-key="Phone" data-field="Phone"><%= t('page.clients.columns.phone') %> <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort-key="Sector" data-field="Sector"><%= t('page.clients.columns.setor') %> <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort-key="NumberOfInvoices" data-field="NumberOfInvoices"><%= t('page.clients.columns.ninvoices') %> <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort-key="CreatedOn" data-field="CreatedOn"><%= t('page.clients.columns.createdAt') %> <span class="sort-indicator"></span></th>
                <th class="sortable" data-sort-key="CompanyNumber" data-field="CompanyNumber"><%= t('page.clients.columns.cnpj') %> <span class="sort-indicator"></span></th>
              </tr>
            </thead>
            <tbody id="lines"></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>
</div>

<% contentFor('scripts') %>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.tooltip.min.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.spline.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.resize.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.pie.js"></script>
<script src="../Assets/inspinia/js/plugins/flot/jquery.flot.symbol.js"></script>
<script src="../Assets/inspinia/js/plugins/peity/jquery.peity.min.js"></script>
<script src="../Assets/inspinia/js/demo/peity-demo.js"></script>

<script src="../Assets/inspinia/js/plugins/jquery-ui/jquery-ui.min.js"></script>

<script src="../Assets/inspinia/js/plugins/jvectormap/jquery-jvectormap-2.0.2.min.js"></script>
<script src="../Assets/inspinia/js/plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>

<script src="../Assets/inspinia/js/plugins/sparkline/jquery.sparkline.min.js"></script>
<script src="../Assets/inspinia/js/demo/sparkline-demo.js"></script>

<script src="../Assets/inspinia/js/plugins/chartJs/Chart.min.js"></script>
<script src="../Assets/inspinia/js/plugins/fullcalendar/moment.min.js"></script>
<script src="../Assets/inspinia/js/plugins/daterangepicker/daterangepicker.js"></script>
<% %>

<script>
  // -------------------- Global cache --------------------
  let clients = [];
  let filteredClients = [];
  const sortState = { key: null, dir: "asc" };
  const savedViewsState = { viewId: null, name: "", columns: [], columns_order: [], filters: [], sort: [] };
  const filterState = {
    CompanyName: "",
    ContactName: "",
    Phone: "",
    Sector: "",
    NumberOfInvoices: "",
    CompanyNumber: "",
    CreatedOnFrom: "",
    CreatedOnTo: "",
  };

  // Cache userId -> full_name
  const userNameCache = new Map();

  // Bulk selection (company ids)
  const selectedCompanyIds = new Set();

  // -------------------- Utils --------------------
  function escapeHtml(value) {
    if (value == null) return "";
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function formatDate(value) {
    if (!value) return "";
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) return String(value);
    return d.toLocaleDateString("pt-BR");
  }

  function parsePtDateToTs(value, endOfDay) {
    const raw = String(value || "").trim();
    const m = raw.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (!m) return NaN;
    const h = endOfDay ? 23 : 0;
    const min = endOfDay ? 59 : 0;
    const sec = endOfDay ? 59 : 0;
    const d = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]), h, min, sec, endOfDay ? 999 : 0);
    return d.getTime();
  }

  function toComparable(v) {
    if (v == null) return "";
    return String(v).toLowerCase();
  }

  function isNonEmptyString(value) {
    return typeof value === "string" && value.trim().length > 0;
  }

  function setBulkActionsVisible(isVisible) {
    const bar = document.getElementById("bulkActions");
    if (!bar) return;
    bar.style.display = isVisible ? "flex" : "none";
  }

  function updateBulkUI() {
    const countEl = document.getElementById("selectedCount");
    if (countEl) countEl.textContent = String(selectedCompanyIds.size);

    setBulkActionsVisible(selectedCompanyIds.size > 0);

    // keep header checkbox in sync
    const chkAll = document.getElementById("chkSelectAll");
    if (chkAll) {
      // consider only currently rendered rows
      const rowChecks = document.querySelectorAll("input.company-check");
      const total = rowChecks.length;
      const checked = Array.from(rowChecks).filter((x) => x.checked).length;
      chkAll.checked = total > 0 && checked === total;
      chkAll.indeterminate = checked > 0 && checked < total;
    }
  }

  // -------------------- API --------------------
  async function fetchCompanies() {
    const resp = await fetch("/api/companies?fields=summary", {
      method: "GET",
      headers: { Accept: "application/json" },
    });

    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) {
      const msg = data?.message || "<%= t('page.clients.messages.loadFail') %>";
      throw new Error(msg);
    }
    return data;
  }

  async function fetchUserById(userId) {
    const resp = await fetch(`/api/users/${encodeURIComponent(userId)}`, {
      method: "GET",
      headers: { Accept: "application/json" },
    });

    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) return null;
    return data;
  }

  async function deleteCompanyById(companyId) {
    const resp = await fetch(`/api/companies/${encodeURIComponent(companyId)}`, {
      method: "DELETE",
      headers: { Accept: "application/json" },
    });

    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) {
      throw new Error(data?.message || "<%= t('page.clients.messages.deleteFailSingle') %>");
    }
    return data;
  }

  // Concurrency limiter (no external libs)
  async function runWithConcurrency(items, limit, worker) {
    const queue = [...items];
    const workers = Array.from({ length: Math.min(limit, items.length) }, async () => {
      while (queue.length > 0) {
        const item = queue.shift();
        await worker(item);
      }
    });
    await Promise.all(workers);
  }

  async function resolveUserNames(userIds) {
    const uniqueIds = [...new Set(userIds.filter(isNonEmptyString))];
    const toFetch = uniqueIds.filter((id) => !userNameCache.has(id));
    if (toFetch.length === 0) return;

    const concurrency = 5;
    await runWithConcurrency(toFetch, concurrency, async (id) => {
      const user = await fetchUserById(id);
      const fullName = user?.full_name ?? user?.fullName ?? user?.name ?? "";
      userNameCache.set(id, isNonEmptyString(fullName) ? String(fullName).trim() : "");
    });
  }

  // -------------------- Mapping --------------------
  function mapCompanyToClient(company, index) {
    const id = company.id ?? company.company_id ?? company.companyId ?? String(index + 1);

    const sector =
      company.sector ??
      company.company_sector ??
      company.sector_name ??
      null;

    const userId = company.user_id ?? company.userId ?? "";

    return {
      Id: String(id),
      rowNumber: index + 1,
      CompanyName: company.company_name ?? "",
      ContactName: "",
      Phone: company.phone ?? "",
      Email: company.email ?? "",
      UserId: userId,

      CreatedOn: company.created_on ?? company.createdAt ?? company.created_at ?? "",
      CompanyNumber: company.company_number ?? "",
      Sector: sector && String(sector).trim() ? String(sector).trim() : "<%= t('page.clients.defaults.sector') %>",
      NumberOfInvoices: company.number_of_invoices ?? "",
    };
  }

  function updateSortIndicators() {
    document.querySelectorAll("#clientsHeaderRow th.sortable").forEach((th) => {
      const indicator = th.querySelector(".sort-indicator");
      if (!indicator) return;
      const key = String(th.getAttribute("data-sort-key") || "");
      if (sortState.key === key) indicator.textContent = sortState.dir === "asc" ? "▲" : "▼";
      else indicator.textContent = "";
    });
  }

  function sortClients(list) {
    if (!sortState.key) return [...list];
    const key = sortState.key;
    const dir = sortState.dir === "desc" ? -1 : 1;
    return [...list].sort((a, b) => {
      let av = a[key];
      let bv = b[key];
      if (key === "NumberOfInvoices" || key === "rowNumber") {
        av = Number(av || 0);
        bv = Number(bv || 0);
      } else if (key === "CreatedOn") {
        av = new Date(a.CreatedOn || 0).getTime();
        bv = new Date(b.CreatedOn || 0).getTime();
      } else {
        av = toComparable(av);
        bv = toComparable(bv);
      }
      if (av < bv) return -1 * dir;
      if (av > bv) return 1 * dir;
      return 0;
    });
  }

  function applyFiltersAndSort() {
    const contains = (value, term) => {
      const v = toComparable(value);
      const t = toComparable(term).trim();
      if (!t) return true;
      return v.includes(t);
    };

    const fromTs = parsePtDateToTs(filterState.CreatedOnFrom, false);
    const toTs = parsePtDateToTs(filterState.CreatedOnTo, true);

    filteredClients = clients.filter((c) => {
      const createdTs = c.CreatedOn ? new Date(c.CreatedOn).getTime() : NaN;
      const dateOk =
        (Number.isNaN(fromTs) || (!Number.isNaN(createdTs) && createdTs >= fromTs)) &&
        (Number.isNaN(toTs) || (!Number.isNaN(createdTs) && createdTs <= toTs));

      return (
        contains(c.CompanyName, filterState.CompanyName) &&
        contains(c.ContactName, filterState.ContactName) &&
        contains(c.Phone, filterState.Phone) &&
        contains(c.Sector, filterState.Sector) &&
        contains(c.NumberOfInvoices, filterState.NumberOfInvoices) &&
        contains(c.CompanyNumber, filterState.CompanyNumber) &&
        dateOk
      );
    });

    renderCompaniesTable(sortClients(filteredClients));
    updateSortIndicators();
  }

  // -------------------- Render --------------------
  function renderCompaniesTable(list) {
    const tbody = document.querySelector("#lines");
    if (!tbody) return;

    tbody.innerHTML = "";

    if (!list || list.length === 0) {
      tbody.innerHTML = `<tr><td colspan="9"><%= t('page.clients.messages.noneFound') %></td></tr>`;
      updateBulkUI();
      return;
    }

    list.forEach((c, idx) => {
      const tr = document.createElement("tr");
      tr.className = "clicker";

      // Row click -> details
      tr.addEventListener("click", function () {
        redirectToProcess(c.Id);
      });

      const isChecked = selectedCompanyIds.has(String(c.Id));

      tr.innerHTML = `
        <td>
          <input
            class="company-check"
            type="checkbox"
            data-id="${escapeHtml(String(c.Id))}"
            ${isChecked ? "checked" : ""}
            title="<%= t('page.clients.ui.select') %>"
          />
        </td>
        <td>${escapeHtml(idx + 1)}</td>
        <td>${escapeHtml(c.CompanyName)}</td>
        <td>${escapeHtml(c.ContactName)}</td>
        <td>${escapeHtml(c.Phone)}</td>
        <td>${escapeHtml(c.Sector)}</td>
        <td>${escapeHtml(c.NumberOfInvoices ?? "")}</td>
        <td>${escapeHtml(formatDate(c.CreatedOn))}</td>
        <td>${escapeHtml(c.CompanyNumber)}</td>
      `;

      // Stop propagation on checkbox click (avoid redirect)
      const chk = tr.querySelector("input.company-check");
      chk.addEventListener("click", function (e) {
        e.stopPropagation();
        const id = String(this.getAttribute("data-id") ?? "");
        if (!id) return;

        if (this.checked) selectedCompanyIds.add(id);
        else selectedCompanyIds.delete(id);

        updateBulkUI();
      });

      tbody.appendChild(tr);
    });

    updateBulkUI();
  }

  // -------------------- Load --------------------
  async function loadCompanies() {
    try {
      const apiData = await fetchCompanies();

      const rows = Array.isArray(apiData)
        ? apiData
        : (apiData.data ?? apiData.rows ?? apiData.companies ?? [apiData]);

      clients = rows.map(mapCompanyToClient);

      // Resolve contact names
      const userIds = clients.map((c) => c.UserId);
      await resolveUserNames(userIds);

      for (const c of clients) {
        const name = c.UserId ? userNameCache.get(c.UserId) : "";
        c.ContactName = isNonEmptyString(name) ? name : (c.ContactName || "");
      }

      applyFiltersAndSort();
    } catch (err) {
      console.error("loadCompanies error:", err);
      const tbody = document.querySelector("#lines");
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan="9">${escapeHtml(err.message || "<%= t('page.clients.messages.loadUnexpected') %>")}</td></tr>`;
      }
    }
  }

  // -------------------- Navigation --------------------
  function redirectToProcess(id) {
    const selectedClient = clients.find((c) => c.Id === String(id));
    if (!selectedClient) {
      console.error("Client not found for id:", id);
      return;
    }

    localStorage.setItem("selectedClientId", String(selectedClient.Id));
    localStorage.setItem("selectedClient", JSON.stringify(selectedClient));
    window.location = "ClientDetails";
  }

  // -------------------- Bulk delete (GlobalModal) --------------------
  function showBulkDeleteConfirm(selectedIds) {
    if (!Array.isArray(selectedIds) || selectedIds.length === 0) {
      return Promise.resolve(false);
    }

    const qty = selectedIds.length;

    // GlobalModal elements from layout
    const modalBtn = document.getElementById("modalButton");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const btnSave = document.getElementById("saveModal");
    const btnClose = document.getElementById("closeModal");

    // Fallback if modal not found
    if (!modalBtn || !modalTitle || !modalBody || !btnSave || !btnClose) {
      const ok = confirm(`<%= t('page.clients.modalRemove.confirmFallbackPrefix') %> ${qty} <%= t('page.clients.modalRemove.confirmFallbackSuffix') %>`);
      return Promise.resolve(ok);
    }

    modalTitle.textContent = "<%= t('page.clients.modalRemove.title') %>";
    modalBody.innerHTML = `
      <p><%= t('page.clients.modalRemove.line1') %> <strong>${escapeHtml(qty)}</strong></p>
      <p class="text-danger"><%= t('page.clients.modalRemove.line2') %></p>
      <p><%= t('page.clients.modalRemove.confirm') %></p>
    `;

    // Make "Save" look like delete
    btnSave.textContent = "<%= t('page.clients.toolbar.remove') %>";
    btnSave.classList.remove("btn-primary");
    btnSave.classList.add("btn-danger");

    btnClose.textContent = "<%= t('page.layout.modal.cancel') %>";

    return new Promise((resolve) => {
      const cleanup = () => {
        btnSave.onclick = null;
        btnClose.onclick = null;

        // restore default styles/text
        btnSave.classList.remove("btn-danger");
        btnSave.classList.add("btn-primary");
        btnSave.textContent = "<%= t('page.layout.modal.save') %>";
        btnClose.textContent = "<%= t('page.layout.modal.close') %>";
      };

      btnSave.onclick = () => {
        cleanup();
        resolve(true);
      };

      btnClose.onclick = () => {
        cleanup();
        resolve(false);
      };

      // Open modal by clicking hidden button (your requirement)
      modalBtn.click();
    });
  }

  async function executeBulkDelete() {
    const ids = Array.from(selectedCompanyIds);
    if (ids.length === 0) return;

    const confirmed = await showBulkDeleteConfirm(ids);
    if (!confirmed) return;

    const btn = document.getElementById("btnBulkDelete");
    const oldText = btn ? btn.innerHTML : "";
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> <%= t('page.clients.ui.removing') %>...`;
    }

    try {
      // Delete with limited concurrency
      const concurrency = 5;
      const failures = [];

      await runWithConcurrency(ids, concurrency, async (id) => {
        try {
          await deleteCompanyById(id);
        } catch (e) {
          failures.push({ id, message: e?.message || "<%= t('page.clients.messages.deleteFail') %>" });
        }
      });

      if (failures.length > 0) {
        console.warn("Bulk delete failures:", failures);
        alert(`<%= t('page.clients.messages.bulkSomeFailedPrefix') %> (${failures.length}). <%= t('page.clients.messages.bulkSomeFailedSuffix') %>`);
      }

      // Remove deleted rows from local list (only those successful)
      const failedIds = new Set(failures.map((x) => String(x.id)));
      const removedIds = ids.filter((id) => !failedIds.has(String(id)));

      clients = clients.filter((c) => !removedIds.includes(String(c.Id)));

      // Clear selection
      removedIds.forEach((id) => selectedCompanyIds.delete(String(id)));

      // Re-render with remaining
      applyFiltersAndSort();
    } catch (err) {
      console.error("executeBulkDelete error:", err);
      alert(err?.message || "<%= t('page.clients.messages.bulkUnexpected') %>");
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = oldText || `<i class="fa fa-trash"></i> <%= t('page.clients.toolbar.remove') %>`;
      }
      updateBulkUI();
    }
  }

  function clearSelection() {
    selectedCompanyIds.clear();
    applyFiltersAndSort();
  }

  // -------------------- Events --------------------
  function bindBulkEvents() {
    const chkAll = document.getElementById("chkSelectAll");
    const btnDelete = document.getElementById("btnBulkDelete");
    const btnClear = document.getElementById("btnClearSelection");

    if (chkAll) {
      chkAll.addEventListener("click", function (e) {
        e.stopPropagation();

        const checks = document.querySelectorAll("input.company-check");
        checks.forEach((chk) => {
          const id = String(chk.getAttribute("data-id") ?? "");
          if (!id) return;

          chk.checked = this.checked;

          if (this.checked) selectedCompanyIds.add(id);
          else selectedCompanyIds.delete(id);
        });

        updateBulkUI();
      });
    }

    if (btnDelete) btnDelete.addEventListener("click", executeBulkDelete);
    if (btnClear) btnClear.addEventListener("click", clearSelection);
  }

  function bindSorting() {
    document.querySelectorAll("#clientsHeaderRow th.sortable").forEach((th) => {
      th.addEventListener("click", function () {
        const key = String(this.getAttribute("data-sort-key") || "");
        if (!key) return;
        if (sortState.key === key) sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
        else { sortState.key = key; sortState.dir = "asc"; }
        applyFiltersAndSort();
      });
    });
  }

  function bindColumnFilters() {
    const map = ["CompanyName", "ContactName", "Phone", "Sector", "NumberOfInvoices", "CreatedOnRange", "CompanyNumber"];
    document.querySelectorAll("#clientsFiltersRow input:not([type='hidden'])").forEach((input, idx) => {
      input.addEventListener("input", function () {
        const field = map[idx];
        if (!field || field === "CreatedOnRange") return;
        filterState[field] = String(this.value || "");
        applyFiltersAndSort();
      });
    });
  }

  function initCreatedDateRange() {
    const $range = $("#clientsCreatedRangeFilter");
    const $from = $("#clientsCreatedFromFilter");
    const $to = $("#clientsCreatedToFilter");
    if (!$range.length) return;

    if ($range.data("daterangepicker")) $range.data("daterangepicker").remove();
    if ($.fn.daterangepicker && window.moment) {
      $range.daterangepicker({
        autoUpdateInput: false,
        locale: {
          format: "DD/MM/YYYY",
          cancelLabel: "<%= t('page.layout.savedViews.clearLabel') %>",
          applyLabel: "<%= t('page.layout.savedViews.applyLabel') %>",
          fromLabel: "<%= t('page.layout.savedViews.fromLabel') %>",
          toLabel: "<%= t('page.layout.savedViews.toLabel') %>",
          daysOfWeek: ["Do", "Se", "Te", "Qa", "Qi", "Se", "Sa"],
          monthNames: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]
        }
      });

      $range.off("apply.daterangepicker.cli").on("apply.daterangepicker.cli", function (_ev, picker) {
        const from = picker.startDate.format("DD/MM/YYYY");
        const to = picker.endDate.format("DD/MM/YYYY");
        $from.val(from);
        $to.val(to);
        $range.val(`${from} - ${to}`);
        filterState.CreatedOnFrom = from;
        filterState.CreatedOnTo = to;
        applyFiltersAndSort();
      });

      $range.off("cancel.daterangepicker.cli").on("cancel.daterangepicker.cli", function () {
        $from.val("");
        $to.val("");
        $range.val("");
        filterState.CreatedOnFrom = "";
        filterState.CreatedOnTo = "";
        applyFiltersAndSort();
      });
    }

    $("#clientsCreatedRangeBtn").off("click.cli").on("click.cli", function (e) {
      e.preventDefault();
      e.stopPropagation();
      if ($range.data("daterangepicker")) $range.data("daterangepicker").show();
      else $range.focus();
    });
  }

  function getAllColumnKeys() {
    return $("#clientsHeaderRow th.sortable").map(function () {
      return String($(this).data("sort-key") || "");
    }).get().filter(Boolean);
  }

  function captureFiltersForSavedView() {
    const filters = [];
    Object.entries(filterState).forEach(([k, v]) => {
      const value = String(v || "").trim();
      if (!value) return;
      if (k === "CreatedOnFrom") filters.push({ field: "CreatedOn", op: "gte", value });
      else if (k === "CreatedOnTo") filters.push({ field: "CreatedOn", op: "lte", value });
      else filters.push({ field: k, op: "contains", value });
    });
    return filters;
  }

  function applyFiltersFromSavedView(def) {
    Object.keys(filterState).forEach((k) => { filterState[k] = ""; });
    $("#clientsFiltersRow input:not([type='hidden'])").val("");
    $("#clientsCreatedFromFilter,#clientsCreatedToFilter,#clientsCreatedRangeFilter").val("");

    (def.filters || []).forEach((f) => {
      const field = String(f.field || "");
      const value = String(f.value || "");
      const op = String(f.op || "").toLowerCase();
      if (!value) return;
      if (field === "CreatedOn" && op === "gte") filterState.CreatedOnFrom = value;
      else if (field === "CreatedOn" && op === "lte") filterState.CreatedOnTo = value;
      else if (Object.prototype.hasOwnProperty.call(filterState, field)) filterState[field] = value;
    });

    const map = ["CompanyName", "ContactName", "Phone", "Sector", "NumberOfInvoices", "CreatedOnRange", "CompanyNumber"];
    $("#clientsFiltersRow input:not([type='hidden'])").each(function (idx) {
      const field = map[idx];
      if (!field || field === "CreatedOnRange") return;
      this.value = filterState[field] || "";
    });

    $("#clientsCreatedFromFilter").val(filterState.CreatedOnFrom || "");
    $("#clientsCreatedToFilter").val(filterState.CreatedOnTo || "");
    if (filterState.CreatedOnFrom && filterState.CreatedOnTo) {
      $("#clientsCreatedRangeFilter").val(`${filterState.CreatedOnFrom} - ${filterState.CreatedOnTo}`);
    }
  }

  function applySortFromSavedView(def) {
    const first = Array.isArray(def.sort) ? def.sort[0] : null;
    const key = String(first?.field || "").trim();
    const dir = String(first?.dir || "asc").toLowerCase() === "desc" ? "desc" : "asc";
    if (!key) {
      sortState.key = null;
      sortState.dir = "asc";
    } else {
      sortState.key = key;
      sortState.dir = dir;
    }
  }

  function tryTriggerAny(selectors) {
    for (const s of selectors) {
      const el = $(s);
      if (el.length) { el.trigger("click"); return true; }
    }
    return false;
  }

  function ensureSavedViewsExtraButtons() {
    const host = $("#clientsSavedViewsHost");
    if (!host.length) return;
    const actions = host.find(".sv-actions").length ? host.find(".sv-actions").first() : host;

    if (!$("#btnSaveCurrentClientsView").length) {
      actions.append(`<button id="btnSaveCurrentClientsView" class="btn btn-white btn-xs sv-actionbar-btn" style="margin-left:8px;" title="<%= t('page.layout.savedViews.saveCurrentTitle') %>"><i class="fa fa-check"></i> <%= t('page.layout.savedViews.saveLabel') %></button>`);
    }
    // Keep only default small delete icon from SavedViewsGrid.
    $("#btnDeleteCurrentClientsView").remove();

    $("#btnSaveCurrentClientsView").off("click.svSaveCurrent").on("click.svSaveCurrent", function (e) {
      e.preventDefault(); e.stopPropagation();
      const did = tryTriggerAny(["#sv_btnSave", "[data-action='save']", ".sv-btn-save"]);
      if (did) return;
      if (savedViewsState.viewId) {
        (async () => {
          try {
            const payload = {
              name: savedViewsState.name || undefined,
              definition_json: {
                columns: savedViewsState.columns,
                columns_order: savedViewsState.columns_order,
                filters: captureFiltersForSavedView(),
                sort: sortState.key ? [{ field: sortState.key, dir: sortState.dir }] : []
              }
            };
            await fetch(`/api/saved-views/${encodeURIComponent(savedViewsState.viewId)}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json", Accept: "application/json" },
              body: JSON.stringify(payload)
            });
            if (typeof window.SavedViewsGrid?.reload === "function") window.SavedViewsGrid.reload();
          } catch (err) { console.error(err); }
        })();
        return;
      }
      tryTriggerAny(["#sv_btnSaveAs", "[data-action='saveas']", ".sv-btn-saveas"]);
    });

    // Delete action is handled by default SavedViewsGrid icon.
  }

  // -------------------- Init --------------------
  $(document).ready(function () {
    if (!window.Auth || !window.Auth.requireLogin()) return;

     const canAccess = window.__auth.isAdmin;
      if (!canAccess) {
        window.location.href = "/Default"; // ou "/Processos"
        return;
      }

    $("#pageName").text("<%= t('page.clients.pageTitle') %>");
    $("#subpageName").text("<%= t('page.clients.pageTitle') %>");

    bindBulkEvents();
    bindSorting();
    bindColumnFilters();
    initCreatedDateRange();

    $("#searchinput").on("keyup change", function () {
      const value = String($(this).val() || "");
      filterState.CompanyName = value;
      const firstFilterInput = $("#clientsFiltersRow input:not([type='hidden'])").eq(0);
      if (firstFilterInput.length) firstFilterInput.val(value);
      applyFiltersAndSort();
    });

    (async function initClientsSavedViews() {
      await loadCompanies();

      const allKeys = getAllColumnKeys();
      savedViewsState.columns = allKeys.slice();
      savedViewsState.columns_order = allKeys.slice();

      await window.SavedViewsGrid.init({
        entityName: "clients",
        hostSelector: "#clientsSavedViewsHost",
        tableSelector: "#clientes",
        headerRowSelector: "#clientes thead tr:eq(1)",
        filtersRowSelector: "#clientes thead tr:eq(0)",
        getAllColumnKeys: () => getAllColumnKeys(),
        fallbackViewName: "",
        includeFallbackOption: false,
        fallbackDefinition: { columns: allKeys.slice(), columns_order: allKeys.slice(), filters: [], sort: [] },
        getCurrentState: () => {
          const domOrder = $("#clientsHeaderRow th.sortable").map(function () { return String($(this).data("sort-key") || ""); }).get().filter(Boolean);
          const visible = $("#clientsHeaderRow th.sortable:visible").map(function () { return String($(this).data("sort-key") || ""); }).get().filter(Boolean);
          savedViewsState.columns_order = domOrder.length ? domOrder : savedViewsState.columns_order;
          savedViewsState.columns = visible.length ? visible : savedViewsState.columns;
          savedViewsState.filters = captureFiltersForSavedView();
          savedViewsState.sort = sortState.key ? [{ field: sortState.key, dir: sortState.dir }] : [];
          return Object.assign({}, savedViewsState);
        },
        applyState: ({ viewId, name, definition, _fromColumnsModal }) => {
          savedViewsState.viewId = viewId;
          savedViewsState.name = name || "";
          if (_fromColumnsModal === true) {
            initCreatedDateRange();
            return;
          }
          applyFiltersFromSavedView(definition || {});
          applySortFromSavedView(definition || {});
          initCreatedDateRange();
          applyFiltersAndSort();
          ensureSavedViewsExtraButtons();
        },
        onAfterApply: () => {
          initCreatedDateRange();
          applyFiltersAndSort();
          ensureSavedViewsExtraButtons();
        }
      });
      setTimeout(ensureSavedViewsExtraButtons, 120);
    })().catch((err) => {
      console.error("init clients saved views error:", err);
    });
  });
</script>

