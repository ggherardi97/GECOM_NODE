<style>
  .ibox-title {
    padding: 15px 90px 20px 15px;
  }

  .wizard-big.wizard > .content {
    min-height: 420px !important;
  }

  .muted {
    color: #888;
    font-size: 12px;
  }

  .select2-container {
    background-color: white;
    box-sizing: border-box;
    display: inline-block;
    margin: 0;
    position: relative;
    vertical-align: middle;
    padding: 3px;
    border: 1px solid #c0c0c0;
  }

  .transport-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }

  .transport-table th, .transport-table td {
    vertical-align: middle !important;
  }

  .btn-xs2 {
    padding: 4px 8px;
    font-size: 12px;
    line-height: 1.2;
  }

  .readonly-select2 .select2-selection {
    background: #eee !important;
    cursor: not-allowed !important;
  }

  .select2-selection__clear{
    padding-right: 10px;
  }

  /* ✅ Fix: typeahead dropdown position/z-index inside wizard/table */
  .typeahead.dropdown-menu {
    z-index: 999999 !important;
    max-height: 240px;
    overflow-y: auto;
  }

  /* ✅ Dropzone usability */
  #dropzoneForm {
    min-height: 160px;
    cursor: pointer;
  }

  .dz-message .btn {
    margin-top: 10px;
  }

  /* List of files */
  .proc-doc-row {
    margin-bottom: 8px;
  }
</style>

<% contentFor('headerLink') %>
<link href="../Assets/inspinia/css/plugins/iCheck/custom.css" rel="stylesheet">
<link href="../Assets/inspinia/css/plugins/steps/jquery.steps.css" rel="stylesheet">
<link href="../Assets/inspinia/css/plugins/select2/select2.min.css" rel="stylesheet">
<link href="../Assets/inspinia/css/plugins/select2/select2-bootstrap.min.css" rel="stylesheet">
<link href="../Assets/inspinia/css/plugins/datapicker/datepicker3.css" rel="stylesheet">

<!-- ✅ Dropzone CSS (sem isso o clique/drag costuma ficar “esquisito”) -->
<link href="../Assets/inspinia/css/plugins/dropzone/basic.css" rel="stylesheet">
<link href="../Assets/inspinia/css/plugins/dropzone/dropzone.css" rel="stylesheet">
<% %>

<div class="wrapper wrapper-content animated fadeInRight" style="margin-top: 0px;">
  <div class="row">
    <div class="col-lg-12">
      <div class="ibox">
        <div class="ibox-title">
          <h5>Novo Processo</h5>
          <div class="ibox-tools"></div>
        </div>

        <div class="ibox-content">
          <p>Preencha as informações do processo e seus transportes.</p>

          <form id="form" action="#" class="wizard-big" onsubmit="return false;">
            <!-- STEP 1 -->
            <h1>Detalhes</h1>
            <fieldset>
              <div class="row">
                <div class="col-lg-9">
                  <div class="row">
                    <div class="form-group col-lg-6">
                      <label>Nº do Processo *</label>
                      <input id="process_number" type="text" class="form-control" placeholder="Preenchido pelo sistema." readonly>
                    </div>

                    <div class="form-group col-lg-6">
                      <label>Empresa *</label>
                      <select id="company_id" class="form-control required"></select>
                    </div>
                  </div>

                  <div class="row">
                    <div class="form-group col-lg-6">
                      <label>Invoice relacionado</label>
                      <select id="invoice" class="form-control"></select>
                      <div class="muted" id="invoiceHelp" style="margin-top:4px; display:none;">
                        Selecione uma empresa para listar as invoices.
                      </div>
                    </div>

                    <div class="form-group col-lg-6">
                      <label>Previsão de Entrega</label>
                      <div class="input-group date">
                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                        <input id="ship_date" type="text" class="form-control datepicker" autocomplete="off">
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="form-group col-lg-6">
                      <label>Tipo de Processo</label>
                      <select id="process_type_id" class="form-control"></select>
                    </div>

                    <div class="form-group col-lg-6">
                      <label>Contato do Cliente *</label>
                      <select id="primary_contact_id" class="form-control required"></select>
                      <div class="muted" id="contactHelp" style="margin-top:4px; display:none;">
                        Selecione uma empresa para listar os contatos.
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-lg-3">
                  <div class="text-center">
                    <div style="margin-top: 20px">
                      <i class="fa fa-suitcase" style="font-size: 180px; color: #e5e5e5"></i>
                    </div>
                  </div>
                </div>
              </div>
            </fieldset>

            <!-- STEP 2 -->
            <h1>Transportes</h1>
            <fieldset>
              <div class="transport-toolbar">
                <div>
                  <strong>Transportes do processo</strong>
                  <div class="muted">Adicione um ou mais transportes relacionados a este processo.</div>
                </div>
                <div>
                  <button type="button" class="btn btn-primary btn-xs2" id="btnAddTransport">
                    <i class="fa fa-plus"></i> Adicionar transporte
                  </button>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-bordered table-striped transport-table">
                  <thead>
                    <tr>
                      <th style="min-width:160px;">Companhia *</th>
                      <th style="min-width:140px;">Telefone</th>
                      <th style="min-width:160px;">Origem *</th>
                      <th style="min-width:160px;">Destino *</th>
                      <th style="min-width:170px;">Tipo *</th>
                      <th style="min-width:170px;">Status *</th>
                      <th style="min-width:150px;">Previsão Embarque</th>
                      <th style="min-width:150px;">Previsão Chegada</th>
                      <th style="width:70px;" class="text-center">Ações</th>
                    </tr>
                  </thead>
                  <tbody id="transportsTbody"></tbody>
                </table>
              </div>

              <div class="alert alert-warning" id="transportWarning" style="display:none; margin-top:10px;"></div>
            </fieldset>

            <!-- STEP 3 -->
            <h1>Documentos</h1>
            <fieldset style="overflow: auto;">
              <h3>Upload de documentos</h3>
              <p class="muted">Anexe até <strong>5 arquivos</strong>. O upload será feito ao finalizar.</p>

              <div class="row">
                <div class="col-lg-6">
                  <button type="button" class="btn btn-primary" id="btnPickProcDocs">
                    <i class="fa fa-paperclip"></i> Selecionar arquivos
                  </button>
                  <div class="muted" style="margin-top:6px;">Você também pode arrastar os arquivos para a área abaixo.</div>
                </div>

                <div class="col-lg-6">
                  <div id="procDocUploadProgress" style="display:none; margin-top: 6px;">
                    <div class="progress progress-striped active" style="margin-bottom:6px;">
                      <div id="procDocUploadProgressBar" class="progress-bar" style="width: 0%"></div>
                    </div>
                    <small id="procDocUploadProgressText" class="text-muted"></small>
                  </div>
                </div>
              </div>

              <div class="ibox-content" style="padding:0; margin-top:12px;">
                <div class="dropzone dz-clickable" id="dropzoneForm" style="display: none;">
                  <div class="dz-default dz-message">
                    <span>
                      <strong>Arraste arquivos aqui</strong><br>
                      <span class="muted">Máximo 5 arquivos.</span><br>
                      <span class="muted">Você poderá renomear cada arquivo abaixo antes de finalizar.</span>
                    </span>
                  </div>
                </div>
              </div>

              <!-- Lista de arquivos + nomes -->
              <div id="procDocFilesList" style="margin-top:12px; display:none;">
                <div class="small text-muted" style="margin-bottom:6px;">
                  Ajuste o nome de cada arquivo (nome no sistema).
                </div>
                <div id="procDocFilesListInner"></div>
              </div>
            </fieldset>
          </form>

        </div>
      </div>
    </div>
  </div>
</div>

<% contentFor('scripts') %>
<script src="../Assets/inspinia/js/plugins/steps/jquery.steps.min.js"></script>
<script src="../Assets/inspinia/js/plugins/validate/jquery.validate.min.js"></script>
<script src="../Assets/inspinia/js/plugins/iCheck/icheck.min.js"></script>
<script src="../Assets/inspinia/js/plugins/select2/select2.full.min.js"></script>
<script src="../Assets/inspinia/js/plugins/datapicker/bootstrap-datepicker.js"></script>
<script src="../Assets/inspinia/js/plugins/typehead/bootstrap3-typeahead.min.js"></script>
<script src="../Assets/inspinia/js/plugins/dropzone/dropzone.js"></script>

<script>
(function () {
  // =========================
  // State
  // =========================
  const state = {
    processId: null,
    creating: false,
    companies: [],
    invoices: [],
    processTypes: [],
    users: [],
    transportTypes: [],
    transportStatuses: [],
    companiesById: new Map(),
    transportSeq: 0,

    // Step 3 (documents)
    __procDzInitialized: false,
    procDocDz: null,
    procDocFilesUi: new Map(), // key: fileKey => { file, $row, $nameInput }
  };

  // =========================
  // Helpers
  // =========================
  function escapeHtml(value) {
    if (value == null) return "";
    return String(value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  async function readJsonSafe(resp) {
    const text = await resp.text().catch(() => "");
    if (!text) return {};
    try { return JSON.parse(text); } catch { return { message: text }; }
  }

  async function apiGet(url) {
    const resp = await fetch(url, { method: "GET", headers: { "Accept": "application/json" } });
    const data = await readJsonSafe(resp);
    if (!resp.ok) throw new Error(data?.message || "Falha na requisição.");
    return data;
  }

  async function apiPost(url, payload) {
    const resp = await fetch(url, {
      method: "POST",
      headers: { "Accept": "application/json", "Content-Type": "application/json" },
      body: JSON.stringify(payload || {})
    });
    const data = await readJsonSafe(resp);
    if (!resp.ok) throw new Error(data?.message || "Falha ao salvar.");
    return data;
  }

  function parseDateBr(value) {
    const text = (value || "").trim();
    const match = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(text);
    if (!match) return null;

    const day = Number(match[1]);
    const month = Number(match[2]);
    const year = Number(match[3]);

    const date = new Date(year, month - 1, day);
    if (date.getFullYear() !== year || date.getMonth() !== (month - 1) || date.getDate() !== day) return null;
    return date;
  }

  function toIsoZFromBr(value) {
    const d = parseDateBr(value);
    if (!d) return null;
    const utc = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0));
    return utc.toISOString();
  }

  function applyBrazilPhoneMask(rawValue) {
    const digits = String(rawValue || "").replace(/\D/g, "").slice(0, 11);
    const ddd = digits.slice(0, 2);
    const isMobile = digits.length > 10;

    const part1 = isMobile ? digits.slice(2, 7) : digits.slice(2, 6);
    const part2 = isMobile ? digits.slice(7, 11) : digits.slice(6, 10);

    if (!digits) return "";
    if (digits.length <= 2) return `(${ddd}`;
    if (digits.length <= 6) return `(${ddd}) ${digits.slice(2)}`;
    if (digits.length <= 10) return `(${ddd}) ${part1}-${part2}`.replace(/-$/, "");
    return `(${ddd}) ${part1}-${part2}`;
  }

  document.addEventListener("input", function (ev) {
    const target = ev.target;
    if (!target) return;
    if (target.classList.contains("phone-mask")) {
      target.value = applyBrazilPhoneMask(target.value);
    }
  }, true);

  // =========================
  // UI init
  // =========================
  function initDatePickers(scope) {
    const $scope = scope ? $(scope) : $(document);

    $scope.find(".datepicker").each(function () {
      const $input = $(this);
      if ($input.data("datepicker")) return;

      $input.datepicker({
        todayBtn: "linked",
        keyboardNavigation: false,
        forceParse: false,
        calendarWeeks: true,
        autoclose: true,
        format: "dd/mm/yyyy",
        container: "body"
      });

      if (!String($input.val() || "").trim()) {
        const now = new Date();
        const dd = String(now.getDate()).padStart(2, "0");
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const yyyy = now.getFullYear();
        $input.val(`${dd}/${mm}/${yyyy}`);
      }
    });
  }

  function initSelect2($el, placeholder, dropdownParent) {
    if (!$el || !$el.length) return;
    if (!$.fn.select2) return;

    if ($el.hasClass("select2-hidden-accessible") || $el.data("select2")) {
      try { $el.select2("destroy"); } catch (_) { }
    }
    $el.siblings(".select2").remove();

    $el.select2({
      width: "100%",
      theme: "bootstrap",
      placeholder: placeholder || "Selecionar...",
      allowClear: true,
      minimumResultsForSearch: 0,
      language: "pt-BR",
      dropdownParent: dropdownParent || undefined
    });
  }

  function setSelectDisabled(selectId, disabled) {
    const el = document.getElementById(selectId);
    if (!el) return;
    el.disabled = !!disabled;

    const $el = $(el);
    const $container = $el.next(".select2");
    if ($container && $container.length) {
      if (disabled) $container.addClass("readonly-select2");
      else $container.removeClass("readonly-select2");
    }
  }

  // =========================
  // Auth helpers
  // =========================
  function getUserCompanyId() {
    const id = window.__auth?.company_id || window.__auth?.companyId || null;
    return id ? String(id) : null;
  }

  function getAccountIdForCreate() {
    const id =
      window.__auth?.accountId ||
      window.__auth?.account_id ||
      window.__auth?.account?.id ||
      window.__auth?.tenant_id ||
      window.__auth?.admin_account_id ||
      null;

    if (id) return String(id);

    const companyId = getUserCompanyId();
    return companyId ? String(companyId) : null;
  }

  // =========================
  // Load lists
  // =========================
  async function loadCompanies() {
    const data = await apiGet("/api/companies");
    const list = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? data?.companies ?? []);

    state.companies = [];
    state.companiesById = new Map();

    list.forEach(c => {
      const id = String(c?.id || "").trim();
      const name = String(c?.company_name || c?.name || "").trim();
      if (!id || !name) return;
      state.companies.push({ id, name });
      state.companiesById.set(id, c);
    });

    const $ddl = $("#company_id");
    $ddl.empty().append(`<option value="">Selecionar...</option>`);
    state.companies.forEach(c => $ddl.append(`<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`));
  }

  async function loadProcessTypes() {
    const data = await apiGet("/api/process-types");
    const list = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? data?.process_types ?? []);
    state.processTypes = list
      .map(t => ({ id: String(t?.id || "").trim(), name: String(t?.name || "").trim() }))
      .filter(x => x.id && x.name);

    const $ddl = $("#process_type_id");
    $ddl.empty().append(`<option value="">Selecionar...</option>`);
    state.processTypes.forEach(t => $ddl.append(`<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`));
  }

  async function loadInvoicesByCompany(companyId) {
    const $ddl = $("#invoice");
    $ddl.empty().append(`<option value="">Selecionar...</option>`);

    if (!companyId) {
      state.invoices = [];
      setSelectDisabled("invoice", true);
      document.getElementById("invoiceHelp").style.display = "block";
      return;
    }

    document.getElementById("invoiceHelp").style.display = "none";
    setSelectDisabled("invoice", false);

    const data = await apiGet(`/api/invoices?company_id=${encodeURIComponent(companyId)}`);
    const list = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? data?.invoices ?? []);
    state.invoices = list
      .map(i => ({
        id: String(i?.id || "").trim(),
        invoice_number: String(i?.invoice_number || "").trim()
      }))
      .filter(x => x.id && x.invoice_number);

    state.invoices.forEach(i => {
      $ddl.append(`<option value="${escapeHtml(i.invoice_number)}">${escapeHtml(i.invoice_number)}</option>`);
    });
  }

  async function loadUsersByCompany(companyId) {
    const $ddl = $("#primary_contact_id");
    $ddl.empty().append(`<option value="">Selecionar...</option>`);

    if (!companyId) {
      state.users = [];
      setSelectDisabled("primary_contact_id", true);
      document.getElementById("contactHelp").style.display = "block";
      return;
    }

    document.getElementById("contactHelp").style.display = "none";
    setSelectDisabled("primary_contact_id", false);

    const data = await apiGet(`/api/users?company_id=${encodeURIComponent(companyId)}`);
    const list = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? data?.users ?? []);
    state.users = list
      .map(u => ({
        id: String(u?.id || "").trim(),
        name: String(u?.full_name || u?.name || "").trim(),
        phone: String(u?.phonenumber || "").trim()
      }))
      .filter(x => x.id && x.name);

    state.users.forEach(u => {
      const label = u.phone ? `${u.name} (${u.phone})` : u.name;
      $ddl.append(`<option value="${escapeHtml(u.id)}">${escapeHtml(label)}</option>`);
    });
  }

  async function loadTransportTypes() {
    const data = await apiGet("/api/transport-types");
    const list = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? data?.transport_types ?? []);
    state.transportTypes = list
      .map(t => ({ id: String(t?.id || "").trim(), name: String(t?.name || "").trim() }))
      .filter(x => x.id && x.name);
  }

  async function loadTransportStatuses() {
    try {
      const data = await apiGet("/api/transport-statuses");
      const list = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? data?.transport_statuses ?? []);
      state.transportStatuses = list
        .map(s => ({ id: String(s?.id || "").trim(), name: String(s?.name || "").trim() }))
        .filter(x => x.id && x.name);
    } catch (e) {
      state.transportStatuses = [];
      const warn = document.getElementById("transportWarning");
      warn.style.display = "block";
      warn.innerHTML = "Aviso: não foi possível carregar os status de transporte. Confirme se existe o endpoint <strong>/api/transport-statuses</strong>.";
    }
  }

  // =========================
  // Transports rows
  // =========================
  function initCountriesTypeahead(scope) {
    const $scope = scope ? $(scope) : $(document);

    const countries = (window.__countriesPtBr && Array.isArray(window.__countriesPtBr))
      ? window.__countriesPtBr
      : ["Brasil","Estados Unidos","Portugal","China","Alemanha","França","Argentina","Chile","México","Japão","Itália","Espanha","Canadá","Reino Unido"];

    $scope.find(".autocompleteCountry").each(function () {
      const $input = $(this);

      // ✅ destroy/re-init safe
      try {
        const ta = $input.data("typeahead");
        if (ta && ta.destroy) ta.destroy();
      } catch (_) {}

      // ✅ main fix: fitToElement keeps dropdown aligned with the input
      $input.typeahead({
        source: countries,
        autoSelect: true,
        fitToElement: true
      });
    });
  }

  function buildTransportRow(rowId) {
    const typeOptions = [`<option value="">Selecionar...</option>`]
      .concat(state.transportTypes.map(t => `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`))
      .join("");

    const statusOptions = [`<option value="">Selecionar...</option>`]
      .concat(state.transportStatuses.map(s => `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)}</option>`))
      .join("");

    return `
      <tr data-row-id="${escapeHtml(rowId)}">
        <td><input type="text" class="form-control" id="${escapeHtml(rowId)}_company" placeholder="Ex: Maersk" /></td>
        <td><input type="text" class="form-control phone-mask" id="${escapeHtml(rowId)}_phone" placeholder="(11) 99999-9999" /></td>
        <td><input type="text" class="form-control autocompleteCountry" id="${escapeHtml(rowId)}_origin" placeholder="País de origem" autocomplete="off" /></td>
        <td><input type="text" class="form-control autocompleteCountry" id="${escapeHtml(rowId)}_destination" placeholder="País de destino" autocomplete="off" /></td>
        <td>
          <select class="form-control transport-type" id="${escapeHtml(rowId)}_type">${typeOptions}</select>
        </td>
        <td>
          <select class="form-control transport-status" id="${escapeHtml(rowId)}_status">${statusOptions}</select>
        </td>
        <td><input type="text" class="form-control datepicker" id="${escapeHtml(rowId)}_departure" autocomplete="off" /></td>
        <td><input type="text" class="form-control datepicker" id="${escapeHtml(rowId)}_arrival" autocomplete="off" /></td>
        <td class="text-center">
          <button type="button" class="btn btn-danger btn-xs2 btn-remove-transport"><i class="fa fa-trash"></i></button>
        </td>
      </tr>
    `;
  }

  function addTransportRow() {
    const tbody = document.getElementById("transportsTbody");
    if (!tbody) return;

    const rowId = `trow_${++state.transportSeq}`;
    tbody.insertAdjacentHTML("beforeend", buildTransportRow(rowId));

    const tr = tbody.querySelector(`tr[data-row-id="${CSS.escape(rowId)}"]`);
    if (!tr) return;

    initDatePickers(tr);
    initSelect2($(tr).find("select.transport-type"), "Selecionar...", null);
    initSelect2($(tr).find("select.transport-status"), "Selecionar...", null);

    // ✅ typeahead align fix per row
    initCountriesTypeahead(tr);
  }

  document.addEventListener("click", function (ev) {
    const btn = ev.target && ev.target.closest(".btn-remove-transport");
    if (!btn) return;
    const tr = btn.closest("tr[data-row-id]");
    if (tr) tr.remove();
  }, true);

  function readTransportRows() {
    const tbody = document.getElementById("transportsTbody");
    const rows = tbody ? Array.from(tbody.querySelectorAll("tr[data-row-id]")) : [];

    return rows.map(tr => {
      const rowId = tr.getAttribute("data-row-id");
      const transport_company = (document.getElementById(`${rowId}_company`)?.value || "").trim();
      const contact_phone = (document.getElementById(`${rowId}_phone`)?.value || "").trim();
      const origin = (document.getElementById(`${rowId}_origin`)?.value || "").trim();
      const destination = (document.getElementById(`${rowId}_destination`)?.value || "").trim();
      const transport_type_id = String(document.getElementById(`${rowId}_type`)?.value || "").trim();
      const transport_status_id = String(document.getElementById(`${rowId}_status`)?.value || "").trim();

      const departure_forecast = toIsoZFromBr(document.getElementById(`${rowId}_departure`)?.value || "");
      const arrival_forecast = toIsoZFromBr(document.getElementById(`${rowId}_arrival`)?.value || "");

      return {
        transport_company,
        contact_phone: contact_phone || null,
        origin,
        destination,
        transport_type_id: transport_type_id || null,
        transport_status_id: transport_status_id || null,
        departure_forecast: departure_forecast || null,
        arrival_forecast: arrival_forecast || null
      };
    });
  }

  function validateTransportRows() {
    const rows = readTransportRows();
    if (!rows.length) return "Adicione pelo menos 1 transporte.";
    const invalid = rows.find(r => !r.transport_company || !r.origin || !r.destination || !r.transport_type_id || !r.transport_status_id);
    if (invalid) return "Preencha Companhia, Origem, Destino, Tipo e Status em todos os transportes.";
    return null;
  }

  // =========================
  // Create process + transports
  // =========================
  function buildProcessPayload() {
    const companyId = String($("#company_id").val() || "").trim();
    const contactId = String($("#primary_contact_id").val() || "").trim();

    return {
      status: 0,
      company_id: companyId,
      primary_contact_id: contactId,
      invoice: String($("#invoice").val() || "").trim() || null,
      ship_date: toIsoZFromBr(document.getElementById("ship_date")?.value || "") || null,
      process_type_id: String($("#process_type_id").val() || "").trim() || null
    };
  }

  async function ensureProcessCreated() {
    if (state.processId) return state.processId;
    if (state.creating) return null;

    const payload = buildProcessPayload();
    if (!payload.company_id) throw new Error("Empresa é obrigatória.");
    if (!payload.primary_contact_id) throw new Error("Contato do Cliente é obrigatório.");

    state.creating = true;
    try {
      const created = await apiPost("/api/processes", payload);
      const id = created?.id ? String(created.id) : (created?.process_id ? String(created.process_id) : null);
      if (!id) throw new Error("Processo criado, mas não retornou ID.");
      state.processId = id;
      return id;
    } finally {
      state.creating = false;
    }
  }

  async function createTransportsForProcess(processId) {
    const rows = readTransportRows();
    for (const t of rows) {
      await apiPost("/api/transports", {
        transport_company: t.transport_company,
        origin: t.origin,
        destination: t.destination,
        contact_phone: t.contact_phone,
        transport_type_id: t.transport_type_id,
        transport_status_id: t.transport_status_id,
        departure_forecast: t.departure_forecast,
        arrival_forecast: t.arrival_forecast,
        process_id: processId
      });
    }
  }

  // =========================
  // Step 3 - Documents upload (MULTI up to 5)
  // =========================
  function showProcDocProgress(flag, pct, text) {
    $("#procDocUploadProgress").toggle(!!flag);
    if (pct != null) $("#procDocUploadProgressBar").css("width", String(Math.max(0, Math.min(100, pct))) + "%");
    if (text != null) $("#procDocUploadProgressText").text(String(text || ""));
  }

  function getExtFromName(fileName) {
    const n = String(fileName || "");
    const idx = n.lastIndexOf(".");
    if (idx <= 0 || idx >= n.length - 1) return null;
    return n.substring(idx + 1).toLowerCase();
  }

  function getFileKey(file) {
    const uuid = file?.upload?.uuid;
    if (uuid) return String(uuid);
    return `${String(file?.name || "file")}__${String(file?.size || 0)}__${String(file?.lastModified || 0)}`;
  }

  function defaultDisplayNameFor(file) {
    return String(file?.name || "").trim() || "Arquivo";
  }

  function showFilesList(flag) {
    $("#procDocFilesList").toggle(!!flag);
  }

  function addOrUpdateFileRow(file) {
    const key = getFileKey(file);
    if (state.procDocFilesUi.has(key)) return;

    showFilesList(true);

    const sizeMb = ((file?.size || 0) / (1024 * 1024)).toFixed(2);

    const row = document.createElement("div");
    row.className = "well well-sm proc-doc-row";
    row.setAttribute("data-file-key", key);

    row.innerHTML = `
      <div class="row" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="flex: 1 1 260px; min-width:220px;">
          <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
            ${escapeHtml(file?.name || "Arquivo")}
          </div>
          <div class="small text-muted">Tamanho: ${escapeHtml(sizeMb)} MB</div>
        </div>

        <div style="flex: 2 1 340px; min-width:260px;">
          <label class="small" style="margin:0 0 4px 0;">Nome do arquivo (no sistema)</label>
          <input type="text" class="form-control input-sm proc-doc-display" maxlength="255" value="${escapeHtml(defaultDisplayNameFor(file))}" />
        </div>
      </div>
    `;

    document.getElementById("procDocFilesListInner").appendChild(row);

    const $row = $(row);
    const $nameInput = $row.find("input.proc-doc-display");

    state.procDocFilesUi.set(key, { file, $row, $nameInput });
  }

  function removeFileRow(file) {
    const key = getFileKey(file);
    const entry = state.procDocFilesUi.get(key);
    if (entry?.$row?.length) entry.$row.remove();
    state.procDocFilesUi.delete(key);

    if (state.procDocFilesUi.size === 0) showFilesList(false);
  }

  function getSelectedProcDocFiles() {
    const dz = state.procDocDz;
    if (!dz || !Array.isArray(dz.files)) return [];
    return dz.files.filter(f => !f?.status || f.status !== "error");
  }

  function getDisplayNameForFile(file) {
    const key = getFileKey(file);
    const entry = state.procDocFilesUi.get(key);
    const perFileName = entry?.$nameInput?.length ? String(entry.$nameInput.val() || "").trim() : "";
    return perFileName || defaultDisplayNameFor(file);
  }

  async function getProcessById(processId) {
    const candidates = [
      `/api/processes/${encodeURIComponent(processId)}`,
      `/api/processes?id=${encodeURIComponent(processId)}`,
      `/api/processes/findById?id=${encodeURIComponent(processId)}`
    ];

    let lastErr = null;
    for (const url of candidates) {
      try {
        const data = await apiGet(url);
        if (data && typeof data === "object") {
          if (data.id || data.process_number) return data;
          if (data.data && (data.data.id || data.data.process_number)) return data.data;
          if (Array.isArray(data) && data[0]) return data[0];
        }
      } catch (e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error("Não foi possível obter os dados do processo.");
  }

  async function ensureProcessFolder(processId, accountId) {
    const process = await getProcessById(processId);
    const processNumber = String(process?.process_number || process?.processNumber || process?.number || "").trim();
    const folderName = processNumber || `Processo ${processId}`;

    const created = await apiPost("/api/documents", {
      account_id: accountId,
      parent_id: null,
      item_type: "FOLDER",
      name: folderName,
      filename: null,
      storage_provider: "NONE",
      related_table: "process",
      related_id: processId
    });

    const folderId = created?.id ? String(created.id) : null;
    if (!folderId) throw new Error("Pasta do processo criada, mas não retornou ID.");
    return { folderId, folderName };
  }

  async function uploadOneFileToDocumentsApi({ file, accountId, parentFolderId, relatedId, displayName }) {
    const fileName = file.name;
    const mimeType = file.type || "application/octet-stream";
    const ext = getExtFromName(fileName);

    const created = await apiPost("/api/documents", {
      account_id: accountId,
      parent_id: parentFolderId,
      item_type: "FILE",
      name: displayName,
      filename: fileName,
      ext: ext,
      mime_type: mimeType,
      related_table: "process",
      related_id: relatedId
    });

    const docId = created?.id ? String(created.id) : null;
    if (!docId) throw new Error("Falha ao criar registro do documento.");

    const presign = await apiPost("/api/documents/" + encodeURIComponent(docId) + "/presign-upload", {
      fileName: fileName,
      contentType: mimeType,
      size: file.size
    });

    const putUrl = presign?.url;
    const putHeaders = presign?.headers || { "Content-Type": mimeType };
    const objectKey = presign?.object_key || presign?.key || null;
    if (!putUrl) throw new Error("Não foi possível gerar a URL de upload.");

    const putRes = await fetch(putUrl, { method: "PUT", headers: putHeaders, body: file });
    if (!putRes.ok) {
      const t = await putRes.text().catch(() => "");
      throw new Error(("Upload falhou (" + putRes.status + "). " + (t || "")).trim());
    }

    const etag = putRes.headers.get("etag") || presign?.etag || null;

    await apiPost("/api/documents/" + encodeURIComponent(docId) + "/complete-upload", {
      upload_status: "UPLOADED",
      object_key: objectKey,
      etag: etag,
      mime_type: mimeType,
      size_bytes: file.size
    });

    return docId;
  }

  async function uploadDocumentsForProcessIfAny(processId) {
    const files = getSelectedProcDocFiles();
    if (!files.length) return;

    if (files.length > 5) throw new Error("Máximo 5 arquivos.");

    const accountId = getAccountIdForCreate();
    if (!accountId) throw new Error("Não foi possível identificar o account_id para anexar documentos.");

    showProcDocProgress(true, 2, "Criando pasta do processo...");
    const { folderId, folderName } = await ensureProcessFolder(processId, accountId);

    const total = files.length;
    let done = 0;

    for (const file of files) {
      done += 1;
      const displayName = getDisplayNameForFile(file);

      showProcDocProgress(true, Math.min(90, Math.round(((done - 1) / total) * 100)), `Enviando ${done}/${total}: ${file.name}`);
      await uploadOneFileToDocumentsApi({
        file,
        accountId,
        parentFolderId: folderId,
        relatedId: processId,
        displayName
      });

      showProcDocProgress(true, Math.min(95, Math.round((done / total) * 100)), `Concluído ${done}/${total} (pasta: ${folderName})`);
    }

    showProcDocProgress(true, 100, `Upload concluído (${total} arquivo(s)).`);
  }

  // ✅ Dropzone init (fix click + button)
  function initProcessDocumentsDropzone() {
    try {
      if (!window.Dropzone) return;
      if (state.__procDzInitialized) return;
      state.__procDzInitialized = true;

      const dz = new Dropzone("#dropzoneForm", {
        url: "/api/documents",
        autoProcessQueue: false,
        maxFilesize: 10, // MB per file
        maxFiles: 5,
        addRemoveLinks: true,
        parallelUploads: 1,
        uploadMultiple: false,

        // ✅ Most important: make clickable reliable in wizard
        clickable: ["#btnPickProcDocs", "#dropzoneForm"],

        // Prevent weird invisible overlay issues
        createImageThumbnails: false,

        dictDefaultMessage: "<strong>Arraste arquivos aqui</strong><br><span class='muted'>Máximo 5 arquivos.</span>",
      });

      state.procDocDz = dz;

      dz.on("addedfile", function (file) {
        const files = getSelectedProcDocFiles();
        if (files.length > 5) {
          dz.removeFile(file);
          alert("Máximo 5 arquivos.");
          return;
        }

        addOrUpdateFileRow(file);
        showProcDocProgress(false, 0, "");
      });

      dz.on("removedfile", function (file) {
        removeFileRow(file);
        showProcDocProgress(false, 0, "");
      });

      dz.on("error", function (_file, message) {
        console.warn("Dropzone error:", message);
      });

      // ✅ Extra: ensure button triggers file picker even if Dropzone click fails in some browsers
      $(document).off("click.gecom", "#btnPickProcDocs");
      $(document).on("click.gecom", "#btnPickProcDocs", function (e) {
        e.preventDefault();
        try {
          dz.hiddenFileInput && dz.hiddenFileInput.click();
        } catch (_) { /* ignore */ }
      });

    } catch (e) {
      console.warn("Dropzone not initialized.", e);
    }
  }

  // =========================
  // Wizard
  // =========================
  function installWizard() {
    $("#form").steps({
      bodyTag: "fieldset",

      onInit: function () {
        initDatePickers(document);

        initSelect2($("#company_id"), "Pesquisar empresa...", null);
        initSelect2($("#invoice"), "Selecionar...", null);
        initSelect2($("#process_type_id"), "Selecionar...", null);
        initSelect2($("#primary_contact_id"), "Selecionar...", null);

        setSelectDisabled("invoice", true);
        setSelectDisabled("primary_contact_id", true);
        document.getElementById("invoiceHelp").style.display = "block";
        document.getElementById("contactHelp").style.display = "block";

        addTransportRow();
      },

      onStepChanging: function (event, currentIndex, newIndex) {
        if (currentIndex > newIndex) return true;

        const form = $(this);
        if (currentIndex < newIndex) {
          $(".body:eq(" + newIndex + ") label.error", form).remove();
          $(".body:eq(" + newIndex + ") .error", form).removeClass("error");
        }

        form.validate().settings.ignore = ":disabled,:hidden";
        if (!form.valid()) return false;

        if (currentIndex === 1 && newIndex === 2) {
          const msg = validateTransportRows();
          if (msg) { alert(msg); return false; }
        }

        const files = getSelectedProcDocFiles();
        if (files.length > 5) { alert("Máximo 5 arquivos."); return false; }

        return true;
      },

      onStepChanged: function (event, currentIndex) {
        const currentBody = $(this).find(".body").eq(currentIndex);
        initDatePickers(currentBody);

        // ✅ keep typeahead aligned even when wizard changes layout
        initCountriesTypeahead(currentBody);
      },

      onFinishing: function () {
        const form = $(this);
        form.validate().settings.ignore = ":disabled";
        if (!form.valid()) return false;

        const msg = validateTransportRows();
        if (msg) { alert(msg); return false; }

        const files = getSelectedProcDocFiles();
        if (files.length > 5) { alert("Máximo 5 arquivos."); return false; }

        return true;
      },

      onFinished: async function () {
        try {
          const processId = await ensureProcessCreated();
          if (!processId) return;

          await createTransportsForProcess(processId);
          await uploadDocumentsForProcessIfAny(processId);

          window.location = `ProcessDetail?id=${encodeURIComponent(processId)}`;
        } catch (e) {
          console.error(e);
          alert(e?.message || "Falha ao criar processo/transportes/documentos.");
        }
      }
    }).validate({
      errorPlacement: function (error, element) {
        error.addClass("field-validation-error");
        const $formGroup = element.closest(".form-group");
        const $label = $formGroup.children("label").first();
        if ($label.length) { error.insertAfter($label); return; }
        error.insertAfter(element);
      }
    });
  }

  // =========================
  // Company change wiring
  // =========================
  function bindCompanyChangeOnce() {
    if (window.__bindCompanyChangeDone) return;
    window.__bindCompanyChangeDone = true;

    $(document).off("change.gecom", "#company_id");
    $(document).on("change.gecom", "#company_id", function () {
      const companyId = String($(this).val() || "").trim();
      onCompanyChanged(companyId);
    });
  }

  let __companyChangeSeq = 0;
  let __companyChangeInFlight = false;

  async function onCompanyChanged(companyId) {
    const seq = ++__companyChangeSeq;
    if (__companyChangeInFlight) return;
    __companyChangeInFlight = true;

    try {
      resetInvoicesSelect();
      resetContactsSelect();

      await loadInvoicesByCompany(companyId);
      loadUsersFromCompanyCache(companyId);

      if (seq !== __companyChangeSeq) return;

      initSelect2($("#invoice"), "Selecionar...", null);
      initSelect2($("#primary_contact_id"), "Selecionar...", null);
    } catch (e) {
      console.error(e);
      alert(e?.message || "Falha ao carregar dados da empresa.");
    } finally {
      __companyChangeInFlight = false;
    }
  }

  function resetInvoicesSelect() {
    const $ddl = $("#invoice");
    $ddl.empty().append(`<option value="">Selecionar...</option>`);
    setSelectDisabled("invoice", !String($("#company_id").val() || "").trim());
    const help = document.getElementById("invoiceHelp");
    if (help) help.style.display = String($("#company_id").val() || "").trim() ? "none" : "block";
  }

  function resetContactsSelect() {
    const $ddl = $("#primary_contact_id");
    $ddl.empty().append(`<option value="">Selecionar...</option>`);
    setSelectDisabled("primary_contact_id", !String($("#company_id").val() || "").trim());
    const help = document.getElementById("contactHelp");
    if (help) help.style.display = String($("#company_id").val() || "").trim() ? "none" : "block";
  }

  function loadUsersFromCompanyCache(companyId) {
    const $ddl = $("#primary_contact_id");
    $ddl.empty().append(`<option value="">Selecionar...</option>`);

    if (!companyId) {
      setSelectDisabled("primary_contact_id", true);
      const help = document.getElementById("contactHelp");
      if (help) help.style.display = "block";
      return;
    }

    const company = state.companiesById.get(companyId);
    const users = Array.isArray(company?.users) ? company.users : [];
    const filtered = users.filter(u => String(u?.status || "").toUpperCase() === "ACTIVE");

    filtered.forEach(u => {
      const id = String(u?.id || "").trim();
      const name = String(u?.full_name || "").trim();
      const phone = String(u?.phonenumber || "").trim();
      if (!id || !name) return;

      const label = phone ? `${name} (${phone})` : name;
      $ddl.append(`<option value="${escapeHtml(id)}">${escapeHtml(label)}</option>`);
    });

    setSelectDisabled("primary_contact_id", false);
    const help = document.getElementById("contactHelp");
    if (help) help.style.display = "none";
  }

  function bindAddTransportOnce() {
    if (window.__bindAddTransportDone) return;
    window.__bindAddTransportDone = true;

    $(document).off("click.gecom", "#btnAddTransport");
    $(document).on("click.gecom", "#btnAddTransport", function (e) {
      e.preventDefault();
      addTransportRow();
    });
  }

  // =========================
  // Boot
  // =========================
  pageLoad();
  async function pageLoad() {
    $("#pageName").text("Novo Processo");
    $("#subSecoundPageName").text("Novo Processo");
    $("#subpageName").text("Processos");
    $("#subpageName").attr("href", "Processos");
    $("#path").show();

    bindCompanyChangeOnce();
    bindAddTransportOnce();

    // ✅ Dropzone
    Dropzone.autoDiscover = false;
    initProcessDocumentsDropzone();

    const bootWarnings = [];

    try {
      await loadCompanies();
    } catch (e) {
      console.error(e);
      alert(e?.message || "Falha ao carregar empresas. Não é possível continuar.");
      return;
    }

    try { await loadProcessTypes(); } catch (e) { console.warn(e); bootWarnings.push("Não foi possível carregar os tipos de processo."); }
    try { await loadTransportTypes(); } catch (e) { console.warn(e); bootWarnings.push("Não foi possível carregar os tipos de transporte."); }
    try { await loadTransportStatuses(); } catch (e) { console.warn(e); bootWarnings.push("Não foi possível carregar os status de transporte."); }

    $("#invoice").empty().append(`<option value="">Selecionar...</option>`);
    $("#primary_contact_id").empty().append(`<option value="">Selecionar...</option>`);

    initDatePickers(document);
    initCountriesTypeahead(document);

    setSelectDisabled("invoice", true);
    setSelectDisabled("primary_contact_id", true);
    document.getElementById("invoiceHelp").style.display = "block";
    document.getElementById("contactHelp").style.display = "block";

    if (bootWarnings.length) {
      const warn = document.getElementById("transportWarning");
      if (warn) {
        warn.style.display = "block";
        warn.innerHTML = bootWarnings.map(x => `• ${escapeHtml(x)}`).join("<br>");
      }
    }

    if (!$.fn.steps) {
      console.error("jquery.steps plugin not loaded.");
      alert("Erro: plugin do assistente (steps) não foi carregado. Verifique os scripts da página.");
      return;
    }

    installWizard();
  }
})();
</script>
<% %>
