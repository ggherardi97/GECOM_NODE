<style>
  .ibox-title {
    padding: 15px 90px 20px 15px;
  }

  .table td,
  .table th {
    vertical-align: middle !important;
  }

  .money {
    font-family: monospace;
  }

  .clicker {
    cursor: pointer;
  }

  /* Better spacing (fix “grudados na linha”) */
  .form-group {
    margin-bottom: 14px;
  }

  .row-tight {
    margin-left: -8px;
    margin-right: -8px;
  }

  .row-tight>[class*="col-"] {
    padding-left: 8px;
    padding-right: 8px;
  }

  .panel-body {
    padding-top: 12px;
  }

  /* Dynamics-like layout helpers */
  .invoice-panel {
    min-height: 560px;
  }

  .lines-disabled {
    opacity: .55;
    pointer-events: none;
    user-select: none;
  }

  .lines-banner {
    display: none;
    margin-bottom: 10px;
  }

  .header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
  }

  .header-actions .left-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }

  .line-actions .btn {
    margin-right: 6px;
  }

  .small-muted {
    font-size: 12px;
    color: #777;
  }
</style>

<% contentFor('headerLink') %>
  <link href="../Assets/inspinia/css/plugins/iCheck/custom.css" rel="stylesheet">
  <link href="../Assets/inspinia/css/plugins/select2/select2.min.css" rel="stylesheet">
  <link href="../Assets/inspinia/css/plugins/select2/select2-bootstrap.min.css" rel="stylesheet">
  <% %>

    <div class="wrapper wrapper-content animated fadeInRight" style="margin-top: 0px;">
      <div class="row">
        <div class="col-lg-12">
          <div class="ibox">
            <div class="ibox-title">
              <h5>Criação de Fatura</h5>
              <div class="ibox-tools">
                <button type="button" class="btn btn-success" id="btnSaveInvoice">
                  <i class="fa fa-check"></i> Salvar fatura
                </button>
              </div>
            </div>

            <div class="ibox-content">
              <form id="form" action="#" onsubmit="return false;">

                <div class="row">

                  <!-- ===================== ESQUERDA: HEADER (col-lg-3) ===================== -->
                  <div class="col-lg-4">
                    <div class="panel panel-default invoice-panel">
                      <div class="panel-heading">
                        <strong>Cabeçalho da Fatura</strong>
                      </div>
                      <div class="panel-body">

                        <div class="form-group">
                          <label>Empresa *</label>
                          <!-- <input id="company_id" class="form-control" /> -->
                          <select id="company_id" class="form-control"></select>
                        </div>

                        <div class="form-group">
                          <label>Moeda *</label>
                          <select id="currency_id" class="form-control"></select>
                        </div>

                        <div class="form-group">
                          <label>Data da Cotação</label>
                          <input id="quote_at" type="datetime-local" class="form-control" />
                          <!-- <div class="small-muted" style="margin-top:4px;">(Opcional)</div> -->
                        </div>

                        <div class="row row-tight">
                          <div class="col-lg-7">
                            <div class="form-group">
                              <label>Status</label>
                              <select id="status" class="form-control">
                                <option value="0" selected>Ativo</option>
                                <option value="1">Expirado</option>
                                <option value="2">Faturado</option>
                                <option value="3">Pago</option>
                              </select>
                            </div>

                          </div>
                          <div class="col-lg-5">
                            <div class="form-group">
                              <label>Desconto %</label>
                              <input id="discount_percent" type="number" min="0" max="100" class="form-control"
                                value="0" readonly />
                              <div class="small-muted" style="margin-top:4px;">*A porcentagem será calculada sob o total
                                bruto (Subtotal)</div>
                            </div>
                            <div class="form-group" style="display: none;">
                              <label>Taxa de câmbio</label>
                              <input id="exchange_rate" type="text" class="form-control" value="1.00000000" />
                            </div>
                          </div>
                        </div>

                        <div class="row row-tight" style="display: none;">
                          <div class="col-xs-6">

                          </div>
                          <div class="col-xs-6">
                            <div class="form-group">
                              <label>Versão</label>
                              <input id="version" type="number" min="1" class="form-control" value="1" />
                            </div>
                          </div>
                        </div>

                        <div class="form-group">
                          <label>Observações</label>
                          <textarea id="notes" class="form-control" rows="3"></textarea>
                        </div>

                        <div class="form-group" style="display: none;">
                          <label>Termos</label>
                          <textarea id="terms" class="form-control" rows="3"></textarea>
                        </div>

                        <hr style="margin: 10px 0;">

                        <strong>Endereço de Cobrança</strong>

                        <div class="form-group" style="margin-top:10px;">
                          <label>Linha 1</label>
                          <input id="billing_address_line1" type="text" class="form-control" />
                        </div>

                        <div class="form-group">
                          <label>Linha 2</label>
                          <input id="billing_address_line2" type="text" class="form-control" />
                        </div>

                        <div class="row row-tight">
                          <div class="col-xs-6">
                            <div class="form-group">
                              <label>Cidade</label>
                              <input id="billing_address_city" type="text" class="form-control" />
                            </div>
                          </div>
                          <div class="col-xs-6">
                            <div class="form-group">
                              <label>Estado</label>
                              <input id="billing_address_state" type="text" class="form-control" />
                            </div>
                          </div>
                        </div>

                        <div class="row row-tight">
                          <div class="col-xs-6">
                            <div class="form-group">
                              <label>CEP</label>
                              <input id="billing_address_postal_code" type="text" class="form-control" />
                            </div>
                          </div>
                          <div class="col-xs-6">
                            <div class="form-group">
                              <label>País</label>
                              <input id="billing_address_country" type="text" class="form-control" />
                            </div>
                          </div>
                        </div>

                        <div class="m-t-sm">
                          <button type="button" class="btn btn-primary btn-block" id="btnSaveHeader">
                            <i class="fa fa-save"></i> Salvar cabeçalho
                          </button>
                        </div>

                      </div>
                    </div>
                  </div>

                  <!-- ===================== MEIO: LINES (col-lg-6) ===================== -->
                  <div class="col-lg-8">
                    <div class="panel panel-default invoice-panel">
                      <div class="panel-heading">
                        <div class="header-actions">
                          <div class="left-actions">
                            <button type="button" class="btn btn-primary" id="btnAddProduct" disabled="disabled">
                              <i class="fa fa-plus"></i> Adicionar produto
                            </button>

                            <button type="button" class="btn btn-white" id="btnAddManualLine" disabled="disabled">
                              <i class="fa fa-pencil"></i> Adicionar linha manual
                            </button>

                          </div>

                          <span class="text-muted">
                            ID da Fatura: <span id="uiInvoiceId">-</span>
                          </span>
                        </div>
                      </div>

                      <div class="panel-body">
                        <div id="invoiceNotCreatedBanner" class="alert alert-warning lines-banner">
                          Salve o cabeçalho da fatura para liberar as linhas.
                        </div>

                        <div id="linesArea" class="lines-disabled">
                          <div class="table-responsive">
                            <table class="table table-striped table-bordered" id="linesTable">
                              <thead>
                                <tr>
                                  <th style="width:55px;">#</th>
                                  <th>Produto</th>
                                  <th>Descrição</th>
                                  <th style="width:110px;">Unidade</th>
                                  <th style="width:120px;">Preço</th>
                                  <th style="width:90px;">Qtd</th>
                                  <th style="width:120px;">Imposto</th>
                                  <th style="width:140px;">Total linha</th>
                                  <th style="width:160px;">Ações</th>
                                </tr>
                              </thead>
                              <tbody id="linesTbody"></tbody>
                            </table>
                          </div>
                        </div>

                      </div>
                    </div>

                    <div class="panel panel-default invoice-panel">
                      <div class="panel-heading">
                        <strong>Totalizadores</strong>
                      </div>
                      <div class="panel-body">
                        <table class="table">
                          <tr>
                            <th>Subtotal</th>
                            <td class="text-right money" id="uiSubtotal">0.0000</td>
                          </tr>
                          <tr>
                            <th>Desconto</th>
                            <td class="text-right money" id="uiDiscount">0.0000</td>
                          </tr>
                          <tr>
                            <th>Impostos</th>
                            <td class="text-right money" id="uiTaxTotal">0.0000</td>
                          </tr>
                          <tr>
                            <th>Total</th>
                            <td class="text-right money" id="uiTotal">0.0000</td>
                          </tr>
                        </table>

                        <div class="help-block">
                          <small class="text-muted">Os totalizadores são calculados a partir das linhas.</small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- ===================== DIREITA: TOTALS (col-lg-3) ===================== -->
                  <div class="col-lg-3">

                  </div>

                </div>

              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="../Assets/inspinia/js/plugins/select2/select2.full.min.js"></script>
    <script src="../Assets/inspinia/js/plugins/select2/i18n/pt-BR.js"></script>

<% contentFor('scripts') %>
   <script>
  (function () {
    // =========================
    // State
    // =========================
    let invoiceId = null;
    let creatingInvoice = false;

    let companiesCache = [];
    let currenciesCache = [];
    let productsCache = [];
    let lines = [];

    // =========================
    // Utils
    // =========================
    function escapeHtml(value) {
      if (value == null) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function parseNumberSafe(value, fallback) {
      const raw = String(value ?? "").trim();
      if (!raw) return fallback ?? 0;

      const s = raw.replace(/\s+/g, "").replace(/[^\d,.\-]/g, "");

      if (s.includes(".") && s.includes(",")) {
        const normalized = s.replace(/\./g, "").replace(",", ".");
        const n = Number(normalized);
        return Number.isFinite(n) ? n : (fallback ?? 0);
      }

      if (s.includes(",") && !s.includes(".")) {
        const normalized = s.replace(",", ".");
        const n = Number(normalized);
        return Number.isFinite(n) ? n : (fallback ?? 0);
      }

      const n = Number(s);
      return Number.isFinite(n) ? n : (fallback ?? 0);
    }

    function money4(v) {
      return parseNumberSafe(v, 0).toFixed(4);
    }

    function clamp01(v) {
      const n = parseNumberSafe(v, 0);
      return Math.max(0, Math.min(1, n));
    }

    // =========================
    // Money mask (4 decimals)
    // =========================
    function bindMoneyMaskOnce(selector, decimals) {
      const $el = $(selector);
      if (!$el.length) return;
      if ($el.data("money-mask")) return;
      $el.data("money-mask", true);

      const d = Number.isFinite(decimals) ? decimals : 4;

      function normalize(val) {
        const raw = String(val ?? "").trim();
        if (!raw) return "";
        const cleaned = raw.replace(/[^\d,.\-]/g, "");
        if (cleaned.includes(".") && cleaned.includes(",")) {
          return cleaned.replace(/\./g, "").replace(",", ".");
        }
        if (cleaned.includes(",") && !cleaned.includes(".")) {
          return cleaned.replace(",", ".");
        }
        return cleaned;
      }

      $el.on("input", function () {
        $(this).val(normalize($(this).val()));
      });

      $el.on("blur", function () {
        const n = parseNumberSafe($(this).val(), 0);
        $(this).val(n.toFixed(d));
      });

      $el.on("focus", function () {
        const n = parseNumberSafe($(this).val(), 0);
        $(this).val(n.toFixed(d));
      });
    }

    // =========================
    // API helpers
    // =========================
    async function readJsonSafe(response) {
      const text = await response.text();
      if (!text) return {};
      try {
        return JSON.parse(text);
      } catch {
        return { message: text };
      }
    }

    async function apiGet(url) {
      const resp = await fetch(url, { method: "GET", headers: { Accept: "application/json" } });
      const data = await readJsonSafe(resp);
      if (!resp.ok) throw new Error(data?.message || "Falha na requisição.");
      return data;
    }

    async function apiPost(url, payload) {
      const resp = await fetch(url, {
        method: "POST",
        headers: { Accept: "application/json", "Content-Type": "application/json" },
        body: JSON.stringify(payload ?? {}),
      });
      const data = await readJsonSafe(resp);
      if (!resp.ok) throw new Error(data?.message || "Falha na requisição.");
      return data;
    }

    async function apiPatch(url, payload) {
      const resp = await fetch(url, {
        method: "PATCH",
        headers: { Accept: "application/json", "Content-Type": "application/json" },
        body: JSON.stringify(payload ?? {}),
      });
      const data = await readJsonSafe(resp);
      if (!resp.ok) throw new Error(data?.message || "Falha na requisição.");
      return data;
    }

    // =========================
    // Global dynamic modal (layout)
    // =========================
    function openSideModal({ title, bodyHtml, okText, cancelText, onOk, onCancel }) {
      const overlay = document.getElementById("dynamicModalOverlay");
      const modal = document.getElementById("dynamicModal");
      const titleEl = document.getElementById("dynamicModalTitle");
      const bodyEl = document.getElementById("dynamicModalBody");
      const btnClose = document.getElementById("dynamicModalCloseBtn");
      const btnCancel = document.getElementById("dynamicModalCancelBtn");
      const btnOk = document.getElementById("dynamicModalOkBtn");

      if (!overlay || !modal || !titleEl || !bodyEl || !btnClose || !btnCancel || !btnOk) {
        alert("Modal global não encontrado no layout.");
        return;
      }

      titleEl.textContent = title || "";
      bodyEl.innerHTML = bodyHtml || "";
      btnOk.textContent = okText || "OK";
      btnCancel.textContent = cancelText || "Cancelar";

      const close = () => {
        overlay.style.display = "none";
        modal.style.display = "none";
        btnOk.onclick = null;
        btnCancel.onclick = null;
        btnClose.onclick = null;
      };

      btnOk.onclick = async () => {
        const keepOpen = (typeof onOk === "function") ? await onOk() : false;
        if (!keepOpen) close();
      };

      btnCancel.onclick = () => {
        if (typeof onCancel === "function") onCancel();
        close();
      };

      btnClose.onclick = () => {
        if (typeof onCancel === "function") onCancel();
        close();
      };

      overlay.style.display = "block";
      modal.style.display = "block";
    }

    // =========================
    // Select2
    // =========================
    function initSelect2Company() {
      if (!window.jQuery || !$.fn.select2) return;
      const $el = $("#company_id");
      if (!$el.length) return;

      if ($el.data("select2")) $el.select2("destroy");

      $el.select2({
        width: "100%",
        theme: "bootstrap",
        placeholder: "Pesquisar empresa...",
        allowClear: true,
        minimumResultsForSearch: 0,
        language: "pt-BR",
      });
    }

    function initSelect2ProductInModal() {
      if (!window.jQuery || !$.fn.select2) return;
      const $el = $("#il_product_id");
      if (!$el.length) return;

      if ($el.data("select2")) $el.select2("destroy");

      $el.select2({
        width: "100%",
        theme: "bootstrap",
        placeholder: "Pesquisar produto...",
        allowClear: true,
        minimumResultsForSearch: 0,
        language: "pt-BR",
        dropdownParent: $("#dynamicModal"),
      });
    }

    // =========================
    // Load lists
    // =========================
    async function loadCompanies() {
      const data = await apiGet("/api/companies");
      const list = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? data?.companies ?? []);
      companiesCache = list
        .map((c) => ({
          id: String(c?.id || "").trim(),
          company_name: String(c?.company_name || c?.name || "").trim(),
        }))
        .filter((x) => x.id && x.company_name);

      const $ddl = $("#company_id");
      $ddl.empty().append(`<option value="">Selecionar...</option>`);
      companiesCache.forEach((c) => {
        $ddl.append(`<option value="${escapeHtml(c.id)}">${escapeHtml(c.company_name)}</option>`);
      });
    }

    async function loadCurrencies() {
      const data = await apiGet("/api/currencies");
      const list = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? data?.currencies ?? []);
      currenciesCache = list
        .map((c) => ({
          id: String(c?.id || "").trim(),
          name: String(c?.name || "").trim(),
          symbol: String(c?.symbol || ""),
          decimals: Number(c?.decimals ?? 2),
        }))
        .filter((x) => x.id && x.name);

      const $ddl = $("#currency_id");
      $ddl.empty().append(`<option value="">Selecionar...</option>`);
      currenciesCache.forEach((c) => {
        $ddl.append(`<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`);
      });
    }

    function toProductModel(p) {
      return {
        id: String(p?.id || "").trim(),
        name: String(p?.name || "").trim(),
        description: String(p?.description || "").trim(),
        unit: String(p?.unit || "").trim(),
        defaultUnitPrice: parseNumberSafe(p?.default_unit_price, 0),
        defaultTaxRate: clamp01(p?.default_tax_rate),
        isActive: !!p?.is_active,
      };
    }

    async function preloadProducts() {
      const currencyId = String($("#currency_id").val() || "").trim();
      if (!currencyId) {
        productsCache = [];
        return;
      }

      const qs = new URLSearchParams();
      qs.set("currency_id", currencyId);
      qs.set("is_active", "true");

      const data = await apiGet(`/api/products?${qs.toString()}`);
      const list = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? data?.products ?? []);
      productsCache = list.map(toProductModel).filter((p) => p.id && p.name);
    }

    function getProductById(productId) {
      const id = String(productId || "").trim();
      return productsCache.find((p) => p.id === id) || null;
    }

    // =========================
    // Company change: auto fill billing
    // =========================
    async function onCompanyChanged(companyId) {
      try {
        const id = String(companyId || "").trim();
        if (!id) return;

        const company = await apiGet(`/api/companies/${encodeURIComponent(id)}`);

        const street = String(company?.address_street || "").trim();
        const number = String(company?.address_number || "").trim();
        const line = String(company?.address_line || "").trim();
        const line1 = line || [street, number].filter(Boolean).join(", ");

        $("#billing_address_line1").val(line1);
        $("#billing_address_line2").val("");
        $("#billing_address_city").val(company?.address_city || "");
        $("#billing_address_state").val(company?.address_state || "");
        $("#billing_address_postal_code").val(company?.address_postalcode || "");
        $("#billing_address_country").val(company?.address_country || "");
      } catch (e) {
        console.error(e);
      }
    }

    $("#company_id").on("change", async function () {
      const companyId = String($(this).val() || "").trim();
      if (companyId) await onCompanyChanged(companyId);
    });

    // =========================
    // Header payloads
    // =========================
    function buildInvoiceHeaderPayload() {
      return {
        company_id: String($("#company_id").val() || "").trim() || null,
        currency_id: String($("#currency_id").val() || "").trim() || null,
        quote_at: $("#quote_at").val() || null,
        exchange_rate: $("#exchange_rate").val() || null,
        status: parseNumberSafe($("#status").val(), 0),
        discount_percent: parseNumberSafe($("#discount_percent").val(), 0),
        version: parseNumberSafe($("#version").val(), 1),
        notes: $("#notes").val() || "",
        terms: $("#terms").val() || "",
      };
    }

    function buildBillingPayload() {
      return {
        billing_address_line1: $("#billing_address_line1").val() || "",
        billing_address_line2: $("#billing_address_line2").val() || "",
        billing_address_city: $("#billing_address_city").val() || "",
        billing_address_state: $("#billing_address_state").val() || "",
        billing_address_postal_code: $("#billing_address_postal_code").val() || "",
        billing_address_country: $("#billing_address_country").val() || "",
      };
    }

    function buildLinesPayload() {
      return (lines || []).map((l) => ({
        product_id: l.product_id || null,
        description: l.description || "",
        unit: l.unit || "",
        unit_price: String(parseNumberSafe(l.unit_price, 0)),
        quantity: String(parseNumberSafe(l.quantity, 1)),
        tax_rate: String(clamp01(l.tax_rate)),
        discount_percent: parseInt(String(l.discount_percent ?? 0), 10) || 0,
      }));
    }

    // =========================
    // Create invoice header if needed
    // =========================
    async function createInvoiceIfNeeded() {
      if (invoiceId || creatingInvoice) return true;

      const payload = { ...buildInvoiceHeaderPayload(), ...buildBillingPayload(), lines: [] };

      if (!payload.company_id || !payload.currency_id) {
        alert("Empresa e Moeda são obrigatórios.");
        return false;
      }

      try {
        creatingInvoice = true;
        const created = await apiPost("/api/invoices", payload);
invoiceId = created?.id ? String(created.id) : null;

        $("#uiInvoiceId").text(invoiceId || "-");
        $("#invoiceNotCreatedBanner").hide();

        $("#discount_percent").prop("readonly", false);

        return !!invoiceId;
      } catch (e) {
        console.error(e);
        alert(e?.message || "Falha ao criar a fatura.");
        return false;
      } finally {
        creatingInvoice = false;
      }
    }

    function setLinesEnabled(isEnabled) {
      const area = document.getElementById("linesArea");
      if (!area) return;
      if (isEnabled) area.classList.remove("lines-disabled");
      else area.classList.add("lines-disabled");
    }

    // =========================
    // Calc line + totals
    // =========================
    function recalcLine(line) {
      const qty = parseNumberSafe(line.quantity, 1);
      const unitPrice = parseNumberSafe(line.unit_price, 0);
      const taxRate = clamp01(line.tax_rate);
      const discountPercent = Math.max(0, Math.min(100, parseNumberSafe(line.discount_percent, 0)));

      const gross = qty * unitPrice;
      const discountAmount = gross * (discountPercent / 100);
      const taxableBase = Math.max(0, gross - discountAmount);
      const taxAmount = taxableBase * taxRate;
      const lineTotal = taxableBase + taxAmount;

      line.quantity = qty;
      line.unit_price = unitPrice;
      line.tax_rate = taxRate;
      line.discount_percent = discountPercent;

      line.line_subtotal = gross;
      line.discount_amount = discountAmount;
      line.tax_amount = taxAmount;
      line.line_total = lineTotal;

      return line;
    }

    function computeTotals() {
      // Always recalc lines first (keeps totals stable)
      (lines || []).forEach(recalcLine);

      let grossSubtotal = 0;
      let taxTotal = 0;
      let lineDiscountTotal = 0;

      for (const l of (lines || [])) {
        grossSubtotal += parseNumberSafe(l.line_subtotal, 0);
        taxTotal += parseNumberSafe(l.tax_amount, 0);
        lineDiscountTotal += parseNumberSafe(l.discount_amount, 0);
      }

      const headerDiscountPercent = Math.max(0, Math.min(100, parseNumberSafe($("#discount_percent").val(), 0)));
      const headerDiscountAmount = grossSubtotal * (headerDiscountPercent / 100);

      const netBeforeHeader = Math.max(0, grossSubtotal - lineDiscountTotal);
      const total = Math.max(0, (netBeforeHeader - headerDiscountAmount) + taxTotal);

      $("#uiSubtotal").text(money4(grossSubtotal));
      $("#uiDiscount").text(money4(headerDiscountAmount));
      $("#uiTaxTotal").text(money4(taxTotal));
      $("#uiTotal").text(money4(total));
    }

    $("#discount_percent").on("keyup change input", computeTotals);

    // =========================
    // Render grid
    // =========================
    function renderLines() {
      const tbody = document.getElementById("linesTbody");
      if (!tbody) return;

      tbody.innerHTML = "";

      (lines || []).forEach(recalcLine);

      if (!lines || lines.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">Nenhuma linha adicionada</td></tr>`;
        computeTotals();
        return;
      }

      lines.forEach((l, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(String(idx + 1))}</td>
          <td>${escapeHtml(l.product_name || "Manual")}</td>
          <td>${escapeHtml(l.description || "")}</td>
          <td>${escapeHtml(l.unit || "")}</td>
          <td class="text-right">${money4(l.unit_price || 0)}</td>
          <td class="text-right">${money4(l.quantity || 0)}</td>
          <td class="text-right">${money4(l.tax_amount || 0)}</td>
          <td class="text-right">${money4(l.line_total || 0)}</td>
          <td>
            <button type="button" class="btn btn-white btn-xs" data-act="edit" data-idx="${idx}">
              <i class="fa fa-pencil"></i> Editar
            </button>
            <button type="button" class="btn btn-danger btn-xs" data-act="del" data-idx="${idx}">
              <i class="fa fa-trash"></i> Excluir
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("button[data-act]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-act");
          const idx = parseInt(btn.getAttribute("data-idx"), 10);
          if (!Number.isFinite(idx)) return;

          if (act === "del") {
            lines.splice(idx, 1);
            renderLines();
          }

          if (act === "edit") {
              openInvoiceLineModal({ mode: "edit", index: idx, requireProduct: false });
          }
        });
      });

      computeTotals();
    }

    // =========================
    // Modal (Add/Edit line)
    // =========================
    function setupProductSelectOptions(existingProductId) {
      const $productEl = $("#il_product_id");
      if (!$productEl.length) return;

      $productEl.empty().append(`<option value="">Selecionar...</option>`);
      (productsCache || []).forEach((p) => {
        $productEl.append(`<option value="${escapeHtml(p.id)}">${escapeHtml(p.name)}</option>`);
      });

      if (existingProductId) {
        $productEl.val(String(existingProductId)).trigger("change.select2");
      }
    }

    function applyProductDefaultsToInputs(product) {
      if (!product) return;

      $("#il_unit").val(product.unit || "");
      if (!String($("#il_description").val() || "").trim()) {
        $("#il_description").val(product.description || "");
      }

      $("#il_unit_price").val(parseNumberSafe(product.defaultUnitPrice, 0).toFixed(4));
      $("#il_tax_rate").val(clamp01(product.defaultTaxRate).toFixed(4));
    }

    function openInvoiceLineModal({ mode, index, requireProduct  }) {
      const isEdit = mode === "edit";
      const existing = isEdit ? (lines[index] || null) : null;

      const line = existing
        ? { ...existing }
        : {
            product_id: null,
            product_name: "",
            description: "",
            unit: "",
            unit_price: 0,
            quantity: 1,
            tax_rate: 0,
            discount_percent: 0,
            tax_amount: 0,
            discount_amount: 0,
            line_subtotal: 0,
            line_total: 0,
          };

      recalcLine(line);

      const bodyHtml = `
        <div class="form-group">
          <label>Produto</label>
          <select id="il_product_id" class="form-control"></select>
          <div class="small text-muted" style="margin-top:6px;">Digite para pesquisar.</div>
        </div>

        <div class="form-group">
          <label>Descrição</label>
          <input id="il_description" type="text" class="form-control" value="${escapeHtml(line.description || "")}" />
        </div>

        <div class="row row-tight">
          <div class="col-xs-6">
            <div class="form-group">
              <label>Unidade</label>
              <input id="il_unit" type="text" class="form-control" maxlength="50" value="${escapeHtml(line.unit || "")}" />
            </div>
          </div>
          <div class="col-xs-6">
            <div class="form-group">
              <label>Preço unitário</label>
              <input id="il_unit_price" type="text" class="form-control money" value="${escapeHtml(money4(line.unit_price || 0))}" />
            </div>
          </div>
        </div>

        <div class="row row-tight">
          <div class="col-xs-6">
            <div class="form-group">
              <label>Quantidade</label>
              <input id="il_quantity" type="text" class="form-control money" value="${escapeHtml(money4(line.quantity || 1))}" />
            </div>
          </div>
          <div class="col-xs-6">
            <div class="form-group">
              <label>Taxa de imposto (0..1)</label>
              <input id="il_tax_rate" type="text" class="form-control money" value="${escapeHtml(money4(clamp01(line.tax_rate))) }" />
            </div>
          </div>
        </div>

        <div class="row row-tight">
          <div class="col-xs-6">
            <div class="form-group">
              <label>Desconto % (linha)</label>
              <input id="il_discount_percent" type="number" min="0" max="100" class="form-control" value="${escapeHtml(String(line.discount_percent || 0))}" />
            </div>
          </div>
          <div class="col-xs-6">
            <div class="form-group">
              <label>Total da linha</label>
              <input id="il_line_total" type="text" class="form-control" value="${escapeHtml(money4(line.line_total))}" readonly />
            </div>
          </div>
        </div>

        <div class="small text-muted">Subtotal/Imposto/Total são calculados automaticamente.</div>
      `;

      openSideModal({
        title: isEdit ? "Editar linha" : "Adicionar linha",
        bodyHtml: bodyHtml,
        okText: isEdit ? "Salvar" : "Adicionar",
        cancelText: "Cancelar",
        onOk: async () => {
  const productId = String($("#il_product_id").val() || "").trim() || null;

  // Se veio do botão "Adicionar produto", obriga seleção real no Select2
  if (requireProduct && !productId) {
    alert("Selecione um produto na lista (digitar não basta).");
    return true; // mantém modal aberto
  }

  const prod = productId ? getProductById(productId) : null;

  const updated = {
    ...line,
    product_id: productId,
    product_name: prod?.name || (productId ? productId : "Manual"),
    description: $("#il_description").val() || "",
    unit: $("#il_unit").val() || "",
    unit_price: parseNumberSafe($("#il_unit_price").val(), 0),
    quantity: parseNumberSafe($("#il_quantity").val(), 1),
    tax_rate: clamp01($("#il_tax_rate").val()),
    discount_percent: parseNumberSafe($("#il_discount_percent").val(), 0),
  };

  // Se selecionou produto, mas inputs ainda estão vazios, aplica defaults também no OK
  if (prod) {
    if (!String(updated.unit || "").trim()) updated.unit = prod.unit || "";
    if (!String(updated.description || "").trim()) updated.description = prod.description || "";
    if (!parseNumberSafe(updated.unit_price, 0)) updated.unit_price = parseNumberSafe(prod.defaultUnitPrice, 0);
    if (!parseNumberSafe(updated.tax_rate, 0)) updated.tax_rate = clamp01(prod.defaultTaxRate);
  }

  recalcLine(updated);

  if (parseNumberSafe(updated.quantity, 0) <= 0) {
    alert("Quantidade deve ser maior que 0.");
    return true; // mantém modal aberto
  }

  if (isEdit) lines[index] = updated;
  else lines.push(updated);

  renderLines();
  return false; // fecha modal
},
      });

      setTimeout(() => {
        // Masks
        bindMoneyMaskOnce("#il_unit_price", 4);
        bindMoneyMaskOnce("#il_quantity", 4);
        bindMoneyMaskOnce("#il_tax_rate", 4);

        // Fill products select + init select2
        setupProductSelectOptions(isEdit ? existing?.product_id : null);
        initSelect2ProductInModal();

        // On product change: apply defaults ONLY when adding
        $("#il_product_id")
          .off("change.__prod")
          .on("change.__prod", function () {
            const pid = String($(this).val() || "").trim();
            const p = pid ? getProductById(pid) : null;
            if (!p) {
              syncModalCalc();
              return;
            }

            if (!isEdit) {
              applyProductDefaultsToInputs(p);
            } else {
              // Edit: do not overwrite price/tax (only fill unit/desc if empty)
              if (!String($("#il_unit").val() || "").trim()) $("#il_unit").val(p.unit || "");
              if (!String($("#il_description").val() || "").trim()) $("#il_description").val(p.description || "");
            }

            syncModalCalc();
          });

        // If editing: force inputs to existing line values
        if (isEdit && existing) {
          $("#il_description").val(existing.description || "");
          $("#il_unit").val(existing.unit || "");
          $("#il_unit_price").val(parseNumberSafe(existing.unit_price, 0).toFixed(4));
          $("#il_quantity").val(parseNumberSafe(existing.quantity, 1).toFixed(4));
          $("#il_tax_rate").val(clamp01(existing.tax_rate).toFixed(4));
          $("#il_discount_percent").val(parseNumberSafe(existing.discount_percent, 0));
        }

        function syncModalCalc() {
          const tmp = {
            ...line,
            unit_price: parseNumberSafe($("#il_unit_price").val(), 0),
            quantity: parseNumberSafe($("#il_quantity").val(), 1),
            tax_rate: clamp01($("#il_tax_rate").val()),
            discount_percent: parseNumberSafe($("#il_discount_percent").val(), 0),
            description: $("#il_description").val() || "",
            unit: $("#il_unit").val() || "",
          };
          recalcLine(tmp);
          $("#il_line_total").val(money4(tmp.line_total));
        }

        $("#il_description, #il_unit, #il_unit_price, #il_quantity, #il_tax_rate, #il_discount_percent")
          .off("keyup.__il change.__il input.__il")
          .on("keyup.__il change.__il input.__il", syncModalCalc);

        syncModalCalc();
      }, 50);
    }

    // =========================
    // Save logic
    // =========================
    async function saveInvoice() {
      const ok = await createInvoiceIfNeeded();
      if (!ok) {
        $("#invoiceNotCreatedBanner").show();
        setLinesEnabled(false);
        return false;
      }

      setLinesEnabled(true);
      $("#invoiceNotCreatedBanner").hide();
      $("#btnAddManualLine").prop("disabled", false);
      $("#btnAddProduct").prop("disabled", false);

      const headerPayload = { ...buildInvoiceHeaderPayload(), ...buildBillingPayload() };

      try {
        if (!lines || lines.length === 0) {
          await apiPatch(`/api/invoices/${encodeURIComponent(invoiceId)}`, headerPayload);
          alert("Cabeçalho salvo com sucesso.");
          return true;
        }

        const payload = { ...headerPayload, lines: buildLinesPayload() };
        await apiPatch(`/api/invoices/${encodeURIComponent(invoiceId)}`, payload);

        alert("Fatura salva com sucesso.");
        return true;
      } catch (e) {
        console.error(e);
        alert(e?.message || "Falha ao salvar a fatura.");
        return false;
      }
    }

    // =========================
    // Buttons / events
    // =========================
    $("#btnAddProduct").on("click", async function () {
  const ok = await createInvoiceIfNeeded();
  if (!ok) return;

  setLinesEnabled(true);
  $("#invoiceNotCreatedBanner").hide();

  try {
    await preloadProducts();
  } catch (e) {
    console.error(e);
    productsCache = [];
  }

  // Produto obrigatório
  openInvoiceLineModal({ mode: "add", requireProduct: true });
});

$("#btnAddManualLine").on("click", async function () {
  const ok = await createInvoiceIfNeeded();
  if (!ok) return;

  setLinesEnabled(true);
  $("#invoiceNotCreatedBanner").hide();

  // Produto opcional (linha manual)
  openInvoiceLineModal({ mode: "add", requireProduct: false });
});


    $("#btnSaveHeader").on("click", async function () {
      const ok = await createInvoiceIfNeeded();
      if (!ok) {
        $("#invoiceNotCreatedBanner").show();
        setLinesEnabled(false);
        return;
      }

      setLinesEnabled(true);
      $("#invoiceNotCreatedBanner").hide();
      $("#btnAddManualLine").prop("disabled", false);
      $("#btnAddProduct").prop("disabled", false);

      alert("Cabeçalho salvo com sucesso.");
      renderLines();
    });

    $("#btnSaveInvoice").on("click", async function () {
      await saveInvoice();
    });

    $("#currency_id").on("change", async function () {
      try {
        await preloadProducts();
      } catch (e) {
        console.error(e);
        productsCache = [];
      }
    });

    // =========================
    // Init
    // =========================
    (async function init() {
      try {
        if ($("#pageName").length) {
          $("#pageName").text("Faturas");
          $("#subpageName").text("Faturas");
          $("#path").show();
          $("#subSecoundPageName").text("Formulários");
          $("#subpath").show();
          $("#subpathName").text("Nova Fatura");
        }

        await Promise.all([loadCompanies(), loadCurrencies()]);
        await preloadProducts();

        initSelect2Company();

        $("#uiInvoiceId").text("-");
        $("#invoiceNotCreatedBanner").show();
        setLinesEnabled(false);

        $("#btnAddManualLine").prop("disabled", true);
        $("#btnAddProduct").prop("disabled", true);

        renderLines();
      } catch (e) {
        console.error(e);
        alert("Falha ao carregar dados iniciais.");
      }
    })();
  })();
</script>

<% %>