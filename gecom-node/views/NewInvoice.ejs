<style>
  b, strong { font-weight: bolder; color: #808080; }

  .ibox-title h5 {
    display: inline-block;
    font-size: 18px;
    margin: 0 0 0px;
    padding: 0px 10px;
    text-overflow: ellipsis;
    float: none;
    font-weight: 500;
  }

  .ibox-title { padding: 20px 90px 20px 15px; }

  .table td, .table th { vertical-align: middle !important; }

  .money { font-family: monospace; }
  .clicker { cursor: pointer; }

  .form-group { margin-bottom: 14px; }

  .row-tight { margin-left: -8px; margin-right: -8px; }
  .row-tight>[class*="col-"] { padding-left: 8px; padding-right: 8px; }

  .panel-body { padding-top: 12px; }

  .invoice-panel { min-height: 560px; }

  .lines-disabled { opacity: .55; pointer-events: none; user-select: none; }
  .lines-banner { display: none; margin-bottom: 10px; }

  .header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
  }

  .header-actions .left-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }

  .line-actions .btn { margin-right: 6px; }

  .small-muted { font-size: 12px; color: #777; }

  .typeahead.dropdown-menu { max-height: 260px; overflow-y: auto; }
</style>

<% contentFor('headerLink') %>
<link href="../Assets/inspinia/css/plugins/iCheck/custom.css" rel="stylesheet">
<% %>

<div class="wrapper wrapper-content animated fadeInRight" style="margin-top: 0px;">
  <div class="row">
    <div class="col-lg-12">
      <div class="ibox">
        <div class="ibox-title">
          <h5 id="invoiceTitle">-</h5>
          <div class="ibox-tools">
            <button type="button" class="btn btn-white" id="btnGenerateInvoicePrint" disabled>
              <i class="fa fa-file-pdf-o"></i> <%= t('page.newInvoice.actions.generateInvoice') %>
            </button>

            <button type="button" class="btn btn-danger" id="btnDeleteInvoice" disabled>
              <i class="fa fa-trash"></i> <%= t('page.newInvoice.actions.deleteInvoice') %>
            </button>

            <button type="button" class="btn btn-success" id="btnSaveInvoice">
              <i class="fa fa-check"></i> <%= t('page.newInvoice.actions.saveInvoice') %>
            </button>
          </div>
        </div>

        <div class="ibox-content">
          <form id="form" action="#" onsubmit="return false;">
            <div class="row">

              <!-- ===================== ESQUERDA: HEADER ===================== -->
              <div class="col-lg-4">
                <div class="panel panel-default invoice-panel">
                  <div class="panel-heading">
                    <strong><%= t('page.newInvoice.form.invoiceDataTitle') %></strong>
                  </div>
                  <div class="panel-body">

                    <div class="form-group">
                      <label><%= t('page.newInvoice.form.company') %></label>
                      <input
                        id="company_name"
                        type="text"
                        class="form-control typeahead-company"
                        placeholder="<%= t('page.newInvoice.placeholders.searchCompany') %>"
                        autocomplete="off"
                      />
                      <input id="company_id" type="hidden" />
                    </div>

                    <div class="row">
                      <div class="col-lg-6">
                        <div class="form-group">
                          <label><%= t('page.newInvoice.form.currency') %></label>
                          <select id="currency_id" class="form-control"></select>
                        </div>
                      </div>

                      <div class="col-lg-6">
                         <div class="form-group">
                          <label><%= t('page.newInvoice.form.status') %></label>
                          <select id="status" class="form-control">
                            <option value="0" selected><%= t('page.newInvoice.form.statusDraft') %></option>
                            <option value="1"><%= t('page.newInvoice.form.statusActive') %></option>
                            <option value="2"><%= t('page.newInvoice.form.statusExpired') %></option>
                            <option value="3"><%= t('page.newInvoice.form.statusBilled') %></option>
                            <option value="4"><%= t('page.newInvoice.form.statusPaid') %></option>
                          </select>
                        </div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-lg-6">
                       <div class="form-group">
                          <label><%= t('page.newInvoice.form.quoteDate') %></label>
                          <input id="quote_at" type="datetime-local" class="form-control" />
                        </div>
                      </div>

                      <div class="col-lg-6">
                        <div class="form-group">
                          <label><%= t('page.newInvoice.form.dueDate') %></label>
                          <input id="due_at" type="date" class="form-control" />
                        </div>

                        <div class="form-group" style="display:none;">
                          <label><%= t('page.newInvoice.form.exchangeRate') %></label>
                          <input id="exchange_rate" type="text" class="form-control" value="1.00000000" />
                        </div>
                      </div>
                    </div>

                    <!-- ✅ NOVO CAMPO: due_at -->
                    <div class="row">
                      <div class="col-lg-6">
                        <div class="form-group">
                          <label><%= t('page.newInvoice.form.discountPercent') %></label>
                          <input id="discount_percent" type="number" min="0" max="100" class="form-control" value="0" readonly />
                          <div class="small-muted" style="margin-top:4px;">
                            <%= t('page.newInvoice.hints.discountRule') %>
                          </div>
                        </div>
                      </div>
                      <div class="col-lg-6"></div>
                    </div>

                    <div class="row row-tight" style="display:none;">
                      <div class="col-lg-6"></div>
                      <div class="col-lg-6">
                        <div class="form-group">
                          <label><%= t('page.newInvoice.form.version') %></label>
                          <input id="version" type="number" min="1" class="form-control" value="1" />
                        </div>
                      </div>
                    </div>

                    <div class="form-group">
                      <label><%= t('page.newInvoice.form.notes') %></label>
                      <textarea id="notes" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="form-group" style="display:none;">
                      <label><%= t('page.newInvoice.form.terms') %></label>
                      <textarea id="terms" class="form-control" rows="3"></textarea>
                    </div>

                  </div>
                </div>

                <div class="panel panel-default invoice-panel">
                  <div class="panel-heading">
                    <strong><%= t('page.newInvoice.form.billingAddress') %></strong>
                  </div>
                  <div class="panel-body">

                    <div class="form-group" style="margin-top:10px;">
                      <label><%= t('page.newInvoice.form.addressLine1') %></label>
                      <input id="billing_address_line1" type="text" class="form-control" />
                    </div>

                    <div class="form-group">
                      <label><%= t('page.newInvoice.form.addressLine2') %></label>
                      <input id="billing_address_line2" type="text" class="form-control" />
                    </div>

                    <div class="row row-tight">
                      <div class="col-lg-6">
                        <div class="form-group">
                          <label><%= t('page.newInvoice.form.city') %></label>
                          <input id="billing_address_city" type="text" class="form-control" />
                        </div>
                      </div>
                      <div class="col-lg-6">
                        <div class="form-group">
                          <label><%= t('page.newInvoice.form.state') %></label>
                          <input id="billing_address_state" type="text" class="form-control" />
                        </div>
                      </div>
                    </div>

                    <div class="row row-tight">
                      <div class="col-lg-6">
                        <div class="form-group">
                          <label><%= t('page.newInvoice.form.postalCode') %></label>
                          <input id="billing_address_postal_code" type="text" class="form-control" />
                        </div>
                      </div>
                      <div class="col-lg-6">
                        <div class="form-group">
                          <label><%= t('page.newInvoice.form.country') %></label>
                          <input id="billing_address_country" type="text" class="form-control" />
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>

              <!-- ===================== DIREITA: LINES ===================== -->
              <div class="col-lg-8">
                <div class="panel panel-default invoice-panel">
                  <div class="panel-heading">
                    <div class="header-actions">
                      <div class="left-actions">
                        <button type="button" class="btn btn-primary" id="btnAddProduct" disabled="disabled">
                          <i class="fa fa-plus"></i> <%= t('page.newInvoice.lines.addProduct') %>
                        </button>

                        <button type="button" class="btn btn-white" id="btnAddManualLine" disabled="disabled">
                          <i class="fa fa-pencil"></i> <%= t('page.newInvoice.lines.addManualLine') %>
                        </button>
                      </div>

                      <span class="text-muted">
                        <%= t('page.newInvoice.labels.invoiceId') %>: <span id="uiInvoiceId">-</span>
                      </span>
                    </div>
                  </div>

                  <div class="panel-body">
                    <div id="invoiceNotCreatedBanner" class="alert alert-warning lines-banner">
                      <%= t('page.newInvoice.hints.saveHeaderToUnlockLines') %>
                    </div>

                    <div id="linesArea" class="lines-disabled">
                      <div class="table-responsive">
                        <table class="table table-striped table-bordered" id="linesTable">
                          <thead>
                            <tr>
                              <th style="width: 30px;">#</th>
                              <th style="width: 28%;"><%= t('page.newInvoice.lines.columns.product') %></th>
                              <th style="width:110px;"><%= t('page.newInvoice.lines.columns.unit') %></th>
                              <th style="width:130px;"><%= t('page.newInvoice.lines.columns.price') %></th>
                              <th style="width:90px;"><%= t('page.newInvoice.lines.columns.quantity') %></th>
                              <th style="width:140px;"><%= t('page.newInvoice.lines.columns.discount') %></th>
                              <th style="width:120px;"><%= t('page.newInvoice.lines.columns.tax') %></th>
                              <th style="width:140px;"><%= t('page.newInvoice.lines.columns.lineTotal') %></th>
                              <th style="width: 8%;"><%= t('page.newInvoice.lines.actions') %></th>
                            </tr>
                          </thead>
                          <tbody id="linesTbody"></tbody>
                        </table>
                      </div>
                    </div>

                  </div>
                </div>

                <div class="panel panel-default invoice-panel">
                  <div class="panel-heading">
                    <strong><%= t('page.newInvoice.totals.title') %></strong>
                  </div>
                  <div class="panel-body">
                    <table class="table">
                      <tr>
                        <th><%= t('page.newInvoice.totals.subtotal') %></th>
                        <td class="text-right money" id="uiSubtotal">0,00</td>
                      </tr>
                      <tr>
                        <th><%= t('page.newInvoice.form.headerDiscount') %></th>
                        <td class="text-right money" id="uiDiscountHeader">0,00</td>
                      </tr>
                      <tr>
                        <th><%= t('page.newInvoice.totals.linesDiscount') %></th>
                        <td class="text-right money" id="uiDiscountLines">0,00</td>
                      </tr>
                      <tr>
                        <th><%= t('page.newInvoice.totals.taxes') %></th>
                        <td class="text-right money" id="uiTaxTotal">0,00</td>
                      </tr>
                      <tr>
                        <th><%= t('page.newInvoice.totals.total') %></th>
                        <td class="text-right money" id="uiTotal">0,00</td>
                      </tr>
                    </table>

                    <div class="help-block">
                      <small class="text-muted"><%= t('page.newInvoice.hints.totalsFromLines') %></small>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-lg-3"></div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<% contentFor('scripts') %>
<script src="/Assets/inspinia/js/plugins/typehead/bootstrap3-typeahead.min.js"></script>

<script>
  (function () {
    // =========================
    // i18n helper
    // =========================
    function tSafe(key, fallback) {
      try {
        if (typeof window.t === "function") return window.t(key);
        if (typeof t === "function") return t(key);
      } catch { /* ignore */ }
      return fallback ?? key;
    }

    // =========================
    // State
    // =========================
    let invoiceId = null;
    let creatingInvoice = false;

    let companiesCache = [];
    let currenciesCache = [];
    let productsCache = [];
    let lines = [];

    let suppressCompanyClear = false;

    function setPrintEnabled() {
      $("#btnGenerateInvoicePrint").prop("disabled", !invoiceId);
      $("#btnDeleteInvoice").prop("disabled", !invoiceId);
    }

    // =========================
    // Utils
    // =========================
    function escapeHtml(value) {
      if (value == null) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function normalizeText(value) {
      return String(value || "")
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    }

    function parseNumberSafe(value, fallback) {
      const raw = String(value ?? "").trim();
      if (!raw) return fallback ?? 0;

      const s = raw.replace(/\s+/g, "").replace(/[^\d,.\-]/g, "");

      if (s.includes(".") && s.includes(",")) {
        const normalized = s.replace(/\./g, "").replace(",", ".");
        const n = Number(normalized);
        return Number.isFinite(n) ? n : (fallback ?? 0);
      }

      if (s.includes(",") && !s.includes(".")) {
        const normalized = s.replace(",", ".");
        const n = Number(normalized);
        return Number.isFinite(n) ? n : (fallback ?? 0);
      }

      const n = Number(s);
      return Number.isFinite(n) ? n : (fallback ?? 0);
    }

    function toIntSafe(value, fallback) {
      const n = parseInt(String(value ?? "").trim(), 10);
      return Number.isFinite(n) ? n : (fallback ?? 0);
    }

    function clamp01(v) {
      const n = parseNumberSafe(v, 0);
      return Math.max(0, Math.min(1, n));
    }

    function tryToDatetimeLocal(value) {
      const raw = String(value ?? "").trim();
      if (!raw) return "";
      const dt = new Date(raw);
      if (Number.isNaN(dt.getTime())) return "";
      const pad = (n) => String(n).padStart(2, "0");
      return (
        dt.getFullYear() + "-" +
        pad(dt.getMonth() + 1) + "-" +
        pad(dt.getDate()) + "T" +
        pad(dt.getHours()) + ":" +
        pad(dt.getMinutes())
      );
    }

    function tryToDateInput(value) {
      const raw = String(value ?? "").trim();
      if (!raw) return "";

      const dt = new Date(raw);
      if (Number.isNaN(dt.getTime())) return "";

      const pad = (n) => String(n).padStart(2, "0");

      // Use UTC to avoid timezone shifting the day
      return (
        dt.getUTCFullYear() + "-" +
        pad(dt.getUTCMonth() + 1) + "-" +
        pad(dt.getUTCDate())
      );
    }

    function getSelectedCurrency() {
      const currencyId = String($("#currency_id").val() || "").trim();
      if (!currencyId) return null;
      return (currenciesCache || []).find(c => String(c.id) === currencyId) || null;
    }

    function resolveCurrencyCode(cur) {
      if (!cur) return null;
      const code = String(cur.code || cur.iso_code || cur.currency_code || "").trim();
      if (code) return code;

      const sym = String(cur.symbol || "").trim();
      if (sym === "R$") return "BRL";
      if (sym === "$") return "USD";
      if (sym === "€") return "EUR";

      return null;
    }

    function formatMoney(value) {
      const cur = getSelectedCurrency();
      const code = resolveCurrencyCode(cur);
      const decimals = Number.isFinite(cur?.decimals) ? cur.decimals : 2;

      const n = parseNumberSafe(value, 0);

      try {
        if (code) {
          return new Intl.NumberFormat("pt-BR", {
            style: "currency",
            currency: code,
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
          }).format(n);
        }
      } catch (e) { /* ignore */ }

      // fallback: pt-BR number + symbol
      const sym = String(cur?.symbol || "").trim();
      const num = new Intl.NumberFormat("pt-BR", {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      }).format(n);

      return sym ? (sym + " " + num) : num;
    }

    // =========================
    // Money mask for currency inputs (pt-BR user typing -> normalized numeric)
    // =========================
    function bindMoneyMaskOnce(selector) {
      const $el = $(selector);
      if (!$el.length) return;
      if ($el.data("money-mask")) return;
      $el.data("money-mask", true);

      function normalize(val) {
        const raw = String(val ?? "").trim();
        if (!raw) return "";
        const cleaned = raw.replace(/[^\d,.\-]/g, "");
        if (cleaned.includes(".") && cleaned.includes(",")) {
          return cleaned.replace(/\./g, "").replace(",", ".");
        }
        if (cleaned.includes(",") && !cleaned.includes(".")) {
          return cleaned.replace(",", ".");
        }
        return cleaned;
      }

      $el.on("input", function () { $(this).val(normalize($(this).val())); });
    }

    // =========================
    // API helpers
    // =========================
    async function readJsonSafe(response) {
      const text = await response.text();
      if (!text) return {};
      try { return JSON.parse(text); }
      catch { return { message: text }; }
    }

    async function apiGet(url) {
      const resp = await fetch(url, { method: "GET", headers: { Accept: "application/json" } });
      const data = await readJsonSafe(resp);
      if (!resp.ok) throw new Error(data?.message || tSafe("page.newInvoice.messages.requestFail", "Falha na requisição."));
      return data;
    }

    async function apiPost(url, payload) {
      const resp = await fetch(url, {
        method: "POST",
        headers: { Accept: "application/json", "Content-Type": "application/json" },
        body: JSON.stringify(payload ?? {}),
      });
      const data = await readJsonSafe(resp);
      if (!resp.ok) throw new Error(data?.message || tSafe("page.newInvoice.messages.requestFail", "Falha na requisição."));
      return data;
    }

    async function apiPatch(url, payload) {
      const resp = await fetch(url, {
        method: "PATCH",
        headers: { Accept: "application/json", "Content-Type": "application/json" },
        body: JSON.stringify(payload ?? {}),
      });
      const data = await readJsonSafe(resp);
      if (!resp.ok) throw new Error(data?.message || tSafe("page.newInvoice.messages.requestFail", "Falha na requisição."));
      return data;
    }

    async function apiDelete(url) {
      const resp = await fetch(url, { method: "DELETE", headers: { Accept: "application/json" } });
      if (resp.status === 204) return {};
      const data = await readJsonSafe(resp);
      if (!resp.ok) throw new Error(data?.message || tSafe("page.newInvoice.messages.deleteFail", "Falha ao excluir."));
      return data;
    }

    // =========================
    // Typeahead: Company
    // =========================
    function initTypeaheadCompany() {
      const $input = $("#company_name");
      if (!$input.length || !$.fn.typeahead) return;

      const items = (companiesCache || []).map((c) => ({
        id: c.id,
        name: c.company_name,
        _norm: normalizeText(c.company_name),
      }));

      try { $input.typeahead("destroy"); } catch { /* ignore */ }
      $input.off(".companyTa");

      $input.typeahead({
        source: items,
        autoSelect: true,
        minLength: 0,
        displayText: function (item) { return item.name; },
        matcher: function (item) {
          const q = normalizeText(this.query);
          if (!q) return true;
          return item._norm.includes(q);
        },
        afterSelect: function (item) {
          suppressCompanyClear = true;
          $("#company_id").val(item.id);
          $("#company_name").val(item.name);
          suppressCompanyClear = false;

          onCompanyChanged(item.id).catch(console.error);

          setTimeout(() => {
            try { $input.typeahead("hide"); } catch (e) { /* ignore */ }
            $input.blur();
          }, 0);
        }
      });

      $input.on("input.companyTa", function () {
        if (suppressCompanyClear) return;
        $("#company_id").val("");
      });

      $input.on("focus.companyTa", function () {
        const hasText = String($(this).val() || "").trim().length > 0;
        if (!hasText) $(this).typeahead("lookup");
      });
    }

    function setCompanyById(companyId) {
      const id = String(companyId || "").trim();
      if (!id) {
        suppressCompanyClear = true;
        $("#company_id").val("");
        $("#company_name").val("");
        suppressCompanyClear = false;
        return;
      }

      const c = (companiesCache || []).find(x => String(x.id) === id);

      suppressCompanyClear = true;
      $("#company_id").val(id);
      $("#company_name").val(c ? c.company_name : "");
      suppressCompanyClear = false;
    }

    // =========================
    // Load lists
    // =========================
    async function loadCompanies() {
      const data = await apiGet("/api/companies?fields=summary");
      const list = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? data?.companies ?? []);
      companiesCache = list
        .map((c) => ({
          id: String(c?.id || "").trim(),
          company_name: String(c?.company_name || c?.name || "").trim(),
        }))
        .filter((x) => x.id && x.company_name);

      initTypeaheadCompany();
    }

    async function loadCurrencies() {
      const data = await apiGet("/api/currencies");
      const list = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? data?.currencies ?? []);
      currenciesCache = list
        .map((c) => ({
          id: String(c?.id || "").trim(),
          name: String(c?.name || "").trim(),
          symbol: String(c?.symbol || ""),
          decimals: Number(c?.decimals ?? 2),
          code: String(c?.code || c?.iso_code || c?.currency_code || "").trim(), // ✅ pra Intl currency
        }))
        .filter((x) => x.id && x.name);

      const $ddl = $("#currency_id");
      $ddl.empty().append(`<option value="">${escapeHtml(tSafe("page.newInvoice.form.selectCurrency", "Selecionar..."))}</option>`);
      currenciesCache.forEach((c) => {
        $ddl.append(`<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`);
      });
    }

    function toProductModel(p) {
      return {
        id: String(p?.id || "").trim(),
        name: String(p?.name || "").trim(),
        description: String(p?.description || "").trim(),
        unit: String(p?.unit || "").trim(),
        defaultUnitPrice: parseNumberSafe(p?.default_unit_price, 0),
        defaultTaxRate: clamp01(p?.default_tax_rate),
        isActive: !!p?.is_active,
      };
    }

    async function preloadProducts() {
      const currencyId = String($("#currency_id").val() || "").trim();
      if (!currencyId) { productsCache = []; return false; }

      const qs = new URLSearchParams();
      qs.set("currency_id", currencyId);
      qs.set("is_active", "true");

      const data = await apiGet(`/api/products?${qs.toString()}`);
      const list = Array.isArray(data) ? data : (data?.data ?? data?.rows ?? data?.products ?? []);
      productsCache = list.map(toProductModel).filter((p) => p.id && p.name);

      return productsCache.length > 0;
    }

    function getProductById(productId) {
      const id = String(productId || "").trim();
      return productsCache.find((p) => p.id === id) || null;
    }

    // =========================
    // Company change: auto fill billing
    // =========================
    async function onCompanyChanged(companyId) {
      try {
        const id = String(companyId || "").trim();
        if (!id) return;

        const company = await apiGet(`/api/companies/${encodeURIComponent(id)}`);

        const street = String(company?.address_street || "").trim();
        const number = String(company?.address_number || "").trim();
        const line = String(company?.address_line || "").trim();
        const line1 = line || [street, number].filter(Boolean).join(", ");

        $("#billing_address_line1").val(line1);
        $("#billing_address_line2").val("");
        $("#billing_address_city").val(company?.address_city || "");
        $("#billing_address_state").val(company?.address_state || "");
        $("#billing_address_postal_code").val(company?.address_postalcode || company?.address_postal_code || "");
        $("#billing_address_country").val(company?.address_country || "");
      } catch (e) {
        console.error(e);
      }
    }

    // =========================
    // Header payloads
    // =========================
    function buildInvoiceHeaderPayload() {
      return {
        company_id: String($("#company_id").val() || "").trim() || null,
        currency_id: String($("#currency_id").val() || "").trim() || null,
        quote_at: $("#quote_at").val() || null,
        due_at: dateInputToIsoUtc($("#due_at").val()),
        exchange_rate: $("#exchange_rate").val() || null,
        status: parseNumberSafe($("#status").val(), 0),
        discount_percent: parseNumberSafe($("#discount_percent").val(), 0),
        version: parseNumberSafe($("#version").val(), 1),
        notes: $("#notes").val() || "",
        terms: $("#terms").val() || "",
      };
    }

    function buildBillingPayload() {
      return {
        billing_address_line1: $("#billing_address_line1").val() || "",
        billing_address_line2: $("#billing_address_line2").val() || "",
        billing_address_city: $("#billing_address_city").val() || "",
        billing_address_state: $("#billing_address_state").val() || "",
        billing_address_postal_code: $("#billing_address_postal_code").val() || "",
        billing_address_country: $("#billing_address_country").val() || "",
      };
    }

    function buildLinesPayload() {
      return (lines || []).map((l) => ({
        product_id: l.product_id || null,
        description: l.description || "",
        unit: l.unit || "",
        unit_price: String(parseNumberSafe(l.unit_price, 0)),
        quantity: String(toIntSafe(l.quantity, 1)), // ✅ int
        tax_rate: String(clamp01(l.tax_rate)),
        discount_amount: String(Math.max(0, parseNumberSafe(l.discount_amount, 0))), // ✅ valor
      }));
    }

    // =========================
    // Create invoice header if needed
    // =========================
    async function createInvoiceIfNeeded() {
      if (invoiceId || creatingInvoice) return true;

      const payload = { ...buildInvoiceHeaderPayload(), ...buildBillingPayload(), lines: [] };

      if (!payload.company_id || !payload.currency_id) {
        alert(tSafe("page.newInvoice.messages.companyAndCurrencyRequired", "Empresa e Moeda são obrigatórios."));
        return false;
      }

      try {
        creatingInvoice = true;
        const created = await apiPost("/api/invoices", payload);

        invoiceId = created?.id ? String(created.id) : null;
        setPrintEnabled();

        $("#uiInvoiceId").text(invoiceId || "-");
        $("#invoiceTitle").text(invoiceId || tSafe("page.newInvoice.titles.create", "Criação de Fatura"));
        $("#invoiceNotCreatedBanner").hide();

        $("#discount_percent").prop("readonly", false);

        return !!invoiceId;
      } catch (e) {
        console.error(e);
        alert(e?.message || tSafe("page.newInvoice.messages.createFail", "Falha ao criar a fatura."));
        return false;
      } finally {
        creatingInvoice = false;
      }
    }

    function setLinesEnabled(isEnabled) {
      const area = document.getElementById("linesArea");
      if (!area) return;
      if (isEnabled) area.classList.remove("lines-disabled");
      else area.classList.add("lines-disabled");
    }

    // =========================
    // Calc line + totals
    // discount_amount is a VALUE (currency), not percent
    // =========================
    function recalcLine(line) {
      const qty = toIntSafe(line.quantity, 1);
      const unitPrice = parseNumberSafe(line.unit_price, 0);
      const taxRate = clamp01(line.tax_rate);

      const gross = qty * unitPrice;

      let discountAmount = Math.max(0, parseNumberSafe(line.discount_amount, 0));
      if (discountAmount > gross) discountAmount = gross;

      const taxableBase = Math.max(0, gross - discountAmount);
      const taxAmount = taxableBase * taxRate;
      const lineTotal = taxableBase + taxAmount;

      line.quantity = qty;
      line.unit_price = unitPrice;
      line.tax_rate = taxRate;

      line.line_subtotal = gross;
      line.discount_amount = discountAmount;
      line.tax_amount = taxAmount;
      line.line_total = lineTotal;

      return line;
    }

    function computeTotals() {
      (lines || []).forEach(recalcLine);

      let grossSubtotal = 0;
      let taxTotal = 0;
      let lineDiscountTotal = 0;

      for (const l of (lines || [])) {
        grossSubtotal += parseNumberSafe(l.line_subtotal, 0);
        taxTotal += parseNumberSafe(l.tax_amount, 0);
        lineDiscountTotal += parseNumberSafe(l.discount_amount, 0);
      }

      const headerDiscountPercent = Math.max(0, Math.min(100, parseNumberSafe($("#discount_percent").val(), 0)));
      const headerDiscountAmount = grossSubtotal * (headerDiscountPercent / 100);

      const total = Math.max(0, (grossSubtotal - lineDiscountTotal - headerDiscountAmount) + taxTotal);

      $("#uiSubtotal").text(formatMoney(grossSubtotal));
      $("#uiDiscountHeader").text(formatMoney(headerDiscountAmount));
      $("#uiDiscountLines").text(formatMoney(lineDiscountTotal));
      $("#uiTaxTotal").text(formatMoney(taxTotal));
      $("#uiTotal").text(formatMoney(total));
    }

    $("#discount_percent").on("keyup change input", computeTotals);
    $("#currency_id").on("change", computeTotals);

    // =========================
    // Render grid
    // =========================
    function renderLines() {
      const tbody = document.getElementById("linesTbody");
      if (!tbody) return;

      tbody.innerHTML = "";
      (lines || []).forEach(recalcLine);

      if (!lines || lines.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">${escapeHtml(tSafe("page.newInvoice.lines.empty", "Nenhuma linha adicionada"))}</td></tr>`;
        computeTotals();
        return;
      }

      lines.forEach((l, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(String(idx + 1))}</td>
          <td>
            <div><strong>${escapeHtml(l.product_name || tSafe("page.newInvoice.lines.manual", "Manual"))}</strong></div>
            <small class="text-muted">${escapeHtml(l.description || "")}</small>
          </td>
          <td>${escapeHtml(l.unit || "")}</td>
          <td class="text-right">${escapeHtml(formatMoney(l.unit_price || 0))}</td>
          <td class="text-right">${escapeHtml(String(toIntSafe(l.quantity, 0)))}</td>
          <td class="text-right">${escapeHtml(formatMoney(l.discount_amount || 0))}</td>
          <td class="text-right">${escapeHtml(formatMoney(l.tax_amount || 0))}</td>
          <td class="text-right">${escapeHtml(formatMoney(l.line_total || 0))}</td>
          <td>
            <button type="button" class="btn btn-white btn-xs" data-act="edit" data-idx="${idx}">
              <i class="fa fa-pencil"></i>
            </button>
            <button type="button" class="btn btn-danger btn-xs" data-act="del" data-idx="${idx}">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("button[data-act]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-act");
          const idx = parseInt(btn.getAttribute("data-idx"), 10);
          if (!Number.isFinite(idx)) return;

          if (act === "del") {
            lines.splice(idx, 1);
            renderLines();
          }

          if (act === "edit") {
            openInvoiceLineModal({ mode: "edit", index: idx, requireProduct: false });
          }
        });
      });

      computeTotals();
    }

    // =========================
    // Modal (Add/Edit line) with Typeahead Product
    // =========================
    function openInvoiceLineModal({ mode, index, requireProduct }) {
      const isEdit = mode === "edit";
      const existing = isEdit ? (lines[index] || null) : null;

      const line = existing ? { ...existing } : {
        id: null,
        product_id: null,
        product_name: "",
        description: "",
        unit: "",
        unit_price: 0,
        quantity: 1,
        tax_rate: 0,
        discount_amount: 0, // ✅ valor
        tax_amount: 0,
        line_subtotal: 0,
        line_total: 0,
      };

      recalcLine(line);

      const html = `
        <div class="form-group">
          <label>${escapeHtml(tSafe("page.newInvoice.lineModal.product", "Produto"))}</label>

          <input
            id="il_product_name"
            type="text"
            class="form-control typeahead-product"
            placeholder="${escapeHtml(tSafe("page.newInvoice.lineModal.searchProduct", "Pesquisar produto..."))}"
            autocomplete="off"
          />

          <input id="il_product_id" type="hidden" />

          <div class="small text-muted" style="margin-top:6px;">${escapeHtml(tSafe("page.newInvoice.lineModal.typeToSearch", "Digite para pesquisar."))}</div>
        </div>

        <div class="form-group">
          <label>${escapeHtml(tSafe("page.newInvoice.lineModal.description", "Descrição"))}</label>
          <input id="il_description" type="text" class="form-control" value="${escapeHtml(line.description || "")}" />
        </div>

        <div class="row row-tight">
          <div class="col-xs-6">
            <div class="form-group">
              <label>${escapeHtml(tSafe("page.newInvoice.lineModal.unit", "Unidade"))}</label>
              <input id="il_unit" type="text" class="form-control" maxlength="50" value="${escapeHtml(line.unit || "")}" />
            </div>
          </div>
          <div class="col-xs-6">
            <div class="form-group">
              <label>${escapeHtml(tSafe("page.newInvoice.lineModal.unitPrice", "Preço unitário"))}</label>
              <input id="il_unit_price" type="text" class="form-control money" value="${escapeHtml(String(parseNumberSafe(line.unit_price, 0)))}" />
            </div>
          </div>
        </div>

        <div class="row row-tight">
          <div class="col-xs-6">
            <div class="form-group">
              <label>${escapeHtml(tSafe("page.newInvoice.lineModal.quantity", "Quantidade"))}</label>
              <input id="il_quantity" type="number" step="1" min="1" class="form-control" value="${escapeHtml(String(toIntSafe(line.quantity, 1)))}" />
              <div class="small text-muted" style="margin-top:4px;">${escapeHtml(tSafe("page.newInvoice.lineModal.integerOnly", "*Somente inteiro"))}</div>
            </div>
          </div>
          <div class="col-xs-6">
            <div class="form-group">
              <label>${escapeHtml(tSafe("page.newInvoice.lineModal.taxRate", "Taxa de imposto (0..1)"))}</label>
              <input id="il_tax_rate" type="text" class="form-control money" value="${escapeHtml(String(clamp01(line.tax_rate)))}" />
            </div>
          </div>
        </div>

        <div class="row row-tight">
          <div class="col-xs-6">
            <div class="form-group">
              <label>${escapeHtml(tSafe("page.newInvoice.lineModal.discountValue", "Desconto (valor)"))}</label>
              <input id="il_discount_amount" type="text" class="form-control money" value="${escapeHtml(String(parseNumberSafe(line.discount_amount, 0)))}" />
            </div>
          </div>
          <div class="col-xs-6">
            <div class="form-group">
              <label>${escapeHtml(tSafe("page.newInvoice.lineModal.lineTotal", "Total da linha"))}</label>
              <input id="il_line_total" type="text" class="form-control" value="${escapeHtml(formatMoney(line.line_total))}" readonly />
            </div>
          </div>
        </div>

        <div class="small text-muted">${escapeHtml(tSafe("page.newInvoice.lineModal.autoCalculated", "Subtotal/Imposto/Total são calculados automaticamente."))}</div>
      `;

      window.SideModal.open({
        title: isEdit ? tSafe("page.newInvoice.lineModal.editTitle", "Editar linha") : tSafe("page.newInvoice.lineModal.addTitle", "Adicionar linha"),
        okText: isEdit ? tSafe("page.newInvoice.lineModal.save", "Salvar") : tSafe("page.newInvoice.lineModal.add", "Adicionar"),
        cancelText: tSafe("page.newInvoice.lineModal.cancel", "Cancelar"),
        html,

        onOpen: async function (ctx) {
          const rootEl = (ctx && ctx.root) || document.getElementById("dynamicModalBody") || document.body;
          const $root = $(rootEl);

          // normalize numeric typing
          bindMoneyMaskOnce($root.find("#il_unit_price"));
          bindMoneyMaskOnce($root.find("#il_tax_rate"));
          bindMoneyMaskOnce($root.find("#il_discount_amount"));

          function syncModalCalc() {
            const tmp = {
              ...line,
              unit_price: parseNumberSafe($root.find("#il_unit_price").val(), 0),
              quantity: toIntSafe($root.find("#il_quantity").val(), 1),
              tax_rate: clamp01($root.find("#il_tax_rate").val()),
              discount_amount: parseNumberSafe($root.find("#il_discount_amount").val(), 0),
            };

            recalcLine(tmp);
            $root.find("#il_line_total").val(formatMoney(tmp.line_total));
          }

          const $prodName = $root.find("#il_product_name");
          const $prodId = $root.find("#il_product_id");

          const items = (productsCache || []).map((p) => ({
            id: p.id,
            name: p.name,
            unit: p.unit,
            description: p.description,
            defaultUnitPrice: p.defaultUnitPrice,
            defaultTaxRate: p.defaultTaxRate,
            _norm: normalizeText(p.name),
          }));

          try { $prodName.typeahead("destroy"); } catch { /* ignore */ }
          $prodName.off(".prodTa");

          $prodName.typeahead({
            source: items,
            autoSelect: true,
            minLength: 0,
            displayText: function (item) { return item.name; },
            matcher: function (item) {
              const q = normalizeText(this.query);
              if (!q) return true;
              return item._norm.includes(q);
            },
            afterSelect: function (item) {
              $prodId.val(item.id);

              if (!isEdit) {
                $root.find("#il_unit").val(item.unit || "");
                if (!String($root.find("#il_description").val() || "").trim()) {
                  $root.find("#il_description").val(item.description || "");
                }
                $root.find("#il_unit_price").val(String(parseNumberSafe(item.defaultUnitPrice, 0)));
                $root.find("#il_tax_rate").val(String(clamp01(item.defaultTaxRate)));
              }

              syncModalCalc();

              setTimeout(() => {
                try { $prodName.typeahead("hide"); } catch (e) { /* ignore */ }
                $prodName.blur();
              }, 0);
            }
          });

          $prodName.on("input.prodTa", function () {
            $prodId.val("");
            syncModalCalc();
          });

          $prodName.on("focus.prodTa", function () {
            const hasText = String($(this).val() || "").trim().length > 0;
            if (!hasText) $(this).typeahead("lookup");
          });

          if (isEdit && existing) {
            if (existing.product_id) {
              const prod = getProductById(existing.product_id);
              $prodId.val(existing.product_id);
              $prodName.val(prod ? prod.name : "");
            }

            $root.find("#il_description").val(existing.description || "");
            $root.find("#il_unit").val(existing.unit || "");
            $root.find("#il_unit_price").val(String(parseNumberSafe(existing.unit_price, 0)));
            $root.find("#il_quantity").val(String(toIntSafe(existing.quantity, 1)));
            $root.find("#il_tax_rate").val(String(clamp01(existing.tax_rate)));
            $root.find("#il_discount_amount").val(String(parseNumberSafe(existing.discount_amount, 0)));
          }

          $root
            .find("#il_description, #il_unit, #il_unit_price, #il_quantity, #il_tax_rate, #il_discount_amount")
            .off("keyup.__il change.__il input.__il")
            .on("keyup.__il change.__il input.__il", syncModalCalc);

          syncModalCalc();
        },

        onOk: async function (ctx) {
          const rootEl = (ctx && ctx.root) || document.getElementById("dynamicModalBody") || document.body;
          const $root = $(rootEl);

          const productId = String($root.find("#il_product_id").val() || "").trim() || null;
          const typedName = String($root.find("#il_product_name").val() || "").trim();

          if (requireProduct && (!productId || !typedName)) {
            alert(tSafe("page.newInvoice.messages.pickProductFromList", "Selecione um produto na lista (digitar não basta)."));
            return true;
          }

          const prod = productId ? getProductById(productId) : null;

          const updated = {
            ...line,
            product_id: productId,
            product_name: prod?.name || (typedName || (productId ? productId : tSafe("page.newInvoice.lines.manual", "Manual"))),
            description: String($root.find("#il_description").val() || ""),
            unit: String($root.find("#il_unit").val() || ""),
            unit_price: parseNumberSafe($root.find("#il_unit_price").val(), 0),
            quantity: toIntSafe($root.find("#il_quantity").val(), 1),
            tax_rate: clamp01($root.find("#il_tax_rate").val()),
            discount_amount: Math.max(0, parseNumberSafe($root.find("#il_discount_amount").val(), 0)),
          };

          if (prod) {
            if (!String(updated.unit || "").trim()) updated.unit = prod.unit || "";
            if (!String(updated.description || "").trim()) updated.description = prod.description || "";
            if (!parseNumberSafe(updated.unit_price, 0)) updated.unit_price = parseNumberSafe(prod.defaultUnitPrice, 0);
            if (!parseNumberSafe(updated.tax_rate, 0)) updated.tax_rate = clamp01(prod.defaultTaxRate);
          }

          recalcLine(updated);

          if (toIntSafe(updated.quantity, 0) <= 0) {
            alert(tSafe("page.newInvoice.messages.quantityGreaterThanZero", "Quantidade deve ser maior que 0."));
            return true;
          }

          if (isEdit) lines[index] = updated;
          else lines.push(updated);

          renderLines();
          return false;
        },
      });
    }

    // =========================
    // Load existing invoice (Edit mode)
    // =========================
    function detectInvoiceIdFromUrl() {
      const qs = new URLSearchParams(window.location.search || "");
      const byQuery = String(qs.get("id") || qs.get("invoice_id") || "").trim();
      if (byQuery) return byQuery;

      const parts = String(window.location.pathname || "")
        .split("/")
        .map((p) => p.trim())
        .filter(Boolean);

      const last = parts[parts.length - 1] || "";
      const uuidLike = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
      return uuidLike.test(last) ? last : null;
    }

    function normalizeLineFromApi(l) {
      const productId = l?.product_id ? String(l.product_id).trim() : null;
      const prod = productId ? getProductById(productId) : null;

      const normalized = {
        id: l?.id ? String(l.id).trim() : null,
        product_id: productId,
        product_name: prod?.name || (productId ? productId : tSafe("page.newInvoice.lines.manual", "Manual")),
        description: String(l?.description ?? "").trim(),
        unit: String(l?.unit ?? "").trim(),
        unit_price: parseNumberSafe(l?.unit_price, 0),
        quantity: toIntSafe(l?.quantity, 1),
        tax_rate: clamp01(l?.tax_rate),
        discount_amount: parseNumberSafe(l?.discount_amount, 0),
        tax_amount: parseNumberSafe(l?.tax_amount, 0),
        line_subtotal: parseNumberSafe(l?.line_subtotal, 0),
        line_total: parseNumberSafe(l?.line_total, 0),
      };

      recalcLine(normalized);
      return normalized;
    }

    async function loadInvoiceForEdit(id) {
      const inv = await apiGet(`/api/invoices/${encodeURIComponent(id)}`);

      invoiceId = String(inv?.id || id).trim();
      $("#uiInvoiceId").text(inv?.invoice_number || invoiceId || "-");
      $("#invoiceTitle").text(inv?.invoice_number || invoiceId || "-");

      setCompanyById(inv?.company_id || "");
      if (inv?.company_id) {
        onCompanyChanged(inv.company_id).catch(console.error);
      }

      $("#currency_id").val(inv?.currency_id || "").trigger("change");

      $("#status").val(String(inv?.status ?? 0));
      $("#version").val(parseNumberSafe(inv?.version, 1));

      $("#quote_at").val(tryToDatetimeLocal(inv?.quote_at));
      $("#due_at").val(tryToDateInput(inv?.due_at)); // ✅ novo

      $("#exchange_rate").val(inv?.exchange_rate ?? "1");

      $("#billing_address_line1").val(inv?.billing_address_line1 || "");
      $("#billing_address_line2").val(inv?.billing_address_line2 || "");
      $("#billing_address_city").val(inv?.billing_address_city || "");
      $("#billing_address_state").val(inv?.billing_address_state || "");
      $("#billing_address_postal_code").val(inv?.billing_address_postal_code || "");
      $("#billing_address_country").val(inv?.billing_address_country || "");

      $("#discount_percent").val(parseNumberSafe(inv?.discount_percent, 0));
      $("#notes").val(inv?.notes || "");
      $("#terms").val(inv?.terms || "");

      await preloadProducts();

      const apiLines = Array.isArray(inv?.invoice_lines) ? inv.invoice_lines : [];
      lines = apiLines.map(normalizeLineFromApi);

      $("#invoiceNotCreatedBanner").hide();
      setLinesEnabled(true);

      $("#btnAddManualLine").prop("disabled", false);
      $("#btnAddProduct").prop("disabled", false);
      $("#discount_percent").prop("readonly", false);

      renderLines();
      computeTotals();

      setPrintEnabled();
      return inv;
    }

    // =========================
    // Save logic
    // =========================
    async function saveInvoice() {
      const ok = await createInvoiceIfNeeded();
      if (!ok) {
        $("#invoiceNotCreatedBanner").show();
        setLinesEnabled(false);
        return false;
      }

      setLinesEnabled(true);
      $("#invoiceNotCreatedBanner").hide();
      $("#btnAddManualLine").prop("disabled", false);
      $("#btnAddProduct").prop("disabled", false);

      const headerPayload = { ...buildInvoiceHeaderPayload(), ...buildBillingPayload() };

      try {
        const payload = { ...headerPayload, lines: buildLinesPayload() };
        await apiPatch(`/api/invoices/${encodeURIComponent(invoiceId)}`, payload);
        return true;
      } catch (e) {
        console.error(e);
        alert(e?.message || tSafe("page.newInvoice.messages.saveFail", "Falha ao salvar a fatura."));
        return false;
      }
    }

    // =========================
    // Buttons / events
    // =========================
    $("#btnAddProduct").on("click", async function () {
      const ok = await createInvoiceIfNeeded();
      if (!ok) return;

      setLinesEnabled(true);
      $("#invoiceNotCreatedBanner").hide();

      const currencyId = String($("#currency_id").val() || "").trim();
      if (!currencyId) {
        alert(tSafe("page.newInvoice.messages.selectCurrencyToLoadProducts", "Selecione uma moeda para carregar os produtos."));
        return;
      }

      try {
        const loaded = await preloadProducts();
        if (!loaded) {
          alert(tSafe("page.newInvoice.messages.noProductsForCurrency", "Nenhum produto encontrado para a moeda selecionada."));
          return;
        }
      } catch (e) {
        console.error(e);
        productsCache = [];
        alert(tSafe("page.newInvoice.messages.loadProductsFail", "Falha ao carregar produtos para a moeda selecionada."));
        return;
      }

      openInvoiceLineModal({ mode: "add", requireProduct: true });
    });

    $("#btnAddManualLine").on("click", async function () {
      const ok = await createInvoiceIfNeeded();
      if (!ok) return;

      setLinesEnabled(true);
      $("#invoiceNotCreatedBanner").hide();

      openInvoiceLineModal({ mode: "add", requireProduct: false });
    });

    $("#btnSaveInvoice").on("click", async function () {
      await saveInvoice();
    });

    $("#btnGenerateInvoicePrint").on("click", async function () {
      const saved = await saveInvoice();
      if (!saved || !invoiceId) return;

      const url = `/api/invoices/${encodeURIComponent(invoiceId)}/print`;
      window.open(url, "_blank", "noopener,noreferrer");
    });

    $("#btnDeleteInvoice").on("click", async function () {
      if (!invoiceId) return;

      const ok = await confirm(
        tSafe("page.newInvoice.confirm.deleteTitle", "Tem certeza que deseja excluir esta fatura?"),
        { title: tSafe("page.newInvoice.confirm.deleteModalTitle", "Excluir fatura"), danger: true }
      );
      if (!ok) return;

      try {
        await apiDelete(`/api/invoices/${encodeURIComponent(invoiceId)}`);
        alert(tSafe("page.newInvoice.messages.deleteSuccess", "Fatura excluída com sucesso."));
        window.location.href = "/Invoices";
      } catch (e) {
        console.error(e);
        alert(e?.message || tSafe("page.newInvoice.messages.deleteFail", "Falha ao excluir a fatura."));
      }
    });

    $("#currency_id").on("change", async function () {
      try { await preloadProducts(); }
      catch (e) { console.error(e); productsCache = []; }
      computeTotals();
      renderLines();
    });

    // =========================
    // Init
    // =========================
    (async function init() {
      try {
        if ($("#pageName").length) {
          // Mantive aqui apenas com t, sem mudar fluxo
          $("#pageName").text(tSafe("page.invoices.pageTitle", "Faturas"));
          $("#subpageName").text(tSafe("page.invoices.pageTitle", "Faturas"));
          $("#path").show();
          $("#subSecoundPageName").text(tSafe("page.newInvoice.breadcrumbs.forms", "Formulários"));
          $("#subpath").show();
          $("#subpathName").text(tSafe("page.newInvoice.breadcrumbs.newInvoice", "Nova Fatura"));
        }

        await Promise.all([loadCompanies(), loadCurrencies()]);

        $("#uiInvoiceId").text("-");
        setPrintEnabled();
        $("#invoiceNotCreatedBanner").show();
        setLinesEnabled(false);

        $("#btnAddManualLine").prop("disabled", true);
        $("#btnAddProduct").prop("disabled", true);

        renderLines();
        computeTotals();

        const existingId = detectInvoiceIdFromUrl();
        if (existingId) {
          $("#subpathName").text(tSafe("page.newInvoice.breadcrumbs.editInvoice", "Editar Fatura"));
          await loadInvoiceForEdit(existingId);
        } else {
          await preloadProducts();
          $("#invoiceTitle").text(tSafe("page.newInvoice.titles.create", "Criação de Fatura"));
        }
      } catch (e) {
        console.error(e);
        alert(tSafe("page.newInvoice.messages.initFail", "Falha ao carregar dados iniciais."));
      }
    })();
  })();

  function dateInputToIsoUtc(dateInputValue) {
    const s = String(dateInputValue || "").trim(); // "YYYY-MM-DD"
    if (!s) return null;

    const [y, m, d] = s.split("-").map((x) => parseInt(x, 10));
    if (!y || !m || !d) return null;

    // Local midnight -> ISO (UTC)
    const localMidnight = new Date(y, m - 1, d, 0, 0, 0, 0);
    return localMidnight.toISOString();
  }
</script>
<% %>
